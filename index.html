<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Management System</title>
  
  <!-- Load React + Lucide + Supabase via ES modules with proper bundling, then Babel -->
  <script type="module">
    // Use esm.sh which properly handles React as a peer dependency
    import React from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import * as LucideReact from 'https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0';
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    import { marked } from 'https://esm.sh/marked@9.1.0';

    // Configure marked for safe rendering
    marked.setOptions({
      breaks: true,  // Convert \n to <br>
      gfm: true,     // GitHub Flavored Markdown
    });
    window.marked = marked;

    // Expose to global scope for Babel scripts
    window.React = React;
    window.ReactDOM = ReactDOM;
    window.ReactDOM.createRoot = createRoot;
    window.lucideReact = LucideReact;

    // Initialize Supabase client with realtime options for better connection stability
    const SUPABASE_URL = 'https://rnzhhwcoxengwmixzaws.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJuemhod2NveGVuZ3dtaXh6YXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MDg5MzgsImV4cCI6MjA4MDM4NDkzOH0.8eH9g3lKKMVIdiGBhEO6O0DhICv6o3X0wtE9Ift2ERw';
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      realtime: {
        params: {
          eventsPerSecond: 10
        },
        heartbeatIntervalMs: 15000,
        reconnectAfterMs: (tries) => Math.min(1000 * Math.pow(2, tries), 30000),
        timeout: 20000
      }
    });

    // Now load and run Babel after React is available
    const babelScript = document.createElement('script');
    babelScript.src = 'https://unpkg.com/@babel/standalone/babel.min.js';
    babelScript.onload = () => {
      // Babel will auto-transform text/babel scripts on load
      Babel.transformScriptTags();
    };
    document.head.appendChild(babelScript);
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #09090b;
      color: #fafafa;
      min-height: 100vh;
    }
    
    #root {
      min-height: 100vh;
    }

    /* Auth styles */
    .auth-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #09090b;
      padding: 20px;
    }

    .auth-card {
      background: #18181b;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .auth-title {
      font-size: 24px;
      font-weight: 600;
      color: #fafafa;
      margin-bottom: 8px;
      text-align: center;
    }

    .auth-subtitle {
      font-size: 14px;
      color: #71717a;
      margin-bottom: 32px;
      text-align: center;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .auth-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .auth-label {
      font-size: 13px;
      font-weight: 500;
      color: #a1a1aa;
    }

    .auth-input {
      padding: 12px 14px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 14px;
      outline: none;
      transition: all 0.15s;
    }

    .auth-input:focus {
      border-color: rgba(99, 102, 241, 0.5);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .auth-input::placeholder {
      color: #52525b;
    }

    .auth-button {
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      margin-top: 8px;
    }

    .auth-button-primary {
      background: #6366f1;
      color: #fff;
    }

    .auth-button-primary:hover {
      background: #4f46e5;
    }

    .auth-button-primary:disabled {
      background: #4338ca;
      opacity: 0.6;
      cursor: not-allowed;
    }

    .auth-toggle {
      text-align: center;
      margin-top: 24px;
      font-size: 14px;
      color: #71717a;
    }

    .auth-toggle-link {
      color: #6366f1;
      cursor: pointer;
      font-weight: 500;
    }

    .auth-toggle-link:hover {
      color: #818cf8;
    }

    .auth-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #fca5a5;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      text-align: center;
    }

    .auth-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #71717a;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel" data-type="module">
const { ChevronLeft, ChevronRight, ChevronDown, ChevronUp, Calendar, FolderOpen, Plus, Check, Clock, Users, X, MessageSquare, Edit2, User, MapPin, Bell, List, Filter, Search, LogOut, Mail, Lock, Trash2, Settings, FolderInput, Webhook, Send } = lucideReact;

// ==================== AUTH CONTEXT & PROVIDER ====================
const AuthContext = React.createContext(null);

function useAuth() {
  const context = React.useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}

// Generate a random color for new users
const generateUserColor = () => {
  const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
  return colors[Math.floor(Math.random() * colors.length)];
};

function AuthProvider({ children }) {
  const [session, setSession] = React.useState(null);
  const [teamMember, setTeamMember] = React.useState(null);
  const [loading, setLoading] = React.useState(true);
  const [authError, setAuthError] = React.useState(null);

  // Fetch or create team member profile
  const fetchOrCreateTeamMember = async (user) => {
    try {
      // First try to get existing team member
      const { data: existing, error: fetchError } = await supabase
        .from('team_members')
        .select('*')
        .eq('auth_user_id', user.id)
        .single();

      if (existing) {
        setTeamMember(existing);
        return existing;
      }

      // If not found, create new team member
      if (fetchError && fetchError.code === 'PGRST116') {
        const { data: newMember, error: createError } = await supabase
          .from('team_members')
          .insert({
            auth_user_id: user.id,
            email: user.email,
            name: user.user_metadata?.name || user.email.split('@')[0],
            color: generateUserColor()
          })
          .select()
          .single();

        if (createError) throw createError;

        // Create personal space for new user
        await supabase
          .from('clients')
          .insert({
            name: 'Personal',
            color: '#8b5cf6',
            details: 'My personal workspace for private notes, tasks, and reminders.',
            is_internal: true,
            is_personal: true,
            owner_id: newMember.id
          });

        setTeamMember(newMember);
        return newMember;
      }

      throw fetchError;
    } catch (err) {
      console.error('Error fetching/creating team member:', err);
      setAuthError(err.message);
      return null;
    }
  };

  // Initialize auth state
  React.useEffect(() => {
    // Get initial session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session);
      if (session?.user) {
        fetchOrCreateTeamMember(session.user).then(() => setLoading(false));
      } else {
        setLoading(false);
      }
    });

    // Listen for auth changes
    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
      setSession(session);
      if (session?.user) {
        await fetchOrCreateTeamMember(session.user);
      } else {
        setTeamMember(null);
      }
    });

    return () => subscription.unsubscribe();
  }, []);

  const signUp = async (email, password, name) => {
    setAuthError(null);
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: { name }
      }
    });
    if (error) {
      setAuthError(error.message);
      return { error };
    }
    return { data };
  };

  const signIn = async (email, password) => {
    setAuthError(null);
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });
    if (error) {
      setAuthError(error.message);
      return { error };
    }
    return { data };
  };

  const signOut = async () => {
    await supabase.auth.signOut();
    setSession(null);
    setTeamMember(null);
  };

  const value = {
    session,
    user: session?.user,
    teamMember,
    loading,
    authError,
    signUp,
    signIn,
    signOut
  };

  return React.createElement(AuthContext.Provider, { value }, children);
}

// ==================== LOGIN/SIGNUP FORM ====================
function AuthForm() {
  const [mode, setMode] = React.useState('signin'); // 'signin' or 'signup'
  const [email, setEmail] = React.useState('');
  const [password, setPassword] = React.useState('');
  const [name, setName] = React.useState('');
  const [isSubmitting, setIsSubmitting] = React.useState(false);
  const [successMessage, setSuccessMessage] = React.useState('');
  const { signIn, signUp, authError } = useAuth();

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsSubmitting(true);
    setSuccessMessage('');

    if (mode === 'signup') {
      const { error } = await signUp(email, password, name);
      if (!error) {
        setSuccessMessage('Check your email to confirm your account!');
      }
    } else {
      await signIn(email, password);
    }

    setIsSubmitting(false);
  };

  return (
    <div className="auth-container">
      <div className="auth-card">
        <h1 className="auth-title">
          {mode === 'signin' ? 'Welcome back' : 'Create account'}
        </h1>
        <p className="auth-subtitle">
          {mode === 'signin'
            ? 'Sign in to your project management workspace'
            : 'Get started with your project management workspace'
          }
        </p>

        <form className="auth-form" onSubmit={handleSubmit}>
          {mode === 'signup' && (
            <div className="auth-field">
              <label className="auth-label">Name</label>
              <input
                type="text"
                className="auth-input"
                placeholder="Your name"
                value={name}
                onChange={(e) => setName(e.target.value)}
                required
              />
            </div>
          )}

          <div className="auth-field">
            <label className="auth-label">Email</label>
            <input
              type="email"
              className="auth-input"
              placeholder="you@example.com"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
            />
          </div>

          <div className="auth-field">
            <label className="auth-label">Password</label>
            <input
              type="password"
              className="auth-input"
              placeholder="••••••••"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              minLength={6}
            />
          </div>

          {authError && (
            <div className="auth-error">{authError}</div>
          )}

          {successMessage && (
            <div className="auth-error" style={{ background: 'rgba(34, 197, 94, 0.1)', borderColor: 'rgba(34, 197, 94, 0.3)', color: '#86efac' }}>
              {successMessage}
            </div>
          )}

          <button
            type="submit"
            className="auth-button auth-button-primary"
            disabled={isSubmitting}
          >
            {isSubmitting
              ? (mode === 'signin' ? 'Signing in...' : 'Creating account...')
              : (mode === 'signin' ? 'Sign in' : 'Create account')
            }
          </button>
        </form>

        <div className="auth-toggle">
          {mode === 'signin' ? (
            <>
              Don't have an account?{' '}
              <span className="auth-toggle-link" onClick={() => setMode('signup')}>
                Sign up
              </span>
            </>
          ) : (
            <>
              Already have an account?{' '}
              <span className="auth-toggle-link" onClick={() => setMode('signin')}>
                Sign in
              </span>
            </>
          )}
        </div>
      </div>
    </div>
  );
}

// ==================== TIME SELECT HELPERS ====================
// Hour options (1-12)
const HOUR_OPTIONS = Array.from({ length: 12 }, (_, i) => {
  const hour = i === 0 ? 12 : i;
  return { value: hour, label: hour.toString() };
});

// Minute options (00, 15, 30, 45)
const MINUTE_OPTIONS = [
  { value: 0, label: '00' },
  { value: 15, label: '15' },
  { value: 30, label: '30' },
  { value: 45, label: '45' }
];

// AM/PM options
const AMPM_OPTIONS = [
  { value: 'AM', label: 'AM' },
  { value: 'PM', label: 'PM' }
];

// Convert HH:MM string to { hour, minute, ampm } object
const parseTimeString = (timeStr) => {
  if (!timeStr) return { hour: 9, minute: 0, ampm: 'AM' };
  const [h, m] = timeStr.split(':').map(Number);
  const hour = h === 0 ? 12 : h > 12 ? h - 12 : h;
  const ampm = h < 12 ? 'AM' : 'PM';
  const minute = Math.round(m / 15) * 15 % 60;
  return { hour, minute, ampm };
};

// Convert { hour, minute, ampm } to HH:MM string
const formatTimeString = (hour, minute, ampm) => {
  let h = hour;
  if (ampm === 'AM') {
    h = hour === 12 ? 0 : hour;
  } else {
    h = hour === 12 ? 12 : hour + 12;
  }
  return `${h.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
};

// Add hours to a time string, return new time string
const addHourToTime = (timeStr, hoursToAdd = 1) => {
  const { hour, minute, ampm } = parseTimeString(timeStr);
  let h = ampm === 'AM' ? (hour === 12 ? 0 : hour) : (hour === 12 ? 12 : hour + 12);
  h = (h + hoursToAdd) % 24;
  const newHour = h === 0 ? 12 : h > 12 ? h - 12 : h;
  const newAmpm = h < 12 ? 'AM' : 'PM';
  return formatTimeString(newHour, minute, newAmpm);
};

// Get default event times (next hour, 1 hour duration) in HST
const getDefaultEventTimes = () => {
  // Get current time in HST
  const now = new Date();
  const hstOptions = { timeZone: 'Pacific/Honolulu' };
  const hstString = now.toLocaleString('en-US', hstOptions);
  const hstNow = new Date(hstString);

  // Round up to next hour
  const nextHour = new Date(hstNow);
  nextHour.setHours(hstNow.getHours() + 1, 0, 0, 0);

  const startH = nextHour.getHours();
  const startHour = startH === 0 ? 12 : startH > 12 ? startH - 12 : startH;
  const startAmpm = startH < 12 ? 'AM' : 'PM';

  const endH = (startH + 1) % 24;
  const endHour = endH === 0 ? 12 : endH > 12 ? endH - 12 : endH;
  const endAmpm = endH < 12 ? 'AM' : 'PM';

  // Format date as YYYY-MM-DD in HST
  const year = nextHour.getFullYear();
  const month = String(nextHour.getMonth() + 1).padStart(2, '0');
  const day = String(nextHour.getDate()).padStart(2, '0');

  return {
    date: `${year}-${month}-${day}`,
    startHour,
    startMinute: 0,
    startAmpm,
    endHour,
    endMinute: 0,
    endAmpm
  };
};

// Helper to round time to nearest 15-minute interval
const roundToNearest15 = (timeStr) => {
  if (!timeStr) return '09:00';
  const [hours, minutes] = timeStr.split(':').map(Number);
  const roundedMinutes = Math.round(minutes / 15) * 15;
  const adjustedHours = roundedMinutes === 60 ? (hours + 1) % 24 : hours;
  const adjustedMinutes = roundedMinutes === 60 ? 0 : roundedMinutes;
  return `${adjustedHours.toString().padStart(2, '0')}:${adjustedMinutes.toString().padStart(2, '0')}`;
};

// ==================== SAMPLE DATA ====================
// Internal spaces (Personal & Team)
const internalSpaces = {
  personal: {
    id: 'personal',
    name: 'Personal',
    color: '#8b5cf6',
    details: 'My personal workspace for private notes, tasks, and reminders.',
    projects: [
      { id: 'personal-p1', name: 'Learning & Development', color: '#a78bfa' },
      { id: 'personal-p2', name: 'Admin & Organization', color: '#c4b5fd' },
    ],
    isInternal: true,
    isPersonal: true,
  },
  team: {
    id: 'team',
    name: 'Team',
    color: '#0ea5e9',
    details: 'Shared team workspace for internal projects, meetings, and collaboration.\nWeekly standup: Mondays 9am\nTeam lunch: Fridays 12pm',
    projects: [
      { id: 'team-p1', name: 'Operations', color: '#38bdf8' },
      { id: 'team-p2', name: 'Business Development', color: '#7dd3fc' },
    ],
    isInternal: true,
    isTeam: true,
  }
};

const initialClients = [
  {
    id: 'c1',
    name: 'Acme Corp',
    color: '#6366f1',
    details: 'Contact: John Smith (john@acmecorp.com) • (808) 555-1234\nIndustry: Technology / SaaS\nBilling: Net 30 • Primary contact for approvals: Sarah Chen',
    projects: [
      { id: 'p1', name: 'Website Redesign', color: '#818cf8' },
      { id: 'p2', name: 'Mobile App', color: '#a78bfa' },
    ]
  },
  {
    id: 'c2',
    name: 'TechStart Inc',
    color: '#10b981',
    details: 'Contact: Mike Johnson (mike@techstart.io) • (808) 555-5678\nStartup - Series A funded\nFlexible timeline, quality focused',
    projects: [
      { id: 'p3', name: 'Brand Identity', color: '#34d399' },
      { id: 'p4', name: 'Marketing Videos', color: '#6ee7b7' },
    ]
  },
  {
    id: 'c3',
    name: 'Global Media',
    color: '#f59e0b',
    details: 'Contact: Lisa Wong (lwong@globalmedia.com) • (808) 555-9012\nEnterprise client - requires detailed invoicing\nPreferred payment: Wire transfer',
    projects: [
      { id: 'p5', name: 'Documentary', color: '#fbbf24' },
      { id: 'p6', name: 'Commercial Spots', color: '#fcd34d' },
    ]
  },
];

const initialTeamMembers = [
  { id: 't1', name: 'Kawika', color: '#6366f1' },
  { id: 't2', name: 'Nick', color: '#10b981' },
  { id: 't3', name: 'John', color: '#f59e0b' },
  { id: 't4', name: 'Chris', color: '#ef4444' },
];

// Generate sample events spread across the month
const generateEvents = () => {
  const now = new Date();
  const events = [];
  const types = ['meeting', 'deadline', 'task', 'review'];
  
  // Sample locations and notes
  const locations = [
    'Conference Room A', 'Zoom Meeting', 'Client Office', 'Studio 1', 
    'Main Office', 'Google Meet', 'On-site', 'Remote', ''
  ];
  const sampleNotes = [
    'Bring latest mockups and prepare presentation deck.',
    'Review action items from last meeting before joining.',
    'Client requested focus on mobile responsiveness.',
    'Need to finalize budget discussion.',
    'Prepare equipment checklist beforehand.',
    '',
    'Follow up on feedback from previous session.',
    ''
  ];
  
  // Helper to generate attendees based on index
  const generateAttendees = (creatorId, index) => {
    const otherMembers = initialTeamMembers.filter(m => m.id !== creatorId);
    const numAttendees = 1 + (index % 3); // 1-3 additional attendees
    const attendees = [creatorId];
    for (let j = 0; j < numAttendees && j < otherMembers.length; j++) {
      attendees.push(otherMembers[(index + j) % otherMembers.length].id);
    }
    return attendees;
  };
  
  // Helper to generate visibility
  const generateVisibility = (creatorId, attendees, index) => {
    const types = ['team', 'team', 'team', 'attendees', 'attendees', 'private'];
    const type = types[index % types.length];
    return {
      type,
      canEdit: type === 'private' ? [creatorId] : [creatorId, attendees[1]].filter(Boolean)
    };
  };
  
  // Events for today (just a few)
  const todayEvents = [
    { projectId: 'p1', title: 'Design Review', hoursFromNow: 2, duration: 1, location: 'Conference Room A', notes: 'Review latest homepage designs with the team.' },
    { projectId: 'p3', title: 'Logo Presentation', hoursFromNow: 4, duration: 1.5, location: 'Zoom Meeting', notes: 'Present final logo concepts to client. Have backup options ready.' },
  ];
  
  todayEvents.forEach((e, i) => {
    const start = new Date(now.getTime() + e.hoursFromNow * 60 * 60 * 1000);
    const end = new Date(start.getTime() + e.duration * 60 * 60 * 1000);
    const createdBy = initialTeamMembers[i % initialTeamMembers.length].id;
    const attendees = generateAttendees(createdBy, i);
    events.push({
      id: `e${events.length + 1}`,
      projectId: e.projectId,
      title: e.title,
      startTime: start,
      endTime: end,
      type: types[i % types.length],
      attendees: attendees,
      createdBy: createdBy,
      visibility: { type: 'team', canEdit: [createdBy, 't2'] },
      isCompleted: false,
      location: e.location || '',
      notes: e.notes || '',
    });
  });
  
  // Events spread throughout the month - past and future
  const monthEvents = [
    // Past events (various days ago)
    { projectId: 'p1', title: 'Kickoff Meeting', daysFromNow: -18, hour: 10, duration: 2 },
    { projectId: 'p1', title: 'Initial Wireframes', daysFromNow: -14, hour: 14, duration: 3 },
    { projectId: 'p2', title: 'Requirements Review', daysFromNow: -16, hour: 11, duration: 2 },
    { projectId: 'p2', title: 'Architecture Planning', daysFromNow: -12, hour: 9, duration: 3 },
    { projectId: 'p3', title: 'Discovery Session', daysFromNow: -15, hour: 13, duration: 2 },
    { projectId: 'p3', title: 'Mood Board Review', daysFromNow: -10, hour: 15, duration: 1.5 },
    { projectId: 'p4', title: 'Creative Brief', daysFromNow: -13, hour: 10, duration: 1.5 },
    { projectId: 'p4', title: 'Script Draft', daysFromNow: -8, hour: 14, duration: 2 },
    { projectId: 'p5', title: 'Pre-Interview', daysFromNow: -17, hour: 11, duration: 1 },
    { projectId: 'p5', title: 'Location Scout', daysFromNow: -11, hour: 9, duration: 4 },
    { projectId: 'p6', title: 'Concept Pitch', daysFromNow: -14, hour: 16, duration: 1 },
    { projectId: 'p6', title: 'Talent Casting', daysFromNow: -9, hour: 10, duration: 3 },
    
    // Near past
    { projectId: 'p1', title: 'Stakeholder Review', daysFromNow: -5, hour: 11, duration: 2 },
    { projectId: 'p2', title: 'Sprint Review', daysFromNow: -3, hour: 14, duration: 1.5 },
    { projectId: 'p3', title: 'Color Studies', daysFromNow: -4, hour: 10, duration: 2 },
    { projectId: 'p5', title: 'B-Roll Shoot', daysFromNow: -2, hour: 8, duration: 6 },
    
    // Tomorrow and near future
    { projectId: 'p1', title: 'Client Call', daysFromNow: 1, hour: 10, duration: 1, location: 'Zoom Meeting', notes: 'Discuss timeline adjustments and next milestones.' },
    { projectId: 'p4', title: 'Storyboard Review', daysFromNow: 1, hour: 14, duration: 2, location: 'Studio 1', notes: 'Bring printed storyboards for markup.' },
    { projectId: 'p2', title: 'Code Review', daysFromNow: 2, hour: 11, duration: 1.5, location: 'Main Office', notes: 'Focus on authentication module.' },
    { projectId: 'p6', title: 'Pre-production Meeting', daysFromNow: 2, hour: 15, duration: 2, location: 'Conference Room A', notes: 'Finalize shot list and equipment needs.' },
    
    // Week ahead
    { projectId: 'p1', title: 'Wireframe Review', daysFromNow: 4, hour: 10, duration: 2, location: 'Google Meet', notes: 'Client will have stakeholders present.' },
    { projectId: 'p3', title: 'Brand Guidelines Draft', daysFromNow: 5, hour: 13, duration: 3, location: 'Main Office', notes: '' },
    { projectId: 'p2', title: 'Beta Testing', daysFromNow: 6, hour: 9, duration: 4, location: 'Remote', notes: 'Coordinate with QA team.' },
    { projectId: 'p5', title: 'Interview Day 1', daysFromNow: 7, hour: 10, duration: 5, location: 'On-site', notes: 'Arrive early for setup. Backup batteries charged.' },
    
    // Two weeks out
    { projectId: 'p1', title: 'Final Mockups', daysFromNow: 10, hour: 14, duration: 3 },
    { projectId: 'p4', title: 'Video Shoot Day 1', daysFromNow: 11, hour: 8, duration: 8, location: 'Client Office', notes: 'Full crew call. Catering arranged.' },
    { projectId: 'p2', title: 'Bug Fixes Sprint', daysFromNow: 12, hour: 10, duration: 4 },
    { projectId: 'p3', title: 'Asset Delivery', daysFromNow: 13, hour: 11, duration: 2 },
    { projectId: 'p6', title: 'Shoot Day', daysFromNow: 14, hour: 7, duration: 10, location: 'Studio 1', notes: 'Talent call time 6:30 AM.' },
    { projectId: 'p5', title: 'Interview Day 2', daysFromNow: 15, hour: 10, duration: 5, location: 'On-site', notes: '' },
    
    // Three weeks out
    { projectId: 'p1', title: 'Dev Handoff', daysFromNow: 18, hour: 11, duration: 2 },
    { projectId: 'p4', title: 'Post Production', daysFromNow: 19, hour: 10, duration: 6 },
    { projectId: 'p2', title: 'App Store Submit', daysFromNow: 20, hour: 15, duration: 1 },
    { projectId: 'p5', title: 'Rough Cut Review', daysFromNow: 21, hour: 14, duration: 3, location: 'Zoom Meeting', notes: 'Client feedback session.' },
    { projectId: 'p6', title: 'Edit Review', daysFromNow: 22, hour: 11, duration: 2 },
    { projectId: 'p3', title: 'Final Presentation', daysFromNow: 23, hour: 10, duration: 2, location: 'Client Office', notes: 'Bring printed brand books.' },
    
    // Personal events (Kawika)
    { projectId: 'personal-p1', title: 'Online Course Session', daysFromNow: 1, hour: 18, duration: 2, location: 'Remote', notes: 'Complete pre-reading before session.' },
    { projectId: 'personal-p1', title: 'Mentorship Call', daysFromNow: 5, hour: 17, duration: 1, location: 'Zoom Meeting', notes: '' },
    { projectId: 'personal-p2', title: 'Portfolio Review Time', daysFromNow: 3, hour: 19, duration: 2, location: '', notes: 'Focus on recent case studies.' },
    { projectId: 'personal-p2', title: 'Tax Prep Meeting', daysFromNow: 8, hour: 10, duration: 1, location: 'Accountant Office', notes: 'Bring Q3 and Q4 receipts.' },
    
    // Team events
    { projectId: 'team-p1', title: 'Weekly Standup', daysFromNow: 0, hour: 9, duration: 0.5, location: 'Main Office', notes: 'Quick sync on blockers and priorities.' },
    { projectId: 'team-p1', title: 'Weekly Standup', daysFromNow: 7, hour: 9, duration: 0.5, location: 'Main Office', notes: '' },
    { projectId: 'team-p1', title: 'Equipment Training', daysFromNow: 3, hour: 14, duration: 2, location: 'Studio 1', notes: 'Sony FX6 training session with John.' },
    { projectId: 'team-p2', title: 'New Lead Review', daysFromNow: 2, hour: 11, duration: 1, location: 'Conference Room A', notes: 'Review incoming RFPs.' },
    { projectId: 'team-p2', title: 'Q1 Planning Session', daysFromNow: 6, hour: 10, duration: 3, location: 'Main Office', notes: 'Bring capacity projections.' },
    { projectId: 'team-p1', title: 'Team Lunch', daysFromNow: 4, hour: 12, duration: 1.5, location: 'TBD', notes: 'Vote on restaurant by Wednesday.' },
  ];
  
  monthEvents.forEach((e, i) => {
    const start = new Date(now);
    start.setDate(start.getDate() + e.daysFromNow);
    start.setHours(e.hour, 0, 0, 0);
    const end = new Date(start.getTime() + e.duration * 60 * 60 * 1000);
    const createdBy = initialTeamMembers[i % initialTeamMembers.length].id;
    const attendees = generateAttendees(createdBy, i);
    const visibility = generateVisibility(createdBy, attendees, i);
    
    events.push({
      id: `e${events.length + 1}`,
      projectId: e.projectId,
      title: e.title,
      startTime: start,
      endTime: end,
      type: types[i % types.length],
      attendees: attendees,
      createdBy: createdBy,
      visibility: visibility,
      isCompleted: e.daysFromNow < -1,
      location: e.location || locations[i % locations.length],
      notes: e.notes !== undefined ? e.notes : sampleNotes[i % sampleNotes.length],
    });
  });
  
  return events;
};

// Generate sample tasks (reminders that can be checked off)
const generateTasks = () => {
  const now = new Date();
  const tasks = [];
  
  const sampleTaskNotes = [
    'Check the latest Figma file for updates.',
    'Coordinate with Nick before sending.',
    'Test on both iOS 16 and iOS 17.',
    'Include examples for each endpoint.',
    'Check with accounting for any outstanding items.',
    'Reference the mood board we approved.',
    'Export in SVG, PNG, and PDF formats.',
    'Call venue to confirm availability.',
    'Check their calendar for conflicts.',
    'Send calendar invite after confirming.',
    '',
    'Organize by date and scene.',
    'Check ASCAP and BMI catalogs.',
    'Weather backup needed.',
    'Include batteries, cables, and cards.',
    'Include any scope changes from last week.',
  ];
  
  const sampleTasks = [
    // Acme Corp tasks
    { clientId: 'c1', projectId: 'p1', title: 'Review homepage mockups', daysFromNow: 0, assignedTo: 't1', createdBy: 't1', notes: 'Check the latest Figma file for updates.', status: 'in-progress' },
    { clientId: 'c1', projectId: 'p1', title: 'Send wireframe feedback', daysFromNow: 1, assignedTo: 't2', createdBy: 't1', notes: 'Coordinate with Nick before sending.', status: 'todo' },
    { clientId: 'c1', projectId: 'p2', title: 'Test login flow on iOS', daysFromNow: 2, assignedTo: 't3', createdBy: 't2', notes: 'Test on both iOS 16 and iOS 17.', status: 'blocked', blockedReason: 'Waiting for staging environment' },
    { clientId: 'c1', projectId: 'p2', title: 'Update API documentation', daysFromNow: 3, assignedTo: 't2', createdBy: 't2', notes: 'Include examples for each endpoint.', status: 'todo' },
    { clientId: 'c1', projectId: null, title: 'Prepare invoice for December', daysFromNow: 5, assignedTo: 't1', createdBy: 't1', notes: 'Check with accounting for any outstanding items.', status: 'todo' },
    
    // TechStart tasks
    { clientId: 'c2', projectId: 'p3', title: 'Finalize color palette', daysFromNow: 0, assignedTo: 't1', createdBy: 't1', notes: 'Reference the mood board we approved.', status: 'urgent' },
    { clientId: 'c2', projectId: 'p3', title: 'Export logo variations', daysFromNow: 2, assignedTo: 't4', createdBy: 't1', notes: 'Export in SVG, PNG, and PDF formats.', status: 'in-progress' },
    { clientId: 'c2', projectId: 'p4', title: 'Book studio for shoot', daysFromNow: 4, assignedTo: 't3', createdBy: 't3', notes: 'Call venue to confirm availability.', status: 'on-hold', blockedReason: 'Budget approval pending' },
    { clientId: 'c2', projectId: 'p4', title: 'Confirm talent availability', daysFromNow: 3, assignedTo: 't3', createdBy: 't3', notes: 'Check their calendar for conflicts.', status: 'todo' },
    { clientId: 'c2', projectId: null, title: 'Schedule quarterly review', daysFromNow: 7, assignedTo: 't1', createdBy: 't1', notes: 'Send calendar invite after confirming.', status: 'todo' },
    
    // Global Media tasks
    { clientId: 'c3', projectId: 'p5', title: 'Transcribe interview notes', daysFromNow: 1, assignedTo: 't4', createdBy: 't2', notes: '', status: 'in-progress' },
    { clientId: 'c3', projectId: 'p5', title: 'Organize B-roll footage', daysFromNow: 2, assignedTo: 't4', createdBy: 't4', notes: 'Organize by date and scene.', status: 'todo' },
    { clientId: 'c3', projectId: 'p5', title: 'Review music licenses', daysFromNow: 6, assignedTo: 't2', createdBy: 't2', notes: 'Check ASCAP and BMI catalogs.', status: 'todo' },
    { clientId: 'c3', projectId: 'p6', title: 'Scout backup locations', daysFromNow: 3, assignedTo: 't3', createdBy: 't3', notes: 'Weather backup needed.', status: 'in-progress' },
    { clientId: 'c3', projectId: 'p6', title: 'Prep equipment checklist', daysFromNow: 5, assignedTo: 't4', createdBy: 't3', notes: 'Include batteries, cables, and cards.', status: 'todo' },
    { clientId: 'c3', projectId: null, title: 'Update project timeline', daysFromNow: 1, assignedTo: 't1', createdBy: 't1', notes: 'Include any scope changes from last week.', status: 'urgent' },
    
    // Personal tasks (Kawika only)
    { clientId: 'personal', projectId: 'personal-p1', title: 'Complete React course module 5', daysFromNow: 2, assignedTo: 't1', createdBy: 't1', notes: 'Focus on hooks and context API.', status: 'in-progress' },
    { clientId: 'personal', projectId: 'personal-p1', title: 'Read "Deep Work" chapter 3', daysFromNow: 4, assignedTo: 't1', createdBy: 't1', notes: '', status: 'todo' },
    { clientId: 'personal', projectId: 'personal-p2', title: 'Update portfolio website', daysFromNow: 7, assignedTo: 't1', createdBy: 't1', notes: 'Add recent case studies and update bio.', status: 'on-hold', blockedReason: 'Waiting for new headshots' },
    { clientId: 'personal', projectId: null, title: 'Schedule dentist appointment', daysFromNow: 3, assignedTo: 't1', createdBy: 't1', notes: 'Call Dr. Kim\'s office in the morning.', status: 'todo' },
    
    // Team tasks
    { clientId: 'team', projectId: 'team-p1', title: 'Review Q4 budget allocations', daysFromNow: 1, assignedTo: 't1', createdBy: 't1', notes: 'Compare with Q3 actuals.', status: 'in-progress' },
    { clientId: 'team', projectId: 'team-p1', title: 'Update equipment inventory', daysFromNow: 5, assignedTo: 't3', createdBy: 't1', notes: 'Include serial numbers for new gear.', status: 'todo' },
    { clientId: 'team', projectId: 'team-p2', title: 'Prepare pitch deck for new leads', daysFromNow: 3, assignedTo: 't2', createdBy: 't1', notes: 'Use the new template.', status: 'blocked', blockedReason: 'Need updated case studies' },
    { clientId: 'team', projectId: 'team-p2', title: 'Follow up with conference contacts', daysFromNow: 2, assignedTo: 't1', createdBy: 't1', notes: 'Send personalized emails to top 5 leads.', status: 'todo' },
    { clientId: 'team', projectId: null, title: 'Plan team holiday party', daysFromNow: 10, assignedTo: 't4', createdBy: 't1', notes: 'Survey team for date preferences.', status: 'todo' },
    
    // Past completed tasks
    { clientId: 'c1', projectId: 'p1', title: 'Set up project folder', daysFromNow: -5, assignedTo: 't1', createdBy: 't1', completed: true, notes: '', status: 'todo' },
    { clientId: 'c2', projectId: 'p3', title: 'Gather brand references', daysFromNow: -3, assignedTo: 't1', createdBy: 't1', completed: true, notes: '', status: 'todo' },
    { clientId: 'c3', projectId: 'p5', title: 'Confirm interview schedule', daysFromNow: -4, assignedTo: 't2', createdBy: 't2', completed: true, notes: '', status: 'todo' },
    { clientId: 'c1', projectId: 'p2', title: 'Review competitor apps', daysFromNow: -2, assignedTo: 't2', createdBy: 't2', completed: true, notes: '', status: 'todo' },
    { clientId: 'personal', projectId: 'personal-p1', title: 'Set up learning schedule', daysFromNow: -3, assignedTo: 't1', createdBy: 't1', completed: true, notes: '', status: 'todo' },
    { clientId: 'team', projectId: 'team-p1', title: 'Complete annual review forms', daysFromNow: -2, assignedTo: 't1', createdBy: 't1', completed: true, notes: '', status: 'todo' },
  ];
  
  sampleTasks.forEach((t, i) => {
    const dueDate = new Date(now);
    dueDate.setDate(dueDate.getDate() + t.daysFromNow);
    dueDate.setHours(17, 0, 0, 0); // Default due time 5pm
    
    tasks.push({
      id: `task${i + 1}`,
      clientId: t.clientId,
      projectId: t.projectId,
      title: t.title,
      dueDate: dueDate,
      assignedTo: t.assignedTo,
      createdBy: t.createdBy,
      isCompleted: t.completed || false,
      notes: t.notes || '',
      status: t.status || 'todo',
      blockedReason: t.blockedReason || '',
    });
  });
  
  return tasks;
};

// ==================== SAMPLE LISTS ====================
const generateLists = () => {
  const now = new Date();
  const lists = [];
  
  const sampleLists = [
    {
      clientId: 'c1',
      projectId: 'p1',
      title: 'Website Launch Checklist',
      daysFromNow: 7,
      createdBy: 't1',
      notes: 'All items must be completed before go-live.',
    },
    {
      clientId: 'c2',
      projectId: 'p3',
      title: 'Brand Guidelines Deliverables',
      daysFromNow: 10,
      createdBy: 't1',
      notes: 'Final brand package for client.',
    },
    {
      clientId: 'team',
      projectId: 'team-p1',
      title: 'Q4 Planning Tasks',
      daysFromNow: 14,
      createdBy: 't1',
      notes: '',
    },
    {
      clientId: 'personal',
      projectId: 'personal-p1',
      title: 'Course Completion Checklist',
      daysFromNow: 30,
      createdBy: 't1',
      notes: 'Track progress through React course.',
    },
  ];
  
  sampleLists.forEach((l, i) => {
    const dueDate = new Date(now);
    dueDate.setDate(dueDate.getDate() + l.daysFromNow);
    dueDate.setHours(17, 0, 0, 0);
    
    lists.push({
      id: `list${i + 1}`,
      clientId: l.clientId,
      projectId: l.projectId,
      title: l.title,
      dueDate: dueDate,
      createdBy: l.createdBy,
      createdAt: new Date(now.getTime() - (i * 2 * 24 * 60 * 60 * 1000)), // Stagger creation dates
      notes: l.notes || '',
    });
  });
  
  return lists;
};

// Generate tasks with some belonging to lists
const generateListTasks = () => {
  const now = new Date();
  const listTasks = [];
  
  // Website Launch Checklist tasks (list1)
  const websiteTasks = [
    { title: 'Final content review', isCompleted: true },
    { title: 'Cross-browser testing', isCompleted: true },
    { title: 'Mobile responsiveness check', isCompleted: true },
    { title: 'SEO meta tags verification', isCompleted: false },
    { title: 'Performance optimization', isCompleted: false },
    { title: 'SSL certificate setup', isCompleted: false },
    { title: 'Analytics integration', isCompleted: false },
    { title: 'Client final approval', isCompleted: false },
  ];
  
  websiteTasks.forEach((t, i) => {
    listTasks.push({
      id: `listtask-1-${i}`,
      listId: 'list1',
      listOrder: i,
      clientId: 'c1',
      projectId: 'p1',
      title: t.title,
      dueDate: null, // Inherits from list
      assignedTo: 't1',
      createdBy: 't1',
      isCompleted: t.isCompleted,
      notes: '',
    });
  });
  
  // Brand Guidelines tasks (list2)
  const brandTasks = [
    { title: 'Primary logo variations', isCompleted: true },
    { title: 'Color palette documentation', isCompleted: true },
    { title: 'Typography guidelines', isCompleted: false },
    { title: 'Icon set', isCompleted: false },
    { title: 'Usage examples', isCompleted: false },
  ];
  
  brandTasks.forEach((t, i) => {
    listTasks.push({
      id: `listtask-2-${i}`,
      listId: 'list2',
      listOrder: i,
      clientId: 'c2',
      projectId: 'p3',
      title: t.title,
      dueDate: null,
      assignedTo: 't1',
      createdBy: 't1',
      isCompleted: t.isCompleted,
      notes: '',
    });
  });
  
  // Q4 Planning tasks (list3)
  const q4Tasks = [
    { title: 'Review Q3 metrics', isCompleted: true },
    { title: 'Set Q4 goals', isCompleted: false },
    { title: 'Budget allocation', isCompleted: false },
    { title: 'Team capacity planning', isCompleted: false },
  ];
  
  q4Tasks.forEach((t, i) => {
    listTasks.push({
      id: `listtask-3-${i}`,
      listId: 'list3',
      listOrder: i,
      clientId: 'team',
      projectId: 'team-p1',
      title: t.title,
      dueDate: null,
      assignedTo: 't1',
      createdBy: 't1',
      isCompleted: t.isCompleted,
      notes: '',
    });
  });
  
  // Course Completion tasks (list4)
  const courseTasks = [
    { title: 'Module 1: Fundamentals', isCompleted: true },
    { title: 'Module 2: Components', isCompleted: true },
    { title: 'Module 3: State Management', isCompleted: true },
    { title: 'Module 4: Hooks', isCompleted: false },
    { title: 'Module 5: Context API', isCompleted: false },
    { title: 'Module 6: Performance', isCompleted: false },
    { title: 'Final Project', isCompleted: false },
  ];
  
  courseTasks.forEach((t, i) => {
    listTasks.push({
      id: `listtask-4-${i}`,
      listId: 'list4',
      listOrder: i,
      clientId: 'personal',
      projectId: 'personal-p1',
      title: t.title,
      dueDate: null,
      assignedTo: 't1',
      createdBy: 't1',
      isCompleted: t.isCompleted,
      notes: '',
    });
  });
  
  return listTasks;
};

// Generate sample notes/threads
const generateNotes = () => {
  const now = new Date();
  
  return [
    // Acme Corp notes (client-level)
    {
      id: 'note1',
      clientId: 'c1',
      projectId: null,
      authorId: 't1',
      content: 'Had a call with their CEO today. They want to push the launch date up by 2 weeks. We need to discuss feasibility with the team.',
      createdAt: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000),
      replies: [
        {
          id: 'reply1',
          authorId: 't2',
          content: 'I think we can make it work if we cut the animations from phase 1. We can add them in a fast-follow.',
          createdAt: new Date(now.getTime() - 1.5 * 24 * 60 * 60 * 1000),
        },
        {
          id: 'reply2',
          authorId: 't3',
          content: 'Agreed. The core functionality is solid. Let me update the timeline.',
          createdAt: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000),
        },
        {
          id: 'reply3',
          authorId: 't1',
          content: 'Perfect. I\'ll let them know we can do it. Thanks team!',
          createdAt: new Date(now.getTime() - 12 * 60 * 60 * 1000),
        }
      ]
    },
    {
      id: 'note2',
      clientId: 'c1',
      projectId: null,
      authorId: 't2',
      content: 'FYI - Their dev team prefers REST over GraphQL. We should adjust our API approach for the mobile app.',
      createdAt: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000),
      replies: [
        {
          id: 'reply4',
          authorId: 't1',
          content: 'Good to know. Can you document the endpoints we\'ll need?',
          createdAt: new Date(now.getTime() - 4.5 * 24 * 60 * 60 * 1000),
        }
      ]
    },
    {
      id: 'note3',
      clientId: 'c1',
      projectId: null,
      authorId: 't4',
      content: 'Billing contact changed - new person is Sarah Chen (sarah.chen@acmecorp.com). Updated in our system.',
      createdAt: new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000),
      replies: []
    },
    // Acme Corp - Website Redesign project notes
    {
      id: 'note-p1-1',
      clientId: 'c1',
      projectId: 'p1',
      authorId: 't2',
      content: 'Wireframes approved! Client loved the hero section concept. Moving to high-fidelity mockups next week.',
      createdAt: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000),
      replies: [
        {
          id: 'reply-p1-1',
          authorId: 't4',
          content: 'Great! I\'ll start on the design system components.',
          createdAt: new Date(now.getTime() - 20 * 60 * 60 * 1000),
        }
      ]
    },
    {
      id: 'note-p1-2',
      clientId: 'c1',
      projectId: 'p1',
      authorId: 't1',
      content: 'Need to finalize the navigation structure. Client wants mega-menus for the product section.',
      createdAt: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000),
      replies: []
    },
    // Acme Corp - Mobile App project notes
    {
      id: 'note-p2-1',
      clientId: 'c1',
      projectId: 'p2',
      authorId: 't2',
      content: 'Authentication flow is complete. Using OAuth 2.0 with their existing SSO provider.',
      createdAt: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000),
      replies: []
    },
    
    // TechStart notes (client-level)
    {
      id: 'note4',
      clientId: 'c2',
      projectId: null,
      authorId: 't1',
      content: 'Brand direction meeting went well. They loved the bold color approach. Moving forward with Option B (the teal/coral palette).',
      createdAt: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000),
      replies: [
        {
          id: 'reply5',
          authorId: 't4',
          content: 'Great news! I\'ll start on the extended palette and typography pairings.',
          createdAt: new Date(now.getTime() - 2.5 * 24 * 60 * 60 * 1000),
        }
      ]
    },
    {
      id: 'note5',
      clientId: 'c2',
      projectId: null,
      authorId: 't3',
      content: 'Video shoot location confirmed for the 15th. It\'s the rooftop space downtown. Need to coordinate equipment transport.',
      createdAt: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000),
      replies: []
    },
    // TechStart - Brand Identity project notes
    {
      id: 'note-p3-1',
      clientId: 'c2',
      projectId: 'p3',
      authorId: 't4',
      content: 'Logo variations complete. Primary, secondary, and icon versions ready for review.',
      createdAt: new Date(now.getTime() - 1.5 * 24 * 60 * 60 * 1000),
      replies: []
    },
    
    // Global Media notes (client-level)
    {
      id: 'note6',
      clientId: 'c3',
      projectId: null,
      authorId: 't2',
      content: 'Documentary interview with Dr. Martinez rescheduled to next Tuesday. She had a conflict with the original date.',
      createdAt: new Date(now.getTime() - 4 * 24 * 60 * 60 * 1000),
      replies: [
        {
          id: 'reply6',
          authorId: 't4',
          content: 'I\'ll adjust the editing schedule. We should still make the delivery date.',
          createdAt: new Date(now.getTime() - 3.5 * 24 * 60 * 60 * 1000),
        },
        {
          id: 'reply7',
          authorId: 't3',
          content: 'Camera crew is confirmed for Tuesday. All set on my end.',
          createdAt: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000),
        }
      ]
    },
    {
      id: 'note7',
      clientId: 'c3',
      projectId: null,
      authorId: 't1',
      content: 'They mentioned potentially expanding scope to include a 30-second cut for social. Waiting on budget approval from their side.',
      createdAt: new Date(now.getTime() - 6 * 24 * 60 * 60 * 1000),
      replies: []
    },
    
    // Personal notes (Kawika only)
    {
      id: 'note8',
      clientId: 'personal',
      projectId: null,
      authorId: 't1',
      content: 'Ideas for portfolio redesign:\n- Add case studies section\n- Include video showreel\n- Testimonials from recent clients\n- Blog section for thought leadership',
      createdAt: new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000),
      replies: []
    },
    {
      id: 'note9',
      clientId: 'personal',
      projectId: null,
      authorId: 't1',
      content: 'Remember to follow up with Mike from the conference about potential collaboration on the AI video project.',
      createdAt: new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000),
      replies: []
    },
    
    // Team notes
    {
      id: 'note10',
      clientId: 'team',
      projectId: null,
      authorId: 't1',
      content: 'Reminder: We\'re shifting to bi-weekly sprints starting next month. Please review the new process doc I shared.',
      createdAt: new Date(now.getTime() - 1 * 24 * 60 * 60 * 1000),
      replies: [
        {
          id: 'reply8',
          authorId: 't2',
          content: 'Reviewed! I like the new retrospective format. Should help us iterate faster.',
          createdAt: new Date(now.getTime() - 18 * 60 * 60 * 1000),
        },
        {
          id: 'reply9',
          authorId: 't3',
          content: 'Same here. The capacity planning section is really helpful.',
          createdAt: new Date(now.getTime() - 12 * 60 * 60 * 1000),
        }
      ]
    },
    {
      id: 'note11',
      clientId: 'team',
      projectId: null,
      authorId: 't3',
      content: 'New camera gear arrived! The Sony FX6 is set up and ready. Let me know if you need training on it.',
      createdAt: new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000),
      replies: [
        {
          id: 'reply10',
          authorId: 't4',
          content: 'Would love a walkthrough when you have time!',
          createdAt: new Date(now.getTime() - 2.5 * 24 * 60 * 60 * 1000),
        }
      ]
    },
    {
      id: 'note12',
      clientId: 'team',
      projectId: null,
      authorId: 't2',
      content: 'Heads up: Office will be closed Dec 23-26 for the holidays. Make sure any urgent client deliverables are handled before then.',
      createdAt: new Date(now.getTime() - 4 * 24 * 60 * 60 * 1000),
      replies: []
    }
  ];
};

// ==================== UTILITIES ====================
const formatTime = (date) => {
  if (!date) return '';
  return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
};

const formatRelativeTime = (dateInput) => {
  const date = new Date(dateInput);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
};

// ==================== TASK STATUS SYSTEM ====================
const taskStatusConfig = {
  'todo': { label: 'To Do', icon: '○', color: '#71717a' },
  'in-progress': { label: 'In Progress', icon: '◐', color: '#3b82f6' },
  'blocked': { label: 'Blocked', icon: '⊘', color: '#ef4444' },
  'on-hold': { label: 'On Hold', icon: '⏸', color: '#f97316' },
  'urgent': { label: 'Urgent', icon: '⚡', color: '#ef4444' },
};

// Check if task is due within 48 hours (or overdue)
const isDueSoon = (task) => {
  if (!task.dueDate) return false;
  const now = new Date();
  const dueDate = new Date(task.dueDate);
  const hoursUntilDue = (dueDate - now) / (1000 * 60 * 60);
  return hoursUntilDue <= 48;
};

// Get status badge info for display
// Returns { label, icon, color, bgColor } or null if no badge should show
const getTaskStatusBadge = (task) => {
  if (!task) return null;
  
  // Completed tasks always show green
  if (task.isCompleted) {
    return { 
      label: 'Completed', 
      icon: '✓', 
      color: '#22c55e', 
      bgColor: 'rgba(34, 197, 94, 0.15)' 
    };
  }
  
  const status = task.status || 'todo';
  const dueSoon = isDueSoon(task);
  const isOverdue = task.dueDate && new Date(task.dueDate) < new Date();
  
  // Urgent - always red
  if (status === 'urgent') {
    return { 
      label: '⚡ Urgent', 
      color: '#ef4444', 
      bgColor: 'rgba(239, 68, 68, 0.15)' 
    };
  }
  
  // Blocked - always red
  if (status === 'blocked') {
    return { 
      label: '⊘ Blocked', 
      color: '#ef4444', 
      bgColor: 'rgba(239, 68, 68, 0.15)' 
    };
  }
  
  // Overdue - red (any status except completed, on-hold)
  if (isOverdue && status !== 'on-hold') {
    return { 
      label: 'Overdue', 
      color: '#ef4444', 
      bgColor: 'rgba(239, 68, 68, 0.15)' 
    };
  }
  
  // On Hold - always orange (not affected by due date)
  if (status === 'on-hold') {
    return { 
      label: '⏸ On Hold', 
      color: '#f97316', 
      bgColor: 'rgba(249, 115, 22, 0.15)' 
    };
  }
  
  // In Progress - blue normally, red if due soon
  if (status === 'in-progress') {
    if (dueSoon) {
      return { 
        label: '◐ Due Soon', 
        color: '#ef4444', 
        bgColor: 'rgba(239, 68, 68, 0.15)' 
      };
    }
    return { 
      label: '◐ In Progress', 
      color: '#3b82f6', 
      bgColor: 'rgba(59, 130, 246, 0.15)' 
    };
  }
  
  // To Do - no badge normally, red if due soon
  if (status === 'todo' || !status) {
    if (dueSoon) {
      return { 
        label: 'Due Soon', 
        color: '#ef4444', 
        bgColor: 'rgba(239, 68, 68, 0.15)' 
      };
    }
    return null; // No badge for regular to-do items
  }
  
  return null;
};

// ==================== CONNECTION INDICATOR ====================
function ConnectionIndicator() {
  const [status, setStatus] = React.useState('connecting');

  React.useEffect(() => {
    const checkStatus = () => {
      const newStatus = window.__realtimeStatus || 'connecting';
      setStatus(newStatus);
    };

    checkStatus();
    const interval = setInterval(checkStatus, 500);
    return () => clearInterval(interval);
  }, []);

  if (status === 'connected') return null;

  const message =
    status === 'connecting' ? 'Connecting...' :
    status === 'reconnecting' ? 'Reconnecting...' :
    status === 'error' ? 'Connection lost' : '';

  return (
    <div className="connection-indicator visible">
      <span className={'connection-indicator-dot ' + status}></span>
      <span>{message}</span>
    </div>
  );
}

// ==================== MAIN APP ====================
function ProjectManagementApp({ currentTeamMember, onSignOut }) {
  // Data loading state
  const [dataLoading, setDataLoading] = React.useState(true);
  const [clients, setClients] = React.useState([]);
  const [internal, setInternal] = React.useState({
    personal: null,
    team: null
  });
  const [events, setEvents] = React.useState([]);
  const [lists, setLists] = React.useState([]);
  const [tasks, setTasks] = React.useState([]);
  const [notes, setNotes] = React.useState([]);
  const [teamMembers, setTeamMembers] = React.useState([]);
  const [activeView, setActiveView] = React.useState('timeline');
  const [selectedClient, setSelectedClient] = React.useState(null);
  const [sidebarCollapsed, setSidebarCollapsed] = React.useState(() => {
    // Default to collapsed on small screens
    if (typeof window !== 'undefined') {
      return window.innerWidth < 900;
    }
    return false;
  });
  // Use authenticated user
  const currentUser = {
    id: currentTeamMember.id,
    name: currentTeamMember.name,
    color: currentTeamMember.color
  };
  const [showAddClient, setShowAddClient] = React.useState(false);
  const [showAddProject, setShowAddProject] = React.useState(false);
  const [selectedEvent, setSelectedEvent] = React.useState(null);
  const [selectedTask, setSelectedTask] = React.useState(null);
  const [selectedList, setSelectedList] = React.useState(null);
  
  // Notifications system
  const [notifications, setNotifications] = React.useState([]);
  const [showNotifications, setShowNotifications] = React.useState(false);

  // Webhook configuration (persisted in localStorage)
  const [webhookUrl, setWebhookUrl] = React.useState(() => {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('iapm_webhook_url') || '';
    }
    return '';
  });
  const [showWebhookSettings, setShowWebhookSettings] = React.useState(false);

  // Save webhook URL to localStorage when it changes
  React.useEffect(() => {
    if (typeof window !== 'undefined') {
      localStorage.setItem('iapm_webhook_url', webhookUrl);
    }
  }, [webhookUrl]);

  // Send notification to webhook endpoint
  const sendNotificationWebhook = async (notification, additionalContext = {}) => {
    if (!webhookUrl) return; // No webhook configured

    const actor = teamMembers.find(m => m.id === notification.actorId);
    const recipient = teamMembers.find(m => m.id === notification.recipientId);

    // Build rich payload for N8N
    const payload = {
      // Core notification data
      type: notification.type,
      message: notification.message,
      timestamp: notification.createdAt || new Date().toISOString(),

      // Actor (who triggered the notification)
      actor: {
        id: notification.actorId,
        name: actor?.name || 'Unknown',
        email: actor?.email || null,
        color: actor?.color || '#6366f1'
      },

      // Recipient (who receives the notification)
      recipient: {
        id: notification.recipientId,
        name: recipient?.name || 'Unknown',
        email: recipient?.email || null,
        color: recipient?.color || '#6366f1'
      },

      // Entity details (what the notification is about)
      entity: {
        type: notification.entityType,
        id: notification.entityId,
        title: notification.entityTitle,
        ...additionalContext
      },

      // App metadata
      source: 'iapm',
      version: '1.0'
    };

    try {
      await fetch(webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
        mode: 'no-cors' // Allow cross-origin requests to N8N
      });
      console.log('Webhook sent:', notification.type);
    } catch (err) {
      console.error('Webhook error:', err);
      // Don't block the app if webhook fails
    }
  };

  // Generate notification from activity
  const createNotification = (type, actorId, recipientId, entityType, entityId, entityTitle, extraData = {}) => {
    if (actorId === recipientId) return null; // Don't notify yourself
    
    const actor = teamMembers.find(m => m.id === actorId);
    const actorName = actor?.name || 'Someone';
    
    let message = '';
    switch (type) {
      case 'task_assigned':
        message = `${actorName} assigned you to "${entityTitle}"`;
        break;
      case 'task_completed':
        message = `${actorName} completed "${entityTitle}"`;
        break;
      case 'event_attendee_added':
        message = `${actorName} added you to "${entityTitle}"`;
        break;
      case 'mentioned':
        message = `${actorName} mentioned you in "${entityTitle}"`;
        break;
      case 'reply':
        message = `${actorName} replied to your note in "${entityTitle}"`;
        break;
      case 'thread_reply':
        message = `${actorName} replied in a thread you're in on "${entityTitle}"`;
        break;
      default:
        message = `${actorName} updated "${entityTitle}"`;
    }
    
    return {
      id: `notif_${Date.now()}_${recipientId}`,
      type,
      recipientId,
      actorId,
      entityType,
      entityId,
      entityTitle,
      message,
      read: false,
      createdAt: new Date().toISOString(),
      ...extraData
    };
  };
  
  // Add notification(s)
  const addNotification = async (notification) => {
    if (!notification) return;

    const dbNotif = {
      type: notification.type,
      recipient_id: notification.recipientId,
      actor_id: notification.actorId,
      entity_type: notification.entityType,
      entity_id: notification.entityId,
      entity_title: notification.entityTitle,
      message: notification.message,
      read: false
    };

    const { data: newNotif, error } = await window.supabase
      .from('notifications')
      .insert(dbNotif)
      .select()
      .single();

    if (error) {
      console.error('Error adding notification:', error);
      return;
    }

    const localNotif = {
      id: newNotif.id,
      type: newNotif.type,
      recipientId: newNotif.recipient_id,
      actorId: newNotif.actor_id,
      entityType: newNotif.entity_type,
      entityId: newNotif.entity_id,
      entityTitle: newNotif.entity_title,
      message: newNotif.message,
      read: newNotif.read,
      createdAt: newNotif.created_at
    };

    setNotifications(prev => [localNotif, ...prev]);

    // Send to webhook
    sendNotificationWebhook(localNotif);
  };

  const addNotifications = async (notifs) => {
    const validNotifs = notifs.filter(Boolean);
    if (validNotifs.length === 0) return;

    const dbNotifs = validNotifs.map(n => ({
      type: n.type,
      recipient_id: n.recipientId,
      actor_id: n.actorId,
      entity_type: n.entityType,
      entity_id: n.entityId,
      entity_title: n.entityTitle,
      message: n.message,
      read: false
    }));

    const { data: newNotifs, error } = await window.supabase
      .from('notifications')
      .insert(dbNotifs)
      .select();

    if (error) {
      console.error('Error adding notifications:', error);
      return;
    }

    const localNotifs = newNotifs.map(n => ({
      id: n.id,
      type: n.type,
      recipientId: n.recipient_id,
      actorId: n.actor_id,
      entityType: n.entity_type,
      entityId: n.entity_id,
      entityTitle: n.entity_title,
      message: n.message,
      read: n.read,
      createdAt: n.created_at
    }));

    setNotifications(prev => [...localNotifs, ...prev]);

    // Send each to webhook
    localNotifs.forEach(notif => sendNotificationWebhook(notif));
  };

  // Mark notification as read
  const markNotificationRead = async (notificationId) => {
    const { error } = await window.supabase
      .from('notifications')
      .update({ read: true })
      .eq('id', notificationId);

    if (error) {
      console.error('Error marking notification read:', error);
      return;
    }

    setNotifications(prev => prev.map(n =>
      n.id === notificationId ? { ...n, read: true } : n
    ));
  };

  // Mark all as read
  const markAllNotificationsRead = async () => {
    const { error } = await window.supabase
      .from('notifications')
      .update({ read: true })
      .eq('recipient_id', currentUser.id)
      .eq('read', false);

    if (error) {
      console.error('Error marking all notifications read:', error);
      return;
    }

    setNotifications(prev => prev.map(n => ({ ...n, read: true })));
  };
  
  // Get unread count for current user
  const getUnreadCount = () => {
    return notifications.filter(n => n.recipientId === currentUser?.id && !n.read).length;
  };
  
  // Get notifications for current user
  const getUserNotifications = () => {
    return notifications
      .filter(n => n.recipientId === currentUser?.id)
      .slice(0, 20); // Limit to 20 most recent
  };

  // Load data from Supabase
  React.useEffect(() => {
    const loadData = async () => {
      try {
        // Load all clients with their projects
        const { data: allClients, error: clientsError } = await supabase
          .from('clients')
          .select(`
            *,
            projects (*)
          `)
          .order('created_at', { ascending: true });

        if (clientsError) throw clientsError;

        // Separate internal spaces from regular clients
        const regularClients = [];
        let personalSpace = null;
        let teamSpace = null;

        allClients?.forEach(client => {
          // Transform projects array for app compatibility
          const clientWithProjects = {
            ...client,
            projects: client.projects || []
          };

          if (client.is_personal && client.owner_id === currentTeamMember.id) {
            personalSpace = clientWithProjects;
          } else if (client.is_team) {
            teamSpace = clientWithProjects;
          } else if (!client.is_internal) {
            regularClients.push(clientWithProjects);
          }
        });

        // If no team space exists, create one
        if (!teamSpace) {
          const { data: newTeam, error: teamError } = await supabase
            .from('clients')
            .insert({
              name: 'Team',
              color: '#0ea5e9',
              details: 'Shared team workspace for internal projects, meetings, and collaboration.',
              is_internal: true,
              is_team: true
            })
            .select(`*, projects (*)`)
            .single();

          if (!teamError && newTeam) {
            teamSpace = { ...newTeam, projects: newTeam.projects || [] };
          }
        }

        setClients(regularClients);
        setInternal({
          personal: personalSpace,
          team: teamSpace
        });

        // Load team members
        const { data: members, error: membersError } = await supabase
          .from('team_members')
          .select('*')
          .order('created_at', { ascending: true });

        if (membersError) throw membersError;
        setTeamMembers(members || []);

        // Load lists
        const { data: allLists, error: listsError } = await supabase
          .from('lists')
          .select('*')
          .order('created_at', { ascending: true });

        if (listsError) throw listsError;

        // Transform lists to match app structure
        const transformedLists = (allLists || []).map(list => ({
          ...list,
          clientId: list.client_id,
          projectId: list.project_id,
          dueDate: list.due_date ? new Date(list.due_date) : null,
          createdBy: list.created_by,
          createdAt: new Date(list.created_at)
        }));
        setLists(transformedLists);

        // Load tasks
        const { data: allTasks, error: tasksError } = await supabase
          .from('tasks')
          .select('*')
          .order('created_at', { ascending: true });

        if (tasksError) throw tasksError;

        // Transform tasks to match app structure
        const transformedTasks = (allTasks || []).map(task => ({
          ...task,
          clientId: task.client_id,
          projectId: task.project_id,
          listId: task.list_id,
          listOrder: task.list_order,
          dueDate: task.due_date ? new Date(task.due_date) : null,
          assignedTo: task.assigned_to,
          createdBy: task.created_by,
          isCompleted: task.is_completed,
          blockedReason: task.blocked_reason || ''
        }));
        setTasks(transformedTasks);

        // Load events with attendees
        const { data: allEvents, error: eventsError } = await supabase
          .from('events')
          .select(`
            *,
            event_attendees (team_member_id)
          `)
          .order('start_time', { ascending: true });

        if (eventsError) throw eventsError;

        // Transform events to match app structure
        const transformedEvents = (allEvents || []).map(event => ({
          ...event,
          startTime: new Date(event.start_time),
          endTime: event.end_time ? new Date(event.end_time) : null,
          allDay: event.all_day,
          projectId: event.project_id,
          clientId: event.client_id,
          isCompleted: event.is_completed,
          attendees: (event.event_attendees || []).map(a => a.team_member_id)
        }));
        setEvents(transformedEvents);

        // Load notes with replies
        const { data: allNotes, error: notesError } = await supabase
          .from('notes')
          .select(`
            *,
            note_replies (*)
          `)
          .order('created_at', { ascending: false });

        if (notesError) throw notesError;

        // Transform notes to match app structure
        const transformedNotes = (allNotes || []).map(note => ({
          id: note.id,
          clientId: note.client_id,
          projectId: note.project_id,
          authorId: note.author_id,
          content: note.content,
          mentions: note.mentions || [],
          createdAt: new Date(note.created_at),
          replies: (note.note_replies || []).map(reply => ({
            id: reply.id,
            authorId: reply.author_id,
            content: reply.content,
            mentions: reply.mentions || [],
            createdAt: new Date(reply.created_at)
          })).sort((a, b) => a.createdAt - b.createdAt)
        }));
        setNotes(transformedNotes);

        // Load notifications for current user
        const { data: allNotifications, error: notificationsError } = await supabase
          .from('notifications')
          .select('*')
          .eq('recipient_id', currentTeamMember.id)
          .order('created_at', { ascending: false })
          .limit(50);

        if (notificationsError) throw notificationsError;

        // Transform notifications to match app structure
        const transformedNotifications = (allNotifications || []).map(n => ({
          id: n.id,
          type: n.type,
          recipientId: n.recipient_id,
          actorId: n.actor_id,
          entityType: n.entity_type,
          entityId: n.entity_id,
          entityTitle: n.entity_title,
          message: n.message,
          read: n.read,
          createdAt: n.created_at
        }));
        setNotifications(transformedNotifications);

      } catch (err) {
        console.error('Error loading data:', err);
      } finally {
        setDataLoading(false);
      }
    };

    loadData();
  }, [currentTeamMember.id]);

  // Supabase Realtime subscriptions for live updates
  React.useEffect(() => {
    if (!currentTeamMember?.id) return;

    const supabase = window.supabase;
    const retryTimeouts = new Map(); // Track retry timeouts for cleanup
    const channelStatuses = new Map(); // Track status of each channel
    const totalChannels = 9; // Number of subscription channels

    // Update overall realtime status based on individual channel statuses
    const updateOverallStatus = () => {
      const statuses = Array.from(channelStatuses.values());
      const connectedCount = statuses.filter(s => s === 'connected').length;
      const errorCount = statuses.filter(s => s === 'error').length;
      const reconnectingCount = statuses.filter(s => s === 'reconnecting').length;

      if (connectedCount === totalChannels) {
        window.__realtimeStatus = 'connected';
      } else if (errorCount > 0) {
        window.__realtimeStatus = 'error';
      } else if (reconnectingCount > 0) {
        window.__realtimeStatus = 'reconnecting';
      } else {
        window.__realtimeStatus = 'connecting';
      }
    };

    // Helper to handle subscription status and retry on errors
    const handleSubscriptionStatus = (channelName, channel, status, retryCount = 0) => {
      console.log(`[Realtime] ${channelName} subscription status:`, status);

      if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
        const maxRetries = 5;
        if (retryCount < maxRetries) {
          channelStatuses.set(channelName, 'reconnecting');
          updateOverallStatus();

          const delay = Math.min(1000 * Math.pow(2, retryCount), 30000);
          console.log(`[Realtime] ${channelName} error, retrying in ${delay}ms (attempt ${retryCount + 1}/${maxRetries})`);

          const timeoutId = setTimeout(() => {
            channel.subscribe((newStatus) => {
              handleSubscriptionStatus(channelName, channel, newStatus, retryCount + 1);
            });
          }, delay);
          retryTimeouts.set(channelName, timeoutId);
        } else {
          console.error(`[Realtime] ${channelName} failed after ${maxRetries} retries`);
          channelStatuses.set(channelName, 'error');
          updateOverallStatus();
        }
      } else if (status === 'SUBSCRIBED') {
        channelStatuses.set(channelName, 'connected');
        updateOverallStatus();

        // Clear any pending retry timeout on successful subscription
        if (retryTimeouts.has(channelName)) {
          clearTimeout(retryTimeouts.get(channelName));
          retryTimeouts.delete(channelName);
        }
      }
    };

    // Helper to transform snake_case to camelCase for tasks
    const transformTask = (task) => ({
      ...task,
      clientId: task.client_id,
      projectId: task.project_id,
      listId: task.list_id,
      listOrder: task.list_order,
      dueDate: task.due_date ? new Date(task.due_date) : null,
      assignedTo: task.assigned_to,
      createdBy: task.created_by,
      isCompleted: task.is_completed,
      blockedReason: task.blocked_reason || ''
    });

    // Helper to transform events
    const transformEvent = (event) => ({
      ...event,
      startTime: new Date(event.start_time),
      endTime: event.end_time ? new Date(event.end_time) : null,
      allDay: event.all_day,
      projectId: event.project_id,
      clientId: event.client_id,
      isCompleted: event.is_completed,
      attendees: [] // Will be loaded separately if needed
    });

    // Helper to transform lists
    const transformList = (list) => ({
      ...list,
      clientId: list.client_id,
      projectId: list.project_id,
      dueDate: list.due_date ? new Date(list.due_date) : null,
      createdBy: list.created_by,
      createdAt: new Date(list.created_at)
    });

    // Helper to transform notes
    const transformNote = (note) => ({
      id: note.id,
      clientId: note.client_id,
      projectId: note.project_id,
      authorId: note.author_id,
      content: note.content,
      mentions: note.mentions || [],
      createdAt: new Date(note.created_at),
      replies: []
    });

    // Helper to transform notifications
    const transformNotification = (n) => ({
      id: n.id,
      type: n.type,
      recipientId: n.recipient_id,
      actorId: n.actor_id,
      entityType: n.entity_type,
      entityId: n.entity_id,
      entityTitle: n.entity_title,
      message: n.message,
      read: n.read,
      createdAt: n.created_at
    });

    // Subscribe to tasks
    const tasksChannel = supabase
      .channel('tasks-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, (payload) => {
        console.log('[Realtime] Task change:', payload.eventType, payload.new?.id || payload.old?.id);
        if (payload.eventType === 'INSERT') {
          // Only add if not already in state (prevents duplicates from local add + realtime)
          setTasks(prev => {
            if (prev.some(t => t.id === payload.new.id)) {
              console.log('[Realtime] Task already exists, skipping duplicate:', payload.new.id);
              return prev;
            }
            return [...prev, transformTask(payload.new)];
          });
        } else if (payload.eventType === 'UPDATE') {
          setTasks(prev => prev.map(t => t.id === payload.new.id ? transformTask(payload.new) : t));
        } else if (payload.eventType === 'DELETE') {
          setTasks(prev => prev.filter(t => t.id !== payload.old.id));
        }
      })
      .subscribe((status) => handleSubscriptionStatus('Tasks', tasksChannel, status));

    // Subscribe to events
    const eventsChannel = supabase
      .channel('events-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'events' }, async (payload) => {
        console.log('[Realtime] Event change:', payload.eventType, payload.new?.id || payload.old?.id);
        if (payload.eventType === 'INSERT') {
          // Fetch attendees for new event
          const { data: attendees } = await supabase
            .from('event_attendees')
            .select('team_member_id')
            .eq('event_id', payload.new.id);
          const event = transformEvent(payload.new);
          event.attendees = (attendees || []).map(a => a.team_member_id);
          // Only add if not already in state (prevents duplicates from local add + realtime)
          setEvents(prev => {
            if (prev.some(e => e.id === event.id)) {
              console.log('[Realtime] Event already exists, skipping duplicate:', event.id);
              return prev;
            }
            return [...prev, event];
          });
        } else if (payload.eventType === 'UPDATE') {
          setEvents(prev => prev.map(e => {
            if (e.id === payload.new.id) {
              return { ...transformEvent(payload.new), attendees: e.attendees };
            }
            return e;
          }));
        } else if (payload.eventType === 'DELETE') {
          setEvents(prev => prev.filter(e => e.id !== payload.old.id));
        }
      })
      .subscribe((status) => handleSubscriptionStatus('Events', eventsChannel, status));

    // Subscribe to event_attendees for attendee changes
    const attendeesChannel = supabase
      .channel('attendees-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'event_attendees' }, async (payload) => {
        // Refetch attendees for the affected event
        const eventId = payload.new?.event_id || payload.old?.event_id;
        if (eventId) {
          const { data: attendees } = await supabase
            .from('event_attendees')
            .select('team_member_id')
            .eq('event_id', eventId);
          setEvents(prev => prev.map(e => {
            if (e.id === eventId) {
              return { ...e, attendees: (attendees || []).map(a => a.team_member_id) };
            }
            return e;
          }));
        }
      })
      .subscribe((status) => handleSubscriptionStatus('Attendees', attendeesChannel, status));

    // Subscribe to lists
    const listsChannel = supabase
      .channel('lists-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'lists' }, (payload) => {
        if (payload.eventType === 'INSERT') {
          // Only add if not already in state (prevents duplicates from local add + realtime)
          setLists(prev => {
            if (prev.some(l => l.id === payload.new.id)) {
              console.log('[Realtime] List already exists, skipping duplicate:', payload.new.id);
              return prev;
            }
            return [...prev, transformList(payload.new)];
          });
        } else if (payload.eventType === 'UPDATE') {
          setLists(prev => prev.map(l => l.id === payload.new.id ? transformList(payload.new) : l));
        } else if (payload.eventType === 'DELETE') {
          setLists(prev => prev.filter(l => l.id !== payload.old.id));
        }
      })
      .subscribe((status) => handleSubscriptionStatus('Lists', listsChannel, status));

    // Subscribe to notes
    const notesChannel = supabase
      .channel('notes-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'notes' }, (payload) => {
        if (payload.eventType === 'INSERT') {
          // Check for duplicate before adding
          setNotes(prev => {
            if (prev.some(n => n.id === payload.new.id)) {
              return prev; // Already exists, skip
            }
            return [transformNote(payload.new), ...prev];
          });
        } else if (payload.eventType === 'UPDATE') {
          setNotes(prev => prev.map(n => n.id === payload.new.id ? { ...transformNote(payload.new), replies: n.replies } : n));
        } else if (payload.eventType === 'DELETE') {
          setNotes(prev => prev.filter(n => n.id !== payload.old.id));
        }
      })
      .subscribe((status) => handleSubscriptionStatus('Notes', notesChannel, status));

    // Subscribe to note_replies
    const repliesChannel = supabase
      .channel('replies-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'note_replies' }, (payload) => {
        if (payload.eventType === 'INSERT') {
          const noteId = payload.new.note_id;
          const newReply = {
            id: payload.new.id,
            authorId: payload.new.author_id,
            content: payload.new.content,
            mentions: payload.new.mentions || [],
            createdAt: new Date(payload.new.created_at)
          };
          // Check for duplicate before adding
          setNotes(prev => prev.map(n => {
            if (n.id !== noteId) return n;
            // Check if reply already exists
            if (n.replies.some(r => r.id === newReply.id)) {
              return n; // Already exists, skip
            }
            return { ...n, replies: [...n.replies, newReply] };
          }));
        } else if (payload.eventType === 'DELETE') {
          setNotes(prev => prev.map(n => ({
            ...n,
            replies: n.replies.filter(r => r.id !== payload.old.id)
          })));
        }
      })
      .subscribe((status) => handleSubscriptionStatus('Replies', repliesChannel, status));

    // Subscribe to notifications for current user
    const notificationsChannel = supabase
      .channel('notifications-changes')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'notifications',
        filter: `recipient_id=eq.${currentTeamMember.id}`
      }, (payload) => {
        if (payload.eventType === 'INSERT') {
          setNotifications(prev => [transformNotification(payload.new), ...prev]);
        } else if (payload.eventType === 'UPDATE') {
          setNotifications(prev => prev.map(n => n.id === payload.new.id ? transformNotification(payload.new) : n));
        } else if (payload.eventType === 'DELETE') {
          setNotifications(prev => prev.filter(n => n.id !== payload.old.id));
        }
      })
      .subscribe((status) => handleSubscriptionStatus('Notifications', notificationsChannel, status));

    // Subscribe to clients
    const clientsChannel = supabase
      .channel('clients-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'clients' }, (payload) => {
        if (payload.eventType === 'INSERT') {
          const newClient = { ...payload.new, projects: [] };
          if (payload.new.is_internal) {
            if (payload.new.is_personal && payload.new.owner_id === currentTeamMember.id) {
              setInternal(prev => ({ ...prev, personal: newClient }));
            } else if (payload.new.is_team) {
              setInternal(prev => ({ ...prev, team: newClient }));
            }
          } else {
            setClients(prev => [...prev, newClient]);
          }
        } else if (payload.eventType === 'UPDATE') {
          if (payload.new.is_internal) {
            if (payload.new.is_personal) {
              setInternal(prev => prev.personal?.id === payload.new.id
                ? { ...prev, personal: { ...prev.personal, ...payload.new } }
                : prev);
            } else if (payload.new.is_team) {
              setInternal(prev => prev.team?.id === payload.new.id
                ? { ...prev, team: { ...prev.team, ...payload.new } }
                : prev);
            }
          } else {
            setClients(prev => prev.map(c => c.id === payload.new.id ? { ...c, ...payload.new } : c));
          }
        } else if (payload.eventType === 'DELETE') {
          setClients(prev => prev.filter(c => c.id !== payload.old.id));
        }
      })
      .subscribe((status) => handleSubscriptionStatus('Clients', clientsChannel, status));

    // Subscribe to projects
    const projectsChannel = supabase
      .channel('projects-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, (payload) => {
        const updateClientProjects = (clientsSetter, clientId, updateFn) => {
          clientsSetter(prev => {
            if (Array.isArray(prev)) {
              return prev.map(c => c.id === clientId ? { ...c, projects: updateFn(c.projects || []) } : c);
            }
            return prev;
          });
        };

        if (payload.eventType === 'INSERT') {
          const clientId = payload.new.client_id;
          // Update in clients array
          setClients(prev => prev.map(c =>
            c.id === clientId ? { ...c, projects: [...(c.projects || []), payload.new] } : c
          ));
          // Update in internal spaces
          setInternal(prev => {
            const updated = { ...prev };
            if (prev.personal?.id === clientId) {
              updated.personal = { ...prev.personal, projects: [...(prev.personal.projects || []), payload.new] };
            }
            if (prev.team?.id === clientId) {
              updated.team = { ...prev.team, projects: [...(prev.team.projects || []), payload.new] };
            }
            return updated;
          });
        } else if (payload.eventType === 'UPDATE') {
          const clientId = payload.new.client_id;
          const updateProjects = (projects) => projects.map(p => p.id === payload.new.id ? payload.new : p);
          setClients(prev => prev.map(c =>
            c.id === clientId ? { ...c, projects: updateProjects(c.projects || []) } : c
          ));
          setInternal(prev => {
            const updated = { ...prev };
            if (prev.personal?.id === clientId) {
              updated.personal = { ...prev.personal, projects: updateProjects(prev.personal.projects || []) };
            }
            if (prev.team?.id === clientId) {
              updated.team = { ...prev.team, projects: updateProjects(prev.team.projects || []) };
            }
            return updated;
          });
        } else if (payload.eventType === 'DELETE') {
          const removeProject = (projects) => projects.filter(p => p.id !== payload.old.id);
          setClients(prev => prev.map(c => ({ ...c, projects: removeProject(c.projects || []) })));
          setInternal(prev => ({
            personal: prev.personal ? { ...prev.personal, projects: removeProject(prev.personal.projects || []) } : null,
            team: prev.team ? { ...prev.team, projects: removeProject(prev.team.projects || []) } : null
          }));
        }
      })
      .subscribe((status) => handleSubscriptionStatus('Projects', projectsChannel, status));

    // Cleanup subscriptions on unmount
    return () => {
      // Clear any pending retry timeouts
      retryTimeouts.forEach((timeoutId) => clearTimeout(timeoutId));
      retryTimeouts.clear();

      supabase.removeChannel(tasksChannel);
      supabase.removeChannel(eventsChannel);
      supabase.removeChannel(attendeesChannel);
      supabase.removeChannel(listsChannel);
      supabase.removeChannel(notesChannel);
      supabase.removeChannel(repliesChannel);
      supabase.removeChannel(notificationsChannel);
      supabase.removeChannel(clientsChannel);
      supabase.removeChannel(projectsChannel);
    };
  }, [currentTeamMember?.id]);

  // Auto-collapse sidebar on small viewports
  React.useEffect(() => {
    const handleResize = () => {
      if (window.innerWidth < 900) {
        setSidebarCollapsed(true);
      }
    };
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // Default to Team view on initial load
  const [initialViewSet, setInitialViewSet] = React.useState(false);
  React.useEffect(() => {
    if (!initialViewSet && internal.team) {
      setSelectedClient(internal.team);
      setActiveView('client');
      setInitialViewSet(true);
    }
  }, [internal.team, initialViewSet]);

  const navigateToClient = (clientId, projectId = null) => {
    // Check if it's the personal space (by UUID or is_personal flag)
    if (internal.personal && (clientId === internal.personal.id || clientId === 'personal')) {
      setSelectedClient({ ...internal.personal, _initialProject: projectId });
      setActiveView('client');
      return;
    }
    // Check if it's the team space (by UUID or is_team flag)
    if (internal.team && (clientId === internal.team.id || clientId === 'team')) {
      setSelectedClient({ ...internal.team, _initialProject: projectId });
      setActiveView('client');
      return;
    }
    // Regular client
    const client = clients.find(c => c.id === clientId);
    if (client) {
      setSelectedClient({ ...client, _initialProject: projectId });
      setActiveView('client');
    }
  };

  const toggleTaskComplete = async (taskId) => {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    const newIsCompleted = !task.isCompleted;

    // Update Supabase
    const { error } = await window.supabase
      .from('tasks')
      .update({ is_completed: newIsCompleted })
      .eq('id', taskId);

    if (error) {
      console.error('Error toggling task:', error);
      return;
    }

    setTasks(prev => prev.map(t =>
      t.id === taskId ? { ...t, isCompleted: newIsCompleted } : t
    ));
    // Update selectedTask if it's the one being toggled
    if (selectedTask?.id === taskId) {
      setSelectedTask(prev => ({ ...prev, isCompleted: newIsCompleted }));
    }
  };

  const addTask = async (task) => {
    // Transform camelCase to snake_case for Supabase
    const dbTask = {
      title: task.title,
      notes: task.description || task.notes || null,
      project_id: task.projectId || null,
      client_id: task.clientId || null,
      assigned_to: task.assignedTo || null,
      due_date: task.dueDate instanceof Date ? task.dueDate.toISOString() : task.dueDate || null,
      is_completed: task.isCompleted || false,
      list_id: task.listId || null,
      list_order: task.listOrder ?? null,
      created_by: currentUser?.id
    };

    console.log('Adding task to Supabase:', dbTask);

    try {
      console.log('Starting Supabase insert...');
      const { data: newTask, error } = await window.supabase
        .from('tasks')
        .insert(dbTask)
        .select()
        .single();

      console.log('Supabase insert completed. Error:', error, 'Data:', newTask);

      if (error) {
        console.error('Error adding task:', error);
        alert('Error saving task: ' + error.message);
        return;
      }

      console.log('Task saved successfully:', newTask);

      // Note: Local state update is handled by the realtime subscription
      // to avoid race condition duplicates

      // Notify assignee if different from creator
      if (newTask.assigned_to && newTask.assigned_to !== currentUser.id) {
        const notif = createNotification(
          'task_assigned',
          currentUser.id,
          newTask.assigned_to,
          'task',
          newTask.id,
          newTask.title
        );
        addNotification(notif);
      }
    } catch (err) {
      console.error('Unexpected error adding task:', err);
      alert('Unexpected error saving task: ' + err.message);
    }
  };

  const addEvent = async (event) => {
    const dbEvent = {
      title: event.title,
      notes: event.description || event.notes || null,
      start_time: event.startTime instanceof Date ? event.startTime.toISOString() : event.startTime,
      end_time: event.endTime instanceof Date ? event.endTime.toISOString() : event.endTime,
      all_day: event.allDay || false,
      location: event.location || null,
      project_id: event.projectId || null,
      client_id: event.clientId || null,
      is_completed: event.isCompleted || false,
      created_by: currentUser?.id,
      visibility: event.visibility || {},
      type: event.type || 'meeting'
    };

    console.log('Adding event to Supabase:', dbEvent);

    const { data: newEvent, error } = await window.supabase
      .from('events')
      .insert(dbEvent)
      .select()
      .single();

    if (error) {
      console.error('Error adding event:', error);
      alert('Error saving event: ' + error.message);
      return;
    }

    console.log('Event saved successfully:', newEvent);

    // Add attendees if any
    if (event.attendees && event.attendees.length > 0) {
      const attendeeRecords = event.attendees.map(memberId => ({
        event_id: newEvent.id,
        team_member_id: memberId
      }));

      const { error: attendeeError } = await window.supabase
        .from('event_attendees')
        .insert(attendeeRecords);

      if (attendeeError) {
        console.error('Error adding event attendees:', attendeeError);
      }
    }

    // Note: Local state update is handled by the realtime subscription
    // to avoid race condition duplicates

    // Notify attendees (except creator)
    if (event.attendees && event.attendees.length > 0) {
      const notifs = event.attendees
        .filter(attendeeId => attendeeId !== currentUser.id)
        .map(attendeeId => createNotification(
          'event_attendee_added',
          currentUser.id,
          attendeeId,
          'event',
          newEvent.id,
          event.title
        ));
      addNotifications(notifs);
    }
  };

  const updateEvent = async (eventId, updates) => {
    console.log('updateEvent called:', eventId, updates);

    const dbUpdates = {};
    if (updates.title !== undefined) dbUpdates.title = updates.title;
    if (updates.description !== undefined) dbUpdates.notes = updates.description;
    if (updates.notes !== undefined) dbUpdates.notes = updates.notes;
    if (updates.startTime !== undefined) dbUpdates.start_time = updates.startTime instanceof Date ? updates.startTime.toISOString() : updates.startTime;
    if (updates.endTime !== undefined) dbUpdates.end_time = updates.endTime instanceof Date ? updates.endTime.toISOString() : updates.endTime;
    if (updates.allDay !== undefined) dbUpdates.all_day = updates.allDay;
    if (updates.location !== undefined) dbUpdates.location = updates.location;
    if (updates.projectId !== undefined) dbUpdates.project_id = updates.projectId;
    if (updates.clientId !== undefined) dbUpdates.client_id = updates.clientId;
    if (updates.isCompleted !== undefined) dbUpdates.is_completed = updates.isCompleted;
    if (updates.visibility !== undefined) dbUpdates.visibility = updates.visibility;

    console.log('dbUpdates to send:', dbUpdates);

    if (Object.keys(dbUpdates).length > 0) {
      console.log('Sending update to Supabase...');
      const { error } = await window.supabase
        .from('events')
        .update(dbUpdates)
        .eq('id', eventId);

      console.log('Supabase update result, error:', error);

      if (error) {
        console.error('Error updating event:', error);
        alert('Error updating event: ' + error.message);
        return;
      }
    }

    // Handle attendee updates
    if (updates.attendees !== undefined) {
      // Delete existing attendees and re-add
      await window.supabase
        .from('event_attendees')
        .delete()
        .eq('event_id', eventId);

      if (updates.attendees.length > 0) {
        const attendeeRecords = updates.attendees.map(memberId => ({
          event_id: eventId,
          team_member_id: memberId
        }));

        await window.supabase
          .from('event_attendees')
          .insert(attendeeRecords);
      }
    }

    setEvents(prev => prev.map(e =>
      e.id === eventId ? { ...e, ...updates } : e
    ));
    setSelectedEvent(null);
  };

  const deleteEvent = async (eventId) => {
    // Attendees will be deleted via CASCADE
    const { error } = await window.supabase
      .from('events')
      .delete()
      .eq('id', eventId);

    if (error) {
      console.error('Error deleting event:', error);
      return;
    }

    setEvents(prev => prev.filter(e => e.id !== eventId));
    setSelectedEvent(null);
  };

  const updateTask = async (taskId, updates) => {
    const oldTask = tasks.find(t => t.id === taskId);

    // Transform camelCase to snake_case for Supabase
    const dbUpdates = {};
    if (updates.title !== undefined) dbUpdates.title = updates.title;
    if (updates.description !== undefined) dbUpdates.notes = updates.description;
    if (updates.notes !== undefined) dbUpdates.notes = updates.notes;
    if (updates.projectId !== undefined) dbUpdates.project_id = updates.projectId;
    if (updates.clientId !== undefined) dbUpdates.client_id = updates.clientId;
    if (updates.assignedTo !== undefined) dbUpdates.assigned_to = updates.assignedTo;
    if (updates.dueDate !== undefined) dbUpdates.due_date = updates.dueDate instanceof Date ? updates.dueDate.toISOString() : updates.dueDate;
    if (updates.isCompleted !== undefined) dbUpdates.is_completed = updates.isCompleted;
    if (updates.listId !== undefined) dbUpdates.list_id = updates.listId;
    if (updates.listOrder !== undefined) dbUpdates.list_order = updates.listOrder;
    if (updates.status !== undefined) dbUpdates.status = updates.status;
    if (updates.blockedReason !== undefined) dbUpdates.blocked_reason = updates.blockedReason;

    console.log('Sending update to Supabase:', taskId, dbUpdates);

    try {
      const { error } = await window.supabase
        .from('tasks')
        .update(dbUpdates)
        .eq('id', taskId);

      if (error) {
        console.error('Error updating task:', error);
        alert('Error updating task: ' + error.message);
        return;
      }

      console.log('Task updated successfully:', taskId);

      // Check if assignment changed
      if (updates.assignedTo && oldTask && updates.assignedTo !== oldTask.assignedTo) {
        const notif = createNotification(
          'task_assigned',
          currentUser.id,
          updates.assignedTo,
          'task',
          taskId,
          updates.title || oldTask.title
        );
        addNotification(notif);
      }

      setTasks(prev => prev.map(t =>
        t.id === taskId ? { ...t, ...updates } : t
      ));
      // Close the modal after update
      setSelectedTask(null);
    } catch (err) {
      console.error('Unexpected error updating task:', err);
      alert('Unexpected error updating task: ' + err.message);
    }
  };

  const deleteTask = async (taskId) => {
    const { error } = await window.supabase
      .from('tasks')
      .delete()
      .eq('id', taskId);

    if (error) {
      console.error('Error deleting task:', error);
      return;
    }

    setTasks(prev => prev.filter(t => t.id !== taskId));
    setSelectedTask(null);
  };

  // List CRUD functions
  const addList = async (list) => {
    const dbList = {
      title: list.title,
      notes: list.description || list.notes || null,
      project_id: list.projectId || null,
      client_id: list.clientId || null,
      due_date: list.dueDate instanceof Date ? list.dueDate.toISOString() : list.dueDate || null,
      created_by: currentUser?.id || null
    };

    console.log('Adding list to Supabase:', dbList);

    const { data: newList, error } = await window.supabase
      .from('lists')
      .insert(dbList)
      .select()
      .single();

    if (error) {
      console.error('Error adding list:', error);
      alert('Error saving list: ' + error.message);
      return;
    }

    console.log('List saved successfully:', newList);

    // Note: Local state update is handled by the realtime subscription
    // to avoid race condition duplicates
  };

  const updateList = async (listId, updates) => {
    const dbUpdates = {};
    if (updates.title !== undefined) dbUpdates.title = updates.title;
    if (updates.description !== undefined) dbUpdates.notes = updates.description;
    if (updates.notes !== undefined) dbUpdates.notes = updates.notes;
    if (updates.projectId !== undefined) dbUpdates.project_id = updates.projectId;
    if (updates.clientId !== undefined) dbUpdates.client_id = updates.clientId;
    if (updates.dueDate !== undefined) dbUpdates.due_date = updates.dueDate instanceof Date ? updates.dueDate.toISOString() : updates.dueDate;

    const { error } = await window.supabase
      .from('lists')
      .update(dbUpdates)
      .eq('id', listId);

    if (error) {
      console.error('Error updating list:', error);
      alert('Error updating list: ' + error.message);
      return;
    }

    setLists(prev => prev.map(l =>
      l.id === listId ? { ...l, ...updates } : l
    ));
    setSelectedList(null);
  };

  const deleteList = async (listId) => {
    // First remove list association from tasks in Supabase
    const { error: taskError } = await window.supabase
      .from('tasks')
      .update({ list_id: null, list_order: null })
      .eq('list_id', listId);

    if (taskError) {
      console.error('Error unlinking tasks from list:', taskError);
      return;
    }

    // Then delete the list
    const { error } = await window.supabase
      .from('lists')
      .delete()
      .eq('id', listId);

    if (error) {
      console.error('Error deleting list:', error);
      return;
    }

    // Update local state
    setTasks(prev => prev.map(t =>
      t.listId === listId ? { ...t, listId: null, listOrder: null } : t
    ));
    setLists(prev => prev.filter(l => l.id !== listId));
    setSelectedList(null);
  };

  // Get tasks for a specific list, sorted by listOrder
  const getListTasks = (listId) => {
    return tasks
      .filter(t => t.listId === listId)
      .sort((a, b) => (a.listOrder || 0) - (b.listOrder || 0));
  };

  // Get list progress (completed / total)
  const getListProgress = (listId) => {
    const listTasks = tasks.filter(t => t.listId === listId);
    const completed = listTasks.filter(t => t.isCompleted).length;
    return { completed, total: listTasks.length };
  };

  // Add task to a list
  const addTaskToList = async (listId, task) => {
    const list = lists.find(l => l.id === listId);
    if (!list) return;

    const listTasks = getListTasks(listId);
    const maxOrder = listTasks.length > 0 ? Math.max(...listTasks.map(t => t.listOrder || 0)) : -1;

    // Use addTask to properly save to Supabase
    await addTask({
      ...task,
      listId: listId,
      listOrder: maxOrder + 1,
      clientId: list.clientId,
      projectId: list.projectId,
      dueDate: task.dueDate || null,
    });
  };

  // Reorder tasks within a list
  const reorderListTasks = (listId, taskId, newOrder) => {
    const listTasks = getListTasks(listId);
    const taskIndex = listTasks.findIndex(t => t.id === taskId);
    if (taskIndex === -1) return;
    
    // Remove task from current position
    const [movedTask] = listTasks.splice(taskIndex, 1);
    // Insert at new position
    listTasks.splice(newOrder, 0, movedTask);
    
    // Update all list orders
    const updatedTaskIds = listTasks.map((t, i) => ({ id: t.id, listOrder: i }));
    
    setTasks(prev => prev.map(t => {
      const update = updatedTaskIds.find(u => u.id === t.id);
      return update ? { ...t, listOrder: update.listOrder } : t;
    }));
  };

  // Remove task from list (keeps task but removes list association)
  const removeTaskFromList = (taskId) => {
    setTasks(prev => prev.map(t => 
      t.id === taskId ? { ...t, listId: null, listOrder: null } : t
    ));
  };

  // Helper to extract @mentions from text
  const extractMentions = (text) => {
    const mentionRegex = /@(\w+(?:\s+\w+)?)/g;
    const mentions = [];
    let match;
    while ((match = mentionRegex.exec(text)) !== null) {
      const name = match[1];
      const member = teamMembers.find(m => m.name === name);
      if (member) {
        mentions.push(member.id);
      }
    }
    return [...new Set(mentions)]; // Remove duplicates
  };

  const addNote = async (clientId, content, projectId = null) => {
    const mentions = extractMentions(content);
    const client = [...clients, internal.personal, internal.team].find(c => c.id === clientId);

    const dbNote = {
      client_id: clientId,
      project_id: projectId,
      author_id: currentUser.id,
      content,
      mentions
    };

    const { data: newNoteData, error } = await window.supabase
      .from('notes')
      .insert(dbNote)
      .select()
      .single();

    if (error) {
      console.error('Error adding note:', error);
      return;
    }

    const newNote = {
      id: newNoteData.id,
      clientId: newNoteData.client_id,
      projectId: newNoteData.project_id,
      authorId: newNoteData.author_id,
      content: newNoteData.content,
      mentions: newNoteData.mentions || [],
      createdAt: new Date(newNoteData.created_at),
      replies: []
    };

    // Note: Don't add to local state - realtime subscription will handle it
    // This prevents duplicate notes from appearing

    // Create notifications for mentioned users
    const mentionNotifs = mentions
      .filter(userId => userId !== currentUser.id)
      .map(userId => createNotification(
        'mentioned',
        currentUser.id,
        userId,
        'note',
        newNote.id,
        client?.name || 'a note'
      ));
    addNotifications(mentionNotifs);
  };

  const addReply = async (noteId, content) => {
    console.log('addReply called with noteId:', noteId, 'content:', content);
    const mentions = extractMentions(content);

    // Don't include mentions in insert - let it default, similar to task status fix
    const dbReply = {
      note_id: noteId,
      author_id: currentUser.id,
      content
    };
    console.log('Inserting reply to Supabase:', dbReply);

    try {
      console.log('Starting Supabase insert for reply...');
      const { data: newReplyData, error } = await window.supabase
        .from('note_replies')
        .insert(dbReply)
        .select()
        .single();

      console.log('Reply insert result:', { data: newReplyData, error });
      if (error) {
        console.error('Error adding reply:', error);
        alert('Error adding reply: ' + error.message);
        return;
      }

      // Note: Don't add to local state - realtime subscription will handle it
      // This prevents duplicate replies from appearing
      console.log('Reply added successfully, id:', newReplyData.id);

      // Find the note to get context for notifications
      const parentNote = notes.find(n => n.id === noteId);
      const client = parentNote ? [...clients, internal.personal, internal.team].find(c => c.id === parentNote.clientId) : null;

      // Collect all people who should be notified about this reply:
      // 1. People mentioned in this reply
      // 2. The original note author
      // 3. People who were mentioned in the original note
      // 4. People who were mentioned in previous replies
      const notificationsToSend = [];
      const alreadyNotified = new Set([currentUser.id]); // Don't notify self

      // 1. Notify people mentioned in this reply
      mentions.forEach(userId => {
        if (!alreadyNotified.has(userId)) {
          const notif = createNotification(
            'mentioned',
            currentUser.id,
            userId,
            'note',
            noteId,
            client?.name || 'a reply'
          );
          if (notif) notificationsToSend.push(notif);
          alreadyNotified.add(userId);
        }
      });

      // 2. Notify the original note author
      if (parentNote && parentNote.authorId && !alreadyNotified.has(parentNote.authorId)) {
        const notif = createNotification(
          'reply',
          currentUser.id,
          parentNote.authorId,
          'note',
          noteId,
          client?.name || 'your note'
        );
        if (notif) notificationsToSend.push(notif);
        alreadyNotified.add(parentNote.authorId);
      }

      // 3. Notify people mentioned in the original note (thread participants)
      if (parentNote?.mentions) {
        parentNote.mentions.forEach(userId => {
          if (!alreadyNotified.has(userId)) {
            const notif = createNotification(
              'thread_reply',
              currentUser.id,
              userId,
              'note',
              noteId,
              client?.name || 'a thread you\'re in'
            );
            if (notif) notificationsToSend.push(notif);
            alreadyNotified.add(userId);
          }
        });
      }

      // 4. Notify people mentioned in previous replies (thread participants)
      if (parentNote?.replies) {
        parentNote.replies.forEach(reply => {
          // Notify reply authors
          if (reply.authorId && !alreadyNotified.has(reply.authorId)) {
            const notif = createNotification(
              'thread_reply',
              currentUser.id,
              reply.authorId,
              'note',
              noteId,
              client?.name || 'a thread you\'re in'
            );
            if (notif) notificationsToSend.push(notif);
            alreadyNotified.add(reply.authorId);
          }
          // Notify people mentioned in previous replies
          if (reply.mentions) {
            reply.mentions.forEach(userId => {
              if (!alreadyNotified.has(userId)) {
                const notif = createNotification(
                  'thread_reply',
                  currentUser.id,
                  userId,
                  'note',
                  noteId,
                  client?.name || 'a thread you\'re in'
                );
                if (notif) notificationsToSend.push(notif);
                alreadyNotified.add(userId);
              }
            });
          }
        });
      }

      addNotifications(notificationsToSend);
    } catch (err) {
      console.error('Unexpected error adding reply:', err);
      alert('Unexpected error adding reply: ' + err.message);
    }
  };

  const deleteNote = async (noteId) => {
    try {
      // Delete the note (replies will cascade due to foreign key)
      const { error } = await window.supabase
        .from('notes')
        .delete()
        .eq('id', noteId);

      if (error) {
        console.error('Error deleting note:', error);
        alert('Error deleting note: ' + error.message);
        return false;
      }

      // Update local state
      setNotes(prev => prev.filter(n => n.id !== noteId));
      return true;
    } catch (err) {
      console.error('Unexpected error deleting note:', err);
      alert('Unexpected error deleting note: ' + err.message);
      return false;
    }
  };

  const deleteReply = async (noteId, replyId) => {
    try {
      const { error } = await window.supabase
        .from('note_replies')
        .delete()
        .eq('id', replyId);

      if (error) {
        console.error('Error deleting reply:', error);
        alert('Error deleting reply: ' + error.message);
        return false;
      }

      // Update local state - remove reply from the note
      setNotes(prev => prev.map(note =>
        note.id === noteId
          ? { ...note, replies: note.replies.filter(r => r.id !== replyId) }
          : note
      ));
      return true;
    } catch (err) {
      console.error('Unexpected error deleting reply:', err);
      alert('Unexpected error deleting reply: ' + err.message);
      return false;
    }
  };

  const updateNote = async (noteId, updates) => {
    try {
      const dbUpdates = {};
      if (updates.clientId !== undefined) dbUpdates.client_id = updates.clientId;
      if (updates.projectId !== undefined) dbUpdates.project_id = updates.projectId;

      const { error } = await window.supabase
        .from('notes')
        .update(dbUpdates)
        .eq('id', noteId);

      if (error) {
        console.error('Error updating note:', error);
        alert('Error updating note: ' + error.message);
        return false;
      }

      // Update local state
      setNotes(prev => prev.map(note =>
        note.id === noteId
          ? { ...note, ...updates }
          : note
      ));
      return true;
    } catch (err) {
      console.error('Unexpected error updating note:', err);
      alert('Unexpected error updating note: ' + err.message);
      return false;
    }
  };

  const addClient = async (name, color, details = '') => {
    try {
      const { data: newClient, error } = await supabase
        .from('clients')
        .insert({
          name,
          color,
          details,
          is_internal: false,
          is_personal: false,
          is_team: false
        })
        .select()
        .single();

      if (error) throw error;

      const clientWithProjects = { ...newClient, projects: [] };
      setClients(prev => [...prev, clientWithProjects]);
      setSelectedClient(clientWithProjects);
      setActiveView('client');
    } catch (err) {
      console.error('Error adding client:', err);
    }
  };

  const updateClient = async (clientId, updates) => {
    try {
      // Get the actual UUID for internal spaces
      let actualId = clientId;
      if (clientId === 'personal') {
        actualId = internal.personal?.id;
      } else if (clientId === 'team') {
        actualId = internal.team?.id;
      }

      // Only update allowed fields
      const { name, color, details } = updates;
      const updateData = {};
      if (name !== undefined) updateData.name = name;
      if (color !== undefined) updateData.color = color;
      if (details !== undefined) updateData.details = details;

      const { error } = await supabase
        .from('clients')
        .update(updateData)
        .eq('id', actualId);

      if (error) throw error;

      // Update local state
      if (clientId === 'personal' || clientId === 'team') {
        setInternal(prev => ({
          ...prev,
          [clientId]: { ...prev[clientId], ...updates }
        }));
        if (selectedClient?.id === actualId || selectedClient?.id === clientId) {
          setSelectedClient(prev => ({ ...prev, ...updates }));
        }
      } else {
        setClients(prev => prev.map(c =>
          c.id === clientId ? { ...c, ...updates } : c
        ));
        if (selectedClient?.id === clientId) {
          setSelectedClient(prev => ({ ...prev, ...updates }));
        }
      }
    } catch (err) {
      console.error('Error updating client:', err);
    }
  };

  const addProject = async (clientId, name, color) => {
    try {
      // Get the actual UUID for internal spaces
      let actualClientId = clientId;
      if (clientId === 'personal') {
        actualClientId = internal.personal?.id;
      } else if (clientId === 'team') {
        actualClientId = internal.team?.id;
      }

      const { data: newProject, error } = await supabase
        .from('projects')
        .insert({
          client_id: actualClientId,
          name,
          color
        })
        .select()
        .single();

      if (error) throw error;

      // Update local state
      if (clientId === 'personal' || clientId === 'team') {
        setInternal(prev => ({
          ...prev,
          [clientId]: {
            ...prev[clientId],
            projects: [...(prev[clientId]?.projects || []), newProject]
          }
        }));
        if (selectedClient?.id === actualClientId || selectedClient?.is_personal || selectedClient?.is_team) {
          setSelectedClient(prev => ({ ...prev, projects: [...(prev.projects || []), newProject] }));
        }
      } else {
        setClients(prev => prev.map(c =>
          c.id === clientId
            ? { ...c, projects: [...(c.projects || []), newProject] }
            : c
        ));
        if (selectedClient?.id === clientId) {
          setSelectedClient(prev => ({ ...prev, projects: [...(prev.projects || []), newProject] }));
        }
      }
    } catch (err) {
      console.error('Error adding project:', err);
    }
  };

  const deleteProject = async (projectId) => {
    try {
      // Delete all associated data first (tasks, events, lists, notes)
      // Tasks
      await supabase.from('tasks').delete().eq('project_id', projectId);
      // Events (attendees will cascade)
      await supabase.from('events').delete().eq('project_id', projectId);
      // Lists
      await supabase.from('lists').delete().eq('project_id', projectId);
      // Notes (replies will cascade)
      await supabase.from('notes').delete().eq('project_id', projectId);

      // Delete the project
      const { error } = await supabase.from('projects').delete().eq('id', projectId);
      if (error) throw error;

      // Update local state
      const removeProjectFromList = (projects) => (projects || []).filter(p => p.id !== projectId);

      setClients(prev => prev.map(c => ({
        ...c,
        projects: removeProjectFromList(c.projects)
      })));
      setInternal(prev => ({
        personal: prev.personal ? { ...prev.personal, projects: removeProjectFromList(prev.personal.projects) } : null,
        team: prev.team ? { ...prev.team, projects: removeProjectFromList(prev.team.projects) } : null
      }));
      if (selectedClient) {
        setSelectedClient(prev => ({ ...prev, projects: removeProjectFromList(prev.projects) }));
      }
      setTasks(prev => prev.filter(t => t.projectId !== projectId));
      setEvents(prev => prev.filter(e => e.projectId !== projectId));
      setLists(prev => prev.filter(l => l.projectId !== projectId));
      setNotes(prev => prev.filter(n => n.projectId !== projectId));
    } catch (err) {
      console.error('Error deleting project:', err);
      throw err;
    }
  };

  const deleteClient = async (clientId) => {
    try {
      // Get all projects for this client first
      const clientProjects = clients.find(c => c.id === clientId)?.projects || [];
      const projectIds = clientProjects.map(p => p.id);

      // Delete all associated data
      // Tasks (by client or by project)
      await supabase.from('tasks').delete().eq('client_id', clientId);
      for (const projectId of projectIds) {
        await supabase.from('tasks').delete().eq('project_id', projectId);
      }
      // Events (attendees will cascade)
      await supabase.from('events').delete().eq('client_id', clientId);
      for (const projectId of projectIds) {
        await supabase.from('events').delete().eq('project_id', projectId);
      }
      // Lists
      await supabase.from('lists').delete().eq('client_id', clientId);
      for (const projectId of projectIds) {
        await supabase.from('lists').delete().eq('project_id', projectId);
      }
      // Notes (replies will cascade)
      await supabase.from('notes').delete().eq('client_id', clientId);
      for (const projectId of projectIds) {
        await supabase.from('notes').delete().eq('project_id', projectId);
      }
      // Projects
      for (const projectId of projectIds) {
        await supabase.from('projects').delete().eq('id', projectId);
      }

      // Delete the client
      const { error } = await supabase.from('clients').delete().eq('id', clientId);
      if (error) throw error;

      // Update local state
      setClients(prev => prev.filter(c => c.id !== clientId));
      if (selectedClient?.id === clientId) {
        setSelectedClient(null);
        setActiveView('timeline');
      }
      setTasks(prev => prev.filter(t => t.clientId !== clientId && !projectIds.includes(t.projectId)));
      setEvents(prev => prev.filter(e => e.clientId !== clientId && !projectIds.includes(e.projectId)));
      setLists(prev => prev.filter(l => l.clientId !== clientId && !projectIds.includes(l.projectId)));
      setNotes(prev => prev.filter(n => n.clientId !== clientId && !projectIds.includes(n.projectId)));
    } catch (err) {
      console.error('Error deleting client:', err);
      throw err;
    }
  };

  // Show loading state while data is being fetched
  if (dataLoading) {
    return (
      <div style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        height: '100vh',
        background: '#09090b',
        color: '#71717a',
        fontSize: '14px'
      }}>
        Loading your workspace...
      </div>
    );
  }

  return (
    <div className="app">
      <style>{`
        * { margin: 0; padding: 0; box-sizing: border-box; }

        .app {
          display: flex;
          height: 100vh;
          background: #09090b;
          color: #fafafa;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          overflow: hidden;
        }
        
        /* Connection Status Indicator */
        .connection-indicator {
          position: fixed;
          bottom: 16px;
          right: 16px;
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 12px;
          background: rgba(39, 39, 42, 0.95);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 8px;
          font-size: 12px;
          color: #a1a1aa;
          z-index: 1000;
          backdrop-filter: blur(8px);
          transition: all 0.3s ease;
          opacity: 0;
          transform: translateY(10px);
          pointer-events: none;
        }
        .connection-indicator.visible {
          opacity: 1;
          transform: translateY(0);
          pointer-events: auto;
        }
        .connection-indicator-dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          flex-shrink: 0;
        }
        .connection-indicator-dot.connected { background: #22c55e; }
        .connection-indicator-dot.connecting { background: #eab308; animation: pulse 1.5s infinite; }
        .connection-indicator-dot.reconnecting { background: #f97316; animation: pulse 1s infinite; }
        .connection-indicator-dot.error { background: #ef4444; }
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.4; }
        }

        /* Sidebar */
        .sidebar {
          width: ${sidebarCollapsed ? '56px' : '240px'};
          background: rgba(10, 10, 14, 0.95);
          border-right: 1px solid rgba(255, 255, 255, 0.06);
          display: flex;
          flex-direction: column;
          transition: width 0.2s ease;
          flex-shrink: 0;
          position: relative;
        }
        
        .sidebar-toggle {
          position: absolute;
          top: 20px;
          right: -12px;
          width: 24px;
          height: 24px;
          border-radius: 50%;
          background: #27272a;
          border: 1px solid rgba(255, 255, 255, 0.1);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          color: #a1a1aa;
          transition: all 0.15s;
          z-index: 10;
        }
        
        .sidebar-toggle:hover {
          background: #3f3f46;
          color: #fff;
        }
        
        .sidebar-header {
          padding: 20px 16px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .logo-icon {
          width: 32px;
          height: 32px;
          background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
        }
        
        .logo-text {
          font-weight: 600;
          font-size: 15px;
          white-space: nowrap;
          overflow: hidden;
        }
        
        .nav-section {
          padding: 16px 12px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .nav-label {
          font-size: 10px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: #52525b;
          margin-bottom: 8px;
          padding: 0 8px;
        }
        
        .nav-item {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 10px 12px;
          border-radius: 8px;
          cursor: pointer;
          color: #a1a1aa;
          font-size: 14px;
          transition: all 0.15s ease;
          margin-bottom: 2px;
        }
        
        .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: #e4e4e7; }
        .nav-item.active { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
        .nav-item svg { width: 18px; height: 18px; flex-shrink: 0; }
        
        .nav-subitem {
          padding-left: 40px;
          font-size: 13px;
        }
        
        .nav-add-item {
          color: #52525b;
          border: 1px dashed rgba(255, 255, 255, 0.1);
          margin-top: 8px;
        }
        
        .nav-add-item:hover {
          color: #818cf8;
          border-color: rgba(99, 102, 241, 0.3);
          background: rgba(99, 102, 241, 0.1);
        }

        .sidebar-user {
          padding: 12px;
          border-top: 1px solid rgba(255, 255, 255, 0.06);
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 8px;
        }

        .sidebar-user-info {
          display: flex;
          align-items: center;
          gap: 10px;
          flex: 1;
          min-width: 0;
        }

        .sidebar-user-details {
          min-width: 0;
          flex: 1;
        }

        .sidebar-user-name {
          font-size: 13px;
          font-weight: 500;
          color: #fafafa;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .sidebar-user-email {
          font-size: 11px;
          color: #71717a;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .sidebar-signout {
          width: 32px;
          height: 32px;
          border-radius: 6px;
          border: none;
          background: transparent;
          color: #71717a;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.15s;
          flex-shrink: 0;
        }

        .sidebar-signout:hover {
          background: rgba(239, 68, 68, 0.1);
          color: #f87171;
        }

        /* Main Content */
        .main {
          flex: 1;
          display: flex;
          flex-direction: column;
          min-width: 0;
          overflow: hidden;
        }
        
        .header {
          padding: 20px 32px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
          flex-shrink: 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        .header-title {
          font-size: 24px;
          font-weight: 600;
        }
        
        .header-actions {
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .notification-btn {
          position: relative;
          background: rgba(255, 255, 255, 0.05);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 8px;
          padding: 8px;
          cursor: pointer;
          color: #a1a1aa;
          transition: all 0.15s;
        }
        
        .notification-btn:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #f4f4f5;
        }
        
        .notification-badge {
          position: absolute;
          top: -4px;
          right: -4px;
          background: #ef4444;
          color: #fff;
          font-size: 10px;
          font-weight: 600;
          min-width: 16px;
          height: 16px;
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 0 4px;
        }
        
        .notification-dropdown {
          position: absolute;
          top: calc(100% + 8px);
          right: 0;
          width: 360px;
          max-height: 480px;
          background: #1c1c1f;
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 12px;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
          z-index: 1000;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }
        
        .notification-header {
          padding: 16px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.08);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        .notification-header h3 {
          margin: 0;
          font-size: 14px;
          font-weight: 600;
          color: #f4f4f5;
        }
        
        .notification-mark-read {
          background: none;
          border: none;
          color: #6366f1;
          font-size: 12px;
          cursor: pointer;
          padding: 4px 8px;
          border-radius: 4px;
          transition: all 0.15s;
        }
        
        .notification-mark-read:hover {
          background: rgba(99, 102, 241, 0.1);
        }
        
        .notification-list {
          flex: 1;
          overflow-y: auto;
        }
        
        .notification-item {
          padding: 12px 16px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
          cursor: pointer;
          transition: all 0.15s;
          display: flex;
          gap: 12px;
          align-items: flex-start;
        }
        
        .notification-item:hover {
          background: rgba(255, 255, 255, 0.03);
        }
        
        .notification-item.unread {
          background: rgba(99, 102, 241, 0.08);
        }
        
        .notification-item.unread:hover {
          background: rgba(99, 102, 241, 0.12);
        }
        
        .notification-dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          margin-top: 6px;
          flex-shrink: 0;
        }
        
        .notification-content {
          flex: 1;
          min-width: 0;
        }
        
        .notification-message {
          font-size: 13px;
          color: #e4e4e7;
          line-height: 1.4;
          margin-bottom: 4px;
        }
        
        .notification-time {
          font-size: 11px;
          color: #71717a;
        }
        
        .notification-unread-indicator {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #6366f1;
          flex-shrink: 0;
          margin-top: 6px;
        }
        
        .notification-empty {
          padding: 32px 16px;
          text-align: center;
          color: #71717a;
          font-size: 13px;
        }

        .settings-btn {
          background: transparent;
          border: none;
          color: #71717a;
          cursor: pointer;
          padding: 8px;
          border-radius: 8px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s;
        }

        .settings-btn:hover {
          background: rgba(255, 255, 255, 0.08);
          color: #a1a1aa;
        }

        .webhook-modal-overlay {
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
        }

        .webhook-modal {
          background: #18181b;
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 12px;
          padding: 24px;
          width: 90%;
          max-width: 500px;
        }

        .webhook-modal h3 {
          margin: 0 0 8px 0;
          font-size: 18px;
          color: #f4f4f5;
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .webhook-modal-desc {
          color: #71717a;
          font-size: 13px;
          margin-bottom: 20px;
          line-height: 1.5;
        }

        .webhook-field {
          margin-bottom: 20px;
        }

        .webhook-label {
          display: block;
          font-size: 12px;
          color: #a1a1aa;
          margin-bottom: 8px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .webhook-input {
          width: 100%;
          padding: 12px 14px;
          border-radius: 8px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #f4f4f5;
          font-size: 14px;
          font-family: 'SF Mono', Monaco, monospace;
        }

        .webhook-input:focus {
          outline: none;
          border-color: rgba(99, 102, 241, 0.5);
        }

        .webhook-input::placeholder {
          color: #52525b;
        }

        .webhook-status {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 12px;
          border-radius: 8px;
          font-size: 13px;
          margin-bottom: 20px;
        }

        .webhook-status.active {
          background: rgba(34, 197, 94, 0.1);
          border: 1px solid rgba(34, 197, 94, 0.2);
          color: #22c55e;
        }

        .webhook-status.inactive {
          background: rgba(113, 113, 122, 0.1);
          border: 1px solid rgba(113, 113, 122, 0.2);
          color: #71717a;
        }

        .webhook-actions {
          display: flex;
          gap: 12px;
          justify-content: flex-end;
        }

        .webhook-btn {
          padding: 10px 20px;
          border-radius: 8px;
          font-size: 14px;
          cursor: pointer;
          font-family: inherit;
          transition: all 0.15s;
        }

        .webhook-btn-secondary {
          background: rgba(255, 255, 255, 0.06);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #a1a1aa;
        }

        .webhook-btn-secondary:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #f4f4f5;
        }

        .webhook-btn-primary {
          background: rgba(99, 102, 241, 0.2);
          border: 1px solid rgba(99, 102, 241, 0.3);
          color: #818cf8;
        }

        .webhook-btn-primary:hover {
          background: rgba(99, 102, 241, 0.3);
        }

        .webhook-btn-test {
          background: rgba(34, 197, 94, 0.15);
          border: 1px solid rgba(34, 197, 94, 0.3);
          color: #22c55e;
        }

        .webhook-btn-test:hover {
          background: rgba(34, 197, 94, 0.25);
        }

        .webhook-btn-test:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .content {
          flex: 1;
          padding: 24px 32px;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }
        
        /* Responsive padding for smaller screens */
        @media (max-width: 768px) {
          .header {
            padding: 16px 20px;
          }
          .content {
            padding: 16px 20px;
          }
        }
        
        @media (max-width: 480px) {
          .header {
            padding: 12px 16px;
          }
          .content {
            padding: 12px 16px;
          }
          .header-title {
            font-size: 20px;
          }
        }
      `}</style>

      {/* Sidebar */}
      <aside className="sidebar">
        <button 
          className="sidebar-toggle"
          onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
          title={sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'}
        >
          {sidebarCollapsed ? <ChevronRight size={14} /> : <ChevronLeft size={14} />}
        </button>
        
        <div className="sidebar-header">
          <div className="logo-icon"><FolderOpen size={18} /></div>
          {!sidebarCollapsed && <span className="logo-text">Invisible Arts</span>}
        </div>

        <nav className="nav-section">
          {!sidebarCollapsed && <div className="nav-label">Views</div>}
          <div 
            className={`nav-item ${activeView === 'timeline' ? 'active' : ''}`} 
            onClick={() => { setActiveView('timeline'); setSelectedClient(null); }}
          >
            <Calendar /> {!sidebarCollapsed && 'Timeline'}
          </div>
          <div 
            className={`nav-item ${activeView === 'calendar' ? 'active' : ''}`} 
            onClick={() => { setActiveView('calendar'); setSelectedClient(null); }}
          >
            <Clock /> {!sidebarCollapsed && 'Calendar'}
          </div>
          <div 
            className={`nav-item ${activeView === 'list' ? 'active' : ''}`} 
            onClick={() => { setActiveView('list'); setSelectedClient(null); }}
          >
            <List /> {!sidebarCollapsed && 'List View'}
          </div>
        </nav>

        <nav className="nav-section">
          {!sidebarCollapsed && <div className="nav-label">Internal</div>}
          {internal.personal && (
            <div
              className={`nav-item ${selectedClient?.id === internal.personal.id || selectedClient?.is_personal ? 'active' : ''}`}
              onClick={() => { setSelectedClient(internal.personal); setActiveView('client'); }}
            >
              <User size={16} style={{ color: internal.personal.color }} />
              {!sidebarCollapsed && 'Personal'}
            </div>
          )}
          {internal.team && (
            <div
              className={`nav-item ${selectedClient?.id === internal.team.id || selectedClient?.is_team ? 'active' : ''}`}
              onClick={() => { setSelectedClient(internal.team); setActiveView('client'); }}
            >
              <Users size={16} style={{ color: internal.team.color }} />
              {!sidebarCollapsed && 'Team'}
            </div>
          )}
        </nav>

        <nav className="nav-section" style={{ flex: 1, overflowY: 'auto' }}>
          {!sidebarCollapsed && <div className="nav-label">Clients</div>}
          {clients.map(client => (
            <div 
              key={client.id}
              className={`nav-item ${selectedClient?.id === client.id ? 'active' : ''}`}
              onClick={() => { setSelectedClient(client); setActiveView('client'); }}
            >
              <div style={{ 
                width: 8, 
                height: 8, 
                borderRadius: '50%', 
                background: client.color,
                flexShrink: 0 
              }} />
              {!sidebarCollapsed && client.name}
            </div>
          ))}
          <div 
            className="nav-item nav-add-item"
            onClick={() => setShowAddClient(true)}
          >
            <Plus size={14} />
            {!sidebarCollapsed && 'Add Client'}
          </div>
        </nav>

        <nav className="nav-section">
          {!sidebarCollapsed && <div className="nav-label">Team</div>}
          {teamMembers.map(member => (
            <div key={member.id} className="nav-item">
              <div style={{ 
                width: 24, 
                height: 24, 
                borderRadius: 6, 
                background: member.color,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: 11,
                fontWeight: 600,
                flexShrink: 0
              }}>
                {member.name[0]}
              </div>
              {!sidebarCollapsed && member.name}
            </div>
          ))}
        </nav>

        {/* Current User & Sign Out */}
        <div className="sidebar-user">
          <div className="sidebar-user-info">
            <div style={{
              width: 32,
              height: 32,
              borderRadius: 8,
              background: currentUser.color,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: 13,
              fontWeight: 600,
              flexShrink: 0
            }}>
              {currentUser.name[0]}
            </div>
            {!sidebarCollapsed && (
              <div className="sidebar-user-details">
                <div className="sidebar-user-name">{currentUser.name}</div>
                <div className="sidebar-user-email">{currentTeamMember.email}</div>
              </div>
            )}
          </div>
          <button
            className="sidebar-signout"
            onClick={onSignOut}
            title="Sign out"
          >
            <LogOut size={16} />
          </button>
        </div>
      </aside>

      {/* Main */}
      <main className="main">
        <header className="header">
          <h1 className="header-title">
            {activeView === 'timeline' ? 'Timeline' : 
             activeView === 'calendar' ? 'Calendar' :
             activeView === 'list' ? 'List View' :
             selectedClient?.name || 'Dashboard'}
          </h1>
          
          <div className="header-actions">
            <button
              className="settings-btn"
              onClick={() => setShowWebhookSettings(true)}
              title="Webhook Settings"
            >
              <Settings size={18} />
            </button>

            <div style={{ position: 'relative' }}>
              <button
                className="notification-btn"
                onClick={() => setShowNotifications(!showNotifications)}
              >
                <Bell size={18} />
                {getUnreadCount() > 0 && (
                  <span className="notification-badge">
                    {getUnreadCount() > 9 ? '9+' : getUnreadCount()}
                  </span>
                )}
              </button>
              
              {showNotifications && (
                <>
                  <div 
                    style={{ 
                      position: 'fixed', 
                      inset: 0, 
                      zIndex: 999 
                    }} 
                    onClick={() => setShowNotifications(false)} 
                  />
                  <div className="notification-dropdown">
                  <div className="notification-header">
                    <h3>Notifications</h3>
                    {getUnreadCount() > 0 && (
                      <button 
                        className="notification-mark-read"
                        onClick={markAllNotificationsRead}
                      >
                        Mark all read
                      </button>
                    )}
                  </div>
                  <div className="notification-list">
                    {getUserNotifications().length === 0 ? (
                      <div className="notification-empty">
                        No notifications yet
                      </div>
                    ) : (
                      getUserNotifications().map(notif => {
                        const actor = teamMembers.find(m => m.id === notif.actorId);
                        return (
                          <div 
                            key={notif.id}
                            className={`notification-item ${!notif.read ? 'unread' : ''}`}
                            onClick={() => {
                              markNotificationRead(notif.id);
                              // Navigate to the entity if applicable
                              if (notif.entityType === 'task') {
                                const task = tasks.find(t => t.id === notif.entityId);
                                if (task) setSelectedTask(task);
                              } else if (notif.entityType === 'event') {
                                const event = events.find(e => e.id === notif.entityId);
                                if (event) setSelectedEvent(event);
                              } else if (notif.entityType === 'list') {
                                const list = lists.find(l => l.id === notif.entityId);
                                if (list) setSelectedList(list);
                              }
                              setShowNotifications(false);
                            }}
                          >
                            <div 
                              className="notification-dot" 
                              style={{ background: actor?.color || '#6366f1' }}
                            />
                            <div className="notification-content">
                              <div className="notification-message">{notif.message}</div>
                              <div className="notification-time">
                                {formatRelativeTime(notif.createdAt)}
                              </div>
                            </div>
                            {!notif.read && <div className="notification-unread-indicator" />}
                          </div>
                        );
                      })
                    )}
                  </div>
                </div>
                </>
              )}
            </div>
          </div>
        </header>

        <div className="content">
          {activeView === 'timeline' && (
            <Timeline
              clients={clients}
              internal={internal}
              events={events}
              tasks={tasks}
              lists={lists}
              teamMembers={teamMembers}
              navigateToClient={navigateToClient}
              toggleTaskComplete={toggleTaskComplete}
              addTask={addTask}
              addEvent={addEvent}
              addList={addList}
              onEventClick={setSelectedEvent}
              onTaskClick={setSelectedTask}
              onListClick={setSelectedList}
              getListProgress={getListProgress}
              currentUser={currentUser}
            />
          )}
          {activeView === 'calendar' && (
            <MonthlyCalendar
              clients={clients}
              internal={internal}
              events={events}
              tasks={tasks}
              lists={lists}
              teamMembers={teamMembers}
              navigateToClient={navigateToClient}
              toggleTaskComplete={toggleTaskComplete}
              addTask={addTask}
              addEvent={addEvent}
              addList={addList}
              onEventClick={setSelectedEvent}
              onTaskClick={setSelectedTask}
              onListClick={setSelectedList}
              getListProgress={getListProgress}
              currentUser={currentUser}
            />
          )}
          {activeView === 'list' && (
            <ListView 
              clients={clients} 
              internal={internal}
              events={events}
              tasks={tasks}
              lists={lists}
              teamMembers={teamMembers}
              currentUserId={currentUser?.id}
              navigateToClient={navigateToClient}
              toggleTaskComplete={toggleTaskComplete}
              addTask={addTask}
              addEvent={addEvent}
              addList={addList}
              onEventClick={setSelectedEvent}
              onTaskClick={setSelectedTask}
              onListClick={setSelectedList}
              getListProgress={getListProgress}
            />
          )}
          {activeView === 'client' && selectedClient && (
            <ClientView 
              client={selectedClient} 
              events={events.filter(e => {
                // Include project-level events
                const project = selectedClient.projects.find(p => p.id === e.projectId);
                if (project) return true;
                // Include client-level events (no project)
                if (e.clientId === selectedClient.id && !e.projectId) return true;
                return false;
              })}
              tasks={tasks.filter(t => t.clientId === selectedClient.id)}
              lists={lists.filter(l => l.clientId === selectedClient.id)}
              notes={notes.filter(n => n.clientId === selectedClient.id)}
              teamMembers={teamMembers}
              allEvents={events}
              clients={clients}
              internal={internal}
              toggleTaskComplete={toggleTaskComplete}
              addTask={addTask}
              addEvent={addEvent}
              addList={addList}
              addNote={addNote}
              addReply={addReply}
              deleteNote={deleteNote}
              deleteReply={deleteReply}
              updateNote={updateNote}
              addProject={addProject}
              deleteProject={deleteProject}
              deleteClient={deleteClient}
              updateClient={updateClient}
              currentUser={currentUser}
              onEventClick={setSelectedEvent}
              onTaskClick={setSelectedTask}
              onListClick={setSelectedList}
              getListProgress={getListProgress}
            />
          )}
        </div>
        
        {/* Add Client Modal */}
        {showAddClient && (
          <AddClientModal 
            onClose={() => setShowAddClient(false)}
            onAdd={addClient}
          />
        )}
        
        {/* Event Modal (Edit) */}
        {selectedEvent && (
          <EventModal
            event={selectedEvent}
            onClose={() => setSelectedEvent(null)}
            onUpdate={updateEvent}
            onDelete={deleteEvent}
            clients={clients}
            internal={internal}
            teamMembers={teamMembers}
            currentUserId={currentUser.id}
            navigateToClient={navigateToClient}
          />
        )}
        
        {/* Task Modal (Edit) */}
        {selectedTask && (
          <TaskModal
            task={selectedTask}
            onClose={() => setSelectedTask(null)}
            onUpdate={updateTask}
            onDelete={deleteTask}
            onToggleComplete={toggleTaskComplete}
            clients={clients}
            internal={internal}
            teamMembers={teamMembers}
            navigateToClient={navigateToClient}
          />
        )}
        
        {/* List Modal (Edit) */}
        {selectedList && (
          <ListModal
            list={selectedList}
            onClose={() => setSelectedList(null)}
            onUpdate={updateList}
            onDelete={deleteList}
            clients={clients}
            internal={internal}
            teamMembers={teamMembers}
            tasks={tasks}
            onToggleTaskComplete={toggleTaskComplete}
            onAddTaskToList={addTaskToList}
            onRemoveTaskFromList={removeTaskFromList}
            onReorderTasks={reorderListTasks}
            onTaskClick={(task) => { setSelectedList(null); setSelectedTask(task); }}
            navigateToClient={navigateToClient}
          />
        )}
      </main>
      {/* Webhook Settings Modal */}
      {showWebhookSettings && (
        <div className="webhook-modal-overlay" onClick={() => setShowWebhookSettings(false)}>
          <div className="webhook-modal" onClick={e => e.stopPropagation()}>
            <h3><Webhook size={20} /> Webhook Settings</h3>
            <p className="webhook-modal-desc">
              Configure a webhook URL to send notification data to external services like N8N, Zapier, or custom endpoints.
              All notifications will be POSTed to this URL in JSON format.
            </p>

            <div className={`webhook-status ${webhookUrl ? 'active' : 'inactive'}`}>
              {webhookUrl ? (
                <>
                  <Check size={16} />
                  <span>Webhook is active</span>
                </>
              ) : (
                <>
                  <X size={16} />
                  <span>Webhook is not configured</span>
                </>
              )}
            </div>

            <div className="webhook-field">
              <label className="webhook-label">Webhook URL</label>
              <input
                type="url"
                className="webhook-input"
                placeholder="https://your-n8n-instance.com/webhook/..."
                value={webhookUrl}
                onChange={(e) => setWebhookUrl(e.target.value)}
              />
            </div>

            <div className="webhook-actions">
              <button
                className="webhook-btn webhook-btn-test"
                disabled={!webhookUrl}
                onClick={async () => {
                  const testPayload = {
                    type: 'test',
                    message: 'This is a test notification from IAPM',
                    timestamp: new Date().toISOString(),
                    actor: {
                      id: currentUser?.id,
                      name: currentUser?.name || 'Test User',
                      email: null,
                      color: currentUser?.color || '#6366f1'
                    },
                    recipient: {
                      id: currentUser?.id,
                      name: currentUser?.name || 'Test User',
                      email: null,
                      color: currentUser?.color || '#6366f1'
                    },
                    entity: {
                      type: 'test',
                      id: 'test-id',
                      title: 'Test Notification'
                    },
                    source: 'iapm',
                    version: '1.0'
                  };
                  try {
                    await fetch(webhookUrl, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(testPayload),
                      mode: 'no-cors'
                    });
                    alert('Test notification sent! Check your webhook endpoint.');
                  } catch (err) {
                    alert('Error sending test: ' + err.message);
                  }
                }}
              >
                <Send size={14} /> Test Webhook
              </button>
              <button
                className="webhook-btn webhook-btn-secondary"
                onClick={() => setShowWebhookSettings(false)}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ==================== CONFIRM DELETE MODAL ====================
function ConfirmDeleteModal({ title, itemName, itemType, affectedItems, onClose, onConfirm }) {
  const [confirmText, setConfirmText] = React.useState('');
  const [isDeleting, setIsDeleting] = React.useState(false);

  const canDelete = confirmText.toLowerCase() === 'delete';

  const handleConfirm = async () => {
    if (!canDelete) return;
    setIsDeleting(true);
    try {
      await onConfirm();
      onClose();
    } catch (err) {
      console.error('Error deleting:', err);
      setIsDeleting(false);
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()} style={{ maxWidth: '420px' }}>
        <style>{`
          .confirm-delete-modal h2 {
            color: #fafafa;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
          }
          .confirm-delete-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
          }
          .confirm-delete-warning-icon {
            color: #ef4444;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
          }
          .confirm-delete-warning p {
            color: #fca5a5;
            font-size: 13px;
            line-height: 1.5;
            margin: 0;
          }
          .confirm-delete-affected {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
          }
          .confirm-delete-affected-title {
            color: #a1a1aa;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          .confirm-delete-affected-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
          }
          .confirm-delete-affected-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            color: #d4d4d8;
          }
          .confirm-delete-affected-item span {
            color: #fafafa;
            font-weight: 500;
          }
          .confirm-delete-input-section {
            margin-bottom: 20px;
          }
          .confirm-delete-input-label {
            color: #a1a1aa;
            font-size: 13px;
            margin-bottom: 8px;
            display: block;
          }
          .confirm-delete-input-label code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: #fafafa;
          }
          .confirm-delete-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fafafa;
            font-size: 14px;
          }
          .confirm-delete-input:focus {
            outline: none;
            border-color: #ef4444;
          }
          .confirm-delete-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
          }
          .confirm-delete-btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
          }
          .confirm-delete-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
          }
          .confirm-delete-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fafafa;
          }
          .confirm-delete-btn-delete {
            background: #ef4444;
            color: white;
          }
          .confirm-delete-btn-delete:hover:not(:disabled) {
            background: #dc2626;
          }
          .confirm-delete-btn-delete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
          }
        `}</style>
        <div className="confirm-delete-modal">
          <h2>{title}</h2>

          <div className="confirm-delete-warning">
            <div className="confirm-delete-warning-icon">
              <span>⚠</span> This action cannot be undone
            </div>
            <p>
              You are about to permanently delete <strong>{itemName}</strong> and all of its associated data.
            </p>
          </div>

          {affectedItems && affectedItems.length > 0 && (
            <div className="confirm-delete-affected">
              <div className="confirm-delete-affected-title">Will be permanently deleted:</div>
              <div className="confirm-delete-affected-list">
                {affectedItems.map((item, i) => (
                  <div key={i} className="confirm-delete-affected-item">
                    <span>{item.count}</span> {item.label}
                  </div>
                ))}
              </div>
            </div>
          )}

          <div className="confirm-delete-input-section">
            <label className="confirm-delete-input-label">
              Type <code>DELETE</code> to confirm:
            </label>
            <input
              type="text"
              className="confirm-delete-input"
              value={confirmText}
              onChange={(e) => setConfirmText(e.target.value)}
              placeholder="Type DELETE here"
              autoFocus
            />
          </div>

          <div className="confirm-delete-actions">
            <button className="confirm-delete-btn confirm-delete-btn-cancel" onClick={onClose}>
              Cancel
            </button>
            <button
              className="confirm-delete-btn confirm-delete-btn-delete"
              onClick={handleConfirm}
              disabled={!canDelete || isDeleting}
            >
              {isDeleting ? 'Deleting...' : 'Delete ' + itemType}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ==================== ADD CLIENT MODAL ====================
function AddClientModal({ onClose, onAdd }) {
  const [name, setName] = React.useState('');
  const [color, setColor] = React.useState('#6366f1');
  const [details, setDetails] = React.useState('');
  
  const colorOptions = [
    '#6366f1', '#8b5cf6', '#a855f7', '#d946ef',
    '#ec4899', '#f43f5e', '#ef4444', '#f97316',
    '#f59e0b', '#eab308', '#84cc16', '#22c55e',
    '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9',
  ];
  
  const handleSubmit = () => {
    if (!name.trim()) return;
    onAdd(name.trim(), color, details.trim());
    onClose();
  };
  
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <style>{`
          .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
          }
          
          .modal-content {
            background: #18181b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            width: 480px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
          }
          
          .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
          }
          
          .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #e4e4e7;
          }
          
          .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.06);
            border: none;
            color: #71717a;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
          }
          
          .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
          }
          
          .modal-body {
            padding: 24px;
            overflow-y: auto;
          }
          
          .modal-field {
            margin-bottom: 20px;
          }
          
          .modal-field:last-child {
            margin-bottom: 0;
          }
          
          .modal-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #a1a1aa;
            margin-bottom: 8px;
          }
          
          .modal-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.15s;
          }
          
          .modal-input:focus {
            border-color: rgba(99, 102, 241, 0.5);
          }
          
          .modal-input::placeholder {
            color: #52525b;
          }
          
          .modal-textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px 16px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            resize: vertical;
            transition: all 0.15s;
          }
          
          .modal-textarea:focus {
            border-color: rgba(99, 102, 241, 0.5);
          }
          
          .modal-textarea::placeholder {
            color: #52525b;
          }
          
          .color-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
          }
          
          .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
          }
          
          .color-option:hover {
            transform: scale(1.1);
          }
          
          .color-option.selected {
            border-color: #fff;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
          }
          
          .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            flex-shrink: 0;
          }
          
          .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
          }
          
          .modal-btn-primary {
            background: #6366f1;
            color: #fff;
          }
          
          .modal-btn-primary:hover {
            background: #5558e3;
          }
          
          .modal-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
          }
          
          .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.06);
            color: #a1a1aa;
            border: 1px solid rgba(255, 255, 255, 0.1);
          }
          
          .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
          }
        `}</style>
        
        <div className="modal-header">
          <span className="modal-title">Add New Client</span>
          <button className="modal-close" onClick={onClose}>
            <X size={18} />
          </button>
        </div>
        
        <div className="modal-body">
          <div className="modal-field">
            <label className="modal-label">Client Name</label>
            <input
              className="modal-input"
              type="text"
              placeholder="Enter client name..."
              value={name}
              onChange={e => setName(e.target.value)}
              autoFocus
            />
          </div>
          
          <div className="modal-field">
            <label className="modal-label">Color</label>
            <div className="color-grid">
              {colorOptions.map(c => (
                <div
                  key={c}
                  className={`color-option ${color === c ? 'selected' : ''}`}
                  style={{ background: c }}
                  onClick={() => setColor(c)}
                />
              ))}
            </div>
          </div>
          
          <div className="modal-field">
            <label className="modal-label">Client Details (optional)</label>
            <textarea
              className="modal-textarea"
              placeholder="Contact info, billing details, notes..."
              value={details}
              onChange={e => setDetails(e.target.value)}
            />
          </div>
        </div>
        
        <div className="modal-footer">
          <button className="modal-btn modal-btn-secondary" onClick={onClose}>Cancel</button>
          <button 
            className="modal-btn modal-btn-primary" 
            onClick={handleSubmit}
            disabled={!name.trim()}
          >
            Add Client
          </button>
        </div>
      </div>
    </div>
  );
}

// ==================== ADD PROJECT MODAL ====================
function AddProjectModal({ client, onClose, onAdd }) {
  const [name, setName] = React.useState('');
  const [color, setColor] = React.useState(client.color);
  
  // Generate color options based on client color
  const colorOptions = [
    client.color,
    '#6366f1', '#8b5cf6', '#a855f7', '#d946ef',
    '#ec4899', '#f43f5e', '#ef4444', '#f97316',
    '#f59e0b', '#eab308', '#84cc16', '#22c55e',
    '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9',
  ];
  
  const handleSubmit = () => {
    if (!name.trim()) return;
    onAdd(client.id, name.trim(), color);
    onClose();
  };
  
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <style>{`
          .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
          }
          
          .modal-content {
            background: #18181b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            width: 400px;
            max-width: 90vw;
            overflow: hidden;
          }
          
          .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
          }
          
          .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #e4e4e7;
          }
          
          .modal-subtitle {
            font-size: 13px;
            color: #71717a;
            margin-top: 4px;
          }
          
          .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.06);
            border: none;
            color: #71717a;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
          }
          
          .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
          }
          
          .modal-body {
            padding: 24px;
          }
          
          .modal-field {
            margin-bottom: 20px;
          }
          
          .modal-field:last-child {
            margin-bottom: 0;
          }
          
          .modal-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #a1a1aa;
            margin-bottom: 8px;
          }
          
          .modal-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.15s;
          }
          
          .modal-input:focus {
            border-color: rgba(99, 102, 241, 0.5);
          }
          
          .modal-input::placeholder {
            color: #52525b;
          }
          
          .color-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
          }
          
          .color-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
          }
          
          .color-option:hover {
            transform: scale(1.1);
          }
          
          .color-option.selected {
            border-color: #fff;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
          }
          
          .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
          }
          
          .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
          }
          
          .modal-btn-primary {
            background: #6366f1;
            color: #fff;
          }
          
          .modal-btn-primary:hover {
            background: #5558e3;
          }
          
          .modal-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
          }
          
          .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.06);
            color: #a1a1aa;
            border: 1px solid rgba(255, 255, 255, 0.1);
          }
          
          .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
          }
        `}</style>
        
        <div className="modal-header">
          <div>
            <div className="modal-title">Add New {client.isInternal ? 'Category' : 'Project'}</div>
            <div className="modal-subtitle">for {client.name}</div>
          </div>
          <button className="modal-close" onClick={onClose}>
            <X size={18} />
          </button>
        </div>
        
        <div className="modal-body">
          <div className="modal-field">
            <label className="modal-label">{client.isInternal ? 'Category' : 'Project'} Name</label>
            <input
              className="modal-input"
              type="text"
              placeholder={client.isInternal ? "Enter category name..." : "Enter project name..."}
              value={name}
              onChange={e => setName(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && handleSubmit()}
              autoFocus
            />
          </div>
          
          <div className="modal-field">
            <label className="modal-label">Color</label>
            <div className="color-grid">
              {colorOptions.map((c, i) => (
                <div
                  key={`${c}-${i}`}
                  className={`color-option ${color === c ? 'selected' : ''}`}
                  style={{ background: c }}
                  onClick={() => setColor(c)}
                />
              ))}
            </div>
          </div>
        </div>
        
        <div className="modal-footer">
          <button className="modal-btn modal-btn-secondary" onClick={onClose}>Cancel</button>
          <button 
            className="modal-btn modal-btn-primary" 
            onClick={handleSubmit}
            disabled={!name.trim()}
          >
            Add {client.isInternal ? 'Category' : 'Project'}
          </button>
        </div>
      </div>
    </div>
  );
}

// ==================== MENTION TEXTAREA COMPONENT ====================
function MentionTextarea({ value, onChange, placeholder, className, teamMembers, onSubmit }) {
  const [showMentions, setShowMentions] = React.useState(false);
  const [mentionFilter, setMentionFilter] = React.useState('');
  const [mentionIndex, setMentionIndex] = React.useState(0);
  const [cursorPosition, setCursorPosition] = React.useState(0);
  const textareaRef = React.useRef(null);
  
  // Filter team members based on what's typed after @
  const filteredMembers = (teamMembers || []).filter(m => 
    m.name.toLowerCase().includes(mentionFilter.toLowerCase())
  );
  
  const handleChange = (e) => {
    const newValue = e.target.value;
    const cursor = e.target.selectionStart;
    setCursorPosition(cursor);
    
    // Check if we should show mention dropdown
    const textBeforeCursor = newValue.slice(0, cursor);
    const atMatch = textBeforeCursor.match(/@(\w*)$/);
    
    if (atMatch) {
      setMentionFilter(atMatch[1]);
      setShowMentions(true);
      setMentionIndex(0);
    } else {
      setShowMentions(false);
    }
    
    onChange(newValue);
  };
  
  const insertMention = (member) => {
    const textBeforeCursor = value.slice(0, cursorPosition);
    const textAfterCursor = value.slice(cursorPosition);
    const atIndex = textBeforeCursor.lastIndexOf('@');
    
    const newValue = textBeforeCursor.slice(0, atIndex) + '@' + member.name + ' ' + textAfterCursor;
    onChange(newValue);
    setShowMentions(false);
    
    // Focus back on textarea
    setTimeout(() => {
      if (textareaRef.current) {
        textareaRef.current.focus();
        const newCursor = atIndex + member.name.length + 2;
        textareaRef.current.setSelectionRange(newCursor, newCursor);
      }
    }, 0);
  };
  
  const handleKeyDown = (e) => {
    if (showMentions) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        setMentionIndex(i => Math.min(i + 1, filteredMembers.length - 1));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        setMentionIndex(i => Math.max(i - 1, 0));
      } else if (e.key === 'Enter' && filteredMembers.length > 0) {
        e.preventDefault();
        insertMention(filteredMembers[mentionIndex]);
      } else if (e.key === 'Escape') {
        setShowMentions(false);
      }
    } else if (e.key === 'Enter' && !e.shiftKey && onSubmit) {
      e.preventDefault();
      onSubmit();
    }
  };
  
  // Render text with highlighted mentions
  const renderHighlightedText = () => {
    if (!value) return null;
    const parts = value.split(/(@\w+)/g);
    return parts.map((part, i) => {
      if (part.startsWith('@')) {
        const name = part.slice(1);
        const member = teamMembers?.find(m => m.name === name);
        if (member) {
          return (
            <span key={i} style={{ color: member.color, fontWeight: 500 }}>
              {part}
            </span>
          );
        }
      }
      return <span key={i}>{part}</span>;
    });
  };
  
  return (
    <div className="mention-textarea-wrapper">
      <style>{`
        .mention-textarea-wrapper {
          position: relative;
          width: 100%;
          flex: 1;
        }
        .mention-dropdown {
          position: absolute;
          bottom: calc(100% + 4px);
          left: 0;
          right: 0;
          background: #1c1c1f;
          border: 1px solid rgba(255, 255, 255, 0.15);
          border-radius: 8px;
          box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
          z-index: 100;
          max-height: 180px;
          overflow-y: auto;
        }
        .mention-option {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 10px 12px;
          cursor: pointer;
          transition: background 0.15s;
        }
        .mention-option:hover,
        .mention-option.selected {
          background: rgba(99, 102, 241, 0.15);
        }
        .mention-avatar {
          width: 24px;
          height: 24px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 10px;
          font-weight: 600;
          color: #fff;
        }
        .mention-name {
          font-size: 13px;
          color: #e4e4e7;
        }
        .mention-hint {
          font-size: 11px;
          color: #52525b;
          padding: 6px 12px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }
      `}</style>
      
      {showMentions && filteredMembers.length > 0 && (
        <div className="mention-dropdown">
          <div className="mention-hint">Select a team member</div>
          {filteredMembers.map((member, i) => (
            <div
              key={member.id}
              className={`mention-option ${i === mentionIndex ? 'selected' : ''}`}
              onClick={() => insertMention(member)}
            >
              <div className="mention-avatar" style={{ background: member.color }}>
                {member.name.split(' ').map(n => n[0]).join('')}
              </div>
              <span className="mention-name">{member.name}</span>
            </div>
          ))}
        </div>
      )}
      
      <textarea
        ref={textareaRef}
        className={className}
        placeholder={placeholder || "Add notes... Type @ to mention someone"}
        value={value}
        onChange={handleChange}
        onKeyDown={handleKeyDown}
        onBlur={() => setTimeout(() => setShowMentions(false), 150)}
      />
    </div>
  );
}

// Single-line mention input for replies
function MentionInput({ value, onChange, onSubmit, placeholder, teamMembers }) {
  const [showMentions, setShowMentions] = React.useState(false);
  const [mentionFilter, setMentionFilter] = React.useState('');
  const [mentionIndex, setMentionIndex] = React.useState(0);
  const [cursorPosition, setCursorPosition] = React.useState(0);
  const inputRef = React.useRef(null);
  
  const filteredMembers = (teamMembers || []).filter(m => 
    m.name.toLowerCase().includes(mentionFilter.toLowerCase())
  );
  
  const handleChange = (e) => {
    const newValue = e.target.value;
    const cursor = e.target.selectionStart;
    setCursorPosition(cursor);
    
    const textBeforeCursor = newValue.slice(0, cursor);
    const atMatch = textBeforeCursor.match(/@(\w*)$/);
    
    if (atMatch) {
      setMentionFilter(atMatch[1]);
      setShowMentions(true);
      setMentionIndex(0);
    } else {
      setShowMentions(false);
    }
    
    onChange(newValue);
  };
  
  const insertMention = (member) => {
    const textBeforeCursor = value.slice(0, cursorPosition);
    const textAfterCursor = value.slice(cursorPosition);
    const atIndex = textBeforeCursor.lastIndexOf('@');
    
    const newValue = textBeforeCursor.slice(0, atIndex) + '@' + member.name + ' ' + textAfterCursor;
    onChange(newValue);
    setShowMentions(false);
    
    setTimeout(() => {
      if (inputRef.current) {
        inputRef.current.focus();
        const newCursor = atIndex + member.name.length + 2;
        inputRef.current.setSelectionRange(newCursor, newCursor);
      }
    }, 0);
  };
  
  const handleKeyDown = (e) => {
    if (showMentions && filteredMembers.length > 0) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        setMentionIndex(i => Math.min(i + 1, filteredMembers.length - 1));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        setMentionIndex(i => Math.max(i - 1, 0));
      } else if (e.key === 'Enter') {
        e.preventDefault();
        insertMention(filteredMembers[mentionIndex]);
        return;
      } else if (e.key === 'Escape') {
        setShowMentions(false);
      }
    } else if (e.key === 'Enter' && onSubmit) {
      onSubmit();
    }
  };
  
  return (
    <div className="mention-input-wrapper">
      <style>{`
        .mention-input-wrapper {
          position: relative;
          flex: 1;
        }
        .mention-input-wrapper input {
          width: 100%;
        }
        .mention-input-dropdown {
          position: absolute;
          bottom: calc(100% + 4px);
          left: 0;
          right: 0;
          background: #1c1c1f;
          border: 1px solid rgba(255, 255, 255, 0.15);
          border-radius: 8px;
          box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
          z-index: 100;
          max-height: 150px;
          overflow-y: auto;
        }
      `}</style>
      
      {showMentions && filteredMembers.length > 0 && (
        <div className="mention-input-dropdown">
          {filteredMembers.slice(0, 5).map((member, i) => (
            <div
              key={member.id}
              className={`mention-option ${i === mentionIndex ? 'selected' : ''}`}
              onClick={() => insertMention(member)}
            >
              <div className="mention-avatar" style={{ background: member.color }}>
                {member.name.split(' ').map(n => n[0]).join('')}
              </div>
              <span className="mention-name">{member.name}</span>
            </div>
          ))}
        </div>
      )}
      
      <input
        ref={inputRef}
        type="text"
        placeholder={placeholder || "Write a reply... @ to mention"}
        value={value}
        onChange={handleChange}
        onKeyDown={handleKeyDown}
        onBlur={() => setTimeout(() => setShowMentions(false), 150)}
      />
    </div>
  );
}

// ==================== EVENT MODAL (Create & Edit) ====================
function EventModal({ event, onClose, onSave, onUpdate, onDelete, clients, internal, teamMembers, currentUserId, defaultClientId, defaultProjectId, navigateToClient }) {
  const isExistingEvent = !!event;
  const allSpaces = [internal.personal, internal.team, ...clients];
  
  // Visibility options
  const visibilityOptions = [
    { value: 'team', label: 'Entire Team', icon: '👥', description: 'Everyone can see this event' },
    { value: 'attendees', label: 'Attendees Only', icon: '🔒', description: 'Only selected attendees can see' },
    { value: 'private', label: 'Private', icon: '👤', description: 'Only you can see this event' },
  ];
  
  // State for view/edit mode (existing events start in view mode)
  const [isEditing, setIsEditing] = React.useState(!isExistingEvent);
  
  // Find client info for existing event
  let existingClientId = defaultClientId || '';
  let existingProjectId = defaultProjectId || '';
  let clientInfo = null;
  let projectInfo = null;
  
  if (isExistingEvent) {
    // Find by projectId first
    for (const space of allSpaces) {
      const project = space.projects.find(p => p.id === event.projectId);
      if (project) {
        existingClientId = space.id;
        existingProjectId = project.id;
        clientInfo = space;
        projectInfo = project;
        break;
      }
    }
    // If no project, use clientId
    if (!clientInfo && event.clientId) {
      clientInfo = allSpaces.find(s => s.id === event.clientId);
      existingClientId = event.clientId;
    }
  }
  
  // Get default times (next hour, 1 hour duration)
  const defaults = getDefaultEventTimes();
  
  // Parse existing event times if editing
  const getInitialTimeValues = () => {
    if (isExistingEvent && event.startTime) {
      const start = new Date(event.startTime);
      const end = new Date(event.endTime);
      const startH = start.getHours();
      const endH = end.getHours();
      // Use local date values (not toISOString which converts to UTC)
      const year = start.getFullYear();
      const month = String(start.getMonth() + 1).padStart(2, '0');
      const day = String(start.getDate()).padStart(2, '0');
      return {
        date: `${year}-${month}-${day}`,
        startHour: startH === 0 ? 12 : startH > 12 ? startH - 12 : startH,
        startMinute: Math.round(start.getMinutes() / 15) * 15 % 60,
        startAmpm: startH < 12 ? 'AM' : 'PM',
        endHour: endH === 0 ? 12 : endH > 12 ? endH - 12 : endH,
        endMinute: Math.round(end.getMinutes() / 15) * 15 % 60,
        endAmpm: endH < 12 ? 'AM' : 'PM',
      };
    }
    return {
      date: defaults.date,
      startHour: defaults.startHour,
      startMinute: defaults.startMinute,
      startAmpm: defaults.startAmpm,
      endHour: defaults.endHour,
      endMinute: defaults.endMinute,
      endAmpm: defaults.endAmpm,
    };
  };
  
  const initialTime = getInitialTimeValues();
  
  // Get initial attendees
  const getInitialAttendees = () => {
    if (isExistingEvent && event.attendees) {
      return event.attendees;
    }
    return currentUserId ? [currentUserId] : (teamMembers?.[0]?.id ? [teamMembers[0].id] : []);
  };
  
  // Get initial visibility
  const getInitialVisibility = () => {
    if (isExistingEvent && event.visibility) {
      return event.visibility.type || 'team';
    }
    return 'team';
  };
  
  // Get initial canEdit list
  const getInitialCanEdit = () => {
    if (isExistingEvent && event.visibility?.canEdit) {
      return event.visibility.canEdit;
    }
    return currentUserId ? [currentUserId] : [];
  };
  
  const [title, setTitle] = React.useState(isExistingEvent ? event.title : '');
  const [clientId, setClientId] = React.useState(existingClientId);
  const [projectId, setProjectId] = React.useState(existingProjectId);
  const [date, setDate] = React.useState(initialTime.date);
  const [startHour, setStartHour] = React.useState(initialTime.startHour);
  const [startMinute, setStartMinute] = React.useState(initialTime.startMinute);
  const [startAmpm, setStartAmpm] = React.useState(initialTime.startAmpm);
  const [endHour, setEndHour] = React.useState(initialTime.endHour);
  const [endMinute, setEndMinute] = React.useState(initialTime.endMinute);
  const [endAmpm, setEndAmpm] = React.useState(initialTime.endAmpm);
  const [isAllDay, setIsAllDay] = React.useState(isExistingEvent ? (event.allDay || false) : false);
  const [location, setLocation] = React.useState(isExistingEvent ? (event.location || '') : '');
  const [eventDescription, setEventDescription] = React.useState(isExistingEvent ? (event.notes || '') : '');
  const [attendees, setAttendees] = React.useState(getInitialAttendees);
  const [visibilityType, setVisibilityType] = React.useState(getInitialVisibility);
  const [canEdit, setCanEdit] = React.useState(getInitialCanEdit);
  const [showAttendeesDropdown, setShowAttendeesDropdown] = React.useState(false);
  const [showVisibilityDropdown, setShowVisibilityDropdown] = React.useState(false);
  const [isSaving, setIsSaving] = React.useState(false);
  
  // Get projects for selected client
  const selectedClient = allSpaces.find(s => s.id === clientId);
  const availableProjects = selectedClient?.projects || [];
  
  // Get current visibility info
  const currentVisibility = visibilityOptions.find(v => v.value === visibilityType) || visibilityOptions[0];
  
  // Toggle attendee
  const toggleAttendee = (memberId) => {
    if (attendees.includes(memberId)) {
      // Don't remove if it's the only attendee or if it's the creator
      if (attendees.length > 1 && memberId !== currentUserId) {
        setAttendees(attendees.filter(id => id !== memberId));
        setCanEdit(canEdit.filter(id => id !== memberId));
      }
    } else {
      setAttendees([...attendees, memberId]);
    }
  };
  
  // Toggle can edit
  const toggleCanEdit = (memberId) => {
    if (canEdit.includes(memberId)) {
      // Don't remove edit rights from creator
      if (memberId !== currentUserId && memberId !== (isExistingEvent ? event.createdBy : currentUserId)) {
        setCanEdit(canEdit.filter(id => id !== memberId));
      }
    } else {
      setCanEdit([...canEdit, memberId]);
    }
  };
  
  // Select all attendees
  const selectAllAttendees = () => {
    setAttendees(teamMembers?.map(m => m.id) || []);
  };
  
  // Calculate original duration in minutes for existing events
  const getOriginalDurationMinutes = () => {
    if (isExistingEvent && event.startTime && event.endTime) {
      const start = new Date(event.startTime);
      const end = new Date(event.endTime);
      return Math.round((end - start) / (1000 * 60));
    }
    return 60; // Default 1 hour
  };

  // Convert 12-hour time to minutes since midnight
  const timeToMinutes = (hour, minute, ampm) => {
    let h = hour;
    if (ampm === 'PM' && hour !== 12) h += 12;
    if (ampm === 'AM' && hour === 12) h = 0;
    return h * 60 + minute;
  };

  // Convert minutes since midnight to 12-hour format
  const minutesToTime = (totalMinutes) => {
    const h = Math.floor(totalMinutes / 60) % 24;
    const m = totalMinutes % 60;
    const hour = h === 0 ? 12 : h > 12 ? h - 12 : h;
    const ampm = h < 12 ? 'AM' : 'PM';
    return { hour, minute: m, ampm };
  };

  // Handle start time change - auto update end time
  const handleStartTimeChange = (field, value) => {
    if (field === 'hour') setStartHour(value);
    else if (field === 'minute') setStartMinute(value);
    else if (field === 'ampm') setStartAmpm(value);

    const newHour = field === 'hour' ? value : startHour;
    const newMinute = field === 'minute' ? value : startMinute;
    const newAmpm = field === 'ampm' ? value : startAmpm;

    // For new events: 1 hour duration
    // For existing events: maintain original duration
    const durationMinutes = isExistingEvent ? getOriginalDurationMinutes() : 60;

    const startMinutes = timeToMinutes(newHour, newMinute, newAmpm);
    const endMinutes = startMinutes + durationMinutes;
    const endTime = minutesToTime(endMinutes);

    setEndHour(endTime.hour);
    setEndMinute(endTime.minute);
    setEndAmpm(endTime.ampm);
  };
  
  // Cancel editing - reset to original values
  const handleCancelEdit = () => {
    if (isExistingEvent) {
      setTitle(event.title);
      setClientId(existingClientId);
      setProjectId(existingProjectId);
      setDate(initialTime.date);
      setStartHour(initialTime.startHour);
      setStartMinute(initialTime.startMinute);
      setStartAmpm(initialTime.startAmpm);
      setEndHour(initialTime.endHour);
      setEndMinute(initialTime.endMinute);
      setEndAmpm(initialTime.endAmpm);
      setLocation(event.location || '');
      setEventDescription(event.notes || '');
      setAttendees(getInitialAttendees());
      setVisibilityType(getInitialVisibility());
      setCanEdit(getInitialCanEdit());
      setIsEditing(false);
    }
  };
  
  const handleSubmit = async () => {
    if (!title.trim() || !clientId || !date) return;
    if (isSaving) return; // Prevent double-clicks

    setIsSaving(true);

    // For all-day events, use 12:15am to 11:45pm to span full day
    let startTimeDate, endTimeDate;
    if (isAllDay) {
      startTimeDate = new Date(`${date}T00:15:00`);
      endTimeDate = new Date(`${date}T23:45:00`);
    } else {
      const startTimeStr = formatTimeString(startHour, startMinute, startAmpm);
      const endTimeStr = formatTimeString(endHour, endMinute, endAmpm);
      startTimeDate = new Date(`${date}T${startTimeStr}`);
      endTimeDate = new Date(`${date}T${endTimeStr}`);
    }

    const eventData = {
      clientId,
      projectId: projectId || null,
      title: title.trim(),
      startTime: startTimeDate,
      endTime: endTimeDate,
      allDay: isAllDay,
      location: location.trim(),
      notes: eventDescription.trim(),
      attendees: attendees,
      createdBy: isExistingEvent ? event.createdBy : currentUserId,
      visibility: {
        type: visibilityType,
        canEdit: canEdit
      }
    };

    try {
      if (isExistingEvent) {
        console.log('Updating event:', event.id, eventData);
        await onUpdate(event.id, eventData);
      } else {
        console.log('Creating new event:', eventData);
        await onSave(eventData);
      }
      onClose();
    } catch (err) {
      console.error('Error saving event:', err);
      setIsSaving(false);
    }
  };
  
  // Format time for display
  const formatDisplayTime = (hour, minute, ampm) => {
    return `${hour}:${minute.toString().padStart(2, '0')} ${ampm}`;
  };
  
  // Format date for display
  const formatDisplayDate = (dateStr) => {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
  };
  
  return (
    <div className="event-modal-overlay" onClick={onClose}>
      <div className="event-modal" onClick={e => e.stopPropagation()}>
        <style>{`
          .event-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
          }
          .event-modal {
            background: #18181b;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            width: 440px;
            max-width: 95vw;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
          }
          .event-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
          }
          .event-modal-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
          }
          .event-modal-title {
            font-size: 14px;
            font-weight: 600;
            color: #e4e4e7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          .event-modal-edit-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.1s ease;
          }
          .event-modal-edit-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: #f4f4f5;
          }
          .event-modal-close {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #71717a;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s ease;
          }
          .event-modal-close:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: #f4f4f5;
          }
          .event-modal-body {
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            overflow-y: auto;
          }
          .event-modal-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
          }
          .event-modal-label {
            font-size: 10px;
            font-weight: 600;
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          .event-modal-value {
            font-size: 14px;
            color: #f4f4f5;
            line-height: 1.5;
          }
          .event-modal-value.empty {
            color: #52525b;
            font-style: italic;
          }
          .event-modal-value.notes {
            white-space: pre-wrap;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 10px 12px;
            border-radius: 2px;
            font-size: 13px;
          }
          .event-modal-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
          }
          .event-modal-badge {
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: white;
            border: none;
            cursor: pointer;
            transition: opacity 0.1s ease;
          }
          .event-modal-badge:hover {
            opacity: 0.85;
          }
          .event-modal-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            padding: 9px 12px;
            color: #f4f4f5;
            font-size: 13px;
            outline: none;
            transition: border-color 0.1s ease;
            box-sizing: border-box;
          }
          .event-modal-input:focus {
            border-color: rgba(99, 102, 241, 0.6);
          }
          .event-modal-input::placeholder {
            color: #52525b;
          }
          .event-modal-select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            padding: 9px 12px;
            color: #f4f4f5;
            font-size: 13px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.1s ease;
            box-sizing: border-box;
          }
          .event-modal-select:focus {
            border-color: rgba(99, 102, 241, 0.6);
          }
          .event-modal-row {
            display: flex;
            gap: 10px;
          }
          .event-modal-row > * {
            flex: 1;
          }
          .event-modal-time-row {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
          }
          .event-modal-time-group {
            display: flex;
            align-items: center;
            gap: 3px;
          }
          .event-modal-time-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            padding: 7px 5px;
            color: #f4f4f5;
            font-size: 12px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.1s ease;
          }
          .event-modal-time-select:focus {
            border-color: rgba(99, 102, 241, 0.6);
          }
          .event-modal-time-colon {
            color: #71717a;
            font-size: 12px;
          }
          .event-modal-time-separator {
            color: #71717a;
            font-size: 12px;
            padding: 0 4px;
          }
          .event-modal-textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            padding: 9px 12px;
            color: #f4f4f5;
            font-size: 13px;
            outline: none;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            transition: border-color 0.1s ease;
            box-sizing: border-box;
          }
          .event-modal-textarea:focus {
            border-color: rgba(99, 102, 241, 0.5);
          }
          
          /* Attendees & Visibility Styles */
          .event-modal-attendees-selector {
            position: relative;
          }
          .event-modal-attendees-trigger {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 9px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.1s ease;
            flex-wrap: wrap;
          }
          .event-modal-attendees-trigger:hover {
            background: rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
          }
          .event-modal-attendee-chip {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
          }
          .event-modal-attendee-chip.can-edit::after {
            content: '✎';
            font-size: 9px;
            opacity: 0.7;
          }
          .event-modal-attendees-placeholder {
            color: #71717a;
            font-size: 13px;
          }
          .event-modal-attendees-arrow {
            margin-left: auto;
            color: #71717a;
          }
          .event-modal-attendees-dropdown {
            position: absolute;
            top: calc(100% + 2px);
            left: 0;
            right: 0;
            background: #1c1c1f;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 100;
            overflow: hidden;
            max-height: 280px;
            overflow-y: auto;
          }
          .event-modal-attendees-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
          }
          .event-modal-attendees-header-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #71717a;
          }
          .event-modal-select-all {
            background: none;
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: #6366f1;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 2px;
            transition: all 0.1s ease;
          }
          .event-modal-select-all:hover {
            background: rgba(99, 102, 241, 0.15);
          }
          .event-modal-attendee-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 12px;
            cursor: pointer;
            transition: background 0.1s ease;
          }
          .event-modal-attendee-option:hover {
            background: rgba(255, 255, 255, 0.06);
          }
          .event-modal-attendee-checkbox {
            width: 14px;
            height: 14px;
            border-radius: 2px;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s ease;
            flex-shrink: 0;
          }
          .event-modal-attendee-checkbox.checked {
            background: #6366f1;
            border-color: #6366f1;
          }
          .event-modal-attendee-color {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            flex-shrink: 0;
          }
          .event-modal-attendee-name {
            flex: 1;
            font-size: 12px;
            color: #e4e4e7;
          }
          .event-modal-edit-toggle {
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #71717a;
            padding: 3px 6px;
            border-radius: 2px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.1s ease;
          }
          .event-modal-edit-toggle:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
          }
          .event-modal-edit-toggle.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.4);
            color: #a5b4fc;
          }
          
          .event-modal-visibility-selector {
            position: relative;
          }
          .event-modal-visibility-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 9px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.1s ease;
          }
          .event-modal-visibility-trigger:hover {
            background: rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
          }
          .event-modal-visibility-icon {
            font-size: 14px;
          }
          .event-modal-visibility-label {
            font-size: 13px;
            color: #e4e4e7;
          }
          .event-modal-visibility-desc {
            font-size: 11px;
            color: #71717a;
            margin-left: 4px;
          }
          .event-modal-visibility-arrow {
            margin-left: auto;
            color: #71717a;
          }
          .event-modal-visibility-dropdown {
            position: absolute;
            top: calc(100% + 2px);
            left: 0;
            right: 0;
            background: #1c1c1f;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
          }
          .event-modal-visibility-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.1s ease;
          }
          .event-modal-visibility-option:hover {
            background: rgba(255, 255, 255, 0.06);
          }
          .event-modal-visibility-option.selected {
            background: rgba(99, 102, 241, 0.12);
          }
          .event-modal-visibility-option-content {
            flex: 1;
          }
          .event-modal-visibility-option-label {
            font-size: 13px;
            color: #e4e4e7;
            margin-bottom: 2px;
          }
          .event-modal-visibility-option-desc {
            font-size: 11px;
            color: #71717a;
          }

          /* View mode attendees display */
          .event-modal-attendees-display {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
          }
          .event-modal-attendee-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
            color: #fff;
          }
          .event-modal-attendee-badge.can-edit::after {
            content: '✎';
            font-size: 9px;
            opacity: 0.7;
            margin-left: 2px;
          }
          .event-modal-visibility-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #a1a1aa;
          }
          
          .event-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
          }
          .event-modal-footer-left {
            display: flex;
            gap: 8px;
          }
          .event-modal-footer-right {
            display: flex;
            gap: 8px;
          }
          .event-modal-btn {
            padding: 8px 16px;
            border-radius: 2px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.1s ease;
            border: none;
          }
          .event-modal-btn-secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #a1a1aa;
          }
          .event-modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: #f4f4f5;
          }
          .event-modal-btn-primary {
            background: #6366f1;
            color: white;
          }
          .event-modal-btn-primary:hover {
            background: #5558e3;
          }
          .event-modal-btn-primary:disabled {
            background: #3f3f46;
            color: #71717a;
            cursor: not-allowed;
          }
          .event-modal-btn-danger {
            background: transparent;
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
          }
          .event-modal-btn-danger:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.5);
          }
        `}</style>
        
        <div className="event-modal-header">
          <div className="event-modal-header-left">
            <div className="event-modal-title">
              {isExistingEvent ? (isEditing ? 'Edit Event' : 'Event Details') : 'New Event'}
            </div>
            {isExistingEvent && !isEditing && (
              canEdit.includes(currentUserId) || event?.createdBy === currentUserId
            ) && (
              <button className="event-modal-edit-btn" onClick={() => setIsEditing(true)}>
                <Edit2 size={14} /> Edit
              </button>
            )}
          </div>
          <button className="event-modal-close" onClick={onClose}>
            <X size={18} />
          </button>
        </div>
        
        <div className="event-modal-body">
          {/* VIEW MODE for existing events */}
          {isExistingEvent && !isEditing ? (
            <>
              <div className="event-modal-field">
                <label className="event-modal-label">Title</label>
                <div className="event-modal-value">{event.title}</div>
              </div>
              
              <div className="event-modal-field">
                <label className="event-modal-label">Location</label>
                <div className={`event-modal-value ${!event.location ? 'empty' : ''}`}>
                  {event.location || 'No location'}
                </div>
              </div>
              
              <div className="event-modal-field">
                <label className="event-modal-label">Client / Project</label>
                <div className="event-modal-badges">
                  {clientInfo && (
                    <button 
                      className="event-modal-badge" 
                      style={{ background: clientInfo.color }}
                      onClick={() => { onClose(); navigateToClient && navigateToClient(clientInfo.id); }}
                    >
                      {clientInfo.name}
                    </button>
                  )}
                  {projectInfo && (
                    <button 
                      className="event-modal-badge" 
                      style={{ background: projectInfo.color }}
                      onClick={() => { onClose(); navigateToClient && navigateToClient(clientInfo.id, projectInfo.id); }}
                    >
                      {projectInfo.name}
                    </button>
                  )}
                  {!clientInfo && !projectInfo && (
                    <div className="event-modal-value empty">No client assigned</div>
                  )}
                </div>
              </div>
              
              <div className="event-modal-field">
                <label className="event-modal-label">Date</label>
                <div className="event-modal-value">{formatDisplayDate(date)}</div>
              </div>
              
              <div className="event-modal-field">
                <label className="event-modal-label">Time</label>
                <div className="event-modal-value">
                  {formatDisplayTime(startHour, startMinute, startAmpm)} – {formatDisplayTime(endHour, endMinute, endAmpm)}
                </div>
              </div>
              
              <div className="event-modal-field">
                <label className="event-modal-label">Attendees</label>
                <div className="event-modal-attendees-display">
                  {attendees.length > 0 ? attendees.map(id => {
                    const member = teamMembers?.find(m => m.id === id);
                    if (!member) return null;
                    const hasEditRights = canEdit.includes(id);
                    return (
                      <span 
                        key={id}
                        className={`event-modal-attendee-badge ${hasEditRights ? 'can-edit' : ''}`}
                        style={{ background: member.color }}
                        title={hasEditRights ? `${member.name} (can edit)` : member.name}
                      >
                        {member.name}
                      </span>
                    );
                  }) : (
                    <div className="event-modal-value empty">No attendees</div>
                  )}
                </div>
              </div>
              
              <div className="event-modal-field">
                <label className="event-modal-label">Visibility</label>
                <div className="event-modal-visibility-display">
                  <span>{currentVisibility.icon}</span>
                  <span>{currentVisibility.label}</span>
                  <span style={{ color: '#52525b' }}>– {currentVisibility.description}</span>
                </div>
              </div>

              <div className="event-modal-field">
                <label className="event-modal-label">Notes</label>
                <div className={`event-modal-value ${!event.notes ? 'empty' : 'notes'}`}>
                  {event.notes ? <MarkdownText text={event.notes} /> : 'No notes'}
                </div>
              </div>
            </>
          ) : (
            /* EDIT MODE for both new and existing events */
            <>
              <div className="event-modal-field">
                <label className="event-modal-label">Title</label>
                <input
                  type="text"
                  className="event-modal-input"
                  placeholder="Event title"
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  autoFocus
                />
              </div>
              
              <div className="event-modal-field">
                <label className="event-modal-label">Location (optional)</label>
                <input
                  type="text"
                  className="event-modal-input"
                  placeholder="Add location"
                  value={location}
                  onChange={(e) => setLocation(e.target.value)}
                />
              </div>
              
              <div className="event-modal-row">
                <div className="event-modal-field">
                  <label className="event-modal-label">Client / Space</label>
                  <select
                    className="event-modal-select"
                    value={clientId}
                    onChange={(e) => { setClientId(e.target.value); setProjectId(''); }}
                  >
                    <option value="">Select...</option>
                    {allSpaces.map(space => (
                      <option key={space.id} value={space.id}>{space.name}</option>
                    ))}
                  </select>
                </div>
                
                <div className="event-modal-field">
                  <label className="event-modal-label">Project (optional)</label>
                  <select
                    className="event-modal-select"
                    value={projectId}
                    onChange={(e) => setProjectId(e.target.value)}
                    disabled={!clientId || availableProjects.length === 0}
                  >
                    <option value="">None</option>
                    {availableProjects.map(p => (
                      <option key={p.id} value={p.id}>{p.name}</option>
                    ))}
                  </select>
                </div>
              </div>
              
              <div className="event-modal-field">
                <label className="event-modal-label">Date</label>
                <input
                  type="date"
                  className="event-modal-input"
                  value={date}
                  onChange={(e) => setDate(e.target.value)}
                />
              </div>

              <div className="event-modal-field" style={{ flexDirection: 'row', alignItems: 'center', gap: 8 }}>
                <input
                  type="checkbox"
                  id="allday-toggle"
                  checked={isAllDay}
                  onChange={(e) => setIsAllDay(e.target.checked)}
                  style={{ width: 16, height: 16, cursor: 'pointer' }}
                />
                <label htmlFor="allday-toggle" style={{ cursor: 'pointer', fontSize: 13 }}>All day event</label>
              </div>

              {!isAllDay && (
              <div className="event-modal-field">
                <label className="event-modal-label">Time</label>
                <div className="event-modal-time-row">
                  <div className="event-modal-time-group">
                    <select
                      className="event-modal-time-select"
                      value={startHour}
                      onChange={(e) => handleStartTimeChange('hour', parseInt(e.target.value))}
                      style={{ width: 50 }}
                    >
                      {HOUR_OPTIONS.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                      ))}
                    </select>
                    <span className="event-modal-time-colon">:</span>
                    <select
                      className="event-modal-time-select"
                      value={startMinute}
                      onChange={(e) => handleStartTimeChange('minute', parseInt(e.target.value))}
                      style={{ width: 50 }}
                    >
                      {MINUTE_OPTIONS.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                      ))}
                    </select>
                    <select
                      className="event-modal-time-select"
                      value={startAmpm}
                      onChange={(e) => handleStartTimeChange('ampm', e.target.value)}
                      style={{ width: 55 }}
                    >
                      {AMPM_OPTIONS.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                      ))}
                    </select>
                  </div>
                  
                  <span className="event-modal-time-separator">to</span>
                  
                  <div className="event-modal-time-group">
                    <select
                      className="event-modal-time-select"
                      value={endHour}
                      onChange={(e) => setEndHour(parseInt(e.target.value))}
                      style={{ width: 50 }}
                    >
                      {HOUR_OPTIONS.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                      ))}
                    </select>
                    <span className="event-modal-time-colon">:</span>
                    <select
                      className="event-modal-time-select"
                      value={endMinute}
                      onChange={(e) => setEndMinute(parseInt(e.target.value))}
                      style={{ width: 50 }}
                    >
                      {MINUTE_OPTIONS.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                      ))}
                    </select>
                    <select
                      className="event-modal-time-select"
                      value={endAmpm}
                      onChange={(e) => setEndAmpm(e.target.value)}
                      style={{ width: 55 }}
                    >
                      {AMPM_OPTIONS.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>
              )}

              <div className="event-modal-field">
                <label className="event-modal-label">Notes (optional)</label>
                <MentionTextarea
                  className="event-modal-textarea"
                  placeholder="Add notes... Type @ to mention someone"
                  value={eventDescription}
                  onChange={setEventDescription}
                  teamMembers={teamMembers}
                />
              </div>
              
              {/* Attendees Selector */}
              <div className="event-modal-field">
                <label className="event-modal-label">Attendees</label>
                <div className="event-modal-attendees-selector">
                  <div 
                    className="event-modal-attendees-trigger"
                    onClick={() => setShowAttendeesDropdown(!showAttendeesDropdown)}
                  >
                    {attendees.length > 0 ? (
                      attendees.map(id => {
                        const member = teamMembers?.find(m => m.id === id);
                        if (!member) return null;
                        const hasEditRights = canEdit.includes(id);
                        return (
                          <span 
                            key={id}
                            className={`event-modal-attendee-chip ${hasEditRights ? 'can-edit' : ''}`}
                            style={{ background: member.color, color: '#fff' }}
                          >
                            {member.name}
                          </span>
                        );
                      })
                    ) : (
                      <span className="event-modal-attendees-placeholder">Select attendees...</span>
                    )}
                    <ChevronDown size={14} className="event-modal-attendees-arrow" />
                  </div>
                  {showAttendeesDropdown && (
                    <>
                      <div 
                        style={{ position: 'fixed', inset: 0, zIndex: 99 }}
                        onClick={() => setShowAttendeesDropdown(false)}
                      />
                      <div className="event-modal-attendees-dropdown">
                        <div className="event-modal-attendees-header">
                          <span className="event-modal-attendees-header-title">Team Members</span>
                          <button 
                            className="event-modal-select-all"
                            onClick={(e) => { e.stopPropagation(); selectAllAttendees(); }}
                          >
                            Select All
                          </button>
                        </div>
                        {teamMembers?.map(member => {
                          const isAttendee = attendees.includes(member.id);
                          const hasEditRights = canEdit.includes(member.id);
                          const isCreator = member.id === currentUserId || member.id === (isExistingEvent ? event.createdBy : currentUserId);
                          return (
                            <div 
                              key={member.id}
                              className="event-modal-attendee-option"
                            >
                              <div 
                                className={`event-modal-attendee-checkbox ${isAttendee ? 'checked' : ''}`}
                                onClick={() => toggleAttendee(member.id)}
                              >
                                {isAttendee && <Check size={10} color="#fff" />}
                              </div>
                              <div 
                                className="event-modal-attendee-color" 
                                style={{ background: member.color }}
                              />
                              <span 
                                className="event-modal-attendee-name"
                                onClick={() => toggleAttendee(member.id)}
                              >
                                {member.name}
                                {isCreator && ' (organizer)'}
                              </span>
                              {isAttendee && (
                                <button
                                  className={`event-modal-edit-toggle ${hasEditRights ? 'active' : ''}`}
                                  onClick={(e) => { e.stopPropagation(); toggleCanEdit(member.id); }}
                                  title={hasEditRights ? 'Can edit' : 'View only'}
                                >
                                  {hasEditRights ? 'Can edit' : 'View only'}
                                </button>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </>
                  )}
                </div>
              </div>
              
              {/* Visibility Selector */}
              <div className="event-modal-field">
                <label className="event-modal-label">Visibility</label>
                <div className="event-modal-visibility-selector">
                  <div 
                    className="event-modal-visibility-trigger"
                    onClick={() => setShowVisibilityDropdown(!showVisibilityDropdown)}
                  >
                    <span className="event-modal-visibility-icon">{currentVisibility.icon}</span>
                    <span className="event-modal-visibility-label">{currentVisibility.label}</span>
                    <ChevronDown size={14} className="event-modal-visibility-arrow" />
                  </div>
                  {showVisibilityDropdown && (
                    <>
                      <div 
                        style={{ position: 'fixed', inset: 0, zIndex: 99 }}
                        onClick={() => setShowVisibilityDropdown(false)}
                      />
                      <div className="event-modal-visibility-dropdown">
                        {visibilityOptions.map(opt => (
                          <div 
                            key={opt.value}
                            className={`event-modal-visibility-option ${visibilityType === opt.value ? 'selected' : ''}`}
                            onClick={() => {
                              setVisibilityType(opt.value);
                              setShowVisibilityDropdown(false);
                            }}
                          >
                            <span className="event-modal-visibility-icon">{opt.icon}</span>
                            <div className="event-modal-visibility-option-content">
                              <div className="event-modal-visibility-option-label">{opt.label}</div>
                              <div className="event-modal-visibility-option-desc">{opt.description}</div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              </div>
            </>
          )}
        </div>
        
        {/* Footer - only show for edit mode or new events */}
        {(isEditing || !isExistingEvent) && (
          <div className="event-modal-footer">
            <div className="event-modal-footer-left">
              {isExistingEvent && onDelete && event?.createdBy === currentUserId && (
                <button 
                  className="event-modal-btn event-modal-btn-danger" 
                  onClick={() => { onDelete(event.id); onClose(); }}
                >
                  Delete Event
                </button>
              )}
            </div>
            <div className="event-modal-footer-right">
              <button
                className="event-modal-btn event-modal-btn-secondary"
                onClick={isExistingEvent ? handleCancelEdit : onClose}
                disabled={isSaving}
              >
                Cancel
              </button>
              <button
                className="event-modal-btn event-modal-btn-primary"
                onClick={handleSubmit}
                disabled={!title.trim() || !clientId || !date || isSaving}
              >
                {isSaving ? 'Saving...' : (isExistingEvent ? 'Save Changes' : 'Create Event')}
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ==================== MARKDOWN TEXT COMPONENT ====================
function MarkdownText({ text, className = '' }) {
  if (!text) return null;
  const html = window.marked ? window.marked.parse(text) : text;
  return <div dangerouslySetInnerHTML={{ __html: html }} className={`markdown-content ${className}`} />;
}

// ==================== TASK MODAL (Create & Edit) ====================
function TaskModal({ task, onClose, onSave, onUpdate, onDelete, onToggleComplete, clients, internal, teamMembers, defaultClientId, defaultProjectId, defaultDate, navigateToClient }) {
  const isExistingTask = !!task;
  const allSpaces = [internal.personal, internal.team, ...clients];
  
  // Status options for dropdown
  const statusOptions = [
    { value: 'todo', label: 'To Do', icon: '○', color: '#71717a' },
    { value: 'in-progress', label: 'In Progress', icon: '◐', color: '#3b82f6' },
    { value: 'blocked', label: 'Blocked', icon: '⊘', color: '#ef4444' },
    { value: 'on-hold', label: 'On Hold', icon: '⏸', color: '#f97316' },
    { value: 'urgent', label: 'Urgent', icon: '⚡', color: '#ef4444' },
  ];
  
  // State for view/edit mode (existing tasks start in view mode)
  const [isEditing, setIsEditing] = React.useState(!isExistingTask);
  
  // Find client info for existing task
  let existingClientId = defaultClientId || '';
  let existingProjectId = defaultProjectId || '';
  let clientInfo = null;
  let projectInfo = null;
  
  if (isExistingTask) {
    clientInfo = allSpaces.find(s => s.id === task.clientId);
    if (clientInfo) {
      existingClientId = clientInfo.id;
      projectInfo = clientInfo.projects.find(p => p.id === task.projectId);
      if (projectInfo) {
        existingProjectId = projectInfo.id;
      }
    }
  }
  
  // Get assignee info
  const assignee = isExistingTask ? teamMembers.find(m => m.id === task.assignedTo) : null;
  
  // Format date as YYYY-MM-DD in local timezone
  const formatDateLocal = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  // Get default due date (today if not specified)
  const getDefaultDueDate = () => {
    if (defaultDate) return defaultDate;
    return formatDateLocal(new Date());
  };

  // Parse existing task due date
  const getInitialDueDate = () => {
    if (isExistingTask) {
      // For existing tasks, use their dueDate or empty string if none
      return task.dueDate ? formatDateLocal(new Date(task.dueDate)) : '';
    }
    // For new tasks, default to no due date
    return '';
  };
  
  const [title, setTitle] = React.useState(isExistingTask ? task.title : '');
  const [clientId, setClientId] = React.useState(existingClientId);
  const [projectId, setProjectId] = React.useState(existingProjectId);
  const [dueDate, setDueDate] = React.useState(getInitialDueDate());
  const [assignedTo, setAssignedTo] = React.useState(isExistingTask ? task.assignedTo : (teamMembers[0]?.id || ''));
  const [taskDescription, setTaskDescription] = React.useState(isExistingTask ? (task.notes || '') : '');
  const [status, setStatus] = React.useState(isExistingTask ? (task.status || 'todo') : 'todo');
  const [blockedReason, setBlockedReason] = React.useState(isExistingTask ? (task.blockedReason || '') : '');
  const [showStatusDropdown, setShowStatusDropdown] = React.useState(false);
  const [isSaving, setIsSaving] = React.useState(false);

  // Get projects for selected client
  const selectedClient = allSpaces.find(s => s.id === clientId);
  const availableProjects = selectedClient?.projects || [];
  
  // Get current status info
  const currentStatus = statusOptions.find(s => s.value === status) || statusOptions[0];
  
  // Cancel editing - reset to original values
  const handleCancelEdit = () => {
    if (isExistingTask) {
      setTitle(task.title);
      setClientId(existingClientId);
      setProjectId(existingProjectId);
      setDueDate(getInitialDueDate());
      setAssignedTo(task.assignedTo);
      setTaskDescription(task.notes || '');
      setStatus(task.status || 'todo');
      setBlockedReason(task.blockedReason || '');
      setIsEditing(false);
    }
  };
  
  const handleSubmit = async () => {
    if (!title.trim() || !clientId) return;
    if (isSaving) return; // Prevent double-clicks

    setIsSaving(true);

    const dueDateObj = dueDate ? new Date(dueDate + 'T17:00:00') : null;

    const taskData = {
      clientId,
      projectId: projectId || null,
      title: title.trim(),
      dueDate: dueDateObj,
      assignedTo,
      notes: taskDescription.trim(),
      isCompleted: isExistingTask ? task.isCompleted : false,
      createdBy: isExistingTask ? task.createdBy : teamMembers[0]?.id,
      status: status,
      blockedReason: status === 'blocked' ? blockedReason.trim() : '',
    };

    try {
      if (isExistingTask) {
        console.log('Updating task:', task.id, taskData);
        await onUpdate(task.id, taskData);
      } else {
        console.log('Creating new task:', taskData);
        await onSave(taskData);
      }
      onClose();
    } catch (err) {
      console.error('Error saving task:', err);
      setIsSaving(false);
    }
  };
  
  // Format date for display
  const formatDisplayDate = (dateStr) => {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
  };
  
  // Check if overdue
  const isOverdue = isExistingTask && !task.isCompleted && task.dueDate && new Date(task.dueDate) < new Date();
  
  return (
    <div className="task-modal-overlay" onClick={onClose}>
      <div className="task-modal" onClick={e => e.stopPropagation()}>
        <style>{`
          .task-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
          }
          .task-modal {
            background: #18181b;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            width: 440px;
            max-width: 95vw;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
          }
          .task-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
          }
          .task-modal-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
          }
          .task-modal-title {
            font-size: 14px;
            font-weight: 600;
            color: #e4e4e7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          .task-modal-edit-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.1s ease;
          }
          .task-modal-edit-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: #f4f4f5;
          }
          .task-modal-close {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #71717a;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s ease;
          }
          .task-modal-close:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: #f4f4f5;
          }
          .task-modal-body {
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            overflow-y: auto;
          }
          .task-modal-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
          }
          .task-modal-label {
            font-size: 10px;
            font-weight: 600;
            color: #a1a1aa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          .task-modal-value {
            font-size: 14px;
            color: #f4f4f5;
            line-height: 1.5;
          }
          .task-modal-value.empty {
            color: #52525b;
            font-style: italic;
          }
          .task-modal-value.notes {
            white-space: pre-wrap;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 10px 12px;
            border-radius: 2px;
            font-size: 13px;
          }
          .task-modal-value.overdue {
            color: #f87171;
          }
          .task-modal-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
          }
          .task-modal-badge {
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: white;
            border: none;
            cursor: pointer;
            transition: opacity 0.1s ease;
          }
          .task-modal-badge:hover {
            opacity: 0.85;
          }
          .task-modal-badge.assignee {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
            cursor: default;
          }
          .task-modal-status-row {
            display: flex;
            align-items: center;
            gap: 10px;
          }
          .task-modal-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 2px;
            border: 2px solid rgba(255, 255, 255, 0.25);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s ease;
            flex-shrink: 0;
          }
          .task-modal-checkbox:hover {
            border-color: rgba(255, 255, 255, 0.4);
          }
          .task-modal-checkbox.completed {
            background: #22c55e;
            border-color: #22c55e;
          }
          .task-modal-status-text {
            font-size: 13px;
            color: #a1a1aa;
          }
          .task-modal-status-text.completed {
            color: #22c55e;
          }
          .task-modal-status-selector {
            position: relative;
          }
          .task-modal-status-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 9px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.1s ease;
          }
          .task-modal-status-trigger:hover {
            background: rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
          }
          .task-modal-status-icon {
            font-size: 14px;
          }
          .task-modal-status-label {
            font-size: 13px;
            font-weight: 500;
          }
          .task-modal-status-arrow {
            margin-left: auto;
            color: #71717a;
          }
          .task-modal-status-dropdown {
            position: absolute;
            top: calc(100% + 2px);
            left: 0;
            right: 0;
            background: #1c1c1f;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            z-index: 100;
            overflow: hidden;
          }
          .task-modal-status-backdrop {
            position: fixed;
            inset: 0;
            z-index: 99;
          }
          .task-modal-status-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 12px;
            cursor: pointer;
            transition: background 0.1s ease;
          }
          .task-modal-status-option:hover {
            background: rgba(255, 255, 255, 0.06);
          }
          .task-modal-status-option.selected {
            background: rgba(99, 102, 241, 0.12);
          }
          .task-modal-status-option-icon {
            font-size: 14px;
          }
          .task-modal-status-option-label {
            font-size: 13px;
            color: #e4e4e7;
          }
          .task-modal-blocked-input {
            margin-top: 8px;
            width: 100%;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 2px;
            padding: 8px 10px;
            color: #f4f4f5;
            font-size: 12px;
            outline: none;
            transition: border-color 0.1s ease;
          }
          .task-modal-blocked-input:focus {
            border-color: rgba(239, 68, 68, 0.5);
          }
          .task-modal-blocked-reason {
            margin-top: 8px;
          }
          .task-modal-blocked-input::placeholder {
            color: #71717a;
          }
          .task-modal-blocked-display {
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.15);
            border-radius: 2px;
            font-size: 12px;
            color: #fca5a5;
          }
          .task-modal-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            padding: 9px 12px;
            color: #f4f4f5;
            font-size: 13px;
            outline: none;
            transition: border-color 0.1s ease;
            box-sizing: border-box;
          }
          .task-modal-input:focus {
            border-color: rgba(99, 102, 241, 0.6);
          }
          .task-modal-input::placeholder {
            color: #52525b;
          }
          .task-modal-select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            padding: 9px 12px;
            color: #f4f4f5;
            font-size: 13px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.1s ease;
            box-sizing: border-box;
          }
          .task-modal-select:focus {
            border-color: rgba(99, 102, 241, 0.6);
          }
          .task-modal-row {
            display: flex;
            gap: 10px;
          }
          .task-modal-row > * {
            flex: 1;
          }
          .task-modal-textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 2px;
            padding: 9px 12px;
            color: #f4f4f5;
            font-size: 13px;
            outline: none;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            transition: border-color 0.1s ease;
            box-sizing: border-box;
          }
          .task-modal-textarea:focus {
            border-color: rgba(99, 102, 241, 0.6);
          }
          .task-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
          }
          .task-modal-footer-left {
            display: flex;
            gap: 8px;
          }
          .task-modal-footer-right {
            display: flex;
            gap: 8px;
          }
          .task-modal-btn {
            padding: 8px 16px;
            border-radius: 2px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.1s ease;
            border: none;
          }
          .task-modal-btn-secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #a1a1aa;
          }
          .task-modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: #f4f4f5;
          }
          .task-modal-btn-primary {
            background: #6366f1;
            color: white;
          }
          .task-modal-btn-primary:hover {
            background: #5558e3;
          }
          .task-modal-btn-primary:disabled {
            background: #3f3f46;
            color: #71717a;
            cursor: not-allowed;
          }
          .task-modal-btn-danger {
            background: transparent;
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
          }
          .task-modal-btn-danger:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.5);
          }
        `}</style>
        
        <div className="task-modal-header">
          <div className="task-modal-header-left">
            <div className="task-modal-title">
              {isExistingTask ? (isEditing ? 'Edit Task' : 'Task Details') : 'New Task'}
            </div>
            {isExistingTask && !isEditing && (
              <button className="task-modal-edit-btn" onClick={() => setIsEditing(true)}>
                <Edit2 size={14} /> Edit
              </button>
            )}
          </div>
          <button className="task-modal-close" onClick={onClose}>
            <X size={18} />
          </button>
        </div>
        
        <div className="task-modal-body">
          {/* VIEW MODE for existing tasks */}
          {isExistingTask && !isEditing ? (
            <>
              {/* Completion Status */}
              <div className="task-modal-field">
                <label className="task-modal-label">Completion</label>
                <div className="task-modal-status-row">
                  <button 
                    className={`task-modal-checkbox ${task.isCompleted ? 'completed' : ''}`}
                    onClick={() => onToggleComplete(task.id)}
                  >
                    {task.isCompleted && <Check size={14} color="white" />}
                  </button>
                  <span className={`task-modal-status-text ${task.isCompleted ? 'completed' : ''}`}>
                    {task.isCompleted ? 'Completed' : 'Not completed'}
                  </span>
                </div>
              </div>
              
              {/* Status Selector (only show when not completed) */}
              {!task.isCompleted && (
                <div className="task-modal-field">
                  <label className="task-modal-label">Status</label>
                  <div className="task-modal-status-selector">
                    <div 
                      className="task-modal-status-trigger"
                      onClick={() => setShowStatusDropdown(!showStatusDropdown)}
                    >
                      <span className="task-modal-status-icon" style={{ color: currentStatus.color }}>{currentStatus.icon}</span>
                      <span className="task-modal-status-label" style={{ color: currentStatus.color }}>
                        {currentStatus.label}
                      </span>
                      <ChevronDown size={14} className="task-modal-status-arrow" />
                    </div>
                    {showStatusDropdown && (
                      <>
                        <div 
                          className="task-modal-status-backdrop"
                          onClick={() => setShowStatusDropdown(false)}
                        />
                        <div className="task-modal-status-dropdown">
                          {statusOptions.map(opt => (
                            <div 
                              key={opt.value}
                              className={`task-modal-status-option ${status === opt.value ? 'selected' : ''}`}
                              onClick={() => {
                                setStatus(opt.value);
                                setShowStatusDropdown(false);
                                // Auto-save status change
                                if (onUpdate && task) {
                                  onUpdate(task.id, { 
                                    status: opt.value,
                                    blockedReason: opt.value === 'blocked' ? blockedReason : ''
                                  });
                                }
                              }}
                            >
                              <span className="task-modal-status-option-icon" style={{ color: opt.color }}>{opt.icon}</span>
                              <span className="task-modal-status-option-label">{opt.label}</span>
                            </div>
                          ))}
                        </div>
                      </>
                    )}
                  </div>
                  {status === 'blocked' && (
                    <div className="task-modal-blocked-reason">
                      <input
                        type="text"
                        className="task-modal-blocked-input"
                        placeholder="Reason for being blocked..."
                        value={blockedReason}
                        onChange={(e) => setBlockedReason(e.target.value)}
                        onBlur={() => {
                          if (onUpdate && task) {
                            onUpdate(task.id, { status, blockedReason: blockedReason.trim() });
                          }
                        }}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') {
                            e.target.blur();
                          }
                        }}
                      />
                    </div>
                  )}
                </div>
              )}
              
              <div className="task-modal-field">
                <label className="task-modal-label">Title</label>
                <div className="task-modal-value">{task.title}</div>
              </div>
              
              <div className="task-modal-field">
                <label className="task-modal-label">Client / Project</label>
                <div className="task-modal-badges">
                  {clientInfo && (
                    <button 
                      className="task-modal-badge" 
                      style={{ background: clientInfo.color }}
                      onClick={() => { onClose(); navigateToClient && navigateToClient(clientInfo.id); }}
                    >
                      {clientInfo.name}
                    </button>
                  )}
                  {projectInfo && (
                    <button 
                      className="task-modal-badge" 
                      style={{ background: projectInfo.color }}
                      onClick={() => { onClose(); navigateToClient && navigateToClient(clientInfo.id, projectInfo.id); }}
                    >
                      {projectInfo.name}
                    </button>
                  )}
                  {!clientInfo && !projectInfo && (
                    <div className="task-modal-value empty">No client assigned</div>
                  )}
                </div>
              </div>
              
              <div className="task-modal-field">
                <label className="task-modal-label">Due Date</label>
                <div className={`task-modal-value ${isOverdue ? 'overdue' : ''} ${!dueDate ? 'empty' : ''}`}>
                  {dueDate ? formatDisplayDate(dueDate) : 'No due date'}
                  {isOverdue && ' (Overdue)'}
                </div>
              </div>
              
              <div className="task-modal-field">
                <label className="task-modal-label">Assigned To</label>
                <div className="task-modal-badges">
                  {assignee ? (
                    <span className="task-modal-badge assignee">
                      {assignee.name}
                    </span>
                  ) : (
                    <div className="task-modal-value empty">Unassigned</div>
                  )}
                </div>
              </div>
              
              <div className="task-modal-field">
                <label className="task-modal-label">Notes</label>
                <div className={`task-modal-value ${!task.notes ? 'empty' : 'notes'}`}>
                  {task.notes ? <MarkdownText text={task.notes} /> : 'No notes'}
                </div>
              </div>
            </>
          ) : (
            /* EDIT MODE for both new and existing tasks */
            <>
              <div className="task-modal-field">
                <label className="task-modal-label">Title</label>
                <input
                  type="text"
                  className="task-modal-input"
                  placeholder="Task title"
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  autoFocus
                />
              </div>
              
              <div className="task-modal-row">
                <div className="task-modal-field">
                  <label className="task-modal-label">Client / Space</label>
                  <select
                    className="task-modal-select"
                    value={clientId}
                    onChange={(e) => { setClientId(e.target.value); setProjectId(''); }}
                  >
                    <option value="">Select...</option>
                    {allSpaces.map(space => (
                      <option key={space.id} value={space.id}>{space.name}</option>
                    ))}
                  </select>
                </div>
                
                <div className="task-modal-field">
                  <label className="task-modal-label">Project (optional)</label>
                  <select
                    className="task-modal-select"
                    value={projectId}
                    onChange={(e) => setProjectId(e.target.value)}
                    disabled={!clientId || availableProjects.length === 0}
                  >
                    <option value="">None</option>
                    {availableProjects.map(p => (
                      <option key={p.id} value={p.id}>{p.name}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="task-modal-row">
                <div className="task-modal-field">
                  <label className="task-modal-label">Due Date (optional)</label>
                  <div style={{ position: 'relative', flex: 1 }}>
                    <input
                      type="date"
                      className="task-modal-input"
                      style={{ width: '100%', paddingRight: dueDate ? '36px' : '14px', color: dueDate ? undefined : 'transparent' }}
                      value={dueDate}
                      onChange={(e) => setDueDate(e.target.value)}
                    />
                    {!dueDate && (
                      <div style={{ position: 'absolute', left: '14px', top: '50%', transform: 'translateY(-50%)', color: '#52525b', pointerEvents: 'none' }}>
                        -- / -- / ----
                      </div>
                    )}
                    {dueDate && (
                      <button
                        type="button"
                        onClick={() => setDueDate('')}
                        title="Clear due date"
                        style={{ position: 'absolute', right: '8px', top: '50%', transform: 'translateY(-50%)', padding: '4px', background: 'transparent', border: 'none', color: '#71717a', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '4px' }}
                        onMouseOver={(e) => e.currentTarget.style.color = '#a1a1aa'}
                        onMouseOut={(e) => e.currentTarget.style.color = '#71717a'}
                      >
                        <X size={16} />
                      </button>
                    )}
                  </div>
                </div>
                
                <div className="task-modal-field">
                  <label className="task-modal-label">Assigned To</label>
                  <select
                    className="task-modal-select"
                    value={assignedTo}
                    onChange={(e) => setAssignedTo(e.target.value)}
                  >
                    {teamMembers.map(member => (
                      <option key={member.id} value={member.id}>{member.name}</option>
                    ))}
                  </select>
                </div>
              </div>
              
              {/* Status Selector */}
              <div className="task-modal-field">
                <label className="task-modal-label">Status</label>
                <div className="task-modal-status-selector">
                  <div 
                    className="task-modal-status-trigger"
                    onClick={() => setShowStatusDropdown(!showStatusDropdown)}
                  >
                    <span className="task-modal-status-icon" style={{ color: currentStatus.color }}>{currentStatus.icon}</span>
                    <span className="task-modal-status-label" style={{ color: currentStatus.color }}>
                      {currentStatus.label}
                    </span>
                    <ChevronDown size={14} className="task-modal-status-arrow" />
                  </div>
                  {showStatusDropdown && (
                    <>
                      <div 
                        className="task-modal-status-backdrop"
                        onClick={() => setShowStatusDropdown(false)}
                      />
                      <div className="task-modal-status-dropdown">
                        {statusOptions.map(opt => (
                          <div 
                            key={opt.value}
                            className={`task-modal-status-option ${status === opt.value ? 'selected' : ''}`}
                            onClick={() => {
                              setStatus(opt.value);
                              setShowStatusDropdown(false);
                              if (opt.value !== 'blocked') {
                                setBlockedReason('');
                              }
                            }}
                          >
                            <span className="task-modal-status-option-icon" style={{ color: opt.color }}>{opt.icon}</span>
                            <span className="task-modal-status-option-label">{opt.label}</span>
                          </div>
                        ))}
                      </div>
                    </>
                  )}
                </div>
                {status === 'blocked' && (
                  <div className="task-modal-blocked-reason">
                    <input
                      type="text"
                      className="task-modal-blocked-input"
                      placeholder="Reason for being blocked..."
                      value={blockedReason}
                      onChange={(e) => setBlockedReason(e.target.value)}
                    />
                  </div>
                )}
              </div>
              
              <div className="task-modal-field">
                <label className="task-modal-label">Notes (optional)</label>
                <MentionTextarea
                  className="task-modal-textarea"
                  placeholder="Add notes... Type @ to mention someone"
                  value={taskDescription}
                  onChange={setTaskDescription}
                  teamMembers={teamMembers}
                />
              </div>
            </>
          )}
        </div>
        
        {/* Footer - only show for edit mode or new tasks */}
        {(isEditing || !isExistingTask) && (
          <div className="task-modal-footer">
            <div className="task-modal-footer-left">
              {isExistingTask && onDelete && (
                <button
                  className="task-modal-btn task-modal-btn-danger"
                  onClick={() => onDelete(task.id)}
                >
                  Delete Task
                </button>
              )}
            </div>
            <div className="task-modal-footer-right">
              <button
                className="task-modal-btn task-modal-btn-secondary"
                onClick={isExistingTask ? handleCancelEdit : onClose}
                disabled={isSaving}
              >
                Cancel
              </button>
              <button
                className="task-modal-btn task-modal-btn-primary"
                onClick={handleSubmit}
                disabled={!title.trim() || !clientId || isSaving}
              >
                {isSaving ? 'Saving...' : (isExistingTask ? 'Save Changes' : 'Create Task')}
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ==================== LIST MODAL (Create & Edit) ====================
function ListModal({ list, onClose, onSave, onUpdate, onDelete, clients, internal, teamMembers, tasks, onToggleTaskComplete, onAddTaskToList, onRemoveTaskFromList, onReorderTasks, onTaskClick, defaultClientId, defaultProjectId, navigateToClient }) {
  const isExistingList = !!list;
  const allSpaces = [internal.personal, internal.team, ...clients];
  
  // State for view/edit mode
  const [isEditing, setIsEditing] = React.useState(!isExistingList);
  const [showAddTask, setShowAddTask] = React.useState(false);
  const [newTaskTitle, setNewTaskTitle] = React.useState('');
  const [draggedTaskId, setDraggedTaskId] = React.useState(null);
  
  // Find client info
  let existingClientId = defaultClientId || '';
  let existingProjectId = defaultProjectId || '';
  let clientInfo = null;
  let projectInfo = null;
  
  if (isExistingList) {
    clientInfo = allSpaces.find(s => s.id === list.clientId);
    if (clientInfo) {
      existingClientId = clientInfo.id;
      projectInfo = clientInfo.projects.find(p => p.id === list.projectId);
      if (projectInfo) {
        existingProjectId = projectInfo.id;
      }
    }
  }
  
  // Format date as YYYY-MM-DD in local timezone
  const formatDateLocal = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  // Form state
  const [title, setTitle] = React.useState(isExistingList ? list.title : '');
  const [clientId, setClientId] = React.useState(existingClientId);
  const [projectId, setProjectId] = React.useState(existingProjectId);
  const [dueDate, setDueDate] = React.useState(() => {
    if (isExistingList) {
      // For existing lists, use their dueDate or empty string if none
      return list.dueDate ? formatDateLocal(new Date(list.dueDate)) : '';
    }
    // For new lists, default to no due date
    return '';
  });
  const [notes, setNotes] = React.useState(isExistingList ? (list.notes || '') : '');
  const [isSaving, setIsSaving] = React.useState(false);

  // Get projects for selected client
  const selectedClient = allSpaces.find(s => s.id === clientId);
  const availableProjects = selectedClient?.projects || [];
  
  // Get list tasks
  const listTasks = isExistingList 
    ? tasks.filter(t => t.listId === list.id).sort((a, b) => (a.listOrder || 0) - (b.listOrder || 0))
    : [];
  
  const completedCount = listTasks.filter(t => t.isCompleted).length;
  const totalCount = listTasks.length;
  const progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
  
  // Handle submit
  const handleSubmit = async () => {
    if (!title.trim() || !clientId) return;
    if (isSaving) return; // Prevent double-clicks

    setIsSaving(true);

    const dueDateObj = dueDate ? new Date(dueDate + 'T17:00:00') : null;

    const listData = {
      clientId,
      projectId: projectId || null,
      title: title.trim(),
      dueDate: dueDateObj,
      notes: notes.trim(),
      createdBy: teamMembers[0]?.id,
      createdAt: new Date(),
    };

    try {
      if (isExistingList) {
        console.log('Updating list:', list.id, listData);
        await onUpdate(list.id, listData);
      } else {
        console.log('Creating new list:', listData);
        await onSave(listData);
        onClose();
      }
    } catch (err) {
      console.error('Error saving list:', err);
      setIsSaving(false);
    }
  };
  
  // Handle cancel edit
  const handleCancelEdit = () => {
    setTitle(list.title);
    setClientId(existingClientId);
    setProjectId(existingProjectId);
    setDueDate(list.dueDate ? formatDateLocal(new Date(list.dueDate)) : '');
    setNotes(list.notes || '');
    setIsEditing(false);
  };
  
  // Handle add task to list
  const handleAddTask = () => {
    if (!newTaskTitle.trim()) return;
    onAddTaskToList(list.id, {
      title: newTaskTitle.trim(),
      assignedTo: teamMembers[0]?.id,
      createdBy: teamMembers[0]?.id,
      isCompleted: false,
      notes: '',
    });
    setNewTaskTitle('');
    setShowAddTask(false);
  };
  
  // Drag handlers
  const handleDragStart = (e, taskId) => {
    setDraggedTaskId(taskId);
    e.dataTransfer.effectAllowed = 'move';
  };
  
  const handleDragOver = (e, targetIndex) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
  };
  
  const handleDrop = (e, targetIndex) => {
    e.preventDefault();
    if (draggedTaskId && onReorderTasks) {
      onReorderTasks(list.id, draggedTaskId, targetIndex);
    }
    setDraggedTaskId(null);
  };
  
  const formatDisplayDate = (dateStr) => {
    const d = new Date(dateStr + 'T12:00:00');
    return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
  };

  return (
    <div className="list-modal-overlay" onClick={onClose}>
      <div className="list-modal" onClick={e => e.stopPropagation()}>
        <style>{`
          .list-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
          }
          .list-modal {
            background: #18181b;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            width: 520px;
            max-width: 95vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
          }
          .list-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            flex-shrink: 0;
          }
          .list-modal-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
          }
          .list-modal-title {
            font-size: 14px;
            font-weight: 600;
            color: #e4e4e7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          .list-modal-edit-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 2px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #a1a1aa;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.1s ease;
          }
          .list-modal-edit-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: #fff;
          }
          .list-modal-close {
            width: 28px;
            height: 28px;
            border-radius: 2px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #71717a;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s ease;
          }
          .list-modal-close:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: #fff;
          }
          .list-modal-body {
            padding: 16px 20px;
            overflow-y: auto;
            flex: 1;
          }
          .list-modal-field {
            margin-bottom: 14px;
          }
          .list-modal-label {
            display: block;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #a1a1aa;
            margin-bottom: 5px;
          }
          .list-modal-value {
            font-size: 14px;
            color: #e4e4e7;
          }
          .list-modal-value.empty {
            color: #52525b;
            font-style: italic;
          }
          .list-modal-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
          }
          .list-modal-badge {
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: opacity 0.1s ease;
          }
          .list-modal-badge:hover {
            opacity: 0.85;
          }
          .list-modal-input {
            width: 100%;
            padding: 9px 12px;
            border-radius: 2px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #fff;
            font-size: 13px;
            outline: none;
            transition: border-color 0.1s ease;
            box-sizing: border-box;
          }
          .list-modal-input:focus {
            border-color: rgba(99, 102, 241, 0.6);
          }
          .list-modal-textarea {
            width: 100%;
            padding: 9px 12px;
            border-radius: 2px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #fff;
            font-size: 13px;
            outline: none;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            transition: border-color 0.1s ease;
            box-sizing: border-box;
          }
          .list-modal-select {
            padding: 9px 12px;
            border-radius: 2px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #fff;
            font-size: 13px;
            outline: none;
            cursor: pointer;
            flex: 1;
            transition: border-color 0.1s ease;
          }
          .list-modal-row {
            display: flex;
            gap: 10px;
          }
          .list-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
            flex-shrink: 0;
          }
          .list-modal-footer-left {
            display: flex;
            gap: 8px;
          }
          .list-modal-footer-right {
            display: flex;
            gap: 8px;
          }
          .list-modal-btn {
            padding: 8px 16px;
            border-radius: 2px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.1s ease;
            border: none;
          }
          .list-modal-btn-secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #a1a1aa;
          }
          .list-modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: #fff;
          }
          .list-modal-btn-primary {
            background: #6366f1;
            color: #fff;
          }
          .list-modal-btn-primary:hover {
            background: #5558e3;
          }
          .list-modal-btn-primary:disabled {
            background: #3f3f46;
            color: #71717a;
            cursor: not-allowed;
          }
          .list-modal-btn-danger {
            background: transparent;
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
          }
          .list-modal-btn-danger:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.5);
          }
          
          /* Progress bar */
          .list-progress {
            margin-bottom: 14px;
          }
          .list-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
          }
          .list-progress-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #a1a1aa;
          }
          .list-progress-count {
            font-size: 11px;
            color: #71717a;
          }
          .list-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1px;
            overflow: hidden;
          }
          .list-progress-fill {
            height: 100%;
            background: #22c55e;
            border-radius: 1px;
            transition: width 0.2s ease;
          }

          /* Task list */
          .list-tasks {
            margin-top: 14px;
          }
          .list-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
          }
          .list-tasks-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #a1a1aa;
          }
          .list-tasks-add-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 2px;
            background: transparent;
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: #818cf8;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.1s ease;
          }
          .list-tasks-add-btn:hover {
            background: rgba(99, 102, 241, 0.15);
          }
          .list-task-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 2px;
            margin-bottom: 4px;
            cursor: grab;
            transition: all 0.1s ease;
          }
          .list-task-item:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.1);
          }
          .list-task-item.dragging {
            opacity: 0.5;
          }
          .list-task-item.completed {
            opacity: 0.6;
          }
          .list-task-drag {
            color: #52525b;
            cursor: grab;
          }
          .list-task-check {
            width: 18px;
            height: 18px;
            border-radius: 2px;
            border: 2px solid #52525b;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s ease;
            flex-shrink: 0;
          }
          .list-task-check:hover {
            border-color: #22c55e;
          }
          .list-task-check.checked {
            background: #22c55e;
            border-color: #22c55e;
          }
          .list-task-title {
            flex: 1;
            font-size: 13px;
            color: #e4e4e7;
          }
          .list-task-item.completed .list-task-title {
            text-decoration: line-through;
            color: #71717a;
          }
          .list-task-remove {
            padding: 3px;
            border-radius: 2px;
            background: transparent;
            border: none;
            color: #52525b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s ease;
          }
          .list-task-remove:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
          }
          .list-add-task-form {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
          }
          .list-add-task-input {
            flex: 1;
            padding: 7px 10px;
            border-radius: 2px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #fff;
            font-size: 12px;
            outline: none;
            transition: border-color 0.1s ease;
          }
          .list-add-task-input:focus {
            border-color: rgba(99, 102, 241, 0.6);
          }
          .list-empty-tasks {
            text-align: center;
            padding: 16px;
            color: #52525b;
            font-size: 12px;
          }
        `}</style>
        
        <div className="list-modal-header">
          <div className="list-modal-header-left">
            <div className="list-modal-title">
              {isExistingList ? (isEditing ? 'Edit List' : 'List Details') : 'New List'}
            </div>
            {isExistingList && !isEditing && (
              <button className="list-modal-edit-btn" onClick={() => setIsEditing(true)}>
                <Edit2 size={14} /> Edit
              </button>
            )}
          </div>
          <button className="list-modal-close" onClick={onClose}>
            <X size={18} />
          </button>
        </div>
        
        <div className="list-modal-body">
          {/* VIEW MODE */}
          {isExistingList && !isEditing ? (
            <>
              <div className="list-modal-field">
                <label className="list-modal-label">Title</label>
                <div className="list-modal-value">{list.title}</div>
              </div>
              
              <div className="list-modal-field">
                <label className="list-modal-label">Client / Project</label>
                <div className="list-modal-badges">
                  {clientInfo && (
                    <button 
                      className="list-modal-badge" 
                      style={{ background: clientInfo.color }}
                      onClick={() => { onClose(); navigateToClient && navigateToClient(clientInfo.id); }}
                    >
                      {clientInfo.name}
                    </button>
                  )}
                  {projectInfo && (
                    <button 
                      className="list-modal-badge" 
                      style={{ background: projectInfo.color }}
                      onClick={() => { onClose(); navigateToClient && navigateToClient(clientInfo.id, projectInfo.id); }}
                    >
                      {projectInfo.name}
                    </button>
                  )}
                </div>
              </div>
              
              <div className="list-modal-field">
                <label className="list-modal-label">Due Date</label>
                <div className={`list-modal-value ${!list.dueDate ? 'empty' : ''}`}>
                  {list.dueDate
                    ? new Date(list.dueDate).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })
                    : 'No due date'}
                </div>
              </div>
              
              {list.notes && (
                <div className="list-modal-field">
                  <label className="list-modal-label">Notes</label>
                  <div className="list-modal-value"><MarkdownText text={list.notes} /></div>
                </div>
              )}
              
              {/* Progress */}
              <div className="list-progress">
                <div className="list-progress-header">
                  <span className="list-progress-label">Progress</span>
                  <span className="list-progress-count">{completedCount} / {totalCount} completed</span>
                </div>
                <div className="list-progress-bar">
                  <div className="list-progress-fill" style={{ width: `${progressPercent}%` }} />
                </div>
              </div>
              
              {/* Tasks */}
              <div className="list-tasks">
                <div className="list-tasks-header">
                  <span className="list-tasks-title">Tasks</span>
                  <button className="list-tasks-add-btn" onClick={() => setShowAddTask(true)}>
                    <Plus size={12} /> Add Task
                  </button>
                </div>
                
                {showAddTask && (
                  <div className="list-add-task-form">
                    <input
                      className="list-add-task-input"
                      type="text"
                      placeholder="Task title..."
                      value={newTaskTitle}
                      onChange={(e) => setNewTaskTitle(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && handleAddTask()}
                      autoFocus
                    />
                    <button className="list-modal-btn list-modal-btn-primary" onClick={handleAddTask} style={{ padding: '8px 12px' }}>
                      Add
                    </button>
                    <button className="list-modal-btn list-modal-btn-secondary" onClick={() => { setShowAddTask(false); setNewTaskTitle(''); }} style={{ padding: '8px 12px' }}>
                      Cancel
                    </button>
                  </div>
                )}
                
                {listTasks.length === 0 ? (
                  <div className="list-empty-tasks">No tasks yet. Add one above!</div>
                ) : (
                  listTasks.map((task, index) => (
                    <div 
                      key={task.id}
                      className={`list-task-item ${task.isCompleted ? 'completed' : ''} ${draggedTaskId === task.id ? 'dragging' : ''}`}
                      draggable
                      onDragStart={(e) => handleDragStart(e, task.id)}
                      onDragOver={(e) => handleDragOver(e, index)}
                      onDrop={(e) => handleDrop(e, index)}
                    >
                      <div className="list-task-drag">⋮⋮</div>
                      <div 
                        className={`list-task-check ${task.isCompleted ? 'checked' : ''}`}
                        onClick={() => onToggleTaskComplete && onToggleTaskComplete(task.id)}
                      >
                        {task.isCompleted && <Check size={12} color="#fff" />}
                      </div>
                      <div className="list-task-title" onClick={() => onTaskClick && onTaskClick(task)}>
                        {task.title}
                      </div>
                      <button 
                        className="list-task-remove"
                        onClick={() => onRemoveTaskFromList && onRemoveTaskFromList(task.id)}
                        title="Remove from list"
                      >
                        <X size={14} />
                      </button>
                    </div>
                  ))
                )}
              </div>
            </>
          ) : (
            /* EDIT MODE */
            <>
              <div className="list-modal-field">
                <label className="list-modal-label">Title</label>
                <input
                  className="list-modal-input"
                  type="text"
                  placeholder="List title..."
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  autoFocus
                />
              </div>
              
              <div className="list-modal-field">
                <label className="list-modal-label">Client / Space</label>
                <div className="list-modal-row">
                  <select
                    className="list-modal-select"
                    value={clientId}
                    onChange={(e) => { setClientId(e.target.value); setProjectId(''); }}
                  >
                    <option value="">Select client...</option>
                    {allSpaces.map(s => (
                      <option key={s.id} value={s.id}>{s.name}</option>
                    ))}
                  </select>
                  <select
                    className="list-modal-select"
                    value={projectId}
                    onChange={(e) => setProjectId(e.target.value)}
                    disabled={!clientId}
                  >
                    <option value="">No project</option>
                    {availableProjects.map(p => (
                      <option key={p.id} value={p.id}>{p.name}</option>
                    ))}
                  </select>
                </div>
              </div>
              
              <div className="list-modal-field">
                <label className="list-modal-label">Due Date (optional)</label>
                <div style={{ position: 'relative' }}>
                  <input
                    className="list-modal-input"
                    type="date"
                    style={{ width: '100%', paddingRight: dueDate ? '36px' : '14px', color: dueDate ? undefined : 'transparent' }}
                    value={dueDate}
                    onChange={(e) => setDueDate(e.target.value)}
                  />
                  {!dueDate && (
                    <div style={{ position: 'absolute', left: '14px', top: '50%', transform: 'translateY(-50%)', color: '#52525b', pointerEvents: 'none' }}>
                      -- / -- / ----
                    </div>
                  )}
                  {dueDate && (
                    <button
                      type="button"
                      onClick={() => setDueDate('')}
                      title="Clear due date"
                      style={{ position: 'absolute', right: '8px', top: '50%', transform: 'translateY(-50%)', padding: '4px', background: 'transparent', border: 'none', color: '#71717a', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '4px' }}
                      onMouseOver={(e) => e.currentTarget.style.color = '#a1a1aa'}
                      onMouseOut={(e) => e.currentTarget.style.color = '#71717a'}
                    >
                      <X size={16} />
                    </button>
                  )}
                </div>
              </div>
              
              <div className="list-modal-field">
                <label className="list-modal-label">Notes (optional)</label>
                <MentionTextarea
                  className="list-modal-textarea"
                  placeholder="Add notes... Type @ to mention someone"
                  value={notes}
                  onChange={setNotes}
                  teamMembers={teamMembers}
                />
              </div>
            </>
          )}
        </div>
        
        {/* Footer for edit mode */}
        {(isEditing || !isExistingList) && (
          <div className="list-modal-footer">
            <div className="list-modal-footer-left">
              {isExistingList && onDelete && (
                <button 
                  className="list-modal-btn list-modal-btn-danger"
                  onClick={() => { onDelete(list.id); onClose(); }}
                >
                  Delete List
                </button>
              )}
            </div>
            <div className="list-modal-footer-right">
              <button
                className="list-modal-btn list-modal-btn-secondary"
                onClick={isExistingList ? handleCancelEdit : onClose}
                disabled={isSaving}
              >
                Cancel
              </button>
              <button
                className="list-modal-btn list-modal-btn-primary"
                onClick={handleSubmit}
                disabled={!title.trim() || !clientId || isSaving}
              >
                {isSaving ? 'Saving...' : (isExistingList ? 'Save Changes' : 'Create List')}
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ==================== TIMELINE DATE PICKER ====================
function TimelineDatePicker({ onSelect, onClose, currentTime }) {
  const [viewDate, setViewDate] = React.useState(new Date(currentTime));
  
  const year = viewDate.getFullYear();
  const month = viewDate.getMonth();
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startingDay = firstDay.getDay();
  const totalDays = lastDay.getDate();
  
  // Previous month days to show
  const prevMonthLastDay = new Date(year, month, 0).getDate();
  const prevMonthDays = [];
  for (let i = startingDay - 1; i >= 0; i--) {
    prevMonthDays.push({
      day: prevMonthLastDay - i,
      date: new Date(year, month - 1, prevMonthLastDay - i),
      isOtherMonth: true
    });
  }
  
  // Current month days
  const currentMonthDays = [];
  const today = new Date();
  for (let d = 1; d <= totalDays; d++) {
    const date = new Date(year, month, d);
    currentMonthDays.push({
      day: d,
      date,
      isToday: date.toDateString() === today.toDateString(),
      isOtherMonth: false
    });
  }
  
  // Next month days to fill grid
  const totalCells = Math.ceil((startingDay + totalDays) / 7) * 7;
  const nextMonthDays = [];
  for (let d = 1; d <= totalCells - startingDay - totalDays; d++) {
    nextMonthDays.push({
      day: d,
      date: new Date(year, month + 1, d),
      isOtherMonth: true
    });
  }
  
  const allDays = [...prevMonthDays, ...currentMonthDays, ...nextMonthDays];
  const weekdays = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
  
  const prevMonth = () => setViewDate(new Date(year, month - 1, 1));
  const nextMonth = () => setViewDate(new Date(year, month + 1, 1));
  
  // Close on click outside
  React.useEffect(() => {
    const handleClick = (e) => {
      if (!e.target.closest('.tl-date-picker-wrapper')) {
        onClose();
      }
    };
    document.addEventListener('click', handleClick);
    return () => document.removeEventListener('click', handleClick);
  }, [onClose]);
  
  return (
    <div className="tl-date-picker-popup" onClick={e => e.stopPropagation()}>
      <div className="tl-picker-header">
        <span className="tl-picker-title">
          {viewDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
        </span>
        <div className="tl-picker-nav">
          <button className="tl-picker-nav-btn" onClick={prevMonth}>
            <ChevronLeft size={16} />
          </button>
          <button className="tl-picker-nav-btn" onClick={nextMonth}>
            <ChevronRight size={16} />
          </button>
        </div>
      </div>
      <div className="tl-picker-weekdays">
        {weekdays.map(day => (
          <div key={day} className="tl-picker-weekday">{day}</div>
        ))}
      </div>
      <div className="tl-picker-days">
        {allDays.map((d, i) => (
          <button 
            key={i} 
            className={`tl-picker-day ${d.isToday ? 'today' : ''} ${d.isOtherMonth ? 'other-month' : ''}`}
            onClick={() => onSelect(d.date)}
          >
            {d.day}
          </button>
        ))}
      </div>
    </div>
  );
}

// ==================== WEEKLY CALENDAR VIEW ====================
function WeeklyCalendarView({ events, tasks, lists, clients, internal, currentTime, targetDate, scrollTrigger, onEventClick, onTaskClick, onListClick, toggleTaskComplete, getListProgress, visibleDateRef }) {
  const scrollRef = React.useRef(null);
  const timeScrollRef = React.useRef(null);
  const headerScrollRef = React.useRef(null);
  const containerRef = React.useRef(null);
  const scrollingRef = React.useRef(null); // Track which element is scrolling to prevent feedback
  const [containerHeight, setContainerHeight] = React.useState(600);
  const [containerWidth, setContainerWidth] = React.useState(800);
  
  const allSpaces = [internal.personal, internal.team, ...clients];
  
  // Calculate date range based on events/tasks
  const today = new Date(currentTime);
  today.setHours(0, 0, 0, 0);
  
  // Start 2 weeks ago
  const rangeStart = new Date(today);
  rangeStart.setDate(rangeStart.getDate() - 14);
  // Align to Sunday
  rangeStart.setDate(rangeStart.getDate() - rangeStart.getDay());
  
  // Find furthest event/task
  let furthestDate = new Date(today);
  furthestDate.setDate(furthestDate.getDate() + 28); // Minimum 4 weeks ahead
  
  events.forEach(event => {
    if (event.endTime > furthestDate) {
      furthestDate = new Date(event.endTime);
    }
  });
  
  tasks.forEach(task => {
    if (task.dueDate > furthestDate) {
      furthestDate = new Date(task.dueDate);
    }
  });
  
  // Add 2 weeks buffer and align to Saturday
  furthestDate.setDate(furthestDate.getDate() + 14);
  furthestDate.setDate(furthestDate.getDate() + (6 - furthestDate.getDay()));
  
  // Generate all days in range
  const allDays = [];
  const currentDay = new Date(rangeStart);
  while (currentDay <= furthestDate) {
    allDays.push(new Date(currentDay));
    currentDay.setDate(currentDay.getDate() + 1);
  }
  
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  
  // Hours array (0-23)
  const hours = Array.from({ length: 24 }, (_, i) => i);
  
  // Calculate dimensions
  const HOUR_HEIGHT = containerHeight / 12; // 12 hours visible (7am-7pm)
  const TOTAL_HEIGHT = HOUR_HEIGHT * 24;
  const DEFAULT_SCROLL = HOUR_HEIGHT * 7; // Scroll to 7am
  const DAY_WIDTH = containerWidth / 7; // 7 days visible
  const TOTAL_WIDTH = DAY_WIDTH * allDays.length;
  
  // Measure container
  React.useEffect(() => {
    const measure = () => {
      if (containerRef.current) {
        const height = containerRef.current.clientHeight;
        const width = containerRef.current.clientWidth - 60; // Subtract time column width
        if (height > 0) setContainerHeight(height);
        if (width > 0) setContainerWidth(width);
      }
    };
    measure();
    const timer = setTimeout(measure, 100);
    window.addEventListener('resize', measure);
    return () => {
      clearTimeout(timer);
      window.removeEventListener('resize', measure);
    };
  }, []);
  
  // Scroll to a specific date (centered)
  const scrollToTargetDate = (date, smooth = true) => {
    if (!scrollRef.current || !headerScrollRef.current || containerWidth <= 0 || DAY_WIDTH <= 0) {
      return;
    }

    // Find the target day in allDays
    const targetDayIndex = allDays.findIndex(d => d.toDateString() === date.toDateString());

    if (targetDayIndex === -1) {
      // If date not found, try to find closest day
      return;
    }

    // Center the target day (subtract 3 to put it in middle of 7-day view)
    const horizontalScroll = Math.max(0, (targetDayIndex - 3) * DAY_WIDTH);

    // Use instant scroll for reliability
    scrollRef.current.scrollLeft = horizontalScroll;
    headerScrollRef.current.scrollLeft = horizontalScroll;
  };
  
  // Set initial scroll position when container is measured
  React.useEffect(() => {
    if (scrollRef.current && timeScrollRef.current && headerScrollRef.current && containerWidth > 0 && DAY_WIDTH > 0) {
      scrollRef.current.scrollTop = DEFAULT_SCROLL;
      timeScrollRef.current.scrollTop = DEFAULT_SCROLL;
      scrollToTargetDate(targetDate, false);
    }
  }, [containerWidth, containerHeight]);
  
  // Respond to scrollTrigger changes from Jump to Now / Jump to Date
  React.useEffect(() => {
    // Skip initial render (scrollTrigger starts at 0)
    if (scrollTrigger === 0) return;
    if (!scrollRef.current || !headerScrollRef.current || containerWidth <= 0) return;

    // Find the target day in allDays
    const targetDayIndex = allDays.findIndex(d => d.toDateString() === targetDate.toDateString());

    if (targetDayIndex === -1) return;

    // Center the target day (subtract 3 to put it in middle of 7-day view)
    const dayWidth = containerWidth / 7;
    const horizontalScroll = Math.max(0, (targetDayIndex - 3) * dayWidth);

    scrollRef.current.scrollLeft = horizontalScroll;
    headerScrollRef.current.scrollLeft = horizontalScroll;
  }, [scrollTrigger, targetDate, containerWidth]); // allDays removed - recalculated but content stable
  
  // Sync scroll between components with feedback loop prevention
  const handleScroll = (e) => {
    const source = e.target;

    // If we're currently syncing from another source, ignore this event
    if (scrollingRef.current && scrollingRef.current !== source) {
      return;
    }

    // Mark this element as the scroll source
    scrollingRef.current = source;

    // Vertical sync between time column and grid
    if (source === scrollRef.current && timeScrollRef.current) {
      timeScrollRef.current.scrollTop = source.scrollTop;
    } else if (source === timeScrollRef.current && scrollRef.current) {
      scrollRef.current.scrollTop = source.scrollTop;
    }

    // Horizontal sync between header and grid
    if (source === scrollRef.current && headerScrollRef.current) {
      headerScrollRef.current.scrollLeft = source.scrollLeft;
    } else if (source === headerScrollRef.current && scrollRef.current) {
      scrollRef.current.scrollLeft = source.scrollLeft;
    }

    // Update visible date ref for parent to read when switching views
    if (visibleDateRef && DAY_WIDTH > 0 && scrollRef.current) {
      const scrollLeft = scrollRef.current.scrollLeft;
      const centerOffset = scrollLeft + (containerWidth / 2);
      const centerDayIndex = Math.floor(centerOffset / DAY_WIDTH);
      if (centerDayIndex >= 0 && centerDayIndex < allDays.length) {
        visibleDateRef.current = allDays[centerDayIndex];
      }
    }

    // Clear scroll source after a short delay to allow sync to complete
    clearTimeout(scrollingRef.scrollTimeout);
    scrollingRef.scrollTimeout = setTimeout(() => {
      scrollingRef.current = null;
    }, 50);
  };
  
  // Get timed events for a specific day (excludes all-day events)
  const getEventsForDay = (date) => {
    return events.filter(e => {
      if (e.allDay) return false; // All-day events go in sticky container
      const eventDate = new Date(e.startTime);
      return eventDate.toDateString() === date.toDateString();
    });
  };

  // Get all-day events for a specific day
  const getAllDayEventsForDay = (date) => {
    return events.filter(e => {
      if (!e.allDay) return false;
      const eventDate = new Date(e.startTime);
      return eventDate.toDateString() === date.toDateString();
    });
  };

  // Get tasks for a specific day (includes list tasks with due dates)
  const getTasksForDay = (date) => {
    return tasks.filter(t => {
      if (!t.dueDate) return false; // Skip tasks without due dates
      const taskDate = new Date(t.dueDate);
      return taskDate.toDateString() === date.toDateString();
    });
  };
  
  // Get project/client info for coloring
  const getEventInfo = (event) => {
    // First try to find by projectId
    for (const space of allSpaces) {
      const project = space.projects.find(p => p.id === event.projectId);
      if (project) {
        return { client: space, project };
      }
    }
    // If no project, find by clientId
    if (event.clientId) {
      const client = allSpaces.find(s => s.id === event.clientId);
      if (client) {
        return { client, project: null };
      }
    }
    return { client: null, project: null };
  };
  
  const getTaskInfo = (task) => {
    const client = allSpaces.find(s => s.id === task.clientId);
    const project = client?.projects.find(p => p.id === task.projectId);
    return { client, project };
  };

  // Get lists for a specific day
  const getListsForDay = (date) => {
    return (lists || []).filter(l => {
      if (!l.dueDate) return false;
      const listDate = new Date(l.dueDate);
      return listDate.toDateString() === date.toDateString();
    });
  };

  const getListInfo = (list) => {
    const client = allSpaces.find(s => s.id === list.clientId);
    const project = client?.projects.find(p => p.id === list.projectId);
    return { client, project };
  };

  // Format hour label
  const formatHour = (hour) => {
    if (hour === 0) return '12 AM';
    if (hour === 12) return '12 PM';
    if (hour < 12) return `${hour} AM`;
    return `${hour - 12} PM`;
  };
  
  // Check if date is today
  const isToday = (date) => date.toDateString() === new Date().toDateString();
  
  // Check if date is start of week (Sunday)
  const isWeekStart = (date) => date.getDay() === 0;
  
  // Check if date is in a different month
  const isNewMonth = (date, index) => {
    if (index === 0) return true;
    const prevDate = allDays[index - 1];
    return date.getMonth() !== prevDate.getMonth();
  };
  
  // Get current time position
  const now = new Date();
  const currentHourPosition = (now.getHours() + now.getMinutes() / 60) * HOUR_HEIGHT;
  
  return (
    <div className="wk-container" ref={containerRef}>
      <style>{`
        .wk-container {
          display: flex;
          flex-direction: column;
          flex: 1;
          overflow: hidden;
          background: #0a0a0e;
          border-radius: 12px;
          border: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .wk-header {
          display: flex;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
          flex-shrink: 0;
        }
        
        .wk-header-time {
          width: 60px;
          flex-shrink: 0;
          background: rgba(255, 255, 255, 0.02);
        }
        
        .wk-header-scroll {
          flex: 1;
          overflow-x: auto;
          overflow-y: hidden;
        }
        
        .wk-header-scroll::-webkit-scrollbar {
          display: none;
        }
        
        .wk-header-days {
          display: flex;
        }
        
        .wk-header-day {
          flex-shrink: 0;
          padding: 8px 4px;
          text-align: center;
          border-left: 1px solid rgba(255, 255, 255, 0.06);
          box-sizing: border-box;
        }
        
        .wk-header-day.week-start {
          border-left: 2px solid rgba(255, 255, 255, 0.15);
        }
        
        .wk-header-day.today {
          background: rgba(99, 102, 241, 0.1);
        }
        
        .wk-day-name {
          font-size: 10px;
          color: #71717a;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 2px;
        }
        
        .wk-day-date {
          font-size: 14px;
          font-weight: 600;
          color: #e4e4e7;
        }
        
        .wk-day-month {
          font-size: 9px;
          color: #52525b;
          margin-top: 2px;
        }
        
        .wk-header-day.today .wk-day-date {
          color: #818cf8;
        }
        
        .wk-body {
          display: flex;
          flex: 1;
          overflow: hidden;
        }
        
        .wk-time-column {
          width: 60px;
          flex-shrink: 0;
          overflow-y: auto;
          overflow-x: hidden;
          background: rgba(255, 255, 255, 0.02);
        }
        
        .wk-time-column::-webkit-scrollbar {
          display: none;
        }
        
        .wk-time-inner {
          position: relative;
        }
        
        .wk-time-label {
          position: absolute;
          right: 8px;
          transform: translateY(-50%);
          font-size: 11px;
          color: #52525b;
        }
        
        .wk-grid-scroll {
          flex: 1;
          overflow: auto;
        }
        
        .wk-grid-scroll::-webkit-scrollbar {
          width: 8px;
          height: 8px;
        }
        
        .wk-grid-scroll::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.02);
        }
        
        .wk-grid-scroll::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.1);
          border-radius: 4px;
        }
        
        .wk-grid {
          display: flex;
          position: relative;
        }
        
        .wk-day-column {
          flex-shrink: 0;
          position: relative;
          border-left: 1px solid rgba(255, 255, 255, 0.06);
          box-sizing: border-box;
          height: 100%;
        }
        
        .wk-day-column.week-start {
          border-left: 2px solid rgba(255, 255, 255, 0.15);
        }
        
        .wk-day-column.today {
          background: rgba(99, 102, 241, 0.03);
        }
        
        .wk-hour-row {
          height: 1px;
          background: rgba(255, 255, 255, 0.06);
          position: absolute;
          left: 0;
          right: 0;
        }
        
        .wk-hour-row.noon {
          background: rgba(255, 255, 255, 0.12);
        }
        
        .wk-now-line {
          position: absolute;
          left: 0;
          right: 0;
          height: 2px;
          background: #ef4444;
          z-index: 10;
        }
        
        .wk-now-line::before {
          content: '';
          position: absolute;
          left: -4px;
          top: -3px;
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #ef4444;
        }
        
        .wk-event {
          position: absolute;
          left: 4px;
          right: 4px;
          border-radius: 6px;
          padding: 4px 8px;
          overflow: hidden;
          cursor: pointer;
          transition: all 0.15s;
          z-index: 5;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .wk-event:hover {
          transform: scale(1.02);
          z-index: 6;
        }
        
        .wk-event-title {
          font-size: 11px;
          font-weight: 500;
          color: #fff;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .wk-event-time {
          font-size: 10px;
          color: rgba(255, 255, 255, 0.7);
        }
        
        .wk-task {
          position: absolute;
          left: 4px;
          right: 4px;
          height: 24px;
          border-radius: 6px;
          padding: 0 8px;
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
          transition: all 0.15s;
          z-index: 5;
          background: rgba(10, 10, 14, 0.95);
          border: 2px solid;
        }
        
        .wk-task:hover {
          transform: scale(1.02);
          z-index: 6;
        }
        
        .wk-task.completed {
          opacity: 0.4;
        }
        
        .wk-task-check {
          width: 14px;
          height: 14px;
          border-radius: 4px;
          border: 2px solid currentColor;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
          cursor: pointer;
        }
        
        .wk-task-check.checked {
          background: currentColor;
        }
        
        .wk-task-title {
          font-size: 11px;
          font-weight: 500;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .wk-items-container {
          position: sticky;
          top: 0;
          margin: 0 4px;
          display: flex;
          flex-direction: column;
          gap: 2px;
          z-index: 10;
          padding: 4px 0;
          background: linear-gradient(to bottom, rgba(10, 10, 14, 0.98) 0%, rgba(10, 10, 14, 0.95) 85%, transparent 100%);
        }

        .wk-list {
          height: 22px;
          border-radius: 6px;
          padding: 0 8px;
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
          transition: all 0.15s;
          background: rgba(10, 10, 14, 0.95);
          border: 2px solid;
          font-size: 11px;
        }

        .wk-list:hover {
          transform: scale(1.02);
        }

        .wk-list-icon {
          font-size: 10px;
          flex-shrink: 0;
        }

        .wk-list-title {
          font-weight: 500;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          flex: 1;
        }

        .wk-list-progress {
          font-size: 9px;
          opacity: 0.7;
          flex-shrink: 0;
        }

        .wk-allday {
          height: 22px;
          border-radius: 6px;
          padding: 0 8px;
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
          color: #fff;
          font-size: 11px;
          font-weight: 500;
        }

        .wk-allday:hover {
          filter: brightness(1.1);
        }

        .wk-allday-title {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          flex: 1;
        }
      `}</style>
      
      {/* Header */}
      <div className="wk-header">
        <div className="wk-header-time" />
        <div className="wk-header-scroll" ref={headerScrollRef} onScroll={handleScroll}>
          <div className="wk-header-days" style={{ width: TOTAL_WIDTH }}>
            {allDays.map((day, i) => (
              <div 
                key={i} 
                className={`wk-header-day ${isToday(day) ? 'today' : ''} ${isWeekStart(day) ? 'week-start' : ''}`}
                style={{ width: DAY_WIDTH }}
              >
                <div className="wk-day-name">{dayNames[day.getDay()]}</div>
                <div className="wk-day-date">
                  {day.toLocaleDateString('en-US', { month: 'short' })} {day.getDate()}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
      
      {/* Body */}
      <div className="wk-body">
        {/* Time column */}
        <div className="wk-time-column" ref={timeScrollRef} onScroll={handleScroll}>
          <div className="wk-time-inner" style={{ height: TOTAL_HEIGHT }}>
            {hours.map(hour => (
              <div 
                key={hour} 
                className="wk-time-label" 
                style={{ top: hour * HOUR_HEIGHT }}
              >
                {formatHour(hour)}
              </div>
            ))}
          </div>
        </div>
        
        {/* Scrollable grid */}
        <div className="wk-grid-scroll" ref={scrollRef} onScroll={handleScroll}>
          <div className="wk-grid" style={{ height: TOTAL_HEIGHT, width: TOTAL_WIDTH }}>
            {/* Hour lines */}
            {hours.map(hour => (
              <div 
                key={hour} 
                className={`wk-hour-row ${hour === 12 ? 'noon' : ''}`}
                style={{ top: hour * HOUR_HEIGHT, width: TOTAL_WIDTH }}
              />
            ))}
            
            {/* Day columns */}
            {allDays.map((day, dayIndex) => {
              const dayEvents = getEventsForDay(day);
              const dayAllDayEvents = getAllDayEventsForDay(day);
              const dayTasks = getTasksForDay(day);
              const dayLists = getListsForDay(day);
              const isTodayCol = isToday(day);
              const isWeekStartCol = isWeekStart(day);

              return (
                <div
                  key={dayIndex}
                  className={`wk-day-column ${isTodayCol ? 'today' : ''} ${isWeekStartCol ? 'week-start' : ''}`}
                  style={{ width: DAY_WIDTH }}
                >
                  {/* Current time indicator */}
                  {isTodayCol && (
                    <div className="wk-now-line" style={{ top: currentHourPosition }} />
                  )}

                  {/* All-day events, Tasks and Lists container at top */}
                  {(dayAllDayEvents.length > 0 || dayTasks.length > 0 || dayLists.length > 0) && (
                    <div className="wk-items-container">
                      {/* All-day events first */}
                      {dayAllDayEvents.map(event => {
                        const info = getEventInfo(event);
                        const color = info.project?.color || info.client?.color || '#6366f1';

                        return (
                          <div
                            key={event.id}
                            className="wk-allday"
                            style={{ background: `linear-gradient(135deg, ${color}dd, ${color}99)` }}
                            onClick={() => onEventClick && onEventClick(event)}
                            title={`All day: ${event.title}`}
                          >
                            <Calendar size={12} style={{ flexShrink: 0 }} />
                            <span className="wk-allday-title">{event.title}</span>
                          </div>
                        );
                      })}
                      {/* Tasks */}
                      {dayTasks.map(task => {
                        const info = getTaskInfo(task);
                        const color = info.project?.color || info.client?.color || '#6366f1';

                        return (
                          <div
                            key={task.id}
                            className={`wk-task ${task.isCompleted ? 'completed' : ''}`}
                            style={{
                              position: 'relative',
                              top: 'auto',
                              borderColor: color,
                              color: color
                            }}
                            onClick={() => {
                              if (task.listId && lists) {
                                const list = lists.find(l => l.id === task.listId);
                                if (list && onListClick) {
                                  onListClick(list);
                                  return;
                                }
                              }
                              onTaskClick && onTaskClick(task);
                            }}
                            title={`Task: ${task.title}`}
                          >
                            <div
                              className={`wk-task-check ${task.isCompleted ? 'checked' : ''}`}
                              onClick={(e) => { e.stopPropagation(); toggleTaskComplete(task.id); }}
                            >
                              {task.isCompleted && <Check size={10} color="#fff" />}
                            </div>
                            <span className="wk-task-title">{task.title}</span>
                            {task.listId && <List size={10} style={{ opacity: 0.6, marginLeft: 4, flexShrink: 0 }} />}
                          </div>
                        );
                      })}
                      {/* Lists */}
                      {dayLists.map(list => {
                        const info = getListInfo(list);
                        const color = info.project?.color || info.client?.color || '#6366f1';
                        const progress = getListProgress ? getListProgress(list.id) : { completed: 0, total: 0 };

                        return (
                          <div
                            key={list.id}
                            className="wk-list"
                            style={{
                              borderColor: color,
                              color: color
                            }}
                            onClick={() => onListClick && onListClick(list)}
                            title={`List: ${list.title}`}
                          >
                            <span className="wk-list-icon">📋</span>
                            <span className="wk-list-title">{list.title}</span>
                            <span className="wk-list-progress">{progress.completed}/{progress.total}</span>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  {/* Events */}
                  {dayEvents.map(event => {
                    const info = getEventInfo(event);
                    const color = info.project?.color || info.client?.color || '#6366f1';
                    const startHour = event.startTime.getHours() + event.startTime.getMinutes() / 60;
                    const endHour = event.endTime.getHours() + event.endTime.getMinutes() / 60;
                    const top = startHour * HOUR_HEIGHT;
                    const height = Math.max((endHour - startHour) * HOUR_HEIGHT, 20);

                    return (
                      <div
                        key={event.id}
                        className="wk-event"
                        style={{
                          top,
                          height,
                          background: `linear-gradient(135deg, ${color}dd, ${color}99)`
                        }}
                        onClick={() => onEventClick && onEventClick(event)}
                        title={`${event.title}\n${event.startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })} - ${event.endTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`}
                      >
                        <div className="wk-event-title">{event.title}</div>
                        {height > 30 && (
                          <div className="wk-event-time">
                            {event.startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  );
}

// ==================== TIMELINE COMPONENT ====================
function Timeline({ clients, internal, events, tasks, lists, teamMembers, navigateToClient, toggleTaskComplete, addTask, addEvent, addList, onEventClick, onTaskClick, onListClick, getListProgress, currentUser }) {
  const [currentTime, setCurrentTime] = React.useState(new Date());
  const [collapsedClients, setCollapsedClients] = React.useState({});
  const [viewMode, setViewMode] = React.useState('day'); // 'day' or 'week'
  const scrollContainerRef = React.useRef(null);
  const rulerScrollRef = React.useRef(null); // Synced header scroll for ruler
  const scrollingRef = React.useRef(null); // Track which element is scrolling to prevent feedback
  const dateIndicatorRef = React.useRef(null); // Direct DOM ref for date indicator
  const [containerWidth, setContainerWidth] = React.useState(800);
  const [showDatePicker, setShowDatePicker] = React.useState(false);
  const [targetDate, setTargetDate] = React.useState(new Date()); // Shared target date for both views
  const [scrollTrigger, setScrollTrigger] = React.useState(0); // Increment to force scroll
  const [visibleDate, setVisibleDate] = React.useState(new Date()); // Currently visible date in 8-hour view
  const visibleDateRef = React.useRef(new Date()); // Track visible date during scroll without re-renders
  const weekVisibleDateRef = React.useRef(new Date()); // Track week view's visible date
  const [showAddEventModal, setShowAddEventModal] = React.useState(false);
  const [showAddTaskModal, setShowAddTaskModal] = React.useState(false);
  const [showAddListModal, setShowAddListModal] = React.useState(false);
  const [itemsPopover, setItemsPopover] = React.useState(null); // { x, y, tasks, lists, color }
  
  // Combine clients with internal spaces for unified handling
  const allSpaces = [
    internal.personal,
    internal.team,
    ...clients
  ];
  
  const HOURS_VISIBLE = 8;
  const LABEL_WIDTH = 200;
  const ROW_HEIGHT = 60;
  const RULER_HEIGHT = 44;
  
  // Update time every minute
  React.useEffect(() => {
    const interval = setInterval(() => setCurrentTime(new Date()), 60000);
    return () => clearInterval(interval);
  }, []);
  
  // Measure container
  React.useEffect(() => {
    const measure = () => {
      if (scrollContainerRef.current) {
        const width = scrollContainerRef.current.clientWidth;
        if (width > 0) setContainerWidth(width);
      }
    };
    measure();
    const timer = setTimeout(measure, 100);
    window.addEventListener('resize', measure);
    return () => {
      clearTimeout(timer);
      window.removeEventListener('resize', measure);
    };
  }, []);
  
  // Toggle client collapse
  const toggleCollapse = (clientId) => {
    setCollapsedClients(prev => ({ ...prev, [clientId]: !prev[clientId] }));
  };

  // Calculate timeline dimensions - round to avoid floating point drift
  const pixelsPerHour = Math.round(containerWidth / HOURS_VISIBLE);
  
  // Time range - start 12 hours ago
  const rangeStart = new Date(currentTime.getTime() - 12 * 60 * 60 * 1000);
  rangeStart.setMinutes(0, 0, 0);
  
  // Calculate dynamic end based on furthest event/task
  const MIN_HOURS = 720; // Minimum 30 days forward
  let furthestTime = new Date(rangeStart.getTime() + MIN_HOURS * 60 * 60 * 1000);
  
  // Check all events for furthest end time
  events.forEach(event => {
    if (event.endTime > furthestTime) {
      furthestTime = new Date(event.endTime);
    }
  });
  
  // Check all tasks for furthest due date
  tasks.forEach(task => {
    if (task.dueDate > furthestTime) {
      furthestTime = new Date(task.dueDate);
    }
  });
  
  // Check all lists for furthest due date
  (lists || []).forEach(list => {
    if (list.dueDate > furthestTime) {
      furthestTime = new Date(list.dueDate);
    }
  });
  
  // Add 24 hour buffer after the furthest item
  furthestTime = new Date(furthestTime.getTime() + 24 * 60 * 60 * 1000);
  
  // Calculate total hours needed
  const TOTAL_HOURS = Math.ceil((furthestTime.getTime() - rangeStart.getTime()) / (1000 * 60 * 60));
  const totalWidth = TOTAL_HOURS * pixelsPerHour;
  
  const getPosition = (time) => {
    const hours = (time.getTime() - rangeStart.getTime()) / (1000 * 60 * 60);
    return hours * pixelsPerHour;
  };
  
  const nowPosition = getPosition(currentTime);
  
  // Handle scroll with sync between ruler and content (like WeeklyCalendarView pattern)
  const handleTimelineScroll = (e) => {
    const source = e.target;

    // If we're currently syncing from another source, ignore this event
    if (scrollingRef.current && scrollingRef.current !== source) {
      return;
    }

    // Mark this element as the scroll source
    scrollingRef.current = source;

    // Sync horizontal scroll between ruler and content
    if (source === scrollContainerRef.current && rulerScrollRef.current) {
      rulerScrollRef.current.scrollLeft = source.scrollLeft;
    } else if (source === rulerScrollRef.current && scrollContainerRef.current) {
      scrollContainerRef.current.scrollLeft = source.scrollLeft;
    }

    // Calculate visible date from center of viewport
    const scrollLeft = scrollContainerRef.current ? scrollContainerRef.current.scrollLeft : source.scrollLeft;
    const centerScrollLeft = scrollLeft + (containerWidth / 2);
    const hoursFromStart = centerScrollLeft / pixelsPerHour;
    const viewportDate = new Date(rangeStart.getTime() + hoursFromStart * 60 * 60 * 1000);

    // Check if we've crossed into a new day BEFORE updating ref
    const dayChanged = viewportDate.toDateString() !== visibleDateRef.current.toDateString();

    // Update ref immediately (no re-render)
    visibleDateRef.current = viewportDate;

    // Update date indicator directly via textContent (very fast, no layout)
    if (dateIndicatorRef.current) {
      dateIndicatorRef.current.textContent = viewportDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    // Update visibleDate state only when day actually changes (triggers re-render for badges)
    if (dayChanged) {
      setVisibleDate(viewportDate);
    }

    // Clear scroll source after sync completes
    clearTimeout(scrollingRef.scrollTimeout);
    scrollingRef.scrollTimeout = setTimeout(() => {
      scrollingRef.current = null;
    }, 50);
  };

  // Generate hour markers - memoized to prevent recalculation on visibleDate changes
  const hourMarkers = React.useMemo(() => {
    const markers = [];
    for (let h = 0; h < TOTAL_HOURS; h++) {
      const time = new Date(rangeStart.getTime() + h * 60 * 60 * 1000);
      markers.push({
        time,
        label: time.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true }),
        isNewDay: time.getHours() === 0,
        date: time.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
        left: h * pixelsPerHour
      });
    }
    return markers;
  }, [TOTAL_HOURS, rangeStart.getTime(), pixelsPerHour]);
  
  // Get events for a project (excludes all-day events - they show in badges)
  const getProjectEvents = (projectId) => {
    return events.filter(e => e.projectId === projectId && !e.allDay);
  };

  // Get all-day events for a project
  const getProjectAllDayEvents = (projectId) => {
    return events.filter(e => e.projectId === projectId && e.allDay);
  };

  // Get tasks for a project (includes list tasks with due dates)
  const getProjectTasks = (projectId) => {
    return tasks.filter(t => t.projectId === projectId && t.dueDate);
  };

  // Get all events for a client (all projects combined + client-level events, excludes all-day)
  const getClientEvents = (client) => {
    const projectIds = client.projects.map(p => p.id);
    return events.filter(e => (projectIds.includes(e.projectId) || (e.clientId === client.id && !e.projectId)) && !e.allDay);
  };

  // Get all all-day events for a client
  const getClientAllDayEvents = (client) => {
    const projectIds = client.projects.map(p => p.id);
    return events.filter(e => (projectIds.includes(e.projectId) || (e.clientId === client.id && !e.projectId)) && e.allDay);
  };

  // Get client-level events (no project, excludes all-day)
  const getClientLevelEvents = (clientId) => {
    return events.filter(e => e.clientId === clientId && !e.projectId && !e.allDay);
  };

  // Get client-level all-day events
  const getClientLevelAllDayEvents = (clientId) => {
    return events.filter(e => e.clientId === clientId && !e.projectId && e.allDay);
  };
  
  // Get all tasks for a client (includes list tasks with due dates)
  const getClientTasks = (client) => {
    return tasks.filter(t => t.clientId === client.id && t.dueDate);
  };
  
  // Get lists for a project
  const getProjectLists = (projectId) => {
    return (lists || []).filter(l => l.projectId === projectId && l.dueDate);
  };
  
  // Get all lists for a client
  const getClientLists = (client) => {
    return (lists || []).filter(l => l.clientId === client.id && l.dueDate);
  };
  
  // Get client-level lists (no project)
  const getClientLevelLists = (clientId) => {
    return (lists || []).filter(l => l.clientId === clientId && !l.projectId && l.dueDate);
  };
  
  // Group tasks and lists by day
  const groupItemsByDay = (rowTasks, rowLists) => {
    const groups = {};
    
    // Add tasks to groups
    rowTasks.forEach(task => {
      const dayKey = new Date(task.dueDate).toDateString();
      if (!groups[dayKey]) {
        groups[dayKey] = { tasks: [], lists: [], date: new Date(task.dueDate) };
      }
      groups[dayKey].tasks.push(task);
    });
    
    // Add lists to groups
    rowLists.forEach(list => {
      const dayKey = new Date(list.dueDate).toDateString();
      if (!groups[dayKey]) {
        groups[dayKey] = { tasks: [], lists: [], date: new Date(list.dueDate) };
      }
      groups[dayKey].lists.push(list);
    });
    
    // Convert to array and calculate positions
    return Object.values(groups).map(group => {
      const totalItems = group.tasks.length + group.lists.length;
      // Use noon of that day as the position for grouped items
      const displayDate = new Date(group.date);
      displayDate.setHours(12, 0, 0, 0);
      return {
        ...group,
        totalItems,
        isGrouped: totalItems >= 2,
        position: getPosition(displayDate),
        dayKey: group.date.toDateString()
      };
    });
  };

  // Auto-scroll when targetDate changes or switching views
  React.useEffect(() => {
    if (viewMode === 'day' && scrollContainerRef.current && containerWidth > 0) {
      const targetPosition = getPosition(targetDate);
      const scrollPos = Math.max(0, targetPosition - containerWidth * 0.15);
      scrollContainerRef.current.scrollLeft = scrollPos;
      if (rulerScrollRef.current) {
        rulerScrollRef.current.scrollLeft = scrollPos;
      }
    }
  }, [containerWidth, viewMode, targetDate]);

  const scrollToNow = () => {
    const now = new Date();
    setTargetDate(now);
    setVisibleDate(now);
    setScrollTrigger(prev => prev + 1);
    if (viewMode === 'day' && scrollContainerRef.current) {
      const scrollPos = Math.max(0, nowPosition - containerWidth * 0.15);
      scrollContainerRef.current.scrollTo({ left: scrollPos, behavior: 'smooth' });
      if (rulerScrollRef.current) {
        rulerScrollRef.current.scrollTo({ left: scrollPos, behavior: 'smooth' });
      }
    }
  };

  const scrollToDate = (date) => {
    const newTarget = new Date(date);
    newTarget.setHours(8, 0, 0, 0);
    setTargetDate(newTarget);
    setVisibleDate(newTarget);
    setScrollTrigger(prev => prev + 1);

    if (viewMode === 'day' && scrollContainerRef.current) {
      const targetPosition = getPosition(newTarget);
      const scrollPos = Math.max(0, targetPosition - containerWidth * 0.15);
      scrollContainerRef.current.scrollTo({ left: scrollPos, behavior: 'smooth' });
      if (rulerScrollRef.current) {
        rulerScrollRef.current.scrollTo({ left: scrollPos, behavior: 'smooth' });
      }
    }
    setShowDatePicker(false);
  };

  // Build rows - memoized to prevent recalculation on visibleDate changes
  const rows = React.useMemo(() => {
    const result = [];
    allSpaces.forEach(client => {
      const isCollapsed = collapsedClients[client.id];

      // Get tasks and lists for client row (includes list tasks with due dates)
      const clientRowTasks = isCollapsed ? getClientTasks(client) : tasks.filter(t => t.clientId === client.id && !t.projectId && t.dueDate);
      const clientRowLists = isCollapsed ? getClientLists(client) : getClientLevelLists(client.id);
      const clientRowAllDayEvents = isCollapsed ? getClientAllDayEvents(client) : getClientLevelAllDayEvents(client.id);

      // Client header row - when collapsed shows all, when expanded shows only client-level (no project)
      result.push({
        type: 'client',
        client,
        isCollapsed,
        events: isCollapsed ? getClientEvents(client) : getClientLevelEvents(client.id),
        allDayEvents: clientRowAllDayEvents,
        tasks: clientRowTasks,
        lists: clientRowLists,
        groupedItems: groupItemsByDay(clientRowTasks, clientRowLists)
      });

      // Project rows (if not collapsed)
      if (!isCollapsed) {
        client.projects.forEach(project => {
          const projectTasks = getProjectTasks(project.id);
          const projectLists = getProjectLists(project.id);
          const projectAllDayEvents = getProjectAllDayEvents(project.id);
          result.push({
            type: 'project',
            client,
            project,
            events: getProjectEvents(project.id),
            allDayEvents: projectAllDayEvents,
            tasks: projectTasks,
            lists: projectLists,
            groupedItems: groupItemsByDay(projectTasks, projectLists)
          });
        });
      }
    });
    return result;
  }, [allSpaces, collapsedClients, events, tasks, lists]);

  return (
    <div style={{ display: 'flex', flexDirection: 'column', flex: 1, overflow: 'hidden' }}>
      <style>{`
        .tl-controls {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding-bottom: 16px;
          flex-shrink: 0;
          gap: 12px;
          flex-wrap: wrap;
        }
        
        .tl-controls-left {
          display: flex;
          align-items: center;
          gap: 12px;
          flex-wrap: wrap;
          min-width: 0;
        }
        
        .tl-controls-center {
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .tl-controls-right {
          display: flex;
          align-items: center;
          gap: 6px;
        }
        
        .tl-add-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          padding: 8px 14px;
          border-radius: 2px;
          background: rgba(99, 102, 241, 0.12);
          border: 1px solid rgba(99, 102, 241, 0.3);
          color: #818cf8;
          font-size: 11px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.1s;
          font-family: inherit;
          white-space: nowrap;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .tl-add-btn .btn-text {
          display: inline;
        }

        .tl-add-btn:hover {
          background: rgba(99, 102, 241, 0.2);
          border-color: rgba(99, 102, 241, 0.5);
        }

        /* Responsive: hide text on smaller screens */
        @media (max-width: 900px) {
          .tl-add-btn {
            padding: 8px 10px;
          }
          .tl-add-btn .btn-text {
            display: none;
          }
          .tl-today-date {
            font-size: 14px !important;
          }
          .tl-btn {
            padding: 8px 12px !important;
            font-size: 10px !important;
          }
          .tl-btn .btn-text {
            display: none;
          }
          .tl-toggle-btn {
            padding: 6px 12px !important;
            font-size: 10px !important;
          }
        }
        
        @media (max-width: 700px) {
          .tl-controls {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
          }
          .tl-controls-left {
            justify-content: space-between;
          }
          .tl-controls-center {
            order: 3;
            justify-content: center;
          }
          .tl-controls-right {
            order: 2;
            justify-content: flex-end;
          }
          .tl-today-display {
            margin-right: 0 !important;
          }
        }
        
        .tl-add-modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
        }
        
        .tl-add-modal {
          background: #18181b;
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 2px;
          width: 480px;
          max-width: 90vw;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .tl-add-modal-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 20px 24px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .tl-add-modal-header h3 {
          font-size: 14px;
          font-weight: 600;
          color: #fff;
          margin: 0;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        
        .tl-add-modal-close {
          background: none;
          border: none;
          color: #71717a;
          cursor: pointer;
          padding: 4px;
          border-radius: 2px;
          transition: all 0.1s;
        }
        
        .tl-add-modal-close:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #fff;
        }
        
        .tl-add-modal-body {
          padding: 24px;
          display: flex;
          flex-direction: column;
          gap: 16px;
        }
        
        .tl-add-form-row {
          display: flex;
          gap: 12px;
          align-items: center;
        }
        
        .tl-add-input, .tl-add-select {
          flex: 1;
          padding: 10px 14px;
          border-radius: 2px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(255, 255, 255, 0.12);
          color: #fff;
          font-size: 13px;
          font-family: inherit;
          outline: none;
          transition: all 0.1s;
        }

        .tl-add-input:focus, .tl-add-select:focus {
          border-color: rgba(99, 102, 241, 0.5);
        }

        .tl-add-input::placeholder {
          color: #52525b;
        }

        .tl-add-select {
          cursor: pointer;
        }

        .tl-add-select:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .tl-add-input[type="date"],
        .tl-add-input[type="time"] {
          position: relative;
        }

        .tl-add-input[type="date"]::-webkit-calendar-picker-indicator,
        .tl-add-input[type="time"]::-webkit-calendar-picker-indicator {
          filter: invert(1);
          opacity: 0.6;
          cursor: pointer;
          padding: 4px;
          margin-right: -4px;
          border-radius: 2px;
          transition: all 0.1s;
        }

        .tl-add-input[type="date"]::-webkit-calendar-picker-indicator:hover,
        .tl-add-input[type="time"]::-webkit-calendar-picker-indicator:hover {
          opacity: 1;
          filter: invert(1) brightness(1.5);
          background: rgba(99, 102, 241, 0.5);
        }

        .tl-add-input[type="date"]::-webkit-datetime-edit,
        .tl-add-input[type="time"]::-webkit-datetime-edit {
          color: #a1a1aa;
        }

        .tl-add-input[type="date"]:focus::-webkit-datetime-edit,
        .tl-add-input[type="time"]:focus::-webkit-datetime-edit {
          color: #fff;
        }
        
        .tl-add-modal-footer {
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          padding: 16px 24px;
          border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .tl-add-modal-btn {
          padding: 10px 20px;
          border-radius: 2px;
          font-size: 11px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.1s;
          font-family: inherit;
          border: none;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .tl-add-modal-btn.primary {
          background: #6366f1;
          color: #fff;
        }

        .tl-add-modal-btn.primary:hover {
          background: #5558e3;
        }

        .tl-add-modal-btn.secondary {
          background: transparent;
          color: #a1a1aa;
          border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .tl-add-modal-btn.secondary:hover {
          background: rgba(255, 255, 255, 0.08);
          color: #fff;
        }
        
        .tl-btn-group {
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .tl-date-btn {
          font-size: 14px;
          font-weight: 600;
          color: #fff;
          background: none;
          border: none;
          cursor: pointer;
          padding: 6px 12px;
          border-radius: 2px;
          transition: all 0.1s;
          display: flex;
          align-items: center;
          gap: 8px;
          font-family: inherit;
        }

        .tl-date-btn:hover {
          background: rgba(255, 255, 255, 0.1);
        }

        .tl-today-display {
          display: flex;
          flex-direction: column;
          margin-right: 16px;
        }

        .tl-today-label {
          font-size: 9px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: #52525b;
          margin-bottom: 2px;
        }

        .tl-today-date {
          font-size: 14px;
          font-weight: 600;
          color: #fff;
        }

        .tl-date-picker-wrapper {
          position: relative;
        }

        .tl-date-picker-popup {
          position: absolute;
          top: 100%;
          left: 0;
          margin-top: 8px;
          background: #18181b;
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 2px;
          padding: 16px;
          z-index: 100;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .tl-picker-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 12px;
        }
        
        .tl-picker-title {
          font-size: 14px;
          font-weight: 600;
          color: #e4e4e7;
        }
        
        .tl-picker-nav {
          display: flex;
          gap: 4px;
        }
        
        .tl-picker-nav-btn {
          width: 26px;
          height: 26px;
          border-radius: 2px;
          background: rgba(255, 255, 255, 0.06);
          border: none;
          color: #a1a1aa;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.1s;
        }

        .tl-picker-nav-btn:hover {
          background: rgba(255, 255, 255, 0.12);
          color: #fff;
        }
        
        .tl-picker-weekdays {
          display: grid;
          grid-template-columns: repeat(7, 32px);
          gap: 2px;
          margin-bottom: 4px;
        }
        
        .tl-picker-weekday {
          font-size: 10px;
          color: #52525b;
          text-align: center;
          padding: 4px 0;
        }
        
        .tl-picker-days {
          display: grid;
          grid-template-columns: repeat(7, 32px);
          gap: 2px;
        }
        
        .tl-picker-day {
          width: 32px;
          height: 32px;
          border-radius: 2px;
          background: none;
          border: none;
          color: #a1a1aa;
          font-size: 12px;
          cursor: pointer;
          transition: all 0.1s;
          font-family: inherit;
        }

        .tl-picker-day:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #fff;
        }

        .tl-picker-day.today {
          background: rgba(99, 102, 241, 0.2);
          color: #818cf8;
        }

        .tl-picker-day.other-month {
          color: #3f3f46;
        }

        .tl-picker-day.other-month:hover {
          color: #71717a;
        }
        
        .tl-btn {
          padding: 8px 16px;
          border-radius: 2px;
          background: rgba(255, 255, 255, 0.06);
          border: 1px solid rgba(255, 255, 255, 0.12);
          color: #a1a1aa;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.1s;
          display: flex;
          align-items: center;
          font-family: inherit;
          white-space: nowrap;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .tl-btn .btn-text {
          display: inline;
        }

        .tl-btn:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #fff;
        }

        .tl-toggle {
          display: flex;
          background: rgba(255, 255, 255, 0.03);
          border-radius: 2px;
          padding: 3px;
          border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .tl-toggle-btn {
          padding: 7px 18px;
          border: none;
          background: transparent;
          color: #71717a;
          font-size: 11px;
          font-weight: 500;
          cursor: pointer;
          border-radius: 2px;
          transition: all 0.1s;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .tl-toggle-btn:hover { color: #a1a1aa; }
        .tl-toggle-btn.active { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        
        .tl-container {
          flex: 1;
          display: flex;
          background: rgba(15, 15, 20, 0.9);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 2px;
          overflow: hidden;
          min-height: 0;
        }
        
        .tl-labels {
          width: ${LABEL_WIDTH}px;
          flex-shrink: 0;
          background: rgba(10, 10, 14, 0.95);
          border-right: 1px solid rgba(255, 255, 255, 0.08);
          display: flex;
          flex-direction: column;
        }
        
        /* Responsive: narrower labels on small screens */
        @media (max-width: 800px) {
          .tl-labels {
            width: 150px;
          }
          .tl-label-row.project {
            padding-left: 20px;
          }
        }
        
        @media (max-width: 600px) {
          .tl-labels {
            width: 120px;
          }
          .tl-label-header {
            font-size: 9px !important;
          }
          .tl-label-text {
            font-size: 11px !important;
          }
          .tl-label-row.project .tl-label-text {
            font-size: 10px !important;
          }
        }
        
        .tl-label-header {
          height: 44px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: #52525b;
          border-bottom: 1px solid rgba(255, 255, 255, 0.08);
          flex-shrink: 0;
        }
        
        .tl-label-row {
          height: ${ROW_HEIGHT}px;
          display: flex;
          align-items: center;
          padding: 0 12px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.04);
          gap: 10px;
        }
        
        .tl-label-row.client {
          background: rgba(255, 255, 255, 0.02);
          cursor: pointer;
        }
        
        .tl-label-row.client:hover {
          background: rgba(255, 255, 255, 0.04);
        }
        
        .tl-label-row.project {
          padding-left: 32px;
        }
        
        .tl-collapse-btn {
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 4px;
          background: rgba(255, 255, 255, 0.05);
          color: #71717a;
          flex-shrink: 0;
        }
        
        .tl-label-dot {
          width: 10px;
          height: 10px;
          border-radius: 50%;
          flex-shrink: 0;
        }
        
        .tl-label-text {
          font-size: 13px;
          font-weight: 500;
          color: #e4e4e7;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .tl-label-row.project .tl-label-text {
          font-size: 12px;
          color: #a1a1aa;
        }
        
        .tl-scroll-wrapper {
          flex: 1;
          display: flex;
          flex-direction: column;
          overflow: hidden;
          min-width: 0;
        }

        .tl-header {
          display: flex;
          border-bottom: 1px solid rgba(255, 255, 255, 0.08);
          flex-shrink: 0;
          position: relative;
        }

        .tl-header-date {
          position: absolute;
          left: 0;
          top: 0;
          bottom: 0;
          z-index: 15;
          background: rgba(10, 10, 14, 0.98);
          padding: 0 12px;
          font-size: 12px;
          font-weight: 600;
          color: #a78bfa;
          display: flex;
          align-items: center;
          border-right: 1px solid rgba(99, 102, 241, 0.3);
          pointer-events: none;
        }

        .tl-ruler-scroll {
          flex: 1;
          overflow-x: auto;
          overflow-y: hidden;
        }

        .tl-ruler-scroll::-webkit-scrollbar {
          display: none;
        }

        .tl-body {
          flex: 1;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }

        .tl-scroll {
          flex: 1;
          overflow-x: auto;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }

        .tl-scroll::-webkit-scrollbar {
          width: 8px;
          height: 8px;
        }

        .tl-scroll::-webkit-scrollbar-track {
          background: rgba(255, 255, 255, 0.02);
        }

        .tl-scroll::-webkit-scrollbar-thumb {
          background: rgba(255, 255, 255, 0.1);
          border-radius: 4px;
        }

        .tl-content {
          display: flex;
          flex-direction: column;
          min-height: 100%;
        }
        
        .tl-ruler {
          height: 44px;
          position: relative;
          background: rgba(10, 10, 14, 0.95);
          border-bottom: 1px solid rgba(255, 255, 255, 0.08);
          flex-shrink: 0;
        }
        
        .tl-hour {
          position: absolute;
          top: 0;
          height: 100%;
          padding-left: 8px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          border-left: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .tl-hour.new-day {
          border-left: 2px solid rgba(99, 102, 241, 0.5);
          background: linear-gradient(90deg, rgba(99, 102, 241, 0.1) 0%, transparent 60px);
        }
        
        .tl-hour-time {
          font-size: 10px;
          font-family: 'JetBrains Mono', monospace;
          color: #71717a;
        }
        
        .tl-hour-date {
          font-size: 9px;
          color: #a78bfa;
          font-weight: 500;
        }
        
        .tl-now-marker {
          position: absolute;
          top: 0;
          bottom: 0;
          width: 2px;
          background: #ef4444;
          z-index: 50;
        }
        
        .tl-now-label {
          position: absolute;
          top: 4px;
          left: 50%;
          transform: translateX(-50%);
          font-size: 8px;
          font-weight: 700;
          color: #ef4444;
          background: rgba(10, 10, 14, 0.95);
          padding: 2px 6px;
          border-radius: 3px;
          white-space: nowrap;
        }
        
        .tl-tracks {
          flex: 1;
          position: relative;
          transform: translateZ(0);
          contain: layout style;
        }

        .tl-now-line {
          position: absolute;
          top: 0;
          bottom: 0;
          width: 2px;
          background: #ef4444;
          z-index: 50;
        }

        .tl-hour-grid {
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          pointer-events: none;
          z-index: 1;
        }

        .tl-hour-line {
          position: absolute;
          top: 0;
          bottom: 0;
          width: 1px;
          background: rgba(255, 255, 255, 0.04);
        }

        .tl-hour-line.new-day {
          width: 2px;
          background: rgba(99, 102, 241, 0.2);
        }
        
        .tl-track {
          height: ${ROW_HEIGHT}px;
          position: relative;
          border-bottom: 1px solid rgba(255, 255, 255, 0.04);
          display: flex;
          align-items: stretch;
        }

        .tl-track.client {
          background-color: rgba(255, 255, 255, 0.02);
        }

        .tl-past {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.3);
          pointer-events: none;
        }

        .tl-event {
          position: absolute;
          top: 8px;
          bottom: 8px;
          border-radius: 6px;
          padding: 0 10px;
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
          overflow: hidden;
          border: 1px solid rgba(255, 255, 255, 0.1);
          z-index: 10;
        }

        .tl-event:hover {
          filter: brightness(1.1);
          z-index: 15;
        }
        
        .tl-event.past {
          opacity: 0.5;
        }
        
        .tl-event-title {
          font-size: 11px;
          font-weight: 500;
          color: #fff;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .tl-event-time {
          font-size: 9px;
          color: rgba(255, 255, 255, 0.7);
          margin-left: auto;
          white-space: nowrap;
        }

        /* Sticky badges container within each track */
        .tl-track-badges {
          position: sticky;
          left: 0;
          top: 0;
          bottom: 0;
          z-index: 20;
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 0 8px;
          background: linear-gradient(90deg, rgba(10, 10, 14, 0.98) 0%, rgba(10, 10, 14, 0.95) 70%, transparent 100%);
          pointer-events: auto;
          height: 100%;
          flex-shrink: 0;
          min-width: fit-content;
        }

        .tl-badge {
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 0 10px;
          border-radius: 6px;
          border: 1.5px solid;
          background: rgba(10, 10, 14, 0.95);
          cursor: pointer;
          font-size: 11px;
          white-space: nowrap;
          pointer-events: auto;
          max-width: 100px;
        }

        .tl-badge:hover {
          transform: scale(1.05);
          z-index: 35;
        }

        .tl-badge-list {
          border-style: dashed;
          height: 44px;
        }

        .tl-badge-allday {
          border-radius: 6px;
          color: #fff;
          font-weight: 500;
          height: 44px;
          border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tl-badge-task {
          height: 44px;
        }

        .tl-badge-fraction {
          font-weight: 600;
          font-size: 10px;
        }

        .tl-badge-task.completed {
          opacity: 0.5;
        }

        .tl-badge-task.completed .tl-badge-title {
          text-decoration: line-through;
        }

        .tl-badge-check {
          width: 12px;
          height: 12px;
          border-radius: 3px;
          border: 1.5px solid;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
        }

        .tl-badge-title {
          overflow: hidden;
          text-overflow: ellipsis;
          color: #a1a1aa;
          font-size: 10px;
        }

        .tl-task {
          position: absolute;
          top: 12px;
          bottom: 12px;
          border-radius: 6px;
          padding: 0 10px;
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
          overflow: hidden;
          background: rgba(10, 10, 14, 0.95);
          border: 2px solid;
          transition: all 0.15s ease;
          z-index: 20;
          min-width: 24px;
        }
        
        .tl-task:hover {
          transform: scale(1.05);
          z-index: 25;
        }
        
        .tl-task.completed {
          opacity: 0.4;
        }
        
        .tl-task-check {
          width: 14px;
          height: 14px;
          border-radius: 3px;
          border: 2px solid currentColor;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
        }
        
        .tl-task.completed .tl-task-check {
          background: currentColor;
        }
        
        .tl-task-title {
          font-size: 11px;
          font-weight: 500;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .tl-task.completed .tl-task-title {
          text-decoration: line-through;
        }
        
        /* Grouped items indicator */
        .tl-items-group {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          height: 36px;
          min-width: 50px;
          padding: 0 10px;
          border-radius: 8px;
          border: 2px solid;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.15s;
          z-index: 10;
        }
        
        .tl-items-group:hover {
          transform: translateY(-50%) scale(1.05);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .tl-group-count {
          font-size: 14px;
          font-weight: 700;
          line-height: 1;
        }
        
        .tl-group-label {
          font-size: 9px;
          opacity: 0.7;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }
        
        /* Single list item */
        .tl-list {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          height: 36px;
          min-width: 100px;
          max-width: 150px;
          padding: 0 10px;
          border-radius: 8px;
          border: 2px dashed;
          border-color: #8b5cf6;
          background: rgba(139, 92, 246, 0.15);
          display: flex;
          align-items: center;
          gap: 6px;
          cursor: pointer;
          transition: all 0.15s;
          z-index: 10;
        }
        
        .tl-list:hover {
          transform: translateY(-50%) scale(1.02);
          background: rgba(139, 92, 246, 0.25);
        }
        
        .tl-list-icon {
          font-size: 12px;
          flex-shrink: 0;
        }
        
        .tl-list-title {
          font-size: 11px;
          color: #c4b5fd;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          flex: 1;
        }
        
        .tl-list-progress {
          font-size: 10px;
          color: #a78bfa;
          opacity: 0.8;
          flex-shrink: 0;
        }
        
        /* Items popover */
        .tl-popover-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          z-index: 1000;
        }
        
        .tl-popover {
          position: fixed;
          background: #1c1c20;
          border: 1px solid rgba(255, 255, 255, 0.12);
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
          min-width: 280px;
          max-width: 360px;
          max-height: 400px;
          overflow: hidden;
          display: flex;
          flex-direction: column;
          z-index: 1001;
        }
        
        .tl-popover-header {
          padding: 12px 16px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.08);
          font-weight: 600;
          font-size: 13px;
          color: #e4e4e7;
          display: flex;
          align-items: center;
          justify-content: space-between;
        }
        
        .tl-popover-close {
          width: 24px;
          height: 24px;
          border-radius: 6px;
          background: transparent;
          border: none;
          color: #71717a;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .tl-popover-close:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #fff;
        }
        
        .tl-popover-content {
          padding: 8px;
          overflow-y: auto;
          flex: 1;
        }
        
        .tl-popover-section {
          margin-bottom: 8px;
        }
        
        .tl-popover-section:last-child {
          margin-bottom: 0;
        }
        
        .tl-popover-section-title {
          font-size: 10px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: #52525b;
          padding: 4px 8px;
        }
        
        .tl-popover-item {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 10px 12px;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.15s;
        }
        
        .tl-popover-item:hover {
          background: rgba(255, 255, 255, 0.06);
        }
        
        .tl-popover-task-check {
          width: 18px;
          height: 18px;
          border-radius: 5px;
          border: 2px solid;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
        }
        
        .tl-popover-task-check.checked {
          background: currentColor;
        }
        
        .tl-popover-item-info {
          flex: 1;
          min-width: 0;
        }
        
        .tl-popover-item-title {
          font-size: 13px;
          color: #e4e4e7;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .tl-popover-item.completed .tl-popover-item-title {
          text-decoration: line-through;
          opacity: 0.6;
        }
        
        .tl-popover-item-meta {
          font-size: 11px;
          color: #71717a;
          margin-top: 2px;
        }
        
        .tl-popover-list-icon {
          font-size: 16px;
          flex-shrink: 0;
        }
        
        .tl-popover-list-progress {
          display: flex;
          align-items: center;
          gap: 8px;
          flex-shrink: 0;
        }
        
        .tl-popover-list-bar {
          width: 50px;
          height: 4px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 2px;
          overflow: hidden;
        }
        
        .tl-popover-list-bar-fill {
          height: 100%;
          background: #22c55e;
          border-radius: 2px;
        }
        
        .tl-popover-list-count {
          font-size: 11px;
          color: #71717a;
        }
      `}</style>
      
      {/* Controls */}
      <div className="tl-controls">
        <div className="tl-controls-left">
          <div className="tl-today-display">
            <span className="tl-today-label">Today</span>
            <span className="tl-today-date">
              {currentTime.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
            </span>
          </div>
          <div className="tl-btn-group">
            <button className="tl-btn" onClick={scrollToNow} title="Jump to Now">
              <Clock size={14} style={{ marginRight: 6 }} />
              <span className="btn-text">Now</span>
            </button>
            <div className="tl-date-picker-wrapper">
              <button className="tl-btn" onClick={() => setShowDatePicker(!showDatePicker)} title="Jump to Date">
                <Calendar size={14} style={{ marginRight: 6 }} />
                <span className="btn-text">Date</span>
              </button>
              {showDatePicker && (
                <TimelineDatePicker 
                  onSelect={scrollToDate} 
                  onClose={() => setShowDatePicker(false)}
                  currentTime={currentTime}
                />
              )}
            </div>
          </div>
        </div>
        <div className="tl-controls-center">
          <button className="tl-add-btn" onClick={() => setShowAddEventModal(true)} title="Add Event">
            <Plus size={14} /> <span className="btn-text">Event</span>
          </button>
          <button className="tl-add-btn" onClick={() => setShowAddTaskModal(true)} title="Add Task">
            <Plus size={14} /> <span className="btn-text">Task</span>
          </button>
          <button className="tl-add-btn" onClick={() => setShowAddListModal(true)} title="Add List" style={{ borderColor: 'rgba(139, 92, 246, 0.3)', background: 'rgba(139, 92, 246, 0.15)', color: '#a78bfa' }}>
            <Plus size={14} /> <span className="btn-text">List</span>
          </button>
        </div>
        <div className="tl-toggle">
          <button className={`tl-toggle-btn ${viewMode === 'day' ? 'active' : ''}`} onClick={() => {
            if (viewMode !== 'day') {
              // When switching from week to day, use the ref but set time to 8am for sensible view
              const targetDay = new Date(weekVisibleDateRef.current);
              targetDay.setHours(8, 0, 0, 0);
              setTargetDate(targetDay);
              setViewMode('day');
            }
          }}>8-Hour</button>
          <button className={`tl-toggle-btn ${viewMode === 'week' ? 'active' : ''}`} onClick={() => {
            if (viewMode !== 'week') {
              // When switching from day to week, use ref (snap to current position)
              setTargetDate(new Date(visibleDateRef.current));
              setScrollTrigger(prev => prev + 1);
              setViewMode('week');
            }
          }}>7-Day</button>
        </div>
      </div>
      
      {/* Add Event Modal */}
      {showAddEventModal && (
        <EventModal
          onClose={() => setShowAddEventModal(false)}
          onSave={addEvent}
          clients={clients}
          internal={internal}
          teamMembers={teamMembers}
          currentUserId={currentUser?.id}
        />
      )}
      
      {/* Add Task Modal */}
      {showAddTaskModal && (
        <TaskModal
          onClose={() => setShowAddTaskModal(false)}
          onSave={addTask}
          clients={clients}
          internal={internal}
          teamMembers={teamMembers}
        />
      )}
      
      {/* Add List Modal */}
      {showAddListModal && (
        <ListModal
          onClose={() => setShowAddListModal(false)}
          onSave={addList}
          clients={clients}
          internal={internal}
          teamMembers={teamMembers}
          tasks={[]}
        />
      )}
      
      {/* Items Popover */}
      {itemsPopover && (
        <>
          <div className="tl-popover-overlay" onClick={() => setItemsPopover(null)} />
          <div 
            className="tl-popover"
            style={{ 
              left: Math.min(itemsPopover.x - 140, window.innerWidth - 300),
              top: Math.min(itemsPopover.y, window.innerHeight - 420)
            }}
          >
            <div className="tl-popover-header">
              <span>
                {new Date(itemsPopover.date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}
              </span>
              <button className="tl-popover-close" onClick={() => setItemsPopover(null)}>
                <X size={14} />
              </button>
            </div>
            <div className="tl-popover-content">
              {/* Lists */}
              {itemsPopover.lists.length > 0 && (
                <div className="tl-popover-section">
                  <div className="tl-popover-section-title">Lists</div>
                  {itemsPopover.lists.map(list => {
                    const progress = getListProgress ? getListProgress(list.id) : { completed: 0, total: 0 };
                    const progressPercent = progress.total > 0 ? (progress.completed / progress.total) * 100 : 0;
                    return (
                      <div 
                        key={list.id}
                        className="tl-popover-item"
                        onClick={() => { setItemsPopover(null); onListClick && onListClick(list); }}
                      >
                        <span className="tl-popover-list-icon">📋</span>
                        <div className="tl-popover-item-info">
                          <div className="tl-popover-item-title">{list.title}</div>
                        </div>
                        <div className="tl-popover-list-progress">
                          <div className="tl-popover-list-bar">
                            <div className="tl-popover-list-bar-fill" style={{ width: `${progressPercent}%` }} />
                          </div>
                          <span className="tl-popover-list-count">{progress.completed}/{progress.total}</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
              
              {/* Tasks */}
              {itemsPopover.tasks.length > 0 && (
                <div className="tl-popover-section">
                  <div className="tl-popover-section-title">Tasks</div>
                  {itemsPopover.tasks.map(task => {
                    const assignee = teamMembers.find(m => m.id === task.assignedTo);
                    return (
                      <div 
                        key={task.id}
                        className={`tl-popover-item ${task.isCompleted ? 'completed' : ''}`}
                        onClick={() => {
                          setItemsPopover(null);
                          if (task.listId && lists) {
                            const list = lists.find(l => l.id === task.listId);
                            if (list && onListClick) {
                              onListClick(list);
                              return;
                            }
                          }
                          onTaskClick && onTaskClick(task);
                        }}
                      >
                        <div 
                          className={`tl-popover-task-check ${task.isCompleted ? 'checked' : ''}`}
                          style={{ borderColor: itemsPopover.color, color: itemsPopover.color }}
                        >
                          {task.isCompleted && <Check size={10} color="#fff" />}
                        </div>
                        <div className="tl-popover-item-info">
                          <div className="tl-popover-item-title" style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
                            {task.title}
                            {task.listId && <List size={12} style={{ opacity: 0.6, flexShrink: 0 }} />}
                          </div>
                          {assignee && <div className="tl-popover-item-meta">{assignee.name}</div>}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </>
      )}
      
      {/* 6-Hour Timeline View */}
      {viewMode === 'day' && (
      <div className="tl-container">
        {/* Labels */}
        <div className="tl-labels">
          <div className="tl-label-header">Clients / Projects</div>
          {rows.map((row, i) => (
            <div
              key={i}
              className={`tl-label-row ${row.type}`}
              onClick={() => row.type === 'client' && toggleCollapse(row.client.id)}
            >
              {row.type === 'client' && (
                <>
                  <div className="tl-collapse-btn">
                    {row.isCollapsed ? <ChevronRight size={12} /> : <ChevronDown size={12} />}
                  </div>
                  <div className="tl-label-dot" style={{ background: row.client.color }} />
                  <span className="tl-label-text">{row.client.name}</span>
                </>
              )}
              {row.type === 'project' && (
                <>
                  <div className="tl-label-dot" style={{ background: row.project.color, width: 8, height: 8 }} />
                  <span className="tl-label-text">{row.project.name}</span>
                </>
              )}
            </div>
          ))}
        </div>

        {/* Scrollable area with synced header/content (like WeeklyCalendarView) */}
        <div className="tl-scroll-wrapper">
          {/* Header with synced ruler scroll */}
          <div className="tl-header">
            <div className="tl-header-date" ref={dateIndicatorRef}>
              {visibleDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
            </div>
            <div className="tl-ruler-scroll" ref={rulerScrollRef} onScroll={handleTimelineScroll}>
              <div className="tl-ruler" style={{ width: totalWidth }}>
                {hourMarkers.map((m, i) => (
                  <div key={i} className={`tl-hour ${m.isNewDay ? 'new-day' : ''}`} style={{ left: m.left }}>
                    <span className="tl-hour-time">{m.label}</span>
                    {m.isNewDay && <span className="tl-hour-date">{m.date}</span>}
                  </div>
                ))}
                <div className="tl-now-marker" style={{ left: nowPosition }}>
                  <span className="tl-now-label">NOW</span>
                </div>
              </div>
            </div>
          </div>

          {/* Body with main scrollable content */}
          <div className="tl-body">
            <div className="tl-scroll" ref={scrollContainerRef} onScroll={handleTimelineScroll}>
              <div className="tl-content" style={{ width: totalWidth }}>
                {/* Tracks */}
                <div className="tl-tracks">
                  {/* Hour grid lines - single overlay for performance */}
                  <div className="tl-hour-grid">
                    {hourMarkers.map((m, i) => (
                      <div key={i} className={`tl-hour-line ${m.isNewDay ? 'new-day' : ''}`} style={{ left: m.left }} />
                    ))}
                  </div>
                  <div className="tl-now-line" style={{ left: nowPosition }} />
                  {rows.map((row, i) => {
                    const color = row.type === 'client' ? row.client.color : row.project?.color || row.client.color;

                    // Get items for current visible date for sticky badges
                    const visibleDateStr = visibleDate.toDateString();
                    const visibleAllDayEvents = (row.allDayEvents || []).filter(e =>
                      new Date(e.startTime).toDateString() === visibleDateStr
                    );
                    const visibleTasks = row.tasks.filter(t =>
                      t.dueDate && new Date(t.dueDate).toDateString() === visibleDateStr
                    );
                    const visibleLists = (row.lists || []).filter(l =>
                      l.dueDate && new Date(l.dueDate).toDateString() === visibleDateStr
                    );
                    const hasBadges = visibleAllDayEvents.length > 0 || visibleTasks.length > 0 || visibleLists.length > 0;

                    return (
                      <div key={i} className={`tl-track ${row.type}`}>
                        <div className="tl-past" style={{ width: nowPosition }} />

                        {/* Sticky badges container */}
                        {hasBadges && (
                          <div className="tl-track-badges">
                            {/* All-day events */}
                            {visibleAllDayEvents.map(event => (
                              <div
                                key={`badge-allday-${event.id}`}
                                className="tl-badge tl-badge-allday"
                                style={{ background: `linear-gradient(135deg, ${color}dd, ${color}99)` }}
                                title={event.title}
                                onClick={() => onEventClick && onEventClick(event)}
                              >
                                <Calendar size={10} />
                                <span className="tl-badge-title">{event.title}</span>
                              </div>
                            ))}
                            {/* Tasks */}
                            {visibleTasks.map(task => (
                              <div
                                key={`badge-task-${task.id}`}
                                className={`tl-badge tl-badge-task ${task.isCompleted ? 'completed' : ''}`}
                                style={{ borderColor: color }}
                                title={task.title}
                                onClick={() => {
                                  if (task.listId && lists) {
                                    const list = lists.find(l => l.id === task.listId);
                                    if (list && onListClick) {
                                      onListClick(list);
                                      return;
                                    }
                                  }
                                  onTaskClick && onTaskClick(task);
                                }}
                              >
                                <div
                                  className="tl-badge-check"
                                  style={{ borderColor: color, background: task.isCompleted ? color : 'transparent' }}
                                  onClick={(e) => { e.stopPropagation(); toggleTaskComplete(task.id); }}
                                >
                                  {task.isCompleted && <Check size={8} color="#fff" />}
                                </div>
                                <span className="tl-badge-title">{task.title}</span>
                                {task.listId && <List size={10} style={{ opacity: 0.6, marginLeft: 2, flexShrink: 0 }} />}
                              </div>
                            ))}
                            {/* Lists */}
                            {visibleLists.map(list => {
                              const progress = getListProgress ? getListProgress(list.id) : { completed: 0, total: 0 };
                              return (
                                <div
                                  key={`badge-list-${list.id}`}
                                  className="tl-badge tl-badge-list"
                                  style={{ borderColor: color, background: `${color}15` }}
                                  title={`${list.title}\n${progress.completed}/${progress.total} completed`}
                                  onClick={() => onListClick && onListClick(list)}
                                >
                                  <List size={12} />
                                  <span className="tl-badge-fraction">{progress.completed}/{progress.total}</span>
                                </div>
                              );
                            })}
                          </div>
                        )}

                        {/* Events */}
                        {row.events.map(event => {
                          const left = getPosition(event.startTime);
                          const width = Math.max(getPosition(event.endTime) - left, 30);
                          const isPast = event.endTime < currentTime;

                          return (
                            <div
                              key={event.id}
                              className={`tl-event ${isPast ? 'past' : ''}`}
                              style={{
                                left,
                                width,
                                background: `linear-gradient(135deg, ${color}dd, ${color}99)`
                              }}
                              title={`${event.title}\n${formatTime(event.startTime)} - ${formatTime(event.endTime)}`}
                              onClick={() => onEventClick && onEventClick(event)}
                            >
                              {width > 60 && <span className="tl-event-title">{event.title}</span>}
                              {width > 120 && <span className="tl-event-time">{formatTime(event.startTime)}</span>}
                            </div>
                          );
                        })}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      )}
      
      {/* Weekly Calendar View */}
      {viewMode === 'week' && (
        <WeeklyCalendarView
          events={events}
          tasks={tasks}
          lists={lists}
          clients={clients}
          internal={internal}
          currentTime={currentTime}
          targetDate={targetDate}
          scrollTrigger={scrollTrigger}
          onEventClick={onEventClick}
          onTaskClick={onTaskClick}
          onListClick={onListClick}
          toggleTaskComplete={toggleTaskComplete}
          getListProgress={getListProgress}
          visibleDateRef={weekVisibleDateRef}
        />
      )}
    </div>
  );
}

// ==================== MONTHLY CALENDAR ====================
function MonthlyCalendar({ clients, internal, events, tasks, lists, teamMembers, navigateToClient, toggleTaskComplete, addTask, addEvent, addList, onEventClick, onTaskClick, onListClick, getListProgress, currentUser }) {
  const [currentDate, setCurrentDate] = React.useState(new Date());
  const [selectedDate, setSelectedDate] = React.useState(new Date());
  const [showAddEventModal, setShowAddEventModal] = React.useState(false);
  const [showAddTaskModal, setShowAddTaskModal] = React.useState(false);
  const [showAddListModal, setShowAddListModal] = React.useState(false);

  // Multi-select filter state (matches ListView pattern)
  const [selectedClients, setSelectedClients] = React.useState({});
  const [selectedProjects, setSelectedProjects] = React.useState({});
  const [expandedClients, setExpandedClients] = React.useState({});
  const [filtersInitialized, setFiltersInitialized] = React.useState(false);
  const [showFilterPanel, setShowFilterPanel] = React.useState(false);
  
  // Combine clients with internal spaces
  const allSpaces = [internal.personal, internal.team, ...clients];

  // Initialize filters when data loads - default to ALL selected
  React.useEffect(() => {
    if (!internal.personal || !internal.team || filtersInitialized) return;

    const newClients = { [internal.personal.id]: true, [internal.team.id]: true };
    const newProjects = {};

    internal.personal.projects?.forEach(p => { newProjects[p.id] = true; });
    internal.team.projects?.forEach(p => { newProjects[p.id] = true; });
    clients.forEach(c => {
      newClients[c.id] = true;
      c.projects?.forEach(p => { newProjects[p.id] = true; });
    });

    setSelectedClients(newClients);
    setSelectedProjects(newProjects);
    setFiltersInitialized(true);
  }, [internal.personal, internal.team, clients, filtersInitialized]);

  // Toggle functions
  const toggleClient = (clientId) => {
    const newSelected = { ...selectedClients, [clientId]: !selectedClients[clientId] };
    setSelectedClients(newSelected);
    const client = allSpaces.find(c => c.id === clientId);
    if (client) {
      const newProjects = { ...selectedProjects };
      client.projects.forEach(p => {
        newProjects[p.id] = newSelected[clientId];
      });
      setSelectedProjects(newProjects);
    }
  };

  const toggleProject = (projectId) => {
    setSelectedProjects(prev => ({ ...prev, [projectId]: !prev[projectId] }));
  };

  const toggleClientExpand = (clientId) => {
    setExpandedClients(prev => ({ ...prev, [clientId]: !prev[clientId] }));
  };

  const selectAllFilters = () => {
    const newClients = {};
    const newProjects = {};
    allSpaces.forEach(c => {
      newClients[c.id] = true;
      c.projects.forEach(p => { newProjects[p.id] = true; });
    });
    setSelectedClients(newClients);
    setSelectedProjects(newProjects);
  };

  const deselectAllFilters = () => {
    const newClients = {};
    const newProjects = {};
    allSpaces.forEach(c => {
      newClients[c.id] = false;
      c.projects.forEach(p => { newProjects[p.id] = false; });
    });
    setSelectedClients(newClients);
    setSelectedProjects(newProjects);
  };

  // Check if any filters are active (not all selected)
  const hasActiveFilter = () => {
    const allClientsSelected = allSpaces.every(c => selectedClients[c.id]);
    const allProjectsSelected = allSpaces.every(c =>
      c.projects.every(p => selectedProjects[p.id])
    );
    return !allClientsSelected || !allProjectsSelected;
  };

  // Filter matching helper - checks if item matches current filter
  const matchesFilter = (item) => {
    // If item has a projectId, check if that project is selected
    if (item.projectId) {
      return selectedProjects[item.projectId] === true;
    }
    // Otherwise check if the client is selected
    return selectedClients[item.clientId] === true;
  };

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  // Get first day of month and total days
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startingDay = firstDay.getDay();
  const totalDays = lastDay.getDate();

  // Navigation
  const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
  const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
  const goToToday = () => {
    const today = new Date();
    setCurrentDate(today);
    setSelectedDate(today);
  };

  // Get events for a specific date (with filter applied)
  const getEventsForDate = (date) => {
    return events.filter(e => {
      if (!matchesFilter(e)) return false;
      const eventDate = new Date(e.startTime);
      return eventDate.getFullYear() === date.getFullYear() &&
             eventDate.getMonth() === date.getMonth() &&
             eventDate.getDate() === date.getDate();
    });
  };

  // Get tasks for a specific date (with filter applied)
  const getTasksForDate = (date) => {
    return tasks.filter(t => {
      if (!t.dueDate) return false;
      if (!matchesFilter(t)) return false;
      const taskDate = new Date(t.dueDate);
      return taskDate.getFullYear() === date.getFullYear() &&
             taskDate.getMonth() === date.getMonth() &&
             taskDate.getDate() === date.getDate();
    });
  };

  // Get lists for a specific date (with filter applied)
  const getListsForDate = (date) => {
    return (lists || []).filter(l => {
      if (!l.dueDate) return false;
      if (!matchesFilter(l)) return false;
      const listDate = new Date(l.dueDate);
      return listDate.getFullYear() === date.getFullYear() &&
             listDate.getMonth() === date.getMonth() &&
             listDate.getDate() === date.getDate();
    });
  };
  
  // Get project/client info for an event
  const getEventInfo = (event) => {
    // First try to find by projectId
    for (const client of allSpaces) {
      const project = client.projects.find(p => p.id === event.projectId);
      if (project) {
        return { client, project };
      }
    }
    // If no project, find by clientId
    if (event.clientId) {
      const client = allSpaces.find(c => c.id === event.clientId);
      if (client) {
        return { client, project: null };
      }
    }
    return null;
  };
  
  // Get client info for a task
  const getTaskClientInfo = (task) => {
    const client = allSpaces.find(c => c.id === task.clientId);
    if (!client) return null;
    const project = task.projectId ? client.projects.find(p => p.id === task.projectId) : null;
    return { client, project };
  };
  
  // Get client info for a list
  const getListClientInfo = (list) => {
    const client = allSpaces.find(c => c.id === list.clientId);
    if (!client) return null;
    const project = list.projectId ? client.projects.find(p => p.id === list.projectId) : null;
    return { client, project };
  };
  
  // Build calendar grid
  const days = [];
  const today = new Date();
  
  // Empty cells for days before month starts
  for (let i = 0; i < startingDay; i++) {
    days.push({ empty: true, key: `empty-${i}` });
  }
  
  // Days of the month
  for (let d = 1; d <= totalDays; d++) {
    const date = new Date(year, month, d);
    const dayEvents = getEventsForDate(date);
    const dayTasks = getTasksForDate(date);
    const dayLists = getListsForDate(date);
    const isToday = date.toDateString() === today.toDateString();
    const isSelected = selectedDate && date.toDateString() === selectedDate.toDateString();
    
    days.push({
      date,
      day: d,
      events: dayEvents,
      tasks: dayTasks,
      lists: dayLists,
      isToday,
      isSelected,
      key: `day-${d}`
    });
  }
  
  // Selected date events, tasks, and lists
  const selectedEvents = selectedDate ? getEventsForDate(selectedDate) : [];
  const selectedTasks = selectedDate ? getTasksForDate(selectedDate) : [];
  const selectedLists = selectedDate ? getListsForDate(selectedDate) : [];

  return (
    <div style={{ display: 'flex', flexDirection: 'column', flex: 1, overflow: 'hidden' }}>
      <style>{`
        .cal-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding-bottom: 20px;
          flex-shrink: 0;
          gap: 12px;
          flex-wrap: wrap;
        }
        
        .cal-nav {
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .cal-nav-btn {
          width: 32px;
          height: 32px;
          border-radius: 2px;
          background: rgba(255, 255, 255, 0.06);
          border: 1px solid rgba(255, 255, 255, 0.12);
          color: #a1a1aa;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.1s;
          flex-shrink: 0;
        }

        .cal-nav-btn:hover {
          background: rgba(255, 255, 255, 0.12);
          color: #fff;
        }

        .cal-title {
          font-size: 16px;
          font-weight: 600;
          color: #fff;
          min-width: 160px;
          text-align: center;
        }

        .cal-today-btn {
          padding: 8px 16px;
          border-radius: 2px;
          background: rgba(99, 102, 241, 0.15);
          border: 1px solid rgba(99, 102, 241, 0.3);
          color: #818cf8;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.1s;
          white-space: nowrap;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          font-weight: 500;
        }

        .cal-today-btn:hover {
          background: rgba(99, 102, 241, 0.25);
        }

        .cal-header-right {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .cal-add-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          padding: 8px 14px;
          border-radius: 2px;
          background: rgba(99, 102, 241, 0.12);
          border: 1px solid rgba(99, 102, 241, 0.3);
          color: #818cf8;
          font-size: 11px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.1s;
          font-family: inherit;
          white-space: nowrap;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .cal-add-btn .btn-text {
          display: inline;
        }

        .cal-add-btn:hover {
          background: rgba(99, 102, 241, 0.2);
          border-color: rgba(99, 102, 241, 0.5);
        }

        /* Responsive: smaller screens */
        @media (max-width: 700px) {
          .cal-title {
            font-size: 14px;
            min-width: 120px;
          }
          .cal-add-btn {
            padding: 8px 10px;
          }
          .cal-add-btn .btn-text {
            display: none;
          }
          .cal-today-btn {
            padding: 8px 12px;
            font-size: 10px;
          }
        }

        .cal-filter-btn {
          display: flex;
          align-items: center;
          gap: 6px;
          padding: 8px 14px;
          border-radius: 2px;
          background: rgba(255, 255, 255, 0.06);
          border: 1px solid rgba(255, 255, 255, 0.12);
          color: #a1a1aa;
          font-size: 12px;
          cursor: pointer;
          transition: all 0.1s;
          position: relative;
        }

        .cal-filter-btn:hover {
          background: rgba(255, 255, 255, 0.1);
          border-color: rgba(255, 255, 255, 0.2);
          color: #e4e4e7;
        }

        .cal-filter-btn.active {
          background: rgba(99, 102, 241, 0.15);
          border-color: rgba(99, 102, 241, 0.3);
          color: #818cf8;
        }

        .cal-filter-badge {
          background: #6366f1;
          color: #fff;
          font-size: 9px;
          padding: 2px 5px;
          border-radius: 8px;
          font-weight: 600;
        }

        .cal-filter-panel {
          position: absolute;
          top: 100%;
          left: 0;
          margin-top: 4px;
          background: #18181b;
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 4px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
          z-index: 100;
          min-width: 280px;
          max-height: 400px;
          overflow-y: auto;
        }

        .cal-filter-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 12px 16px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .cal-filter-title {
          font-size: 11px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: #71717a;
        }

        .cal-filter-actions {
          display: flex;
          gap: 8px;
        }

        .cal-filter-action {
          background: none;
          border: none;
          color: #6366f1;
          font-size: 10px;
          cursor: pointer;
          padding: 2px 6px;
          border-radius: 2px;
          transition: all 0.1s;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .cal-filter-action:hover {
          background: rgba(99, 102, 241, 0.15);
        }

        .cal-filter-list {
          padding: 8px;
        }

        .cal-filter-client {
          border-radius: 2px;
          overflow: hidden;
          margin-bottom: 2px;
        }

        .cal-filter-client-header {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 10px;
          cursor: pointer;
          transition: all 0.1s;
        }

        .cal-filter-client-header:hover {
          background: rgba(255, 255, 255, 0.05);
        }

        .cal-filter-expand {
          color: #71717a;
          transition: transform 0.1s;
          flex-shrink: 0;
        }

        .cal-filter-expand.expanded {
          transform: rotate(90deg);
        }

        .cal-filter-checkbox {
          width: 16px;
          height: 16px;
          border-radius: 2px;
          border: 1px solid rgba(255, 255, 255, 0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.1s;
          flex-shrink: 0;
        }

        .cal-filter-checkbox.checked {
          background: #6366f1;
          border-color: #6366f1;
        }

        .cal-filter-color {
          width: 10px;
          height: 10px;
          border-radius: 2px;
          flex-shrink: 0;
        }

        .cal-filter-name {
          flex: 1;
          font-size: 13px;
          color: #e4e4e7;
        }

        .cal-filter-projects {
          padding-left: 34px;
          display: flex;
          flex-direction: column;
          gap: 2px;
        }

        .cal-filter-project {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 6px 10px;
          border-radius: 2px;
          cursor: pointer;
          transition: all 0.1s;
        }

        .cal-filter-project:hover {
          background: rgba(255, 255, 255, 0.05);
        }

        .cal-filter-project .cal-filter-checkbox {
          width: 14px;
          height: 14px;
        }

        .cal-filter-project .cal-filter-color {
          width: 8px;
          height: 8px;
        }

        .cal-filter-project .cal-filter-name {
          font-size: 11px;
          color: #a1a1aa;
        }

        .cal-filter-wrapper {
          position: relative;
        }

        .cal-add-modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
        }
        
        .cal-add-modal {
          background: #18181b;
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 2px;
          width: 480px;
          max-width: 90vw;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .cal-add-modal-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 20px 24px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .cal-add-modal-header h3 {
          font-size: 14px;
          font-weight: 600;
          color: #fff;
          margin: 0;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        
        .cal-add-modal-close {
          background: none;
          border: none;
          color: #71717a;
          cursor: pointer;
          padding: 4px;
          border-radius: 2px;
          transition: all 0.1s;
        }
        
        .cal-add-modal-close:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #fff;
        }
        
        .cal-add-modal-body {
          padding: 24px;
          display: flex;
          flex-direction: column;
          gap: 16px;
        }
        
        .cal-add-form-row {
          display: flex;
          gap: 12px;
          align-items: center;
        }
        
        .cal-add-input, .cal-add-select {
          flex: 1;
          padding: 10px 14px;
          border-radius: 2px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #fff;
          font-size: 13px;
          font-family: inherit;
          outline: none;
          transition: all 0.1s;
        }
        
        .cal-add-input:focus, .cal-add-select:focus {
          border-color: rgba(99, 102, 241, 0.5);
        }
        
        .cal-add-input::placeholder {
          color: #52525b;
        }
        
        .cal-add-select {
          cursor: pointer;
        }
        
        .cal-add-select:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }
        
        .cal-add-input[type="date"],
        .cal-add-input[type="time"] {
          position: relative;
        }
        
        .cal-add-input[type="date"]::-webkit-calendar-picker-indicator,
        .cal-add-input[type="time"]::-webkit-calendar-picker-indicator {
          filter: invert(1);
          opacity: 0.6;
          cursor: pointer;
          padding: 4px;
          margin-right: -4px;
          border-radius: 2px;
          transition: all 0.1s;
        }
        
        .cal-add-input[type="date"]::-webkit-calendar-picker-indicator:hover,
        .cal-add-input[type="time"]::-webkit-calendar-picker-indicator:hover {
          opacity: 1;
          filter: invert(1) brightness(1.5);
          background: rgba(99, 102, 241, 0.5);
          box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        }
        
        .cal-add-input[type="date"]::-webkit-datetime-edit,
        .cal-add-input[type="time"]::-webkit-datetime-edit {
          color: #a1a1aa;
        }
        
        .cal-add-input[type="date"]:focus::-webkit-datetime-edit,
        .cal-add-input[type="time"]:focus::-webkit-datetime-edit {
          color: #fff;
        }
        
        .cal-add-modal-footer {
          display: flex;
          justify-content: flex-end;
          gap: 12px;
          padding: 16px 24px;
          border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .cal-add-modal-btn {
          padding: 10px 20px;
          border-radius: 2px;
          font-size: 11px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.1s;
          font-family: inherit;
          border: none;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        
        .cal-add-modal-btn.primary {
          background: #6366f1;
          color: #fff;
        }
        
        .cal-add-modal-btn.primary:hover {
          background: #5558e3;
        }
        
        .cal-add-modal-btn.secondary {
          background: rgba(255, 255, 255, 0.06);
          color: #a1a1aa;
          border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .cal-add-modal-btn.secondary:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #fff;
        }
        
        .cal-body {
          display: flex;
          flex: 1;
          gap: 24px;
          min-height: 0;
          overflow: hidden;
        }
        
        .cal-grid-container {
          flex: 1;
          display: flex;
          flex-direction: column;
          min-width: 0;
        }
        
        .cal-weekdays {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 4px;
          margin-bottom: 8px;
        }
        
        .cal-weekday {
          padding: 8px;
          text-align: center;
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: #52525b;
          font-weight: 600;
        }
        
        .cal-grid {
          display: grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 4px;
          flex: 1;
        }
        
        .cal-day {
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.04);
          border-radius: 8px;
          padding: 8px;
          min-height: 80px;
          cursor: pointer;
          transition: all 0.15s;
          overflow: hidden;
        }
        
        .cal-day:hover {
          background: rgba(255, 255, 255, 0.04);
          border-color: rgba(255, 255, 255, 0.1);
        }
        
        .cal-day.empty {
          background: transparent;
          border-color: transparent;
          cursor: default;
        }
        
        /* Responsive: hide sidebar on small screens, adjust grid */
        @media (max-width: 900px) {
          .cal-sidebar {
            display: none;
          }
          .cal-day {
            min-height: 60px;
            padding: 6px;
          }
          .cal-weekday {
            padding: 6px 4px;
            font-size: 10px;
          }
        }
        
        @media (max-width: 600px) {
          .cal-day {
            min-height: 45px;
            padding: 4px;
          }
          .cal-day-number {
            font-size: 11px !important;
          }
          .cal-day-events {
            display: none;
          }
          .cal-day.has-items::after {
            content: '';
            display: block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #818cf8;
            margin: 4px auto 0;
          }
        }
        
        .cal-day.today {
          border-color: rgba(99, 102, 241, 0.5);
          background: rgba(99, 102, 241, 0.1);
        }
        
        .cal-day.selected {
          border-color: #6366f1;
          background: rgba(99, 102, 241, 0.15);
        }
        
        .cal-day-num {
          font-size: 14px;
          font-weight: 500;
          color: #a1a1aa;
          margin-bottom: 6px;
        }
        
        .cal-day.today .cal-day-num {
          color: #818cf8;
          font-weight: 600;
        }
        
        .cal-day-items {
          display: flex;
          flex-direction: column;
          gap: 2px;
        }
        
        .cal-day-event {
          font-size: 10px;
          padding: 2px 6px;
          border-radius: 4px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          color: #fff;
        }
        
        .cal-day-task {
          font-size: 10px;
          padding: 2px 6px;
          border-radius: 4px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          background: transparent;
          border: 1.5px solid;
        }
        
        .cal-day-task.completed {
          opacity: 0.4;
          text-decoration: line-through;
        }
        
        .cal-day-list {
          font-size: 10px;
          padding: 2px 6px;
          border-radius: 4px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          background: rgba(139, 92, 246, 0.15);
          border: 1.5px dashed #8b5cf6;
          color: #c4b5fd;
          display: flex;
          align-items: center;
          gap: 4px;
        }
        
        .cal-day-list-icon {
          font-size: 9px;
        }
        
        .cal-day-more {
          font-size: 10px;
          color: #71717a;
          padding: 2px 6px;
        }
        
        .cal-sidebar {
          width: 360px;
          background: rgba(15, 15, 20, 0.9);
          border: 1px solid rgba(255, 255, 255, 0.06);
          border-radius: 12px;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }
        
        .cal-sidebar-header {
          padding: 16px 20px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
          font-weight: 600;
          color: #e4e4e7;
        }
        
        .cal-sidebar-content {
          flex: 1;
          overflow-y: auto;
          padding: 12px;
        }
        
        .cal-sidebar-section {
          margin-bottom: 16px;
        }
        
        .cal-sidebar-section-title {
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: #52525b;
          margin-bottom: 8px;
          padding: 0 4px;
        }
        
        .cal-sidebar-empty {
          padding: 20px;
          text-align: center;
          color: #52525b;
          font-size: 13px;
        }
        
        .cal-event-card {
          background: rgba(255, 255, 255, 0.03);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 2px;
          padding: 12px;
          margin-bottom: 8px;
          transition: all 0.1s;
          cursor: pointer;
        }

        .cal-event-card:hover {
          background: rgba(255, 255, 255, 0.06);
          border-color: rgba(255, 255, 255, 0.15);
        }

        .cal-task-card {
          background: transparent;
          border: 1px solid rgba(255, 255, 255, 0.12);
          border-radius: 2px;
          padding: 12px;
          margin-bottom: 8px;
          transition: all 0.1s;
          display: flex;
          align-items: flex-start;
          gap: 12px;
        }

        .cal-task-card:hover {
          background: rgba(255, 255, 255, 0.04);
          border-color: rgba(255, 255, 255, 0.2);
        }

        .cal-task-card.completed {
          opacity: 0.5;
        }

        .cal-task-check {
          width: 18px;
          height: 18px;
          border-radius: 2px;
          border: 1px solid;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
          cursor: pointer;
          transition: all 0.1s;
        }

        .cal-task-check:hover {
          transform: scale(1.1);
        }

        .cal-task-check.checked {
          background: currentColor;
        }

        .cal-task-info {
          flex: 1;
          min-width: 0;
        }

        .cal-event-title, .cal-task-title {
          font-size: 13px;
          font-weight: 500;
          color: #e4e4e7;
          margin-bottom: 4px;
        }

        .cal-task-card.completed .cal-task-title {
          text-decoration: line-through;
        }

        .cal-list-card {
          background: rgba(139, 92, 246, 0.06);
          border: 1px solid rgba(139, 92, 246, 0.25);
          border-radius: 2px;
          padding: 12px;
          margin-bottom: 8px;
          transition: all 0.1s;
          cursor: pointer;
        }

        .cal-list-card:hover {
          background: rgba(139, 92, 246, 0.1);
          border-color: rgba(139, 92, 246, 0.4);
        }

        .cal-list-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 8px;
        }

        .cal-list-icon {
          font-size: 14px;
        }
        
        .cal-list-title {
          font-size: 13px;
          font-weight: 500;
          color: #e4e4e7;
        }

        .cal-list-progress {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 8px;
        }

        .cal-list-progress-bar {
          flex: 1;
          height: 4px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 1px;
          overflow: hidden;
        }

        .cal-list-progress-fill {
          height: 100%;
          background: #22c55e;
          border-radius: 1px;
          transition: width 0.2s ease;
        }

        .cal-list-progress-text {
          font-size: 10px;
          color: #71717a;
          min-width: 35px;
          text-align: right;
          font-weight: 500;
        }

        .cal-list-meta {
          display: flex;
          align-items: center;
          gap: 8px;
          flex-wrap: wrap;
        }

        .cal-event-time, .cal-task-meta {
          font-size: 11px;
          color: #71717a;
          margin-bottom: 8px;
        }

        .cal-event-meta, .cal-task-badges {
          display: flex;
          align-items: center;
          gap: 6px;
          flex-wrap: wrap;
        }

        .cal-event-badge, .cal-task-badge {
          font-size: 10px;
          padding: 2px 6px;
          border-radius: 2px;
          color: #fff;
          cursor: pointer;
          transition: all 0.1s;
          border: none;
          font-family: inherit;
          outline: none;
          line-height: 1.4;
          text-transform: uppercase;
          letter-spacing: 0.3px;
          font-weight: 500;
        }

        .cal-event-badge:hover, .cal-task-badge:hover {
          filter: brightness(1.15);
        }

        .cal-event-badge:active, .cal-task-badge:active {
          transform: scale(0.98);
        }
        
        .cal-task-badge.outlined {
          background: transparent;
          border: 1px solid;
          color: inherit;
        }
        
        .cal-task-badge.outlined:hover {
          background: rgba(255, 255, 255, 0.1);
        }
        
        .cal-assignee {
          font-size: 11px;
          padding: 2px 8px;
          border-radius: 4px;
          background: rgba(255, 255, 255, 0.1);
          color: #a1a1aa;
        }
      `}</style>
      
      {/* Header */}
      <div className="cal-header">
        <div className="cal-nav">
          <button className="cal-nav-btn" onClick={prevMonth}><ChevronLeft size={18} /></button>
          <span className="cal-title">
            {currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
          </span>
          <button className="cal-nav-btn" onClick={nextMonth}><ChevronRight size={18} /></button>
        </div>

        {/* Filter */}
        <div className="cal-filter-wrapper">
          <button
            className={`cal-filter-btn ${hasActiveFilter() ? 'active' : ''}`}
            onClick={() => setShowFilterPanel(!showFilterPanel)}
          >
            <Filter size={14} />
            <span>Filter</span>
            {hasActiveFilter() && <span className="cal-filter-badge">!</span>}
          </button>

          {showFilterPanel && (
            <div className="cal-filter-panel">
              <div className="cal-filter-header">
                <span className="cal-filter-title">Clients & Projects</span>
                <div className="cal-filter-actions">
                  <button className="cal-filter-action" onClick={selectAllFilters}>All</button>
                  <button className="cal-filter-action" onClick={deselectAllFilters}>None</button>
                </div>
              </div>
              <div className="cal-filter-list">
                {allSpaces.map(space => (
                  <div key={space.id} className="cal-filter-client">
                    <div className="cal-filter-client-header">
                      {space.projects.length > 0 ? (
                        <ChevronRight
                          size={14}
                          className={`cal-filter-expand ${expandedClients[space.id] ? 'expanded' : ''}`}
                          onClick={(e) => { e.stopPropagation(); toggleClientExpand(space.id); }}
                        />
                      ) : (
                        <div style={{ width: 14 }} />
                      )}
                      <div
                        className={`cal-filter-checkbox ${selectedClients[space.id] ? 'checked' : ''}`}
                        onClick={() => toggleClient(space.id)}
                      >
                        {selectedClients[space.id] && <Check size={10} color="#fff" />}
                      </div>
                      <div className="cal-filter-color" style={{ background: space.color }} />
                      <span className="cal-filter-name" onClick={() => toggleClient(space.id)}>{space.name}</span>
                    </div>
                    {expandedClients[space.id] && space.projects.length > 0 && (
                      <div className="cal-filter-projects">
                        {space.projects.map(project => (
                          <div
                            key={project.id}
                            className="cal-filter-project"
                            onClick={() => toggleProject(project.id)}
                          >
                            <div className={`cal-filter-checkbox ${selectedProjects[project.id] ? 'checked' : ''}`}>
                              {selectedProjects[project.id] && <Check size={8} color="#fff" />}
                            </div>
                            <div className="cal-filter-color" style={{ background: project.color }} />
                            <span className="cal-filter-name">{project.name}</span>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        <div className="cal-header-right">
          <button className="cal-add-btn" onClick={() => setShowAddEventModal(true)} title="Add Event">
            <Plus size={14} /> <span className="btn-text">Event</span>
          </button>
          <button className="cal-add-btn" onClick={() => setShowAddTaskModal(true)} title="Add Task">
            <Plus size={14} /> <span className="btn-text">Task</span>
          </button>
          <button className="cal-add-btn" onClick={() => setShowAddListModal(true)} title="Add List" style={{ borderColor: 'rgba(139, 92, 246, 0.3)', background: 'rgba(139, 92, 246, 0.15)', color: '#a78bfa' }}>
            <Plus size={14} /> <span className="btn-text">List</span>
          </button>
          <button className="cal-today-btn" onClick={goToToday}>Today</button>
        </div>
      </div>
      
      {/* Add Event Modal */}
      {showAddEventModal && (
        <EventModal
          onClose={() => setShowAddEventModal(false)}
          onSave={addEvent}
          clients={clients}
          internal={internal}
          teamMembers={teamMembers}
          currentUserId={currentUser?.id}
        />
      )}
      
      {/* Add Task Modal */}
      {showAddTaskModal && (
        <TaskModal
          onClose={() => setShowAddTaskModal(false)}
          onSave={addTask}
          clients={clients}
          internal={internal}
          teamMembers={teamMembers}
        />
      )}
      
      {/* Add List Modal */}
      {showAddListModal && (
        <ListModal
          onClose={() => setShowAddListModal(false)}
          onSave={addList}
          clients={clients}
          internal={internal}
          teamMembers={teamMembers}
          tasks={[]}
        />
      )}
      
      {/* Body */}
      <div className="cal-body">
        {/* Calendar Grid */}
        <div className="cal-grid-container">
          <div className="cal-weekdays">
            {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
              <div key={d} className="cal-weekday">{d}</div>
            ))}
          </div>
          <div className="cal-grid">
            {days.map(d => {
              const allItems = [...(d.events || []).map(e => ({ ...e, isTask: false })), 
                               ...(d.tasks || []).map(t => ({ ...t, isTask: true })),
                               ...(d.lists || []).map(l => ({ ...l, isList: true }))];
              const displayItems = allItems.slice(0, 3);
              const moreCount = allItems.length - 3;
              
              return (
                <div 
                  key={d.key}
                  className={`cal-day ${d.empty ? 'empty' : ''} ${d.isToday ? 'today' : ''} ${d.isSelected ? 'selected' : ''} ${allItems.length > 0 ? 'has-items' : ''}`}
                  onClick={() => !d.empty && setSelectedDate(d.date)}
                >
                  {!d.empty && (
                    <>
                      <div className="cal-day-num">{d.day}</div>
                      <div className="cal-day-items">
                        {displayItems.map((item, idx) => {
                          if (item.isList) {
                            const progress = getListProgress ? getListProgress(item.id) : { completed: 0, total: 0 };
                            return (
                              <div 
                                key={`list-${item.id}`}
                                className="cal-day-list"
                                onClick={(e) => { e.stopPropagation(); onListClick && onListClick(item); }}
                              >
                                <span className="cal-day-list-icon">📋</span>
                                {item.title}
                              </div>
                            );
                          } else if (item.isTask) {
                            const info = getTaskClientInfo(item);
                            const color = info?.project?.color || info?.client?.color || '#6366f1';
                            return (
                              <div 
                                key={`task-${item.id}`}
                                className={`cal-day-task ${item.isCompleted ? 'completed' : ''}`}
                                style={{ borderColor: color, color }}
                              >
                                {item.title}
                              </div>
                            );
                          } else {
                            const info = getEventInfo(item);
                            return (
                              <div
                                key={`event-${item.id}`}
                                className="cal-day-event"
                                style={{ background: info?.project?.color || info?.client?.color || '#6366f1' }}
                              >
                                {item.title}
                              </div>
                            );
                          }
                        })}
                        {moreCount > 0 && (
                          <div className="cal-day-more">+{moreCount} more</div>
                        )}
                      </div>
                    </>
                  )}
                </div>
              );
            })}
          </div>
        </div>
        
        {/* Sidebar */}
        <div className="cal-sidebar">
          <div className="cal-sidebar-header">
            {selectedDate 
              ? selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })
              : 'Select a day'
            }
          </div>
          <div className="cal-sidebar-content">
            {!selectedDate && (
              <div className="cal-sidebar-empty">Click on a day to see events and tasks</div>
            )}
            
            {selectedDate && selectedEvents.length === 0 && selectedTasks.length === 0 && selectedLists.length === 0 && (
              <div className="cal-sidebar-empty">No events, tasks, or lists scheduled</div>
            )}
            
            {/* Lists */}
            {selectedLists.length > 0 && (
              <div className="cal-sidebar-section">
                <div className="cal-sidebar-section-title">Lists</div>
                {selectedLists.map(list => {
                  const info = getListClientInfo(list);
                  const progress = getListProgress ? getListProgress(list.id) : { completed: 0, total: 0 };
                  const progressPercent = progress.total > 0 ? (progress.completed / progress.total) * 100 : 0;
                  
                  return (
                    <div 
                      key={list.id} 
                      className="cal-list-card"
                      onClick={() => onListClick && onListClick(list)}
                      style={{ cursor: 'pointer' }}
                    >
                      <div className="cal-list-header">
                        <span className="cal-list-icon">📋</span>
                        <div className="cal-list-title">{list.title}</div>
                      </div>
                      <div className="cal-list-progress">
                        <div className="cal-list-progress-bar">
                          <div className="cal-list-progress-fill" style={{ width: `${progressPercent}%` }} />
                        </div>
                        <span className="cal-list-progress-text">{progress.completed}/{progress.total}</span>
                      </div>
                      {info && (
                        <div className="cal-list-meta">
                          <button 
                            className="cal-event-badge" 
                            style={{ background: info.client.color }}
                            onClick={(e) => { e.stopPropagation(); navigateToClient(info.client.id); }}
                          >
                            {info.client.name}
                          </button>
                          {info.project && (
                            <button 
                              className="cal-event-badge" 
                              style={{ background: info.project.color }}
                              onClick={(e) => { e.stopPropagation(); navigateToClient(info.client.id, info.project.id); }}
                            >
                              {info.project.name}
                            </button>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
            
            {/* Events */}
            {selectedEvents.length > 0 && (
              <div className="cal-sidebar-section">
                <div className="cal-sidebar-section-title">Events</div>
                {selectedEvents.map(event => {
                  const info = getEventInfo(event);
                  return (
                    <div 
                      key={event.id} 
                      className="cal-event-card"
                      onClick={() => onEventClick(event)}
                      style={{ cursor: 'pointer' }}
                    >
                      <div className="cal-event-title">{event.title}</div>
                      <div className="cal-event-time">
                        {formatTime(event.startTime)} - {formatTime(event.endTime)}
                      </div>
                      {info && (
                        <div className="cal-event-meta">
                          <button
                            className="cal-event-badge"
                            style={{ background: info.client.color }}
                            onClick={(e) => { e.stopPropagation(); navigateToClient(info.client.id); }}
                          >
                            {info.client.name}
                          </button>
                          {info.project && (
                          <button
                            className="cal-event-badge"
                            style={{ background: info.project.color }}
                            onClick={(e) => { e.stopPropagation(); navigateToClient(info.client.id, info.project.id); }}
                          >
                            {info.project.name}
                          </button>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
            
            {/* Tasks */}
            {selectedTasks.length > 0 && (
              <div className="cal-sidebar-section">
                <div className="cal-sidebar-section-title">Tasks</div>
                {selectedTasks.map(task => {
                  const info = getTaskClientInfo(task);
                  const clientColor = info?.project?.color || info?.client?.color || '#6366f1';
                  const assignee = teamMembers.find(m => m.id === task.assignedTo);
                  
                  return (
                    <div
                      key={task.id}
                      className={`cal-task-card ${task.isCompleted ? 'completed' : ''}`}
                      style={{ borderColor: clientColor, cursor: 'pointer' }}
                      onClick={() => {
                        if (task.listId && lists) {
                          const list = lists.find(l => l.id === task.listId);
                          if (list && onListClick) {
                            onListClick(list);
                            return;
                          }
                        }
                        onTaskClick(task);
                      }}
                    >
                      <div 
                        className={`cal-task-check ${task.isCompleted ? 'checked' : ''}`}
                        style={{ borderColor: clientColor, color: clientColor }}
                        onClick={(e) => { e.stopPropagation(); toggleTaskComplete(task.id); }}
                      >
                        {task.isCompleted && <Check size={12} color="#fff" />}
                      </div>
                      <div className="cal-task-info">
                        <div className="cal-task-title" style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                          {task.title}
                          {task.listId && <List size={12} style={{ opacity: 0.6, flexShrink: 0 }} />}
                        </div>
                        <div className="cal-task-badges">
                          {info && (
                            <button 
                              className="cal-task-badge" 
                              style={{ background: info.client.color }}
                              onClick={(e) => { e.stopPropagation(); navigateToClient(info.client.id); }}
                            >
                              {info.client.name}
                            </button>
                          )}
                          {info?.project && (
                            <button 
                              className="cal-task-badge outlined" 
                              style={{ borderColor: info.project.color, color: info.project.color }}
                              onClick={(e) => { e.stopPropagation(); navigateToClient(info.client.id, info.project.id); }}
                            >
                              {info.project.name}
                            </button>
                          )}
                          {assignee && (
                            <span className="cal-assignee">
                              {assignee.name}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

// ==================== LIST VIEW ====================
function ListView({ clients, internal, events, tasks, lists, teamMembers, currentUserId, navigateToClient, toggleTaskComplete, addTask, addEvent, addList, onEventClick, onTaskClick, onListClick, getListProgress }) {
  // Filter state with localStorage persistence
  const [searchQuery, setSearchQuery] = React.useState('');
  const [showEvents, setShowEvents] = React.useState(() => {
    const saved = localStorage.getItem('listview_showEvents');
    return saved !== null ? JSON.parse(saved) : true;
  });
  const [showTasks, setShowTasks] = React.useState(() => {
    const saved = localStorage.getItem('listview_showTasks');
    return saved !== null ? JSON.parse(saved) : true;
  });
  const [showLists, setShowLists] = React.useState(() => {
    const saved = localStorage.getItem('listview_showLists');
    return saved !== null ? JSON.parse(saved) : true;
  });
  const [showCompleted, setShowCompleted] = React.useState(() => {
    const saved = localStorage.getItem('listview_showCompleted');
    return saved !== null ? JSON.parse(saved) : false;
  });
  const [showPastEvents, setShowPastEvents] = React.useState(() => {
    const saved = localStorage.getItem('listview_showPastEvents');
    return saved !== null ? JSON.parse(saved) : false;
  });
  const [myItemsOnly, setMyItemsOnly] = React.useState(() => {
    const saved = localStorage.getItem('listview_myItemsOnly');
    return saved !== null ? JSON.parse(saved) : false;
  });

  // Task status filter - which statuses to show
  const [selectedStatuses, setSelectedStatuses] = React.useState(() => {
    const saved = localStorage.getItem('listview_selectedStatuses');
    return saved !== null ? JSON.parse(saved) : {
      'todo': true,
      'in-progress': true,
      'blocked': true,
      'on-hold': true,
      'urgent': true
    };
  });

  // Assigned to filter - which team members' tasks to show
  const [selectedAssignees, setSelectedAssignees] = React.useState(() => {
    const saved = localStorage.getItem('listview_selectedAssignees');
    if (saved !== null) return JSON.parse(saved);
    // Default: show all team members
    const defaults = { 'unassigned': true };
    teamMembers.forEach(m => { defaults[m.id] = true; });
    return defaults;
  });
  const [assigneesInitialized, setAssigneesInitialized] = React.useState(false);

  // Date range filter
  const [dateRangeEnabled, setDateRangeEnabled] = React.useState(() => {
    const saved = localStorage.getItem('listview_dateRangeEnabled');
    return saved !== null ? JSON.parse(saved) : false;
  });
  const [dateRangeStart, setDateRangeStart] = React.useState(() => {
    const saved = localStorage.getItem('listview_dateRangeStart');
    return saved || new Date().toISOString().split('T')[0];
  });
  const [dateRangeEnd, setDateRangeEnd] = React.useState(() => {
    const saved = localStorage.getItem('listview_dateRangeEnd');
    if (saved) return saved;
    const endDate = new Date();
    endDate.setDate(endDate.getDate() + 30);
    return endDate.toISOString().split('T')[0];
  });

  const [selectedClients, setSelectedClients] = React.useState({});
  const [selectedProjects, setSelectedProjects] = React.useState({});
  const [expandedClients, setExpandedClients] = React.useState({});
  const [collapsedDays, setCollapsedDays] = React.useState({});
  const [filtersInitialized, setFiltersInitialized] = React.useState(false);

  // Initialize filters when data loads - default to ALL selected
  React.useEffect(() => {
    if (!internal.personal || !internal.team || filtersInitialized) return;

    const newClients = { [internal.personal.id]: true, [internal.team.id]: true };
    const newProjects = {};

    internal.personal.projects?.forEach(p => { newProjects[p.id] = true; });
    internal.team.projects?.forEach(p => { newProjects[p.id] = true; });
    clients.forEach(c => {
      newClients[c.id] = true;
      c.projects?.forEach(p => { newProjects[p.id] = true; });
    });

    setSelectedClients(newClients);
    setSelectedProjects(newProjects);
    setFiltersInitialized(true);
  }, [internal.personal, internal.team, clients, filtersInitialized]);

  // Initialize assignees filter when team members load
  React.useEffect(() => {
    if (assigneesInitialized || !teamMembers || teamMembers.length === 0) return;
    const saved = localStorage.getItem('listview_selectedAssignees');
    if (saved === null) {
      const defaults = { 'unassigned': true };
      teamMembers.forEach(m => { defaults[m.id] = true; });
      setSelectedAssignees(defaults);
    }
    setAssigneesInitialized(true);
  }, [teamMembers, assigneesInitialized]);

  // Persist filter settings to localStorage
  React.useEffect(() => {
    localStorage.setItem('listview_showEvents', JSON.stringify(showEvents));
  }, [showEvents]);
  React.useEffect(() => {
    localStorage.setItem('listview_showTasks', JSON.stringify(showTasks));
  }, [showTasks]);
  React.useEffect(() => {
    localStorage.setItem('listview_showLists', JSON.stringify(showLists));
  }, [showLists]);
  React.useEffect(() => {
    localStorage.setItem('listview_showCompleted', JSON.stringify(showCompleted));
  }, [showCompleted]);
  React.useEffect(() => {
    localStorage.setItem('listview_showPastEvents', JSON.stringify(showPastEvents));
  }, [showPastEvents]);
  React.useEffect(() => {
    localStorage.setItem('listview_myItemsOnly', JSON.stringify(myItemsOnly));
  }, [myItemsOnly]);
  React.useEffect(() => {
    localStorage.setItem('listview_selectedStatuses', JSON.stringify(selectedStatuses));
  }, [selectedStatuses]);
  React.useEffect(() => {
    localStorage.setItem('listview_selectedAssignees', JSON.stringify(selectedAssignees));
  }, [selectedAssignees]);
  React.useEffect(() => {
    localStorage.setItem('listview_dateRangeEnabled', JSON.stringify(dateRangeEnabled));
  }, [dateRangeEnabled]);
  React.useEffect(() => {
    localStorage.setItem('listview_dateRangeStart', dateRangeStart);
  }, [dateRangeStart]);
  React.useEffect(() => {
    localStorage.setItem('listview_dateRangeEnd', dateRangeEnd);
  }, [dateRangeEnd]);

  // Combine all spaces
  const allSpaces = [
    { ...internal.personal, isInternal: true },
    { ...internal.team, isInternal: true },
    ...clients
  ];
  
  // Toggle functions
  const toggleClient = (clientId) => {
    const newSelected = { ...selectedClients, [clientId]: !selectedClients[clientId] };
    setSelectedClients(newSelected);
    const client = allSpaces.find(c => c.id === clientId);
    if (client) {
      const newProjects = { ...selectedProjects };
      client.projects.forEach(p => {
        newProjects[p.id] = newSelected[clientId];
      });
      setSelectedProjects(newProjects);
    }
  };
  
  const toggleProject = (projectId) => {
    setSelectedProjects(prev => ({ ...prev, [projectId]: !prev[projectId] }));
  };
  
  const toggleClientExpand = (clientId) => {
    setExpandedClients(prev => ({ ...prev, [clientId]: !prev[clientId] }));
  };
  
  const selectAll = () => {
    const newClients = {};
    const newProjects = {};
    allSpaces.forEach(c => {
      newClients[c.id] = true;
      c.projects.forEach(p => { newProjects[p.id] = true; });
    });
    setSelectedClients(newClients);
    setSelectedProjects(newProjects);
  };
  
  const deselectAll = () => {
    const newClients = {};
    const newProjects = {};
    allSpaces.forEach(c => {
      newClients[c.id] = false;
      c.projects.forEach(p => { newProjects[p.id] = false; });
    });
    setSelectedClients(newClients);
    setSelectedProjects(newProjects);
  };
  
  const toggleDayCollapse = (dayKey) => {
    setCollapsedDays(prev => ({ ...prev, [dayKey]: !prev[dayKey] }));
  };

  // Toggle status filter
  const toggleStatus = (status) => {
    setSelectedStatuses(prev => ({ ...prev, [status]: !prev[status] }));
  };

  const selectAllStatuses = () => {
    setSelectedStatuses({
      'todo': true,
      'in-progress': true,
      'blocked': true,
      'on-hold': true,
      'urgent': true
    });
  };

  const deselectAllStatuses = () => {
    setSelectedStatuses({
      'todo': false,
      'in-progress': false,
      'blocked': false,
      'on-hold': false,
      'urgent': false
    });
  };

  // Toggle assignee filter
  const toggleAssignee = (assigneeId) => {
    setSelectedAssignees(prev => ({ ...prev, [assigneeId]: !prev[assigneeId] }));
  };

  const selectAllAssignees = () => {
    const newAssignees = { 'unassigned': true };
    teamMembers.forEach(m => { newAssignees[m.id] = true; });
    setSelectedAssignees(newAssignees);
  };

  const deselectAllAssignees = () => {
    const newAssignees = { 'unassigned': false };
    teamMembers.forEach(m => { newAssignees[m.id] = false; });
    setSelectedAssignees(newAssignees);
  };

  // Filter items
  const now = new Date();
  
  // Helper to check if current user is involved in event (for future attendees feature)
  const isMyEvent = (e) => {
    if (!currentUserId) return true;
    if (e.attendees && e.attendees.includes(currentUserId)) return true;
    if (e.createdBy === currentUserId) return true;
    if (e.visibility?.canView && e.visibility.canView.includes(currentUserId)) return true;
    if (e.visibility?.type === 'team') return true;
    return false;
  };
  
  // Helper to check if current user is assigned to task
  const isMyTask = (t) => {
    if (!currentUserId) return true;
    return t.assignedTo === currentUserId || t.createdBy === currentUserId;
  };
  
  // Helper to get clientId for an event (events only have projectId)
  const getEventClientId = (event) => {
    if (event.clientId) return event.clientId;
    if (!event.projectId) return null;
    
    // Find which client/space owns this project
    for (const space of allSpaces) {
      if (space.projects.some(p => p.id === event.projectId)) {
        return space.id;
      }
    }
    return null;
  };
  
  // Date range helper
  const isInDateRange = (date) => {
    if (!dateRangeEnabled) return true;
    const itemDate = new Date(date);
    itemDate.setHours(0, 0, 0, 0);
    const start = new Date(dateRangeStart);
    start.setHours(0, 0, 0, 0);
    const end = new Date(dateRangeEnd);
    end.setHours(23, 59, 59, 999);
    return itemDate >= start && itemDate <= end;
  };

  const filteredEvents = events.filter(e => {
    if (!showEvents) return false;
    if (!showPastEvents && new Date(e.endTime) < now) return false;

    // Date range filter
    if (!isInDateRange(e.startTime)) return false;

    // Get clientId from projectId
    const eventClientId = getEventClientId(e);
    if (eventClientId && !selectedClients[eventClientId]) return false;

    if (e.projectId && !selectedProjects[e.projectId]) return false;
    if (searchQuery && !e.title.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    if (myItemsOnly && !isMyEvent(e)) return false;
    return true;
  });

  const filteredTasks = tasks.filter(t => {
    if (!showTasks) return false;
    if (!showCompleted && t.isCompleted) return false;
    if (!t.dueDate) return false;

    // Date range filter
    if (!isInDateRange(t.dueDate)) return false;

    // Status filter (skip for completed tasks - they're handled by showCompleted)
    if (!t.isCompleted) {
      const taskStatus = t.status || 'todo';
      if (!selectedStatuses[taskStatus]) return false;
    }

    // Assignee filter
    if (t.assignedTo) {
      if (!selectedAssignees[t.assignedTo]) return false;
    } else {
      if (!selectedAssignees['unassigned']) return false;
    }

    if (!selectedClients[t.clientId]) return false;
    if (t.projectId && !selectedProjects[t.projectId]) return false;
    if (searchQuery && !t.title.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    if (myItemsOnly && !isMyTask(t)) return false;
    return true;
  });

  const filteredLists = (lists || []).filter(l => {
    if (!showLists) return false;
    if (!l.dueDate) return false;

    // Date range filter
    if (!isInDateRange(l.dueDate)) return false;

    if (!selectedClients[l.clientId]) return false;
    if (l.projectId && !selectedProjects[l.projectId]) return false;
    if (searchQuery && !l.title.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });
  
  // Combine and sort all items by date
  const allItems = [
    ...filteredEvents.map(e => ({ type: 'event', item: e, date: new Date(e.startTime) })),
    ...filteredTasks.map(t => ({ type: 'task', item: t, date: new Date(t.dueDate) })),
    ...filteredLists.map(l => ({ type: 'list', item: l, date: new Date(l.dueDate) }))
  ].sort((a, b) => a.date - b.date);
  
  // Group by day
  const groupedByDay = {};
  allItems.forEach(item => {
    const dayKey = item.date.toDateString();
    if (!groupedByDay[dayKey]) {
      groupedByDay[dayKey] = { date: item.date, items: [] };
    }
    groupedByDay[dayKey].items.push(item);
  });
  
  const sortedDays = Object.keys(groupedByDay).sort((a, b) => 
    new Date(groupedByDay[a].date) - new Date(groupedByDay[b].date)
  );
  
  // Get client/project info for an item
  const getItemInfo = (item) => {
    // For events, derive clientId from projectId
    let clientId = item.clientId;
    if (!clientId && item.projectId) {
      for (const space of allSpaces) {
        if (space.projects.some(p => p.id === item.projectId)) {
          clientId = space.id;
          break;
        }
      }
    }
    
    let client = clients.find(c => c.id === clientId);
    if (!client) {
      if (clientId === 'personal') client = internal.personal;
      else if (clientId === 'team') client = internal.team;
    }
    const project = client?.projects.find(p => p.id === item.projectId);
    return { client, project };
  };
  
  // Format relative day
  const formatDayHeader = (date) => {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) return 'Today';
    if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
    if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
    
    return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  };
  
  // Check if day is in past
  const isDayPast = (date) => {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const checkDate = new Date(date);
    checkDate.setHours(0, 0, 0, 0);
    return checkDate < today;
  };
  
  // Format time for events
  const formatEventTime = (date) => {
    return new Date(date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
  };
  
  // Count active filters
  const activeClientCount = Object.values(selectedClients).filter(Boolean).length;
  const totalClientCount = allSpaces.length;

  return (
    <div className="lv-container">
      <style>{`
        .lv-container {
          display: flex;
          flex: 1;
          overflow: hidden;
          gap: 0;
        }
        
        /* Filter Panel */
        .lv-filter-panel {
          width: 280px;
          min-width: 280px;
          background: #141416;
          border-right: 1px solid rgba(255, 255, 255, 0.06);
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }
        
        .lv-filter-header {
          padding: 16px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
          display: flex;
          align-items: center;
          gap: 10px;
          flex-shrink: 0;
        }
        
        .lv-filter-header h3 {
          margin: 0;
          font-size: 14px;
          font-weight: 600;
          color: #e4e4e7;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        .lv-search {
          padding: 12px 16px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
          flex-shrink: 0;
        }
        
        .lv-search-wrapper {
          position: relative;
        }
        
        .lv-search-icon {
          position: absolute;
          left: 12px;
          top: 50%;
          transform: translateY(-50%);
          color: #71717a;
        }
        
        .lv-search-input {
          width: 100%;
          padding: 10px 12px 10px 36px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(255, 255, 255, 0.12);
          border-radius: 2px;
          color: #fff;
          font-size: 13px;
          outline: none;
          transition: all 0.1s;
        }

        .lv-search-input:focus {
          border-color: rgba(99, 102, 241, 0.5);
          background: rgba(0, 0, 0, 0.4);
        }
        
        .lv-filter-content {
          flex: 1;
          overflow-y: auto;
          padding: 12px 0;
        }
        
        .lv-filter-section {
          padding: 0 16px;
          margin-bottom: 16px;
        }
        
        .lv-filter-section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
        }
        
        .lv-filter-section-title {
          font-size: 11px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: #71717a;
        }
        
        .lv-filter-actions {
          display: flex;
          gap: 8px;
        }
        
        .lv-filter-action {
          background: none;
          border: none;
          color: #6366f1;
          font-size: 10px;
          cursor: pointer;
          padding: 2px 6px;
          border-radius: 2px;
          transition: all 0.1s;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .lv-filter-action:hover {
          background: rgba(99, 102, 241, 0.15);
        }

        .lv-checkbox-group {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .lv-checkbox-item {
          display: flex;
          align-items: center;
          gap: 10px;
          padding: 8px 10px;
          border-radius: 2px;
          cursor: pointer;
          transition: all 0.1s;
        }

        .lv-checkbox-item:hover {
          background: rgba(255, 255, 255, 0.05);
        }

        .lv-checkbox {
          width: 16px;
          height: 16px;
          border-radius: 2px;
          border: 1px solid rgba(255, 255, 255, 0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.1s;
          flex-shrink: 0;
        }

        .lv-checkbox.checked {
          background: #6366f1;
          border-color: #6366f1;
        }

        .lv-checkbox-label {
          font-size: 12px;
          color: #e4e4e7;
        }

        /* Client list with expansion */
        .lv-client-item {
          border-radius: 2px;
          overflow: hidden;
          margin-bottom: 2px;
        }

        .lv-client-header {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 10px;
          cursor: pointer;
          transition: all 0.1s;
        }

        .lv-client-header:hover {
          background: rgba(255, 255, 255, 0.05);
        }

        .lv-client-expand {
          color: #71717a;
          transition: transform 0.1s;
        }

        .lv-client-expand.expanded {
          transform: rotate(90deg);
        }

        .lv-client-color {
          width: 10px;
          height: 10px;
          border-radius: 2px;
          flex-shrink: 0;
        }
        
        .lv-client-name {
          flex: 1;
          font-size: 13px;
          color: #e4e4e7;
        }
        
        .lv-client-projects {
          padding-left: 34px;
          display: flex;
          flex-direction: column;
          gap: 2px;
        }
        
        .lv-project-item {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 6px 10px;
          border-radius: 2px;
          cursor: pointer;
          transition: all 0.1s;
        }

        .lv-project-item:hover {
          background: rgba(255, 255, 255, 0.05);
        }

        .lv-project-color {
          width: 8px;
          height: 8px;
          border-radius: 2px;
          flex-shrink: 0;
        }

        .lv-project-name {
          font-size: 11px;
          color: #a1a1aa;
        }
        
        /* Main content */
        .lv-main {
          flex: 1;
          overflow-y: auto;
          padding: 20px 24px;
        }
        
        .lv-empty {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 60px 20px;
          color: #71717a;
          text-align: center;
        }
        
        .lv-empty-icon {
          font-size: 48px;
          margin-bottom: 16px;
          opacity: 0.5;
        }
        
        .lv-empty-text {
          font-size: 14px;
        }
        
        /* Day groups */
        .lv-day-group {
          margin-bottom: 24px;
        }
        
        .lv-day-header {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 8px 0;
          margin-bottom: 8px;
          cursor: pointer;
          user-select: none;
        }
        
        .lv-day-header:hover .lv-day-title {
          color: #f4f4f5;
        }
        
        .lv-day-expand {
          color: #71717a;
          transition: transform 0.15s;
        }
        
        .lv-day-expand.collapsed {
          transform: rotate(-90deg);
        }
        
        .lv-day-title {
          font-size: 14px;
          font-weight: 600;
          color: #e4e4e7;
          transition: color 0.15s;
        }
        
        .lv-day-title.past {
          color: #71717a;
        }
        
        .lv-day-title.today {
          color: #6366f1;
        }
        
        .lv-day-count {
          font-size: 10px;
          color: #71717a;
          background: rgba(255, 255, 255, 0.08);
          padding: 2px 8px;
          border-radius: 2px;
          font-weight: 500;
        }

        .lv-day-items {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        /* Item cards */
        .lv-item {
          display: flex;
          align-items: flex-start;
          gap: 12px;
          padding: 12px 14px;
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 2px;
          cursor: pointer;
          transition: all 0.1s;
        }

        .lv-item:hover {
          background: rgba(255, 255, 255, 0.05);
          border-color: rgba(255, 255, 255, 0.15);
        }

        .lv-item.completed {
          opacity: 0.5;
        }

        .lv-item-icon {
          width: 28px;
          height: 28px;
          border-radius: 2px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 13px;
          flex-shrink: 0;
        }

        .lv-item-icon.event {
          background: rgba(99, 102, 241, 0.15);
        }

        .lv-item-icon.task {
          background: rgba(34, 197, 94, 0.15);
        }

        .lv-item-icon.list {
          background: rgba(249, 115, 22, 0.15);
        }
        
        .lv-item-content {
          flex: 1;
          min-width: 0;
        }
        
        .lv-item-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 4px;
        }
        
        .lv-item-title {
          font-size: 13px;
          font-weight: 500;
          color: #f4f4f5;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .lv-item-title.completed {
          text-decoration: line-through;
          color: #71717a;
        }

        .lv-item-meta {
          display: flex;
          align-items: center;
          gap: 6px;
          flex-wrap: wrap;
        }

        .lv-item-time {
          font-size: 11px;
          color: #a1a1aa;
        }

        .lv-item-badge {
          font-size: 10px;
          padding: 2px 6px;
          border-radius: 2px;
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }
        
        .lv-item-location {
          font-size: 12px;
          color: #71717a;
          display: flex;
          align-items: center;
          gap: 4px;
        }
        
        /* Task checkbox */
        .lv-task-checkbox {
          width: 18px;
          height: 18px;
          border-radius: 50%;
          border: 2px solid rgba(255, 255, 255, 0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.15s;
          flex-shrink: 0;
          margin-top: 2px;
        }
        
        .lv-task-checkbox:hover {
          border-color: #22c55e;
          background: rgba(34, 197, 94, 0.1);
        }
        
        .lv-task-checkbox.completed {
          background: #22c55e;
          border-color: #22c55e;
        }
        
        /* List progress */
        .lv-item-progress {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-top: 6px;
        }
        
        .lv-item-progress-bar {
          flex: 1;
          height: 6px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 3px;
          overflow: hidden;
          max-width: 200px;
        }
        
        .lv-item-progress-fill {
          height: 100%;
          background: linear-gradient(90deg, #22c55e, #16a34a);
          border-radius: 3px;
          transition: width 0.3s ease;
        }
        
        .lv-item-progress-text {
          font-size: 12px;
          color: #71717a;
          min-width: 35px;
        }
        
        /* Responsive */
        @media (max-width: 900px) {
          .lv-filter-panel {
            width: 240px;
            min-width: 240px;
          }
        }
        
        @media (max-width: 768px) {
          .lv-filter-panel {
            display: none;
          }
        }
      `}</style>
      
      {/* Filter Panel */}
      <div className="lv-filter-panel">
        <div className="lv-filter-header">
          <h3><Filter size={16} /> Filters</h3>
        </div>
        
        {/* Search */}
        <div className="lv-search">
          <div className="lv-search-wrapper">
            <Search size={16} className="lv-search-icon" />
            <input
              type="text"
              className="lv-search-input"
              placeholder="Search items..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
          </div>
        </div>
        
        <div className="lv-filter-content">
          {/* Date Range Filter */}
          <div className="lv-filter-section">
            <div className="lv-filter-section-header">
              <span className="lv-filter-section-title">Date Range</span>
            </div>
            <div className="lv-checkbox-group">
              <div
                className={`lv-checkbox-item ${dateRangeEnabled ? 'checked' : ''}`}
                onClick={() => setDateRangeEnabled(!dateRangeEnabled)}
              >
                <div className={`lv-checkbox ${dateRangeEnabled ? 'checked' : ''}`}>
                  {dateRangeEnabled && <Check size={10} color="#fff" />}
                </div>
                <span className="lv-checkbox-label">Enable date range</span>
              </div>
              {dateRangeEnabled && (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 8, marginTop: 8, paddingLeft: 26 }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span style={{ fontSize: 11, color: '#71717a', minWidth: 35 }}>From</span>
                    <input
                      type="date"
                      value={dateRangeStart}
                      onChange={(e) => setDateRangeStart(e.target.value)}
                      style={{
                        flex: 1,
                        padding: '6px 8px',
                        background: 'rgba(0, 0, 0, 0.3)',
                        border: '1px solid rgba(255, 255, 255, 0.12)',
                        borderRadius: 2,
                        color: '#fff',
                        fontSize: 12
                      }}
                    />
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span style={{ fontSize: 11, color: '#71717a', minWidth: 35 }}>To</span>
                    <input
                      type="date"
                      value={dateRangeEnd}
                      onChange={(e) => setDateRangeEnd(e.target.value)}
                      style={{
                        flex: 1,
                        padding: '6px 8px',
                        background: 'rgba(0, 0, 0, 0.3)',
                        border: '1px solid rgba(255, 255, 255, 0.12)',
                        borderRadius: 2,
                        color: '#fff',
                        fontSize: 12
                      }}
                    />
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Item Types */}
          <div className="lv-filter-section">
            <div className="lv-filter-section-header">
              <span className="lv-filter-section-title">Item Types</span>
              <div className="lv-filter-actions">
                <button className="lv-filter-action" onClick={() => { setShowEvents(true); setShowTasks(true); setShowLists(true); }}>All</button>
                <button className="lv-filter-action" onClick={() => { setShowEvents(false); setShowTasks(false); setShowLists(false); }}>None</button>
              </div>
            </div>
            <div className="lv-checkbox-group">
              <div
                className={`lv-checkbox-item ${showEvents ? 'checked' : ''}`}
                onClick={() => setShowEvents(!showEvents)}
              >
                <div className={`lv-checkbox ${showEvents ? 'checked' : ''}`}>
                  {showEvents && <Check size={10} color="#fff" />}
                </div>
                <span className="lv-checkbox-label">📅 Events</span>
              </div>
              <div
                className={`lv-checkbox-item ${showTasks ? 'checked' : ''}`}
                onClick={() => setShowTasks(!showTasks)}
              >
                <div className={`lv-checkbox ${showTasks ? 'checked' : ''}`}>
                  {showTasks && <Check size={10} color="#fff" />}
                </div>
                <span className="lv-checkbox-label">✓ Tasks</span>
              </div>
              <div
                className={`lv-checkbox-item ${showLists ? 'checked' : ''}`}
                onClick={() => setShowLists(!showLists)}
              >
                <div className={`lv-checkbox ${showLists ? 'checked' : ''}`}>
                  {showLists && <Check size={10} color="#fff" />}
                </div>
                <span className="lv-checkbox-label">📋 Lists</span>
              </div>
            </div>
          </div>

          {/* Task Status Filter */}
          {showTasks && (
            <div className="lv-filter-section">
              <div className="lv-filter-section-header">
                <span className="lv-filter-section-title">Task Status</span>
                <div className="lv-filter-actions">
                  <button className="lv-filter-action" onClick={selectAllStatuses}>All</button>
                  <button className="lv-filter-action" onClick={deselectAllStatuses}>None</button>
                </div>
              </div>
              <div className="lv-checkbox-group">
                {Object.entries(taskStatusConfig).map(([key, config]) => (
                  <div
                    key={key}
                    className={`lv-checkbox-item ${selectedStatuses[key] ? 'checked' : ''}`}
                    onClick={() => toggleStatus(key)}
                  >
                    <div className={`lv-checkbox ${selectedStatuses[key] ? 'checked' : ''}`}>
                      {selectedStatuses[key] && <Check size={10} color="#fff" />}
                    </div>
                    <span style={{ color: config.color, marginRight: 4 }}>{config.icon}</span>
                    <span className="lv-checkbox-label">{config.label}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Clients & Projects */}
          <div className="lv-filter-section">
            <div className="lv-filter-section-header">
              <span className="lv-filter-section-title">Clients & Projects</span>
              <div className="lv-filter-actions">
                <button className="lv-filter-action" onClick={selectAll}>All</button>
                <button className="lv-filter-action" onClick={deselectAll}>None</button>
              </div>
            </div>
            <div className="lv-checkbox-group">
              {allSpaces.map(space => (
                <div key={space.id} className="lv-client-item">
                  <div className="lv-client-header">
                    {space.projects.length > 0 && (
                      <ChevronRight 
                        size={14} 
                        className={`lv-client-expand ${expandedClients[space.id] ? 'expanded' : ''}`}
                        onClick={(e) => { e.stopPropagation(); toggleClientExpand(space.id); }}
                      />
                    )}
                    {space.projects.length === 0 && <div style={{ width: 14 }} />}
                    <div 
                      className={`lv-checkbox ${selectedClients[space.id] ? 'checked' : ''}`}
                      onClick={() => toggleClient(space.id)}
                    >
                      {selectedClients[space.id] && <Check size={10} color="#fff" />}
                    </div>
                    <div className="lv-client-color" style={{ background: space.color }} />
                    <span className="lv-client-name" onClick={() => toggleClient(space.id)}>{space.name}</span>
                  </div>
                  {expandedClients[space.id] && space.projects.length > 0 && (
                    <div className="lv-client-projects">
                      {space.projects.map(project => (
                        <div 
                          key={project.id}
                          className="lv-project-item"
                          onClick={() => toggleProject(project.id)}
                        >
                          <div className={`lv-checkbox ${selectedProjects[project.id] ? 'checked' : ''}`} style={{ width: 14, height: 14 }}>
                            {selectedProjects[project.id] && <Check size={8} color="#fff" />}
                          </div>
                          <div className="lv-project-color" style={{ background: project.color }} />
                          <span className="lv-project-name">{project.name}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>

          {/* Assigned To Filter */}
          {showTasks && (
            <div className="lv-filter-section">
              <div className="lv-filter-section-header">
                <span className="lv-filter-section-title">Assigned To</span>
                <div className="lv-filter-actions">
                  <button className="lv-filter-action" onClick={selectAllAssignees}>All</button>
                  <button className="lv-filter-action" onClick={deselectAllAssignees}>None</button>
                </div>
              </div>
              <div className="lv-checkbox-group">
                <div
                  className={`lv-checkbox-item ${selectedAssignees['unassigned'] ? 'checked' : ''}`}
                  onClick={() => toggleAssignee('unassigned')}
                >
                  <div className={`lv-checkbox ${selectedAssignees['unassigned'] ? 'checked' : ''}`}>
                    {selectedAssignees['unassigned'] && <Check size={10} color="#fff" />}
                  </div>
                  <span className="lv-checkbox-label" style={{ color: '#71717a', fontStyle: 'italic' }}>Unassigned</span>
                </div>
                {teamMembers.map(member => (
                  <div
                    key={member.id}
                    className={`lv-checkbox-item ${selectedAssignees[member.id] ? 'checked' : ''}`}
                    onClick={() => toggleAssignee(member.id)}
                  >
                    <div className={`lv-checkbox ${selectedAssignees[member.id] ? 'checked' : ''}`}>
                      {selectedAssignees[member.id] && <Check size={10} color="#fff" />}
                    </div>
                    <div style={{
                      width: 18,
                      height: 18,
                      borderRadius: '50%',
                      background: member.color,
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: 10,
                      color: '#fff',
                      fontWeight: 600
                    }}>
                      {member.name.charAt(0)}
                    </div>
                    <span className="lv-checkbox-label">{member.name}</span>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* View Options */}
          <div className="lv-filter-section">
            <div className="lv-filter-section-header">
              <span className="lv-filter-section-title">View Options</span>
            </div>
            <div className="lv-checkbox-group">
              <div
                className={`lv-checkbox-item ${showCompleted ? 'checked' : ''}`}
                onClick={() => setShowCompleted(!showCompleted)}
              >
                <div className={`lv-checkbox ${showCompleted ? 'checked' : ''}`}>
                  {showCompleted && <Check size={10} color="#fff" />}
                </div>
                <span className="lv-checkbox-label">Show completed tasks</span>
              </div>
              <div
                className={`lv-checkbox-item ${showPastEvents ? 'checked' : ''}`}
                onClick={() => setShowPastEvents(!showPastEvents)}
              >
                <div className={`lv-checkbox ${showPastEvents ? 'checked' : ''}`}>
                  {showPastEvents && <Check size={10} color="#fff" />}
                </div>
                <span className="lv-checkbox-label">Show past events</span>
              </div>
              <div
                className={`lv-checkbox-item ${myItemsOnly ? 'checked' : ''}`}
                onClick={() => setMyItemsOnly(!myItemsOnly)}
              >
                <div className={`lv-checkbox ${myItemsOnly ? 'checked' : ''}`}>
                  {myItemsOnly && <Check size={10} color="#fff" />}
                </div>
                <span className="lv-checkbox-label">My items only</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="lv-main">
        {sortedDays.length === 0 ? (
          <div className="lv-empty">
            <div className="lv-empty-icon">📋</div>
            <div className="lv-empty-text">No items match your filters</div>
          </div>
        ) : (
          sortedDays.map(dayKey => {
            const dayData = groupedByDay[dayKey];
            const isCollapsed = collapsedDays[dayKey];
            const isPast = isDayPast(dayData.date);
            const isToday = dayData.date.toDateString() === new Date().toDateString();
            
            return (
              <div key={dayKey} className="lv-day-group">
                <div className="lv-day-header" onClick={() => toggleDayCollapse(dayKey)}>
                  <ChevronDown 
                    size={16} 
                    className={`lv-day-expand ${isCollapsed ? 'collapsed' : ''}`}
                  />
                  <span className={`lv-day-title ${isPast ? 'past' : ''} ${isToday ? 'today' : ''}`}>
                    {formatDayHeader(dayData.date)}
                  </span>
                  <span className="lv-day-count">{dayData.items.length}</span>
                </div>
                
                {!isCollapsed && (
                  <div className="lv-day-items">
                    {dayData.items.map(({ type, item }) => {
                      const info = getItemInfo(item);
                      
                      if (type === 'event') {
                        return (
                          <div 
                            key={item.id}
                            className="lv-item"
                            onClick={() => onEventClick && onEventClick(item)}
                          >
                            <div className="lv-item-icon event">📅</div>
                            <div className="lv-item-content">
                              <div className="lv-item-header">
                                <span className="lv-item-title">{item.title}</span>
                              </div>
                              <div className="lv-item-meta">
                                <span className="lv-item-time">
                                  {formatEventTime(item.startTime)} - {formatEventTime(item.endTime)}
                                </span>
                                {info.project && (
                                  <span 
                                    className="lv-item-badge"
                                    style={{ background: `${info.project.color}20`, color: info.project.color }}
                                  >
                                    {info.project.name}
                                  </span>
                                )}
                                {item.location && (
                                  <span className="lv-item-location">
                                    <MapPin size={12} /> {item.location}
                                  </span>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      }
                      
                      if (type === 'task') {
                        return (
                          <div
                            key={item.id}
                            className={`lv-item ${item.isCompleted ? 'completed' : ''}`}
                            onClick={() => {
                              if (item.listId && lists) {
                                const list = lists.find(l => l.id === item.listId);
                                if (list && onListClick) {
                                  onListClick(list);
                                  return;
                                }
                              }
                              onTaskClick && onTaskClick(item);
                            }}
                          >
                            <div 
                              className={`lv-task-checkbox ${item.isCompleted ? 'completed' : ''}`}
                              onClick={(e) => {
                                e.stopPropagation();
                                toggleTaskComplete(item.id);
                              }}
                            >
                              {item.isCompleted && <Check size={12} color="#fff" />}
                            </div>
                            <div className="lv-item-content">
                              <div className="lv-item-header">
                                <span className={`lv-item-title ${item.isCompleted ? 'completed' : ''}`} style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
                                  {item.title}
                                  {item.listId && <List size={12} style={{ opacity: 0.6, flexShrink: 0 }} />}
                                </span>
                              </div>
                              <div className="lv-item-meta">
                                {info.project && (
                                  <span 
                                    className="lv-item-badge"
                                    style={{ background: `${info.project.color}20`, color: info.project.color }}
                                  >
                                    {info.project.name}
                                  </span>
                                )}
                                {item.assignedTo && (() => {
                                  const assignee = teamMembers.find(m => m.id === item.assignedTo);
                                  return assignee ? (
                                    <span 
                                      className="lv-item-badge"
                                      style={{ background: `${assignee.color}20`, color: assignee.color }}
                                    >
                                      {assignee.name}
                                    </span>
                                  ) : null;
                                })()}
                              </div>
                            </div>
                          </div>
                        );
                      }
                      
                      if (type === 'list') {
                        const progress = getListProgress ? getListProgress(item.id) : { completed: 0, total: 0 };
                        const progressPercent = progress.total > 0 ? (progress.completed / progress.total) * 100 : 0;
                        
                        return (
                          <div 
                            key={item.id}
                            className="lv-item"
                            onClick={() => onListClick && onListClick(item)}
                          >
                            <div className="lv-item-icon list">📋</div>
                            <div className="lv-item-content">
                              <div className="lv-item-header">
                                <span className="lv-item-title">{item.title}</span>
                              </div>
                              <div className="lv-item-meta">
                                {info.project && (
                                  <span 
                                    className="lv-item-badge"
                                    style={{ background: `${info.project.color}20`, color: info.project.color }}
                                  >
                                    {info.project.name}
                                  </span>
                                )}
                              </div>
                              <div className="lv-item-progress">
                                <div className="lv-item-progress-bar">
                                  <div 
                                    className="lv-item-progress-fill" 
                                    style={{ width: `${progressPercent}%` }} 
                                  />
                                </div>
                                <span className="lv-item-progress-text">{progress.completed}/{progress.total}</span>
                              </div>
                            </div>
                          </div>
                        );
                      }
                      
                      return null;
                    })}
                  </div>
                )}
              </div>
            );
          })
        )}
      </div>
    </div>
  );
}

// ==================== CLIENT VIEW ====================
function ClientView({ client, events, tasks, lists, notes, teamMembers, allEvents, clients, internal, toggleTaskComplete, addTask, addEvent, addList, addNote, addReply, deleteNote, deleteReply, updateNote, addProject, deleteProject, deleteClient, updateClient, currentUser, onEventClick, onTaskClick, onListClick, getListProgress }) {
  const [activeTab, setActiveTab] = React.useState('overview');
  const [selectedProject, setSelectedProject] = React.useState(null);
  const [showAddNote, setShowAddNote] = React.useState(false);
  const [newNoteContent, setNewNoteContent] = React.useState('');
  const [selectedNoteId, setSelectedNoteId] = React.useState(null);
  const [replyContent, setReplyContent] = React.useState('');
  const [showCompletedTasks, setShowCompletedTasks] = React.useState(false);
  const [showPastEvents, setShowPastEvents] = React.useState(false);
  const [showAddProject, setShowAddProject] = React.useState(false);
  const [isEditingDetails, setIsEditingDetails] = React.useState(false);
  const [editedDetails, setEditedDetails] = React.useState(client.details || '');
  const [showAddProjectNote, setShowAddProjectNote] = React.useState(false);
  const [newProjectNoteContent, setNewProjectNoteContent] = React.useState('');
  const [selectedProjectNoteId, setSelectedProjectNoteId] = React.useState(null);
  const [projectNoteReplyContent, setProjectNoteReplyContent] = React.useState('');
  const [showAddEventModal, setShowAddEventModal] = React.useState(false);

  // Get actual note objects from IDs (so they update when replies are added)
  const selectedNote = selectedNoteId ? notes.find(n => n.id === selectedNoteId) : null;
  const selectedProjectNote = selectedProjectNoteId ? notes.find(n => n.id === selectedProjectNoteId) : null;
  const [addEventDefaults, setAddEventDefaults] = React.useState({ clientId: '', projectId: '' });
  const [showAddTaskModal, setShowAddTaskModal] = React.useState(false);
  const [addTaskDefaults, setAddTaskDefaults] = React.useState({ clientId: '', projectId: '' });
  const [showAddListModal, setShowAddListModal] = React.useState(false);
  const [addListDefaults, setAddListDefaults] = React.useState({ clientId: '', projectId: '' });
  const [projectToDelete, setProjectToDelete] = React.useState(null);
  const [showDeleteClientModal, setShowDeleteClientModal] = React.useState(false);
  const [noteToDelete, setNoteToDelete] = React.useState(null); // { noteId, replyId? } for confirmation
  const [isDeleting, setIsDeleting] = React.useState(false);
  const [noteToMove, setNoteToMove] = React.useState(null); // note object for move modal
  const [moveTargetClient, setMoveTargetClient] = React.useState('');
  const [moveTargetProject, setMoveTargetProject] = React.useState('');
  const [isMoving, setIsMoving] = React.useState(false);

  // All spaces for move modal dropdown
  const allSpaces = [internal.personal, internal.team, ...clients];

  // Handle initial project selection and reset state when switching clients
  React.useEffect(() => {
    setEditedDetails(client.details || '');
    setIsEditingDetails(false);
    
    // If navigated with a specific project, select it and switch to projects tab
    if (client._initialProject) {
      const project = client.projects.find(p => p.id === client._initialProject);
      if (project) {
        setSelectedProject(project);
        setActiveTab('projects');
      }
    } else {
      setSelectedProject(null);
      setActiveTab('overview');
    }
  }, [client.id, client._initialProject]);
  
  // Get events for a specific project
  const getProjectEvents = (projectId) => events.filter(e => e.projectId === projectId);
  
  // Get client-level events (no project)
  const clientLevelEvents = events.filter(e => !e.projectId);
  
  // Get tasks for a specific project (or client-level if projectId is null)
  const getProjectTasks = (projectId) => tasks.filter(t => t.projectId === projectId && !t.listId);
  const clientLevelTasks = tasks.filter(t => !t.projectId && !t.listId);
  
  // Get notes for a specific project
  const getProjectNotes = (projectId) => notes.filter(n => n.projectId === projectId);

  // Get client-level notes (no projectId)
  const clientLevelNotes = notes.filter(n => !n.projectId);

  // Get last activity date for a note (most recent of note creation or any reply)
  const getLastActivity = (note) => {
    if (!note.replies || note.replies.length === 0) {
      return note.createdAt;
    }
    const lastReplyDate = note.replies.reduce((latest, reply) =>
      reply.createdAt > latest ? reply.createdAt : latest
    , note.createdAt);
    return lastReplyDate;
  };

  // Sort notes by last activity (most recent first)
  const sortByActivity = (notesArray) =>
    [...notesArray].sort((a, b) => getLastActivity(b) - getLastActivity(a));
  
  // Get lists for a specific project
  const getProjectLists = (projectId) => (lists || []).filter(l => l.projectId === projectId);
  
  // Get all client lists (for Tasks tab)
  const allClientLists = lists || [];
  
  // Stats (excluding list items)
  const totalEvents = events.length;
  const completedEvents = events.filter(e => e.isCompleted).length;
  const upcomingEvents = events.filter(e => e.startTime > new Date() && !e.isCompleted);
  const pendingTasks = tasks.filter(t => !t.isCompleted && !t.listId);
  const completedTasks = tasks.filter(t => t.isCompleted && !t.listId);
  
  // Sort upcoming by date
  upcomingEvents.sort((a, b) => a.startTime - b.startTime);
  
  // Sort notes by last activity (most recent activity first)
  // Client-level notes only (not project-specific)
  const sortedNotes = sortByActivity(clientLevelNotes);

  // All notes sorted by last activity (for Overview tab - includes both client-level and project notes)
  const allSortedNotes = sortByActivity(notes);
  
  // Get team member by id
  const getMember = (id) => teamMembers.find(m => m.id === id);
  
  // Render text with markdown and highlighted @mentions
  const renderMentionText = (text) => {
    if (!text) return null;

    // First, process @mentions and wrap them in styled spans
    let processedText = text.replace(/(@\w+(?:\s+\w+)?)/g, (match) => {
      const name = match.slice(1);
      const member = teamMembers.find(m => m.name === name);
      if (member) {
        return `<span style="color: ${member.color}; font-weight: 600;">${match}</span>`;
      }
      return match;
    });

    // Parse markdown
    const html = window.marked ? window.marked.parse(processedText) : processedText;

    return <div dangerouslySetInnerHTML={{ __html: html }} className="markdown-content" />;
  };
  
  // Format relative time
  const formatRelativeTime = (date) => {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  };
  
  // Handle add note
  const handleAddNote = () => {
    if (!newNoteContent.trim()) return;
    addNote(client.id, newNoteContent);
    setNewNoteContent('');
    setShowAddNote(false);
  };
  
  // Handle add project note
  const handleAddProjectNote = () => {
    if (!newProjectNoteContent.trim() || !selectedProject) return;
    addNote(client.id, newProjectNoteContent, selectedProject.id);
    setNewProjectNoteContent('');
    setShowAddProjectNote(false);
  };
  
  // Handle add project note reply
  const handleAddProjectNoteReply = () => {
    console.log('handleAddProjectNoteReply called', { projectNoteReplyContent, selectedProjectNote });
    if (!projectNoteReplyContent.trim() || !selectedProjectNote) {
      console.log('handleAddProjectNoteReply early return:', { hasContent: !!projectNoteReplyContent.trim(), hasSelectedNote: !!selectedProjectNote });
      return;
    }
    console.log('Calling addReply with noteId:', selectedProjectNote.id);
    addReply(selectedProjectNote.id, projectNoteReplyContent);
    setProjectNoteReplyContent('');
  };
  
  // Handle add reply
  const handleAddReply = () => {
    console.log('handleAddReply called', { replyContent, selectedNote, selectedNoteId });
    if (!replyContent.trim() || !selectedNote) {
      console.log('handleAddReply early return:', { hasContent: !!replyContent.trim(), hasSelectedNote: !!selectedNote });
      return;
    }
    console.log('Calling addReply with noteId:', selectedNote.id);
    addReply(selectedNote.id, replyContent);
    setReplyContent('');
  };
  
  // Open add event modal with defaults
  const openAddEventModal = (projectId = null) => {
    setAddEventDefaults({ clientId: client.id, projectId: projectId || '' });
    setShowAddEventModal(true);
  };
  
  // Open add task modal with defaults
  const openAddTaskModal = (projectId = null) => {
    setAddTaskDefaults({ clientId: client.id, projectId: projectId || '' });
    setShowAddTaskModal(true);
  };

  // Handle delete note/reply confirmation
  const handleDeleteConfirm = async () => {
    if (!noteToDelete || isDeleting) return;

    setIsDeleting(true);
    let success = false;

    if (noteToDelete.replyId) {
      // Delete a reply
      success = await deleteReply(noteToDelete.noteId, noteToDelete.replyId);
    } else {
      // Delete the entire note
      success = await deleteNote(noteToDelete.noteId);
      // If we deleted the currently selected note, close the thread view
      if (success && selectedNoteId === noteToDelete.noteId) {
        setSelectedNoteId(null);
      }
      if (success && selectedProjectNoteId === noteToDelete.noteId) {
        setSelectedProjectNoteId(null);
      }
    }

    setIsDeleting(false);
    setNoteToDelete(null);
  };

  // Open move note modal
  const openMoveNoteModal = (note) => {
    setNoteToMove(note);
    setMoveTargetClient(note.clientId);
    setMoveTargetProject(note.projectId || '');
  };

  // Handle move note
  const handleMoveNote = async () => {
    if (!noteToMove || isMoving) return;
    if (!moveTargetClient) {
      alert('Please select a destination');
      return;
    }

    setIsMoving(true);
    const success = await updateNote(noteToMove.id, {
      clientId: moveTargetClient,
      projectId: moveTargetProject || null
    });

    if (success) {
      // Close thread views if the moved note was selected
      if (selectedNoteId === noteToMove.id) {
        setSelectedNoteId(null);
      }
      if (selectedProjectNoteId === noteToMove.id) {
        setSelectedProjectNoteId(null);
      }
    }

    setIsMoving(false);
    setNoteToMove(null);
    setMoveTargetClient('');
    setMoveTargetProject('');
  };

  // Get projects for selected client in move modal
  const getMoveTargetProjects = () => {
    const targetClient = allSpaces.find(s => s.id === moveTargetClient);
    return targetClient?.projects || [];
  };

  return (
    <div style={{ display: 'flex', flexDirection: 'column', flex: 1, overflow: 'hidden' }}>
      <style>{`
        .cv-header {
          display: flex;
          align-items: center;
          gap: 16px;
          padding-bottom: 24px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.06);
          margin-bottom: 24px;
          flex-shrink: 0;
        }
        
        .cv-color-bar {
          width: 6px;
          height: 48px;
          border-radius: 3px;
        }
        
        .cv-header-info h2 {
          font-size: 24px;
          font-weight: 600;
          margin-bottom: 4px;
        }
        
        .cv-header-meta {
          font-size: 13px;
          color: #71717a;
        }

        .cv-delete-client-btn {
          background: transparent;
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #71717a;
          cursor: pointer;
          padding: 8px;
          border-radius: 6px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-left: auto;
          transition: all 0.15s;
        }
        .cv-delete-client-btn:hover {
          background: rgba(239, 68, 68, 0.1);
          border-color: rgba(239, 68, 68, 0.3);
          color: #ef4444;
        }

        .cv-details-section {
          margin-bottom: 20px;
          flex-shrink: 0;
        }
        
        .cv-details-display {
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.06);
          border-radius: 10px;
          padding: 14px 16px;
          cursor: pointer;
          transition: all 0.15s;
          position: relative;
        }
        
        .cv-details-display:hover {
          background: rgba(255, 255, 255, 0.04);
          border-color: rgba(255, 255, 255, 0.1);
        }
        
        .cv-details-display:hover .cv-details-edit-hint {
          opacity: 1;
        }
        
        .cv-details-text {
          font-size: 13px;
          color: #a1a1aa;
          line-height: 1.6;
          white-space: pre-wrap;
        }
        
        .cv-details-placeholder {
          font-size: 13px;
          color: #52525b;
          font-style: italic;
        }
        
        .cv-details-edit-hint {
          position: absolute;
          top: 10px;
          right: 12px;
          font-size: 11px;
          color: #52525b;
          opacity: 0;
          transition: opacity 0.15s;
        }
        
        .cv-details-edit {
          background: rgba(255, 255, 255, 0.03);
          border: 1px solid rgba(99, 102, 241, 0.3);
          border-radius: 10px;
          padding: 14px 16px;
        }
        
        .cv-details-textarea {
          width: 100%;
          min-height: 80px;
          padding: 0;
          background: transparent;
          border: none;
          color: #e4e4e7;
          font-size: 13px;
          font-family: inherit;
          line-height: 1.6;
          outline: none;
          resize: vertical;
        }
        
        .cv-details-textarea::placeholder {
          color: #52525b;
        }
        
        .cv-details-actions {
          display: flex;
          gap: 8px;
          justify-content: flex-end;
          margin-top: 12px;
          padding-top: 12px;
          border-top: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .cv-tabs {
          display: flex;
          gap: 8px;
          padding: 12px;
          margin-bottom: 20px;
          flex-shrink: 0;
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 2px;
          flex-wrap: wrap;
        }

        .cv-tab {
          padding: 10px 20px;
          border-radius: 2px;
          background: transparent;
          border: 1px solid transparent;
          color: #71717a;
          font-size: 12px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.1s;
          white-space: nowrap;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .cv-tab:hover { color: #e4e4e7; background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); }
        .cv-tab.active { color: #818cf8; background: rgba(99, 102, 241, 0.15); border-color: rgba(99, 102, 241, 0.4); }

        /* Responsive tabs */
        @media (max-width: 600px) {
          .cv-tab {
            padding: 8px 14px;
            font-size: 11px;
          }
        }

        .cv-content {
          flex: 1;
          overflow-y: auto;
        }

        .cv-stats {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 12px;
          margin-bottom: 24px;
        }

        /* Responsive stats grid */
        @media (max-width: 700px) {
          .cv-stats {
            grid-template-columns: repeat(2, 1fr);
          }
        }

        @media (max-width: 400px) {
          .cv-stats {
            grid-template-columns: 1fr;
          }
        }

        .cv-stat {
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.06);
          border-radius: 2px;
          padding: 12px 16px;
        }
        
        .cv-stat-value {
          font-size: 20px;
          font-weight: 600;
          color: #a1a1aa;
          margin-bottom: 2px;
        }
        
        .cv-stat-label {
          font-size: 11px;
          color: #52525b;
        }
        
        .cv-section {
          margin-bottom: 24px;
        }
        
        .cv-section-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 12px;
        }
        
        .cv-section-title {
          font-size: 14px;
          font-weight: 600;
          color: #a1a1aa;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .cv-subsection-title {
          font-size: 11px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          color: #52525b;
          margin-bottom: 8px;
          margin-top: 4px;
        }

        .cv-add-btn {
          padding: 4px 10px;
          border-radius: 2px;
          background: rgba(255, 255, 255, 0.04);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #71717a;
          font-size: 10px;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 4px;
          transition: all 0.1s;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .cv-add-btn:hover {
          background: rgba(99, 102, 241, 0.15);
          border-color: rgba(99, 102, 241, 0.3);
          color: #818cf8;
        }

        .cv-project-detail-split {
          display: flex;
          gap: 24px;
          margin-top: 16px;
        }

        .cv-project-notes-section {
          flex: 1 1 58%;
          min-width: 0;
        }

        .cv-project-tasks-section {
          flex: 1 1 40%;
          min-width: 280px;
        }

        /* Responsive: stack on narrow screens */
        @media (max-width: 800px) {
          .cv-project-detail-split {
            flex-direction: column;
          }
          .cv-project-notes-section,
          .cv-project-tasks-section {
            flex: 1 1 auto;
            min-width: 0;
          }
        }

        .cv-show-more {
          font-size: 10px;
          color: #71717a;
          padding: 8px 12px;
          text-align: center;
          background: rgba(255, 255, 255, 0.02);
          border-radius: 2px;
          margin-top: 4px;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .cv-projects {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
          gap: 12px;
        }

        .cv-project {
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.06);
          border-radius: 2px;
          padding: 12px 16px;
          cursor: pointer;
          transition: all 0.1s;
          border-left: 3px solid;
        }
        
        .cv-project:hover {
          background: rgba(255, 255, 255, 0.04);
          border-color: rgba(255, 255, 255, 0.08);
        }
        
        .cv-project.selected {
          background: rgba(99, 102, 241, 0.1);
          border-color: rgba(99, 102, 241, 0.3);
        }
        
        .cv-project-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 4px;
        }

        .cv-project-name {
          font-size: 14px;
          font-weight: 600;
          color: #e4e4e7;
        }

        .cv-project-delete-btn {
          background: transparent;
          border: none;
          color: #52525b;
          cursor: pointer;
          padding: 4px;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          opacity: 0;
          transition: all 0.15s;
        }
        .cv-project:hover .cv-project-delete-btn {
          opacity: 1;
        }
        .cv-project-delete-btn:hover {
          background: rgba(239, 68, 68, 0.1);
          color: #ef4444;
        }

        .cv-project-stats {
          display: flex;
          gap: 12px;
          font-size: 11px;
          color: #52525b;
        }
        
        .cv-notes-list {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        
        .cv-note-card {
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.06);
          border-radius: 2px;
          padding: 12px;
          cursor: pointer;
          transition: all 0.1s;
        }

        .cv-note-card:hover {
          background: rgba(255, 255, 255, 0.05);
          border-color: rgba(255, 255, 255, 0.12);
        }

        .cv-note-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 6px;
        }

        .cv-note-avatar {
          width: 22px;
          height: 22px;
          border-radius: 2px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 9px;
          font-weight: 600;
          color: #fff;
          text-transform: uppercase;
        }

        .cv-note-author {
          font-size: 11px;
          font-weight: 600;
          color: #e4e4e7;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .cv-note-time {
          font-size: 10px;
          color: #52525b;
          margin-left: auto;
        }

        .cv-note-content {
          font-size: 13px;
          color: #a1a1aa;
          line-height: 1.5;
          margin-bottom: 8px;
        }

        /* Markdown content styles */
        .markdown-content {
          line-height: 1.5;
        }
        .markdown-content p {
          margin: 0 0 0.5em 0;
        }
        .markdown-content p:last-child {
          margin-bottom: 0;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3,
        .markdown-content h4, .markdown-content h5, .markdown-content h6 {
          margin: 0.5em 0 0.25em 0;
          font-weight: 600;
          color: #e4e4e7;
        }
        .markdown-content h1 { font-size: 1.4em; }
        .markdown-content h2 { font-size: 1.25em; }
        .markdown-content h3 { font-size: 1.1em; }
        .markdown-content ul, .markdown-content ol {
          margin: 0.25em 0;
          padding-left: 1.5em;
        }
        .markdown-content li {
          margin: 0.15em 0;
        }
        .markdown-content code {
          background: #27272a;
          padding: 0.15em 0.4em;
          border-radius: 4px;
          font-family: 'SF Mono', Monaco, monospace;
          font-size: 0.9em;
          color: #a78bfa;
        }
        .markdown-content pre {
          background: #27272a;
          padding: 0.75em 1em;
          border-radius: 6px;
          overflow-x: auto;
          margin: 0.5em 0;
        }
        .markdown-content pre code {
          background: none;
          padding: 0;
        }
        .markdown-content blockquote {
          border-left: 3px solid #6366f1;
          margin: 0.5em 0;
          padding-left: 1em;
          color: #71717a;
        }
        .markdown-content a {
          color: #818cf8;
          text-decoration: none;
        }
        .markdown-content a:hover {
          text-decoration: underline;
        }
        .markdown-content strong {
          font-weight: 600;
          color: #e4e4e7;
        }
        .markdown-content em {
          font-style: italic;
        }

        .cv-note-footer {
          display: flex;
          align-items: center;
          gap: 12px;
        }
        
        .cv-note-replies {
          font-size: 11px;
          color: #71717a;
          display: flex;
          align-items: center;
          gap: 6px;
        }
        
        .cv-note-replies-count {
          background: rgba(99, 102, 241, 0.2);
          color: #818cf8;
          padding: 2px 8px;
          border-radius: 10px;
          font-weight: 500;
        }

        .cv-note-delete-btn {
          opacity: 0;
          background: none;
          border: none;
          color: #71717a;
          cursor: pointer;
          padding: 4px;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.15s;
          margin-left: auto;
        }

        .cv-note-card:hover .cv-note-delete-btn,
        .cv-reply:hover .cv-note-delete-btn {
          opacity: 1;
        }

        .cv-note-delete-btn:hover {
          background: rgba(239, 68, 68, 0.15);
          color: #ef4444;
        }

        .cv-delete-note-modal {
          background: #18181b;
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 8px;
          padding: 24px;
          max-width: 400px;
          width: 90%;
        }

        .cv-delete-note-modal h4 {
          margin: 0 0 12px 0;
          font-size: 16px;
          color: #f4f4f5;
        }

        .cv-delete-note-modal p {
          color: #a1a1aa;
          font-size: 14px;
          margin: 0 0 20px 0;
        }

        .cv-delete-note-actions {
          display: flex;
          gap: 12px;
          justify-content: flex-end;
        }

        .cv-delete-note-actions button {
          padding: 8px 16px;
          border-radius: 6px;
          font-size: 13px;
          cursor: pointer;
          font-family: inherit;
          transition: all 0.15s;
        }

        .cv-delete-note-cancel {
          background: rgba(255, 255, 255, 0.06);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #a1a1aa;
        }

        .cv-delete-note-cancel:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #f4f4f5;
        }

        .cv-delete-note-confirm {
          background: rgba(239, 68, 68, 0.2);
          border: 1px solid rgba(239, 68, 68, 0.3);
          color: #ef4444;
        }

        .cv-delete-note-confirm:hover {
          background: rgba(239, 68, 68, 0.3);
        }

        .cv-delete-note-confirm:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .cv-move-note-modal {
          background: #18181b;
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 8px;
          padding: 24px;
          max-width: 420px;
          width: 90%;
        }

        .cv-move-note-modal h4 {
          margin: 0 0 16px 0;
          font-size: 16px;
          color: #f4f4f5;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .cv-move-note-field {
          margin-bottom: 16px;
        }

        .cv-move-note-label {
          display: block;
          font-size: 12px;
          color: #71717a;
          margin-bottom: 6px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .cv-move-note-select {
          width: 100%;
          padding: 10px 12px;
          border-radius: 6px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #f4f4f5;
          font-size: 14px;
          font-family: inherit;
          cursor: pointer;
        }

        .cv-move-note-select:focus {
          outline: none;
          border-color: rgba(99, 102, 241, 0.5);
        }

        .cv-move-note-actions {
          display: flex;
          gap: 12px;
          justify-content: flex-end;
          margin-top: 20px;
        }

        .cv-move-note-btn {
          padding: 8px 16px;
          border-radius: 6px;
          font-size: 13px;
          cursor: pointer;
          font-family: inherit;
          transition: all 0.15s;
        }

        .cv-move-note-cancel {
          background: rgba(255, 255, 255, 0.06);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #a1a1aa;
        }

        .cv-move-note-cancel:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #f4f4f5;
        }

        .cv-move-note-confirm {
          background: rgba(99, 102, 241, 0.2);
          border: 1px solid rgba(99, 102, 241, 0.3);
          color: #818cf8;
        }

        .cv-move-note-confirm:hover {
          background: rgba(99, 102, 241, 0.3);
        }

        .cv-move-note-confirm:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        .cv-note-move-btn {
          opacity: 0;
          background: none;
          border: none;
          color: #71717a;
          cursor: pointer;
          padding: 4px;
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.15s;
        }

        .cv-note-card:hover .cv-note-move-btn {
          opacity: 1;
        }

        .cv-note-move-btn:hover {
          background: rgba(99, 102, 241, 0.15);
          color: #818cf8;
        }

        .cv-thread-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
        }
        
        .cv-thread-modal {
          background: #18181b;
          border: 1px solid rgba(255, 255, 255, 0.15);
          border-radius: 2px;
          width: 600px;
          max-width: 90vw;
          max-height: 80vh;
          display: flex;
          flex-direction: column;
          overflow: hidden;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .cv-thread-header {
          padding: 16px 20px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          display: flex;
          align-items: center;
          justify-content: space-between;
          flex-shrink: 0;
          background: rgba(255, 255, 255, 0.02);
        }

        .cv-thread-title {
          font-size: 14px;
          font-weight: 600;
          color: #e4e4e7;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .cv-thread-close {
          width: 28px;
          height: 28px;
          border-radius: 2px;
          background: transparent;
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #71717a;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.1s ease;
        }

        .cv-thread-close:hover {
          background: rgba(255, 255, 255, 0.08);
          border-color: rgba(255, 255, 255, 0.2);
          color: #fff;
        }
        
        .cv-thread-content {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
        }

        .cv-thread-original {
          padding-bottom: 16px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.08);
          margin-bottom: 16px;
        }

        .cv-thread-original .cv-note-content {
          font-size: 14px;
          color: #e4e4e7;
          line-height: 1.5;
        }

        .cv-thread-replies {
          display: flex;
          flex-direction: column;
          gap: 14px;
        }

        .cv-reply {
          display: flex;
          gap: 10px;
          padding: 10px;
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.04);
          border-radius: 2px;
        }

        .cv-reply-content {
          flex: 1;
        }

        .cv-reply-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 4px;
        }

        .cv-reply-author {
          font-size: 12px;
          font-weight: 600;
          color: #e4e4e7;
        }

        .cv-reply-time {
          font-size: 10px;
          color: #52525b;
        }

        .cv-reply-text {
          font-size: 13px;
          color: #a1a1aa;
          line-height: 1.5;
        }
        
        .cv-thread-input {
          padding: 16px 20px;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
          display: flex;
          gap: 10px;
          flex-shrink: 0;
          background: rgba(255, 255, 255, 0.02);
        }

        .cv-thread-input input {
          flex: 1;
          padding: 10px 14px;
          border-radius: 2px;
          background: rgba(0, 0, 0, 0.4);
          border: 1px solid rgba(255, 255, 255, 0.12);
          color: #fff;
          font-size: 13px;
          outline: none;
          transition: border-color 0.1s ease;
        }

        .cv-thread-input input:focus {
          border-color: rgba(99, 102, 241, 0.6);
        }

        .cv-thread-input button {
          padding: 10px 18px;
          border-radius: 2px;
          background: #6366f1;
          border: none;
          color: #fff;
          font-size: 13px;
          font-weight: 500;
          cursor: pointer;
          transition: background 0.1s ease;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .cv-thread-input button:hover {
          background: #5558e3;
        }
        
        .cv-tasks-list {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .cv-task {
          display: flex;
          align-items: center;
          gap: 10px;
          background: transparent;
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 2px;
          padding: 10px 12px;
          transition: all 0.1s;
        }

        .cv-task:hover {
          background: rgba(255, 255, 255, 0.03);
          border-color: rgba(255, 255, 255, 0.15);
        }

        .cv-task.completed {
          opacity: 0.5;
        }

        .cv-task-check {
          width: 16px;
          height: 16px;
          border-radius: 2px;
          border: 1px solid;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
          cursor: pointer;
          transition: all 0.1s;
        }

        .cv-task-check:hover {
          transform: scale(1.1);
        }

        .cv-task-check.checked {
          background: currentColor;
        }

        .cv-task-info {
          flex: 1;
          min-width: 0;
        }

        .cv-task-title {
          font-size: 13px;
          font-weight: 500;
          color: #e4e4e7;
          margin-bottom: 2px;
        }

        .cv-task.completed .cv-task-title {
          text-decoration: line-through;
        }

        .cv-task-meta {
          font-size: 10px;
          color: #52525b;
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .cv-task-badge {
          padding: 2px 6px;
          border-radius: 2px;
          font-size: 9px;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .cv-task-status-badge {
          padding: 3px 8px;
          border-radius: 2px;
          font-size: 10px;
          font-weight: 500;
          flex-shrink: 0;
          margin-left: auto;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }
        
        .cv-lists-section {
          margin-top: 24px;
        }
        
        .cv-lists-list {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }
        
        .cv-list-card {
          display: flex;
          align-items: center;
          gap: 12px;
          background: rgba(139, 92, 246, 0.04);
          border: 1px solid rgba(139, 92, 246, 0.2);
          border-radius: 2px;
          padding: 12px 14px;
          transition: all 0.1s;
          cursor: pointer;
        }

        .cv-list-card:hover {
          background: rgba(139, 92, 246, 0.08);
          border-color: rgba(139, 92, 246, 0.35);
        }

        .cv-list-icon {
          font-size: 16px;
          flex-shrink: 0;
        }

        .cv-list-info {
          flex: 1;
          min-width: 0;
        }

        .cv-list-title {
          font-size: 13px;
          font-weight: 500;
          color: #e4e4e7;
          margin-bottom: 4px;
        }

        .cv-list-meta {
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 10px;
          color: #71717a;
        }

        .cv-list-project-badge {
          padding: 2px 6px;
          border-radius: 2px;
          font-size: 9px;
          color: #fff;
          text-transform: uppercase;
          letter-spacing: 0.3px;
          font-weight: 500;
        }
        
        .cv-list-progress-wrapper {
          display: flex;
          align-items: center;
          gap: 10px;
          flex-shrink: 0;
        }

        .cv-list-progress-bar {
          width: 80px;
          height: 4px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 1px;
          overflow: hidden;
        }

        .cv-list-progress-fill {
          height: 100%;
          background: #8b5cf6;
          border-radius: 1px;
          transition: width 0.2s ease;
        }

        .cv-list-progress-fill.complete {
          background: #22c55e;
        }

        .cv-list-count {
          font-size: 11px;
          color: #a1a1aa;
          font-weight: 500;
          min-width: 32px;
          text-align: right;
        }
        
        .cv-events-list {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        .cv-event {
          display: flex;
          align-items: center;
          gap: 12px;
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.08);
          border-radius: 2px;
          padding: 10px 12px;
          transition: all 0.1s;
        }

        .cv-event:hover {
          background: rgba(255, 255, 255, 0.05);
          border-color: rgba(255, 255, 255, 0.15);
        }

        .cv-event.completed {
          opacity: 0.5;
        }

        .cv-event-color {
          width: 3px;
          height: 28px;
          border-radius: 1px;
          flex-shrink: 0;
        }

        .cv-event-info {
          flex: 1;
          min-width: 0;
        }

        .cv-event-title {
          font-size: 13px;
          font-weight: 500;
          color: #e4e4e7;
          margin-bottom: 2px;
        }

        .cv-event-meta {
          font-size: 10px;
          color: #52525b;
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .cv-event-project {
          padding: 2px 6px;
          border-radius: 2px;
          font-size: 9px;
          color: #fff;
          text-transform: uppercase;
          letter-spacing: 0.3px;
        }

        .cv-event-check {
          width: 24px;
          height: 24px;
          border-radius: 2px;
          border: 1px solid rgba(255, 255, 255, 0.15);
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.1s;
          flex-shrink: 0;
        }

        .cv-event-check:hover {
          border-color: rgba(99, 102, 241, 0.5);
          background: rgba(99, 102, 241, 0.1);
        }

        .cv-event-check.checked {
          background: #10b981;
          border-color: #10b981;
        }
        
        .cv-empty {
          text-align: center;
          padding: 40px;
          color: #52525b;
          font-size: 14px;
        }
        
        .cv-collapsible-section {
          margin-top: 24px;
        }
        
        .cv-collapsible-header {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 12px 16px;
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.06);
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.15s;
          font-size: 13px;
          color: #71717a;
          font-weight: 500;
        }
        
        .cv-collapsible-header:hover {
          background: rgba(255, 255, 255, 0.04);
          border-color: rgba(255, 255, 255, 0.1);
          color: #a1a1aa;
        }
        
        .cv-collapsible-toggle {
          display: flex;
          align-items: center;
          justify-content: center;
          color: #52525b;
        }
        
        .cv-collapsible-count {
          margin-left: auto;
          background: rgba(255, 255, 255, 0.06);
          padding: 2px 8px;
          border-radius: 10px;
          font-size: 11px;
        }
        
        .cv-add-task-form, .cv-add-note-form {
          background: rgba(255, 255, 255, 0.03);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 16px;
        }
        
        .cv-inline-form {
          display: flex;
          gap: 8px;
          align-items: center;
        }
        
        .cv-inline-form-stacked {
          flex-direction: column;
          align-items: stretch;
        }
        
        .cv-form-row {
          display: flex;
          gap: 12px;
          margin-bottom: 12px;
        }
        
        .cv-form-row:last-child {
          margin-bottom: 0;
        }
        
        .cv-input {
          flex: 1;
          padding: 10px 14px;
          border-radius: 8px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #fff;
          font-size: 14px;
          outline: none;
          transition: all 0.15s;
        }
        
        .cv-input:focus {
          border-color: rgba(99, 102, 241, 0.5);
        }
        
        .cv-input::placeholder {
          color: #52525b;
        }
        
        /* Date and time picker icon styling */
        .cv-input[type="date"],
        .cv-input[type="time"] {
          position: relative;
        }
        
        .cv-input[type="date"]::-webkit-calendar-picker-indicator,
        .cv-input[type="time"]::-webkit-calendar-picker-indicator {
          filter: invert(1);
          opacity: 0.6;
          cursor: pointer;
          padding: 4px;
          margin-right: -4px;
          border-radius: 4px;
          transition: all 0.15s;
        }
        
        .cv-input[type="date"]::-webkit-calendar-picker-indicator:hover,
        .cv-input[type="time"]::-webkit-calendar-picker-indicator:hover {
          opacity: 1;
          filter: invert(1) brightness(1.5);
          background: rgba(99, 102, 241, 0.5);
          box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        }
        
        .cv-input[type="date"]::-webkit-datetime-edit,
        .cv-input[type="time"]::-webkit-datetime-edit {
          color: #a1a1aa;
        }
        
        .cv-input[type="date"]:focus::-webkit-datetime-edit,
        .cv-input[type="time"]:focus::-webkit-datetime-edit {
          color: #fff;
        }
        
        .cv-textarea {
          width: 100%;
          min-height: 100px;
          padding: 12px 14px;
          border-radius: 8px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #fff;
          font-size: 14px;
          font-family: inherit;
          outline: none;
          resize: vertical;
          transition: all 0.15s;
        }
        
        .cv-textarea:focus {
          border-color: rgba(99, 102, 241, 0.5);
        }
        
        .cv-textarea::placeholder {
          color: #52525b;
        }
        
        .cv-select {
          padding: 10px 14px;
          border-radius: 8px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(255, 255, 255, 0.1);
          color: #fff;
          font-size: 14px;
          outline: none;
          cursor: pointer;
          min-width: 150px;
        }
        
        .cv-form-actions {
          display: flex;
          gap: 8px;
          justify-content: flex-end;
        }
        
        .cv-btn {
          padding: 10px 20px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.15s;
          border: none;
        }
        
        .cv-btn-primary {
          background: #6366f1;
          color: #fff;
        }
        
        .cv-btn-primary:hover {
          background: #5558e3;
        }
        
        .cv-btn-secondary {
          background: rgba(255, 255, 255, 0.06);
          color: #a1a1aa;
          border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .cv-btn-secondary:hover {
          background: rgba(255, 255, 255, 0.1);
          color: #fff;
        }
      `}</style>
      
      {/* Header */}
      <div className="cv-header">
        <div className="cv-color-bar" style={{ background: client.color }} />
        <div className="cv-header-info">
          <h2 style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
            {client.isPersonal && <User size={24} style={{ color: client.color }} />}
            {client.isTeam && <Users size={24} style={{ color: client.color }} />}
            {client.name}
          </h2>
          <div className="cv-header-meta">
            {client.isPersonal && 'Private workspace • '}
            {client.isTeam && 'Shared team space • '}
            {client.projects.length} {client.isInternal ? 'categories' : 'projects'} • {totalEvents} events • {tasks.length} tasks
          </div>
        </div>
        {!client.isInternal && deleteClient && (
          <button
            className="cv-delete-client-btn"
            onClick={() => setShowDeleteClientModal(true)}
            title="Delete client"
          >
            <Trash2 size={18} />
          </button>
        )}
      </div>
      
      {/* Client Details Section */}
      <div className="cv-details-section">
        {isEditingDetails ? (
          <div className="cv-details-edit">
            <textarea
              className="cv-details-textarea"
              value={editedDetails}
              onChange={(e) => setEditedDetails(e.target.value)}
              placeholder={client.isInternal 
                ? "Add notes, reminders, or other details..." 
                : "Add client details like contact info, billing preferences, notes..."
              }
              autoFocus
            />
            <div className="cv-details-actions">
              <button 
                className="cv-btn cv-btn-secondary" 
                onClick={() => {
                  setIsEditingDetails(false);
                  setEditedDetails(client.details || '');
                }}
              >
                Cancel
              </button>
              <button 
                className="cv-btn cv-btn-primary"
                onClick={() => {
                  updateClient(client.id, { details: editedDetails });
                  setIsEditingDetails(false);
                }}
              >
                Save
              </button>
            </div>
          </div>
        ) : (
          <div 
            className="cv-details-display"
            onClick={() => {
              setEditedDetails(client.details || '');
              setIsEditingDetails(true);
            }}
          >
            {client.details ? (
              <div className="cv-details-text">{client.details}</div>
            ) : (
              <div className="cv-details-placeholder">
                {client.isInternal 
                  ? 'Click to add notes or details...'
                  : 'Click to add client details...'
                }
              </div>
            )}
            <div className="cv-details-edit-hint">
              <Edit2 size={12} />
            </div>
          </div>
        )}
      </div>
      
      {/* Tabs */}
      <div className="cv-tabs">
        <button
          className={`cv-tab ${activeTab === 'overview' ? 'active' : ''}`}
          onClick={() => setActiveTab('overview')}
        >
          Overview
        </button>
        <button
          className={`cv-tab ${activeTab === 'projects' ? 'active' : ''}`}
          onClick={() => setActiveTab('projects')}
        >
          {client.isInternal ? 'Categories' : 'Projects'}
        </button>
      </div>
      
      {/* Content */}
      <div className="cv-content">
        {activeTab === 'overview' && (
          <div className="cv-project-detail-split">
            {/* Left side - Notes (60%) */}
            <div className="cv-project-notes-section">
              <div className="cv-section-header">
                <div className="cv-section-title">
                  <MessageSquare size={14} />
                  Notes
                </div>
                <button className="cv-add-btn" onClick={() => setShowAddNote(!showAddNote)}>
                  <Plus size={12} /> Add Note
                </button>
              </div>

              {showAddNote && (
                <div className="cv-add-note-form" style={{ marginBottom: 12 }}>
                  <div className="cv-form-row">
                    <MentionTextarea
                      className="cv-textarea"
                      placeholder={client.isInternal ? "Write a note... Type @ to mention someone" : "Write a note about this client... Type @ to mention someone"}
                      value={newNoteContent}
                      onChange={setNewNoteContent}
                      teamMembers={teamMembers}
                      onSubmit={handleAddNote}
                    />
                  </div>
                  <div className="cv-form-actions">
                    <button className="cv-btn cv-btn-secondary" onClick={() => { setShowAddNote(false); setNewNoteContent(''); }}>Cancel</button>
                    <button className="cv-btn cv-btn-primary" onClick={handleAddNote}>Post Note</button>
                  </div>
                </div>
              )}

              <div className="cv-notes-list">
                {allSortedNotes.map(note => {
                  const author = getMember(note.authorId);
                  const project = note.projectId ? client.projects.find(p => p.id === note.projectId) : null;
                  return (
                    <div
                      key={note.id}
                      className="cv-note-card"
                      onClick={() => setSelectedNoteId(note.id)}
                    >
                      <div className="cv-note-header">
                        <div className="cv-note-avatar" style={{ background: author?.color || '#6366f1' }}>
                          {author?.name?.split(' ').map(n => n[0]).join('') || '?'}
                        </div>
                        <span className="cv-note-author">{author?.name || 'Unknown'}</span>
                        <span className="cv-note-time">{formatRelativeTime(note.createdAt)}</span>
                        {project && (
                          <span className="cv-task-badge" style={{ background: project.color, color: '#fff', marginLeft: project ? 'auto' : '0' }}>
                            {project.name}
                          </span>
                        )}
                        {note.authorId === currentUser?.id && (
                          <>
                            <button
                              className="cv-note-move-btn"
                              style={{ marginLeft: project ? '8px' : 'auto' }}
                              onClick={(e) => {
                                e.stopPropagation();
                                openMoveNoteModal(note);
                              }}
                              title="Move note"
                            >
                              <FolderInput size={14} />
                            </button>
                            <button
                              className="cv-note-delete-btn"
                              style={{ marginLeft: '4px' }}
                              onClick={(e) => {
                                e.stopPropagation();
                                setNoteToDelete({ noteId: note.id });
                              }}
                              title="Delete note"
                            >
                              <Trash2 size={14} />
                            </button>
                          </>
                        )}
                      </div>
                      <div className="cv-note-content">{renderMentionText(note.content)}</div>
                      {note.replies?.length > 0 && (
                        <div className="cv-note-footer">
                          <span className="cv-note-replies">
                            <MessageSquare size={12} /> {note.replies.length} {note.replies.length === 1 ? 'reply' : 'replies'}
                          </span>
                        </div>
                      )}
                    </div>
                  );
                })}
                {allSortedNotes.length === 0 && !showAddNote && (
                  <div className="cv-empty">
                    {client.isPersonal
                      ? 'No personal notes yet. Add thoughts, reminders, or ideas!'
                      : client.isTeam
                        ? 'No team notes yet. Start a conversation!'
                        : 'No notes yet. Start a conversation about this client!'
                    }
                  </div>
                )}
              </div>
            </div>

            {/* Right side - Tasks (40%) */}
            <div className="cv-project-tasks-section">
              <div className="cv-section" style={{ marginBottom: 16 }}>
                <div className="cv-section-header" style={{ marginBottom: 8 }}>
                  <div className="cv-section-title">
                    Pending Tasks ({pendingTasks.length})
                  </div>
                  <button className="cv-add-btn" onClick={() => openAddTaskModal()}>
                    <Plus size={12} /> Add
                  </button>
                </div>

                <div className="cv-tasks-list">
                  {pendingTasks.filter(t => t.dueDate).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate)).concat(
                    pendingTasks.filter(t => !t.dueDate)
                  ).map(task => {
                    const project = client.projects.find(p => p.id === task.projectId);
                    const color = project?.color || client.color;
                    const assignee = teamMembers.find(m => m.id === task.assignedTo);
                    const isOverdue = task.dueDate && new Date(task.dueDate) < new Date();
                    const statusBadge = getTaskStatusBadge(task);
                    return (
                      <div
                        key={task.id}
                        className="cv-task"
                        style={{ borderColor: color, cursor: 'pointer' }}
                        onClick={() => onTaskClick && onTaskClick(task)}
                      >
                        <div
                          className="cv-task-check"
                          style={{ borderColor: color, color: color }}
                          onClick={(e) => { e.stopPropagation(); toggleTaskComplete(task.id); }}
                        />
                        <div className="cv-task-info">
                          <div className="cv-task-title">{task.title}</div>
                          <div className="cv-task-meta">
                            <span style={{ color: isOverdue ? '#ef4444' : undefined }}>
                              {!task.dueDate ? 'No due date' : isOverdue ? 'Overdue' : new Date(task.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                            </span>
                            {project && (
                              <span className="cv-task-badge" style={{ background: project.color, color: '#fff' }}>
                                {project.name}
                              </span>
                            )}
                            {!project && (
                              <span className="cv-task-badge" style={{ background: 'rgba(255,255,255,0.1)', color: '#a1a1aa' }}>
                                {client.isInternal ? 'General' : 'Client-level'}
                              </span>
                            )}
                            {assignee && <span>→ {assignee.name}</span>}
                          </div>
                        </div>
                        {statusBadge && (
                          <div
                            className="cv-task-status-badge"
                            style={{ background: statusBadge.bgColor, color: statusBadge.color }}
                          >
                            {statusBadge.label}
                          </div>
                        )}
                      </div>
                    );
                  })}
                  {pendingTasks.length === 0 && (
                    <div className="cv-empty">No pending tasks</div>
                  )}
                </div>
              </div>

              {/* Upcoming Events Section */}
              <div className="cv-section" style={{ marginBottom: 16 }}>
                <div className="cv-section-header" style={{ marginBottom: 8 }}>
                  <div className="cv-section-title">
                    Upcoming Events ({upcomingEvents.length})
                  </div>
                  <button className="cv-add-btn" onClick={() => openAddEventModal()}>
                    <Plus size={12} /> Add
                  </button>
                </div>

                <div className="cv-events-list">
                  {upcomingEvents.slice(0, 5).map(event => {
                    const project = client.projects.find(p => p.id === event.projectId);
                    const color = project?.color || client.color;
                    return (
                      <div
                        key={event.id}
                        className="cv-event"
                        style={{ cursor: 'pointer' }}
                        onClick={() => onEventClick && onEventClick(event)}
                      >
                        <div className="cv-event-color" style={{ background: color }} />
                        <div className="cv-event-info">
                          <div className="cv-event-title">{event.title}</div>
                          <div className="cv-event-meta">
                            <span>{event.startTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                            <span>{formatTime(event.startTime)}</span>
                            {project && (
                              <span className="cv-task-badge" style={{ background: project.color, color: '#fff' }}>
                                {project.name}
                              </span>
                            )}
                            {!project && (
                              <span className="cv-task-badge" style={{ background: 'rgba(255,255,255,0.1)', color: '#a1a1aa' }}>
                                {client.isInternal ? 'General' : 'Client-level'}
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                  {upcomingEvents.length === 0 && (
                    <div className="cv-empty">No upcoming events</div>
                  )}
                  {upcomingEvents.length > 5 && (
                    <div className="cv-show-more">+{upcomingEvents.length - 5} more events</div>
                  )}
                </div>
              </div>

              {/* Lists Section */}
              <div className="cv-section">
                <div className="cv-section-header" style={{ marginBottom: 8 }}>
                  <div className="cv-section-title">
                    Lists ({allClientLists.length})
                  </div>
                  <button className="cv-add-btn" onClick={() => {
                    setAddListDefaults({ clientId: client.id, projectId: '' });
                    setShowAddListModal(true);
                  }}>
                    <Plus size={12} /> Add
                  </button>
                </div>

                <div className="cv-lists-list">
                  {allClientLists.slice(0, 5).map(list => {
                    const project = client.projects.find(p => p.id === list.projectId);
                    const progress = getListProgress ? getListProgress(list.id) : { completed: 0, total: 0 };
                    const percent = progress.total > 0 ? (progress.completed / progress.total) * 100 : 0;
                    const isComplete = progress.total > 0 && progress.completed === progress.total;
                    return (
                      <div
                        key={list.id}
                        className="cv-list-card"
                        onClick={() => onListClick && onListClick(list)}
                      >
                        <span className="cv-list-icon">📋</span>
                        <div className="cv-list-info">
                          <div className="cv-list-title">{list.title}</div>
                          <div className="cv-list-meta">
                            {list.dueDate && (
                              <span>Due {new Date(list.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                            )}
                            {project && (
                              <span className="cv-task-badge" style={{ background: project.color, color: '#fff' }}>
                                {project.name}
                              </span>
                            )}
                            {!project && (
                              <span className="cv-task-badge" style={{ background: 'rgba(255,255,255,0.1)', color: '#a1a1aa' }}>
                                {client.isInternal ? 'General' : 'Client-level'}
                              </span>
                            )}
                          </div>
                        </div>
                        <div className="cv-list-progress-wrapper">
                          <div className="cv-list-progress-bar">
                            <div
                              className={`cv-list-progress-fill ${isComplete ? 'complete' : ''}`}
                              style={{ width: `${percent}%` }}
                            />
                          </div>
                          <span className="cv-list-count">{progress.completed}/{progress.total}</span>
                        </div>
                      </div>
                    );
                  })}
                  {allClientLists.length === 0 && (
                    <div className="cv-empty">No lists</div>
                  )}
                  {allClientLists.length > 5 && (
                    <div className="cv-show-more">+{allClientLists.length - 5} more lists</div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'projects' && (
          <>
            <div className="cv-section-header" style={{ marginBottom: 16 }}>
              <div className="cv-section-title">All {client.isInternal ? 'Categories' : 'Projects'}</div>
              <button className="cv-add-btn" onClick={() => setShowAddProject(true)}>
                <Plus size={14} /> Add {client.isInternal ? 'Category' : 'Project'}
              </button>
            </div>
            <div className="cv-projects" style={{ marginBottom: 24 }}>
              {client.projects.map(project => {
                const projectEvents = getProjectEvents(project.id);
                const projectTasks = getProjectTasks(project.id);
                const projectLists = getProjectLists(project.id);
                const projectNotes = notes.filter(n => n.projectId === project.id);
                const upcomingProjectEvents = projectEvents.filter(e => e.endTime >= new Date());
                const pendingProjectTasks = projectTasks.filter(t => !t.isCompleted);
                const isSelected = selectedProject?.id === project.id;
                return (
                  <div
                    key={project.id}
                    className={`cv-project ${isSelected ? 'selected' : ''}`}
                    style={{ borderLeftColor: project.color }}
                    onClick={() => setSelectedProject(isSelected ? null : project)}
                  >
                    <div className="cv-project-header">
                      <div className="cv-project-name">{project.name}</div>
                      {deleteProject && (
                        <button
                          className="cv-project-delete-btn"
                          onClick={(e) => {
                            e.stopPropagation();
                            setProjectToDelete({
                              ...project,
                              taskCount: projectTasks.length,
                              eventCount: projectEvents.length,
                              listCount: projectLists.length,
                              noteCount: projectNotes.length
                            });
                          }}
                          title="Delete project"
                        >
                          <Trash2 size={14} />
                        </button>
                      )}
                    </div>
                    <div className="cv-project-stats">
                      <span>{upcomingProjectEvents.length} upcoming events</span>
                      <span>{pendingProjectTasks.length} pending tasks</span>
                      {projectLists.length > 0 && <span>{projectLists.length} lists</span>}
                    </div>
                  </div>
                );
              })}
              {client.projects.length === 0 && (
                <div className="cv-empty" style={{ padding: 20, gridColumn: '1 / -1' }}>
                  No {client.isInternal ? 'categories' : 'projects'} yet. Add one to get started!
                </div>
              )}
            </div>
            
            {selectedProject && (
              <>
                {(() => {
                  const projectTasks = getProjectTasks(selectedProject.id).filter(t => !t.isCompleted);
                  const projectEvents = getProjectEvents(selectedProject.id).filter(e => e.endTime >= new Date());
                  const projectNotes = getProjectNotes(selectedProject.id);
                  const sortedProjectNotes = sortByActivity(projectNotes);
                  
                  return (
                    <div className="cv-project-detail-split">
                      {/* Left side - Notes (60%) */}
                      <div className="cv-project-notes-section">
                        <div className="cv-section-header">
                          <div className="cv-section-title" style={{ color: selectedProject.color }}>
                            <MessageSquare size={14} />
                            {selectedProject.name} Notes
                          </div>
                          <button className="cv-add-btn" onClick={() => setShowAddProjectNote(!showAddProjectNote)}>
                            <Plus size={12} /> Add Note
                          </button>
                        </div>
                        
                        {showAddProjectNote && (
                          <div className="cv-add-note-form" style={{ marginBottom: 12 }}>
                            <div className="cv-form-row">
                              <MentionTextarea
                                className="cv-textarea"
                                placeholder="Add a note about this project... Type @ to mention someone"
                                value={newProjectNoteContent}
                                onChange={setNewProjectNoteContent}
                                teamMembers={teamMembers}
                                onSubmit={handleAddProjectNote}
                              />
                            </div>
                            <div className="cv-form-actions">
                              <button 
                                className="cv-btn cv-btn-secondary"
                                onClick={() => { setShowAddProjectNote(false); setNewProjectNoteContent(''); }}
                              >
                                Cancel
                              </button>
                              <button 
                                className="cv-btn cv-btn-primary"
                                onClick={handleAddProjectNote}
                              >
                                Post Note
                              </button>
                            </div>
                          </div>
                        )}
                        
                        <div className="cv-notes-list">
                          {sortedProjectNotes.map(note => {
                            const author = teamMembers.find(m => m.id === note.authorId);
                            return (
                              <div 
                                key={note.id} 
                                className="cv-note-card"
                                onClick={() => setSelectedProjectNoteId(note.id)}
                              >
                                <div className="cv-note-header">
                                  <div className="cv-note-avatar" style={{ background: author?.color || '#6366f1' }}>
                                    {author?.name?.split(' ').map(n => n[0]).join('') || '?'}
                                  </div>
                                  <span className="cv-note-author">{author?.name || 'Unknown'}</span>
                                  <span className="cv-note-time">{formatRelativeTime(note.createdAt)}</span>
                                  {note.authorId === currentUser?.id && (
                                    <>
                                      <button
                                        className="cv-note-move-btn"
                                        style={{ marginLeft: 'auto' }}
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          openMoveNoteModal(note);
                                        }}
                                        title="Move note"
                                      >
                                        <FolderInput size={14} />
                                      </button>
                                      <button
                                        className="cv-note-delete-btn"
                                        style={{ marginLeft: '4px' }}
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          setNoteToDelete({ noteId: note.id });
                                        }}
                                        title="Delete note"
                                      >
                                        <Trash2 size={14} />
                                      </button>
                                    </>
                                  )}
                                </div>
                                <div className="cv-note-content">{renderMentionText(note.content)}</div>
                                {note.replies?.length > 0 && (
                                  <div className="cv-note-footer">
                                    <span className="cv-note-replies">
                                      <MessageSquare size={12} /> {note.replies.length} {note.replies.length === 1 ? 'reply' : 'replies'}
                                    </span>
                                  </div>
                                )}
                              </div>
                            );
                          })}
                          {sortedProjectNotes.length === 0 && !showAddProjectNote && (
                            <div className="cv-empty">No notes yet for this project</div>
                          )}
                        </div>
                      </div>
                      
                      {/* Right side - Tasks & Events (40%) */}
                      <div className="cv-project-tasks-section">
                        <div className="cv-section" style={{ marginBottom: 16 }}>
                          <div className="cv-section-header" style={{ marginBottom: 8 }}>
                            <div className="cv-section-title" style={{ color: selectedProject.color }}>
                              Pending Tasks ({projectTasks.length})
                            </div>
                            <button className="cv-add-btn" onClick={() => openAddTaskModal(selectedProject.id)}>
                              <Plus size={12} /> Add
                            </button>
                          </div>
                          
                          <div className="cv-tasks-list">
                            {projectTasks.slice(0, 5).map(task => {
                              const assignee = teamMembers.find(m => m.id === task.assignedTo);
                              const isOverdue = task.dueDate && task.dueDate < new Date();
                              const statusBadge = getTaskStatusBadge(task);
                              return (
                                <div 
                                  key={task.id} 
                                  className="cv-task"
                                  style={{ borderColor: selectedProject.color, cursor: 'pointer' }}
                                  onClick={() => onTaskClick && onTaskClick(task)}
                                >
                                  <div 
                                    className="cv-task-check"
                                    style={{ borderColor: selectedProject.color, color: selectedProject.color }}
                                    onClick={(e) => { e.stopPropagation(); toggleTaskComplete(task.id); }}
                                  />
                                  <div className="cv-task-info">
                                    <div className="cv-task-title">{task.title}</div>
                                    <div className="cv-task-meta">
                                      <span style={{ color: isOverdue ? '#ef4444' : undefined }}>
                                        {!task.dueDate ? 'No due date' : isOverdue ? 'Overdue' : task.dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                      </span>
                                    </div>
                                  </div>
                                  {statusBadge && (
                                    <div 
                                      className="cv-task-status-badge"
                                      style={{ background: statusBadge.bgColor, color: statusBadge.color }}
                                    >
                                      {statusBadge.label}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                            {projectTasks.length === 0 && (
                              <div className="cv-empty">No pending tasks</div>
                            )}
                            {projectTasks.length > 5 && (
                              <div className="cv-show-more">+{projectTasks.length - 5} more tasks</div>
                            )}
                          </div>
                        </div>
                        
                        <div className="cv-section">
                          <div className="cv-section-header" style={{ marginBottom: 8 }}>
                            <div className="cv-section-title" style={{ color: selectedProject.color }}>
                              Upcoming Events ({projectEvents.length})
                            </div>
                            <button className="cv-add-btn" onClick={() => openAddEventModal(selectedProject.id)}>
                              <Plus size={12} /> Add
                            </button>
                          </div>
                          
                          <div className="cv-events-list">
                            {projectEvents.slice(0, 5).map(event => (
                              <div 
                                key={event.id} 
                                className="cv-event"
                                style={{ cursor: 'pointer' }}
                                onClick={() => onEventClick && onEventClick(event)}
                              >
                                <div className="cv-event-color" style={{ background: selectedProject.color }} />
                                <div className="cv-event-info">
                                  <div className="cv-event-title">{event.title}</div>
                                  <div className="cv-event-meta">
                                    <span>{event.startTime.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                                    <span>{formatTime(event.startTime)}</span>
                                  </div>
                                </div>
                              </div>
                            ))}
                            {projectEvents.length === 0 && (
                              <div className="cv-empty">No upcoming events</div>
                            )}
                            {projectEvents.length > 5 && (
                              <div className="cv-show-more">+{projectEvents.length - 5} more events</div>
                            )}
                          </div>
                        </div>
                        
                        {/* Lists Section */}
                        {(() => {
                          const projectLists = getProjectLists(selectedProject.id);
                          return (
                            <div className="cv-section">
                              <div className="cv-section-header" style={{ marginBottom: 8 }}>
                                <div className="cv-section-title" style={{ color: selectedProject.color }}>
                                  Lists ({projectLists.length})
                                </div>
                                <button className="cv-add-btn" onClick={() => {/* TODO: Add list modal */}}>
                                  <Plus size={12} /> Add
                                </button>
                              </div>
                              
                              <div className="cv-lists-list">
                                {projectLists.map(list => {
                                  const progress = getListProgress ? getListProgress(list.id) : { completed: 0, total: 0 };
                                  const percent = progress.total > 0 ? (progress.completed / progress.total) * 100 : 0;
                                  const isComplete = progress.total > 0 && progress.completed === progress.total;
                                  return (
                                    <div 
                                      key={list.id}
                                      className="cv-list-card"
                                      onClick={() => onListClick && onListClick(list)}
                                    >
                                      <span className="cv-list-icon">📋</span>
                                      <div className="cv-list-info">
                                        <div className="cv-list-title">{list.title}</div>
                                        <div className="cv-list-meta">
                                          {list.dueDate && (
                                            <span>Due {new Date(list.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
                                          )}
                                        </div>
                                      </div>
                                      <div className="cv-list-progress-wrapper">
                                        <div className="cv-list-progress-bar">
                                          <div 
                                            className={`cv-list-progress-fill ${isComplete ? 'complete' : ''}`}
                                            style={{ width: `${percent}%` }}
                                          />
                                        </div>
                                        <span className="cv-list-count">{progress.completed}/{progress.total}</span>
                                      </div>
                                    </div>
                                  );
                                })}
                                {projectLists.length === 0 && (
                                  <div className="cv-empty">No lists</div>
                                )}
                              </div>
                            </div>
                          );
                        })()}
                      </div>
                    </div>
                  );
                })()}
              </>
            )}
            
            {/* Project Note Thread Modal */}
            {selectedProjectNote && (
              <div className="cv-thread-overlay" onClick={() => setSelectedProjectNoteId(null)}>
                <div className="cv-thread-modal" onClick={e => e.stopPropagation()}>
                  <div className="cv-thread-header">
                    <h3>Thread</h3>
                    <button className="cv-close-btn" onClick={() => setSelectedProjectNoteId(null)}>
                      <X size={20} />
                    </button>
                  </div>
                  <div className="cv-thread-content">
                    <div className="cv-thread-original">
                      <div className="cv-note-header">
                        <div className="cv-note-avatar" style={{ background: getMember(selectedProjectNote.authorId)?.color || '#6366f1' }}>
                          {getMember(selectedProjectNote.authorId)?.name?.split(' ').map(n => n[0]).join('') || '?'}
                        </div>
                        <span className="cv-note-author">{getMember(selectedProjectNote.authorId)?.name || 'Unknown'}</span>
                        <span className="cv-note-time">{formatRelativeTime(selectedProjectNote.createdAt)}</span>
                      </div>
                      <div className="cv-note-content">{renderMentionText(selectedProjectNote.content)}</div>
                    </div>
                    
                    {selectedProjectNote.replies?.length > 0 && (
                      <div className="cv-thread-replies">
                        {selectedProjectNote.replies.map(reply => (
                          <div key={reply.id} className="cv-thread-reply">
                            <div className="cv-note-header">
                              <div className="cv-note-avatar" style={{ background: getMember(reply.authorId)?.color || '#6366f1' }}>
                                {getMember(reply.authorId)?.name?.split(' ').map(n => n[0]).join('') || '?'}
                              </div>
                              <span className="cv-note-author">{getMember(reply.authorId)?.name || 'Unknown'}</span>
                              <span className="cv-note-time">{formatRelativeTime(reply.createdAt)}</span>
                              {reply.authorId === currentUser?.id && (
                                <button
                                  className="cv-note-delete-btn"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setNoteToDelete({ noteId: selectedProjectNote.id, replyId: reply.id });
                                  }}
                                  title="Delete reply"
                                >
                                  <Trash2 size={12} />
                                </button>
                              )}
                            </div>
                            <div className="cv-note-content">{renderMentionText(reply.content)}</div>
                          </div>
                        ))}
                      </div>
                    )}
                    
                    <div className="cv-thread-input">
                      <MentionInput
                        placeholder="Write a reply... @ to mention"
                        value={projectNoteReplyContent}
                        onChange={setProjectNoteReplyContent}
                        onSubmit={handleAddProjectNoteReply}
                        teamMembers={teamMembers}
                      />
                      <button onClick={handleAddProjectNoteReply}>Reply</button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </>
        )}
      </div>
      
      {/* Thread Modal */}
      {selectedNote && (
        <div className="cv-thread-overlay" onClick={() => setSelectedNoteId(null)}>
          <div className="cv-thread-modal" onClick={(e) => e.stopPropagation()}>
            <div className="cv-thread-header">
              <span className="cv-thread-title">Thread</span>
              <button className="cv-thread-close" onClick={() => setSelectedNoteId(null)}>
                <X size={18} />
              </button>
            </div>
            <div className="cv-thread-content">
              {/* Original note */}
              <div className="cv-thread-original">
                <div className="cv-note-header">
                  <div className="cv-note-avatar" style={{ background: getMember(selectedNote.authorId)?.color || '#6366f1' }}>
                    {getMember(selectedNote.authorId)?.name?.charAt(0) || '?'}
                  </div>
                  <span className="cv-note-author">{getMember(selectedNote.authorId)?.name || 'Unknown'}</span>
                  <span className="cv-note-time">{formatRelativeTime(selectedNote.createdAt)}</span>
                </div>
                <div className="cv-note-content">{renderMentionText(selectedNote.content)}</div>
              </div>
              
              {/* Replies */}
              <div className="cv-thread-replies">
                {selectedNote.replies.map(reply => {
                  const replyAuthor = getMember(reply.authorId);
                  return (
                    <div key={reply.id} className="cv-reply">
                      <div className="cv-note-avatar" style={{ background: replyAuthor?.color || '#6366f1', width: 28, height: 28, fontSize: 11 }}>
                        {replyAuthor?.name?.charAt(0) || '?'}
                      </div>
                      <div className="cv-reply-content">
                        <div className="cv-reply-header">
                          <span className="cv-reply-author">{replyAuthor?.name || 'Unknown'}</span>
                          <span className="cv-reply-time">{formatRelativeTime(reply.createdAt)}</span>
                          {reply.authorId === currentUser?.id && (
                            <button
                              className="cv-note-delete-btn"
                              onClick={(e) => {
                                e.stopPropagation();
                                setNoteToDelete({ noteId: selectedNote.id, replyId: reply.id });
                              }}
                              title="Delete reply"
                            >
                              <Trash2 size={12} />
                            </button>
                          )}
                        </div>
                        <div className="cv-reply-text">{renderMentionText(reply.content)}</div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
            
            {/* Reply input */}
            <div className="cv-thread-input">
              <MentionInput
                placeholder="Write a reply... @ to mention"
                value={replyContent}
                onChange={setReplyContent}
                onSubmit={handleAddReply}
                teamMembers={teamMembers}
              />
              <button onClick={handleAddReply}>Reply</button>
            </div>
          </div>
        </div>
      )}
      
      {/* Add Project Modal */}
      {showAddProject && (
        <AddProjectModal
          client={client}
          onClose={() => setShowAddProject(false)}
          onAdd={addProject}
        />
      )}

      {/* Delete Project Confirmation Modal */}
      {projectToDelete && (
        <ConfirmDeleteModal
          title="Delete Project"
          itemName={projectToDelete.name}
          itemType="Project"
          affectedItems={[
            { count: projectToDelete.taskCount, label: 'tasks' },
            { count: projectToDelete.eventCount, label: 'events' },
            { count: projectToDelete.listCount, label: 'lists' },
            { count: projectToDelete.noteCount, label: 'notes' }
          ].filter(item => item.count > 0)}
          onClose={() => setProjectToDelete(null)}
          onConfirm={() => deleteProject(projectToDelete.id)}
        />
      )}

      {/* Delete Client Confirmation Modal */}
      {showDeleteClientModal && (
        <ConfirmDeleteModal
          title="Delete Client"
          itemName={client.name}
          itemType="Client"
          affectedItems={[
            { count: client.projects?.length || 0, label: 'projects' },
            { count: tasks.length, label: 'tasks' },
            { count: events.length, label: 'events' },
            { count: lists.length, label: 'lists' },
            { count: notes.length, label: 'notes' }
          ].filter(item => item.count > 0)}
          onClose={() => setShowDeleteClientModal(false)}
          onConfirm={() => deleteClient(client.id)}
        />
      )}

      {/* Delete Note/Reply Confirmation Modal */}
      {noteToDelete && (
        <div className="cv-thread-overlay" onClick={() => setNoteToDelete(null)}>
          <div className="cv-delete-note-modal" onClick={e => e.stopPropagation()}>
            <h4>{noteToDelete.replyId ? 'Delete Reply?' : 'Delete Note?'}</h4>
            <p>
              {noteToDelete.replyId
                ? 'This reply will be permanently deleted.'
                : 'This note and all its replies will be permanently deleted.'}
            </p>
            <div className="cv-delete-note-actions">
              <button className="cv-delete-note-cancel" onClick={() => setNoteToDelete(null)}>
                Cancel
              </button>
              <button
                className="cv-delete-note-confirm"
                onClick={handleDeleteConfirm}
                disabled={isDeleting}
              >
                {isDeleting ? 'Deleting...' : 'Delete'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Move Note Modal */}
      {noteToMove && (
        <div className="cv-thread-overlay" onClick={() => setNoteToMove(null)}>
          <div className="cv-move-note-modal" onClick={e => e.stopPropagation()}>
            <h4><FolderInput size={18} /> Move Note</h4>

            <div className="cv-move-note-field">
              <label className="cv-move-note-label">Destination</label>
              <select
                className="cv-move-note-select"
                value={moveTargetClient}
                onChange={(e) => {
                  setMoveTargetClient(e.target.value);
                  setMoveTargetProject('');
                }}
              >
                <option value="">Select a client or space...</option>
                <optgroup label="Internal Spaces">
                  <option value={internal.personal?.id}>{internal.personal?.name}</option>
                  <option value={internal.team?.id}>{internal.team?.name}</option>
                </optgroup>
                <optgroup label="Clients">
                  {clients.map(c => (
                    <option key={c.id} value={c.id}>{c.name}</option>
                  ))}
                </optgroup>
              </select>
            </div>

            {moveTargetClient && getMoveTargetProjects().length > 0 && (
              <div className="cv-move-note-field">
                <label className="cv-move-note-label">Project (optional)</label>
                <select
                  className="cv-move-note-select"
                  value={moveTargetProject}
                  onChange={(e) => setMoveTargetProject(e.target.value)}
                >
                  <option value="">No project (client-level)</option>
                  {getMoveTargetProjects().map(p => (
                    <option key={p.id} value={p.id}>{p.name}</option>
                  ))}
                </select>
              </div>
            )}

            <div className="cv-move-note-actions">
              <button className="cv-move-note-btn cv-move-note-cancel" onClick={() => setNoteToMove(null)}>
                Cancel
              </button>
              <button
                className="cv-move-note-btn cv-move-note-confirm"
                onClick={handleMoveNote}
                disabled={isMoving || !moveTargetClient}
              >
                {isMoving ? 'Moving...' : 'Move Note'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Event Modal (Create) */}
      {showAddEventModal && (
        <EventModal 
          onClose={() => setShowAddEventModal(false)}
          onSave={addEvent}
          clients={clients}
          internal={internal}
          teamMembers={teamMembers}
          currentUserId={currentUser?.id}
          defaultClientId={addEventDefaults.clientId}
          defaultProjectId={addEventDefaults.projectId}
        />
      )}
      
      {/* Task Modal (Create) */}
      {showAddTaskModal && (
        <TaskModal
          onClose={() => setShowAddTaskModal(false)}
          onSave={addTask}
          clients={clients}
          internal={internal}
          teamMembers={teamMembers}
          defaultClientId={addTaskDefaults.clientId}
          defaultProjectId={addTaskDefaults.projectId}
        />
      )}

      {/* List Modal (Create) */}
      {showAddListModal && (
        <ListModal
          onClose={() => setShowAddListModal(false)}
          onSave={addList}
          clients={clients}
          internal={internal}
          teamMembers={teamMembers}
          tasks={tasks}
          defaultClientId={addListDefaults.clientId}
          defaultProjectId={addListDefaults.projectId}
        />
      )}

      {/* Connection Status Indicator */}
      <ConnectionIndicator />
    </div>
  );
}

// ==================== APP WITH AUTH WRAPPER ====================
function AppWithAuth() {
  const { session, teamMember, loading, signOut } = useAuth();

  if (loading) {
    return (
      <div className="auth-loading">
        Loading...
      </div>
    );
  }

  if (!session || !teamMember) {
    return <AuthForm />;
  }

  return <ProjectManagementApp currentTeamMember={teamMember} onSignOut={signOut} />;
}

// Render the app
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  React.createElement(AuthProvider, null,
    React.createElement(AppWithAuth)
  )
);
  </script>
</body>
</html>
